'''
–≠—Ç–æ —Ç–∏–ø–∞ –º—ã —Ü–µ–ø–ª—è–µ–º –º–æ–¥—É–ª—å sys,
–æ–Ω –Ω—É–∂–µ–Ω —á—Ç–æ–±—ã —Ä—É–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –ø—Ä–∏–∫–æ–ª–∞–º–∏ ‚Äî —Ç–∞–º –ø—É—Ç—å, –≤—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥–∏,
—Ç–∞–∫–∏–µ –¥–µ–ª–∞.
'''
import sys
'''
"""
–°–º–æ—Ç—Ä–∏, —Ç—É—Ç –º—ã –∑–∞—Ç–∞—Å–∫–∏–≤–∞–µ–º –∏–∑ PyQt5.QtWidgets –∫—É—á—É –¥–µ—Ç–∞–ª–µ–π,
—ç—Ç–æ —Ç–∞–∫–∏–µ –∫–∏—Ä–ø–∏—á–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –æ–∫–Ω–∞.

QWidget ‚Äî —ç—Ç–æ —Ç–∏–ø–∞ —Å–∞–º–∞ –∫–æ—Ä–æ–±–∫–∞ –æ–∫–Ω–∞.

QVBoxLayout –∏ QHBoxLayout ‚Äî —ç—Ç–æ —Ä–∞–∑–º–µ—Ç–∫–∞,
—á—Ç–æ–± –≤–∏–¥–∂–µ—Ç—ã —Ä–æ–≤–Ω–µ–Ω—å–∫–æ –ª–µ–∂–∞–ª–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.

QLabel ‚Äî —Ç–µ–∫—Å—Ç –≤ –æ–∫–æ—à–∫–µ.

QPushButton ‚Äî –∫–Ω–æ–ø–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∂–º—ë—à—å.

QComboBox ‚Äî –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫.

QProgressBar ‚Äî –ø–æ–ª–æ—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –≤–∏–¥–Ω–æ –±—ã–ª–æ, –∫–∞–∫ –¥–≤–∏–∂—É—Ö–∞ –∏–¥—ë—Ç.

QFileDialog ‚Äî –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞.

QApplication ‚Äî –≥–ª–∞–≤–Ω—ã–π –¥–≤–∏–∂–æ–∫ –≤—Å–µ–≥–æ –æ–∫–Ω–∞.

QMessageBox ‚Äî –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–∏–ø–∞ "–±—Ä–∞—Ç, –æ—à–∏–±–∫–∞").

QGroupBox ‚Äî —Ä–∞–º–æ—á–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.

QSpacerItem, QSizePolicy ‚Äî —à—Ç—É–∫–∏ –¥–ª—è —Ç–æ–≥–æ,
—á—Ç–æ–± –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∏—Å—å/—Å–∂–∏–º–∞–ª–∏—Å—å —ç–ª–µ–º–µ–Ω—Ç—ã.
"""
'''
from PyQt5.QtWidgets import (
    QWidget, QVBoxLayout, QLabel, QPushButton, QComboBox, QProgressBar,
    QFileDialog, QApplication, QMessageBox, QHBoxLayout, QGroupBox, QSpacerItem, QSizePolicy,
    QDialog, QComboBox, 
)
"""
–¢—É—Ç –º—ã –±–µ—Ä—ë–º —è–¥—Ä–æ Qt:

Qt ‚Äî –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤—Å—è–∫–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞).

QThread ‚Äî –∑–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞,
—á—Ç–æ–± –ø—Ä–æ–≥–∞ –Ω–µ –∑–∞–≤–∏—Å–∞–ª–∞, –ø–æ–∫–∞ –≤–∏–¥–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è.

pyqtSignal ‚Äî —Ç–∏–ø–∞ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è: "—ç–π, –ø–æ—Ç–æ–∫ –∑–∞–∫–æ–Ω—á–∏–ª, —à–ª–∏ –∏–Ω—Ñ—É".
"""
from PyQt5.QtCore import Qt, QThread, pyqtSignal, QSize
#–≠—Ç–æ –ø—Ä–æ —à—Ä–∏—Ñ—Ç—ã, —á—Ç–æ–± —Ç–µ–∫—Å—Ç –≤—ã–≥–ª—è–¥–µ–ª –Ω–µ –∫–∞–∫ —É –±–æ–º–∂–∞ –Ω–∞ –∑–∞–±–æ—Ä–µ.
from PyQt5.QtGui import QFont, QMovie
"""
‚Äî os, pathlib.Path ‚Äî –≤–æ–∑–Ω—è —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –ø–∞–ø–∫–∞–º–∏.
‚Äî shutil ‚Äî –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –¥–≤–∏–≥–∞—Ç—å, —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã –ø–∞—á–∫–∞–º–∏.
‚Äî subprocess ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–µ–≤—É—é –ø—Ä–æ–≥—É —Ç–∏–ø–∞ "ffmpeg".
‚Äî re ‚Äî —Ä–µ–≥—É–ª—è—Ä–∫–∏, –∏—Å–∫–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ.
‚Äî cv2 ‚Äî OpenCV, –º–æ—â–Ω–∞—è —à—Ç—É–∫–∞ –¥–ª—è –∫–æ–≤—ã—Ä—è–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ –≤–∏–¥–µ–æ.
"""
import os
from pathlib import Path
import shutil
import subprocess
import re
import cv2
'''
–¢—É—Ç –º—ã —Ç—è–Ω–µ–º moviepy, –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–∏–¥–æ—Å–∞–º–∏.
VideoFileClip ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–æ—Å, VideoClip ‚Äî —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π.
'''
from moviepy.editor import VideoFileClip, VideoClip # 1.0.3 version moviepy
"""

numpy ‚Äî —á—Ç–æ–± —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏ –º–∞—Ç—Ä–∏—Ü–∞–º–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –∫—Ä–∞—Å–æ—Ç–µ.

math ‚Äî –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, —Ç–∏–ø–∞ —Å–∏–Ω—É—Å—ã-–∫–æ—Å–∏–Ω—É—Å—ã.

random ‚Äî –Ω—É, —Ä–∞–Ω–¥–æ–º—á–∏–∫, —á—Ç–æ–± —á—ë-—Ç–æ —Å–ª—É—á–∞–π–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ.
"""
import numpy as np
import math
import random



'''
–≠—Ç–æ –º—ã –º—É—Ç–∏–º —Å–≤–æ–π –∫–ª–∞—Å—Å EffectProcessor,
–æ–Ω –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç QThread.
–ö–æ—Ä–æ—á–µ, –±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫,
—á—Ç–æ–± –≤–∏–¥–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–µ–∑ –ª–∞–≥–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
'''
class EffectProcessor(QThread):
    '''
–¢—É—Ç –º—ã –¥–µ–ª–∞–µ–º –¥–≤–∞ —Å–∏–≥–Ω–∞–ª–∞:

progress ‚Äî –±—É–¥–µ—Ç —Å–ª–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã (—Å–∫–æ–ª—å–∫–æ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ).

finished ‚Äî —à–ª—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞ –∑–∞–∫–æ–Ω—á–µ–Ω–∞,
–∏ –æ—Ç–¥–∞—ë—Ç –ø—É—Ç—å –∫ –≥–æ—Ç–æ–≤–æ–º—É –≤–∏–¥–æ—Å—É.
    '''
    progress = pyqtSignal(int)
    finished = pyqtSignal(str)




    '''
self ‚Äî —ç—Ç–æ –∫–∞–∫ "—è —Å–∞–º" –¥–ª—è –æ–±—ä–µ–∫—Ç–∞.

–ö–æ–≥–¥–∞ —Ç—ã –¥–µ–ª–∞–µ—à—å –∫–ª–∞—Å—Å –∏ –ø–æ—Ç–æ–º —Å–æ–∑–¥–∞—ë—à—å –∏–∑ –Ω–µ–≥–æ –æ–±—ä–µ–∫—Ç,
self –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–æ–≤ —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞ ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å —Ç–æ—Ç —Å–∞–º—ã–π –æ–±—ä–µ–∫—Ç,
—Ç–∏–ø–∞ "—è —Å–∞–º, –º–æ–π –∫–∞—Ä–º–∞–Ω".

–ü—Ä–∏–º–µ—Ä:

–£ —Ç–µ–±—è –µ—Å—Ç—å –∫–æ—Ä–µ—à –ü–µ—Ç—è (–æ–±—ä–µ–∫—Ç).

–£ –Ω–µ–≥–æ –≤ –∫–∞—Ä–º–∞–Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω (—Å–≤–æ–π—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–∞).

–ö–æ–≥–¥–∞ –æ–Ω –≥–æ–≤–æ—Ä–∏—Ç self.phone, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç "–º–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω", –∞ –Ω–µ —á–µ–π-—Ç–æ –¥—Ä—É–≥–æ–π.

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—à—å –º–µ—Ç–æ–¥ —É –æ–±—ä–µ–∫—Ç–∞,
–ø–∏—Ç–æ–Ω —Å–∞–º –ø–æ–¥—Å–æ–≤—ã–≤–∞–µ—Ç —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤ self.

–¢–æ –µ—Å—Ç—å obj.method() –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ method(self=obj).

–í—Å—ë, —á—Ç–æ —Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ—à—å —á–µ—Ä–µ–∑ self.—á—Ç–æ-—Ç–æ,
–±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∏–º–µ–Ω–Ω–æ —É —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –∞ –Ω–µ —É –≤—Å–µ—Ö –ø–æ–¥—Ä—è–¥.

–ö–æ—Ä–æ—á–µ, self ‚Äî —ç—Ç–æ —Ç–∏–ø–∞ "—Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è",
—á—Ç–æ–± —É –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ü–∞–Ω–∞ (–æ–±—ä–µ–∫—Ç–∞) –±—ã–ª–∏ —Å–≤–æ–∏ —à–º–æ—Ç–∫–∏ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ).
    '''
    
    '''
–≠—Ç–æ —Ç–∏–ø–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
–û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç: –∫–∞–∫–æ–π –≤–∏–¥–æ—Å –≤—Ö–æ–¥—è—â–∏–π, –∫–∞–∫–æ–π –≤—ã—Ö–æ–¥—è—â–∏–π, –∏ –∫–∞–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç —é–∑–∞—Ç—å.
    '''
    def __init__(self, input_video, output_video, effect_type):
        '''
–ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ (QThread).
        '''
        super().__init__()
        '''
‚Äî self.input_video ‚Äî –ø—É—Ç—å –∫ –≤—Ö–æ–¥—è—â–µ–º—É —Ä–æ–ª–∏–∫—É.
‚Äî self.output_video ‚Äî –∫—É–¥–∞ —Å–∫–∏–Ω—É—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ä–æ–ª–∏–∫.
‚Äî self.effect_type ‚Äî –∫–∞–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å.
‚Äî self.frame_cache ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–∞–¥—Ä–æ–≤,
–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —é–∑–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–∞–¥—Ä—ã (—Ç–∏–ø–∞ "—ç—Ñ—Ñ–µ–∫—Ç —Ç–æ–Ω–Ω–µ–ª—è").
        '''
        self.input_video = input_video
        self.output_video = output_video
        self.effect_type = effect_type
        self.frame_cache = []
    '''
–ö–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è.
    '''
    def run(self):
        '''
–û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Ö–æ–¥—è—â–∏–π —Ä–æ–ª–∏–∫ —á–µ—Ä–µ–∑ moviepy.
        '''
        clip = VideoFileClip(self.input_video)
        '''
–ë–µ—Ä—ë–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ä–æ–ª–∏–∫–∞:

duration ‚Äî –¥–ª–∏–Ω–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö.

fps ‚Äî –∫–∞–¥—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É.

width, height ‚Äî —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        '''
        duration = clip.duration
        fps = clip.fps
        width, height = clip.size
        self.frame_cache = []  # –û—á–∏—â–∞–µ–º –∫—ç—à

        '''
–¢—É—Ç –º—ã –¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—ë—Ç –∫–∞–¥—Ä –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ t (—Å–µ–∫—É–Ω–¥–∞).
moviepy –±—É–¥–µ—Ç —é–∑–∞—Ç—å –µ—ë, —á—Ç–æ–±—ã —Å–æ–±–∏—Ä–∞—Ç—å –Ω–æ–≤—ã–π –≤–∏–¥–æ—Å.
        '''
        def make_frame(t):
            #–î–æ—Å—Ç–∞—ë–º –∫–∞–¥—Ä –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–æ–ª–∏–∫–∞ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ t.
            frame = clip.get_frame(t)
            '''
–ö–∞–¥—Ä –∏–¥—ë—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ RGB, –∞ cv2 –ª—é–±–∏—Ç BGR ‚Äî –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–µ–º.
            '''
            frame = cv2.cvtColor(frame, cv2.COLOR_RGB2BGR)  # –í BGR –¥–ª—è OpenCV
            #—Ç—É—Ç –Ω–∞—à–∏ —ç—Ñ—Ñ–µ–∫—Ç—ã:
            if self.effect_type == 1: frame = self.particle_fly_out(frame, t, duration)
            elif self.effect_type == 2: frame = self.strip_slicing(frame, t, duration)
            elif self.effect_type == 3: frame = self.vortex_rotation(frame, t, duration)
            elif self.effect_type == 4: frame = self.explosion_shatter_forward(frame, t, duration)
            elif self.effect_type == 5: frame = self.wave_morphing(frame, t, duration)
            elif self.effect_type == 6: frame = self.cartoonify(frame, t, duration)
            elif self.effect_type == 7: frame = self.infinity_spiral(frame, t, duration)
            elif self.effect_type == 8: frame = self.mirror_maze(frame, t, duration)
            elif self.effect_type == 9: frame = self.glitch_art(frame, t, duration)
            elif self.effect_type == 10: frame = self.fire_burst(frame, t, duration)
            elif self.effect_type == 11: frame = self.water_ripple(frame, t, duration)
            elif self.effect_type == 12: frame = self.pixel_rain(frame, t, duration)
            elif self.effect_type == 13: frame = self.kaleidoscope(frame, t, duration)
            elif self.effect_type == 14: frame = self.time_tunnel(frame, t, duration, clip)
            elif self.effect_type == 15: frame = self.neon_glow(frame, t, duration)
            elif self.effect_type == 16: frame = self.glitch_shift(frame, t, duration)
            elif self.effect_type == 17: frame = self.starburst_explosion(frame, t, duration)
            elif self.effect_type == 18: frame = self.mirror_shatter(frame, t, duration)
            elif self.effect_type == 19: frame = self.color_wave_glitch(frame, t, duration)
            elif self.effect_type == 20: frame = self.pixel_fly_out(frame, t, duration)
            elif self.effect_type == 21: frame = self.hologram_flicker(frame, t, duration)
            elif self.effect_type == 22: frame = self.fireworks_overlay(frame, t, duration)
            elif self.effect_type == 23: frame = self.liquid_melt(frame, t, duration)
            elif self.effect_type == 24: frame = self.neon_glow2(frame, t, duration)
            elif self.effect_type == 25: frame = self.time_warp(frame, t, duration)
            elif self.effect_type == 26: frame = self.explosion_shatter_backward(frame, t, duration)
            elif self.effect_type == 27: frame = self.explosion_shatter_sides(frame, t, duration)
            elif self.effect_type == 28: frame = self.cartoonify2(frame, t, duration)
            elif self.effect_type == 29: frame = self.infinity_spiral2(frame, t, duration)
            elif self.effect_type == 30: frame = self.mirror_maze2(frame, t, duration)
            elif self.effect_type == 31: frame = self.glitch_art2(frame, t, duration)
            elif self.effect_type == 32: frame = self.glitch_art3(frame, t, duration)
            elif self.effect_type == 33: frame = self.glitch_art4(frame, t, duration)
            elif self.effect_type == 34: frame = self.kaleidoscope2(frame, t, duration)
            elif self.effect_type == 35: frame = self.time_tunnel2(frame, t, duration, clip)
            elif self.effect_type == 36: frame = self.neon_glow3(frame, t, duration)
            elif self.effect_type == 37: frame = self.glitch_shift2(frame, t, duration)
            elif self.effect_type == 38: frame = self.starburst_explosion2(frame, t, duration)
            elif self.effect_type == 39: frame = self.mirror_shatter2(frame, t, duration)
            elif self.effect_type == 40: frame = self.color_wave_glitch2(frame, t, duration)
            elif self.effect_type == 41: frame = self.liquid_melt2(frame, t, duration)

            elif self.effect_type == 42: frame = self.neon_glitch(frame, t, duration)
            elif self.effect_type == 43: frame = self.hologram_flicker44(frame, t, duration)
            elif self.effect_type == 44: frame = self.matrix_digital_rain(frame, t, duration)
            elif self.effect_type == 45: frame = self.crt_wave_distortion(frame, t, duration)
            elif self.effect_type == 46: frame = self.neon_edge_glow(frame, t, duration)
            elif self.effect_type == 47: frame = self.smoke_screen_dissolve(frame, t, duration)
            elif self.effect_type == 48: frame = self.raid_flashbang(frame, t, duration)
            elif self.effect_type == 49: frame = self.contraband_scan_lines(frame, t, duration)
            elif self.effect_type == 50: frame = self.territory_split_pan(frame, t, duration)
            elif self.effect_type == 51: frame = self.amnesty_color_shift(frame, t, duration)
            elif self.effect_type == 52: frame = self.blur_pulse(frame, t, duration)
            elif self.effect_type == 53: frame = self.pixelation(frame, t, duration)
            elif self.effect_type == 54: frame = self.heat_haze(frame, t, duration)
            elif self.effect_type == 55: frame = self.edge_sketch(frame, t, duration)
            elif self.effect_type == 56: frame = self.color_invert_pulse44(frame, t, duration)
            elif self.effect_type == 57: frame = self.zoom_shake(frame, t, duration)
            elif self.effect_type == 58: frame = self.vhs_noise44(frame, t, duration)
            elif self.effect_type == 59: frame = self.glow_aura(frame, t, duration)
            elif self.effect_type == 60: frame = self.circle_ripple44(frame, t, duration)
            elif self.effect_type == 61: frame = self.neon_glitch2(frame, t, duration)
            elif self.effect_type == 62: frame = self.raid_flashbang2(frame, t, duration)

            '''
–í–µ—Ä–Ω—É–ª–∏ –∫–∞–¥—Ä –æ–±—Ä–∞—Ç–Ω–æ –≤ RGB, —á—Ç–æ–±—ã moviepy –Ω–µ –ø—Å–∏—Ö–æ–≤–∞–ª.
            '''
            frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)  # –û–±—Ä–∞—Ç–Ω–æ –≤ RGB
            '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –∫–∏–¥–∞–µ–º –µ–≥–æ –Ω–∞—Ä—É–∂—É —Å–∏–≥–Ω–∞–ª–æ–º.
            '''
            self.progress.emit(int((t / duration) * 100))
            #–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä.
            return frame

        '''
–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ä–æ–ª–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ç—Å—è –∫–∞–¥—Ä –∑–∞ –∫–∞–¥—Ä–æ–º —á–µ—Ä–µ–∑ make_frame.
        '''
        new_clip = VideoClip(make_frame, duration=duration)
        '''
–°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –≤–∏–¥–æ—Å –≤ —Ñ–∞–π–ª, —é–∑–∞–µ–º –∫–æ–¥–µ–∫ libx264 (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –≤–µ—Å).
        '''
        new_clip.write_videofile(self.output_video, fps=fps, codec='libx264')
        '''
–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏ ‚Äî —Å–∏–≥–Ω–∞–ª–∏–º –Ω–∞—Ä—É–∂—É: "–ë—Ä–∞—Ç, –≥–æ—Ç–æ–≤–æ! –í–æ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É".
        '''
        self.finished.emit(self.output_video)

    '''
—Ñ—É–Ω–∫—Ü–∏—è –±–µ—Ä—ë—Ç –∫–∞–¥—Ä (frame), –≤—Ä–µ–º—è (t), –∏ –æ–±—â—É—é –¥–ª–∏–Ω—É –≤–∏–¥–æ—Å–∞ (duration).
–ù–∞ –≤—ã—Ö–æ–¥–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π –∫–∞–¥—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º.
    '''
    def particle_fly_out(self, frame, t, duration):
    
        # --- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∞ ---
        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ –æ—Ç –Ω–∞—á–∞–ª–∞ ‚Äî –æ—Ç 0 –¥–æ 1.
max(duration, 1e-6) ‚Äî —á—Ç–æ–± –Ω–µ –¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–æ–ª—å.
np.clip ‚Äî –æ–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ —É—à–ª–æ –∑–∞ —Ä–∞–º–∫–∏ (0‚Äì1).
        '''
        progress = float(t) / float(max(duration, 1e-6))
        progress = np.clip(progress, 0.0, 1.0)

        # –ù–µ –Ω–∞—á–∏–Ω–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç —Å—Ä–∞–∑—É
        '''
–ö–æ—Ä–æ—á–µ, —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ —Å—Ä–∞–∑—É –≤–∫–ª—é—á–∞–µ—Ç—Å—è.
–ü–µ—Ä–≤—ã–µ 25% –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–¥—Ä –∏–¥—ë—Ç –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ —Ñ–æ–∫—É—Å–æ–≤.
–ï—Å–ª–∏ –≤—Ä–µ–º—è –º–µ–Ω—å—à–µ –ø–æ—Ä–æ–≥–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª.
        '''
        start_thresh = 0.25
        if progress <= start_thresh:
            return frame
        
        #–ë–µ—Ä—ë–º –≤—ã—Å–æ—Ç—É –∏ —à–∏—Ä–∏–Ω—É –∫–∞–¥—Ä–∞.
        h, w = frame.shape[:2]

        # –ü–æ–¥–±–∏—Ä–∞–µ–º —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        #(–±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç—å/–∫–∞—á–µ—Å—Ç–≤–æ)
        '''
–°—á–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä "—á–∞—Å—Ç–∏—Ü—ã" (–∫–≤–∞–¥—Ä–∞—Ç–∏–∫, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É).
‚Äî –ï—Å–ª–∏ –µ—â—ë –Ω–µ —Å—á–∏—Ç–∞–ª–∏, –¥–µ–ª–∏–º –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞ –Ω–∞ 40.
‚Äî –ù–æ —á—Ç–æ–± –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–æ/–∫—Ä—É–ø–Ω–æ: –º–∏–Ω–∏–º—É–º 8 –ø–∏–∫—Å–µ–ª–µ–π, –º–∞–∫—Å–∏–º—É–º 24.
        '''
        if not hasattr(self, '_pf_particle_size'):
            self._pf_particle_size = max(8, min(24, int(min(h, w) / 40)))
        particle_size = self._pf_particle_size

        # –ß–∏—Å–ª–æ –±–ª–æ–∫–æ–≤ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏/–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ (—á–∞—Å—Ç–∏—Ü) –ø–æ–º–µ—â–∞–µ—Ç—Å—è:

nby ‚Äî –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏,

nbx ‚Äî –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
        '''
        nby = (h + particle_size - 1) // particle_size
        nbx = (w + particle_size - 1) // particle_size

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        #(–æ–¥–∏–Ω —Ä–∞–∑, –ª–∏–±–æ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–¥—Ä–∞)
        '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –Ω–∞—Å —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —ç—Ç–∏—Ö —á–∞—Å—Ç–∏—Ü.
–ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ.
        '''
        state = getattr(self, '_pf_state', None)
        if (state is None) or (state.get('shape') != (h, w, particle_size)):
            '''
–§–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–Ω–¥–æ–º, —á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –≤—Å–µ–≥–¥–∞ –≤—ã–≥–ª—è–¥–µ–ª –æ–¥–∏–Ω–∞–∫–æ–≤–æ (–Ω–µ —Ö–∞–æ—Å).
            '''
            rng = np.random.RandomState(12345)  #–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å
            # –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–∏–ª–∞ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
            '''
–î–ª—è –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏—Ü—ã –∑–∞–¥–∞—ë–º:

angles ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫—É–¥–∞ –æ–Ω–∞ –ø–æ–ª–µ—Ç–∏—Ç (–æ—Ç 0 –¥–æ 360 –≥—Ä–∞–¥—É—Å–æ–≤).

speeds ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å (–æ—Ç 0.6 –¥–æ 1.0).

vx_blocks –∏ vy_blocks ‚Äî —ç—Ç–æ —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –æ—Å—è–º (X –∏ Y).
            '''
            angles = rng.uniform(0, 2 * np.pi, size=(nby, nbx)).astype(np.float32)
            speeds = rng.uniform(0.6, 1.0, size=(nby, nbx)).astype(np.float32)
            vx_blocks = np.cos(angles) * speeds
            vy_blocks = np.sin(angles) * speeds
            # –Ω–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–π –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏/—à—É–º–æ–≤–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
            alpha_base = rng.uniform(0.6, 1.0, size=(nby, nbx)).astype(np.float32)
            #–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë —ç—Ç–æ –≤ self, —á—Ç–æ–± –ø–æ—Ç–æ–º –∑–∞–Ω–æ–≤–æ –Ω–µ —Å—á–∏—Ç–∞—Ç—å.
            self._pf_state = {
                'vx': vx_blocks,
                'vy': vy_blocks,
                'alpha_base': alpha_base,
                'shape': (h, w, particle_size)
            }
            state = self._pf_state
        '''
–î–æ—Å—Ç–∞—ë–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
        '''
        vx_blocks = state['vx']
        vy_blocks = state['vy']
        alpha_base = state['alpha_base']

        '''
s ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ñ—Ñ–µ–∫—Ç–∞ (–æ—Ç 0 –¥–æ 1 –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞).

ease ‚Äî –ø–ª–∞–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ –º–µ–¥–ª–µ–Ω–Ω–æ, –ø–æ—Ç–æ–º –±—ã—Å—Ç—Ä–µ–µ (–∫—É–±–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞).
        '''
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ [0,1] –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∞–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞
        s = np.clip((progress - start_thresh) / (1.0 - start_thresh), 0.0, 1.0)
        # ease out cubic (–ø–ª–∞–≤–Ω—ã–π —Å—Ç–∞—Ä—Ç/–±—ã—Å—Ç—Ä—ã–π –∫–æ–Ω–µ—Ü)
        ease = 1.0 - (1.0 - s) ** 3

        
        '''
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –∫—É–¥–∞ –º–æ–∂–µ—Ç —É–ª–µ—Ç–µ—Ç—å —á–∞—Å—Ç–∏—Ü–∞
(–ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –∫–∞–¥—Ä–∞).
        '''
        max_dist = np.hypot(w, h) * 0.55 #–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ

        # –°–º–µ—â–µ–Ω–∏—è –¥–ª—è –±–ª–æ–∫–æ–≤
        '''
–°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏—Ü—ã –ø–æ X –∏ Y –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
        '''
        dx_blocks = vx_blocks * ease * max_dist
        dy_blocks = vy_blocks * ease * max_dist

        # –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (vectorized)
        '''
–î–µ–ª–∞–µ–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –≤—Å–µ–≥–æ –∫–∞–¥—Ä–∞.
–ö–∞–∂–¥–æ–º—É –ø–∏–∫—Å–µ–ª—é –Ω–∞–∑–Ω–∞—á–∞–µ–º, –∫ –∫–∞–∫–æ–º—É –±–ª–æ–∫—É (—á–∞—Å—Ç–∏—Ü–µ) –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è.
        '''
        ys, xs = np.meshgrid(np.arange(h), np.arange(w), indexing='ij')  # shape (h,w)
        block_x = (xs // particle_size).astype(np.int32)
        block_y = (ys // particle_size).astype(np.int32)

        # –ë–µ—Ä–µ–º —Å–º–µ—â–µ–Ω–∏—è –∏–∑ –±–ª–æ–∫–æ–≤–æ–π –∫–∞—Ä—Ç—ã
        dx = dx_blocks[block_y, block_x]  # shape (h,w)
        dy = dy_blocks[block_y, block_x]

        # remap: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –ø–∏–∫—Å–µ–ª—è (x, y) = (x - dx, y - dy)
        '''
–ö–∞—Ä—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: –≥–¥–µ —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å.
        '''
        map_x = (xs - dx).astype(np.float32)
        map_y = (ys - dy).astype(np.float32)

        # –í—ã–ø–æ–ª–Ω—è–µ–º remap ‚Äî —ç—Ç–æ C-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
        # –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–Ω–µ–π–Ω—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç–æ—Ç –Ω—É–ª—è–º–∏
        '''
–ë–µ—Ä—ë–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–∞–¥—Ä –∏ –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –ø–∏–∫—Å–µ–ª–∏ –ø–æ –Ω–æ–≤—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º.
‚Äî INTER_LINEAR ‚Äî —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ.
‚Äî borderValue=0 ‚Äî –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ –∑–∞–∫—Ä–∞—à–∏–≤–∞–µ–º —á—ë—Ä–Ω—ã–º.
        '''
        new_frame = cv2.remap(frame, map_x, map_y, interpolation=cv2.INTER_LINEAR,
                              borderMode=cv2.BORDER_CONSTANT, borderValue=0)

        # –õ—ë–≥–∫–æ–µ –≤—ã—Ü–≤–µ—Ç–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü –ø–æ –º–µ—Ä–µ –≤—ã–ª–µ—Ç–∞ (–∞–ª—å—Ñ–∞ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä)
        # alpha_base ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è –±–∞–∑–∞ –≤ –±–ª–æ–∫–µ, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å ease
        alpha_block = np.clip(1.0 - ease * 1.05, 0.0, 1.0) * alpha_base[block_y, block_x]
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –∫–∞–∂–¥–æ–º—É –∫–∞–Ω–∞–ª—É (–µ—Å–ª–∏ —Ü–≤–µ—Ç–Ω–æ–µ)
        '''
–ï—Å–ª–∏ –∫–∞–¥—Ä —Ü–≤–µ—Ç–Ω–æ–π (3 –∫–∞–Ω–∞–ª–∞) ‚Äî —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∞–ª—å—Ñ—É –ø–æ–¥ –≤—Å–µ –∫–∞–Ω–∞–ª—ã.
–ü–µ—Ä–µ–º–Ω–æ–∂–∞–µ–º ‚Äî –ø–∏–∫—Å–µ–ª–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ç—É—Å–∫–ª–µ–µ.
–ï—Å–ª–∏ –∫–∞–¥—Ä —Å–µ—Ä—ã–π ‚Äî –ø—Ä–æ—Å—Ç–æ —É–º–Ω–æ–∂–∞–µ–º.
        '''
        if new_frame.ndim == 3 and new_frame.shape[2] == 3:
            alpha_3 = alpha_block[:, :, None]
            # –ø—Ä–∏–≤–æ–¥–∏–º –∫ float –¥–ª—è –ø–µ—Ä–µ–º–Ω–æ–∂–µ–Ω–∏—è, –∑–∞—Ç–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–∏–ø
            new_frame = (new_frame.astype(np.float32) * alpha_3).astype(frame.dtype)
        else:
            new_frame = (new_frame.astype(np.float32) * alpha_block).astype(frame.dtype)
        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–∞–¥—Ä, –≥–¥–µ —á–∞—Å—Ç–∏—Ü—ã —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è –∏ —Ç–∞—é—Ç.
        '''
        return new_frame
    '''
–ë—Ä–∞—Ç, —ç—Ç–æ —É —Ç–µ–±—è –ø—Ä—è–º –∫–∏–Ω–æ—à–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ä–∞–∑–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –∫—É—Å–∫–∏, –∏ –æ–Ω–∏ –∫—Ä–∞—Å–∏–≤–æ —É–ª–µ—Ç–∞—é—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—ã. üî•
    '''


    '''
–§—É–Ω–∫—Ü–∏—è. –ë–µ—Ä—ë—Ç –∫–∞–¥—Ä (frame), –≤—Ä–µ–º—è (t), –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (duration)
–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∞:

num_strips ‚Äî —Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ—Å –Ω–∞—Ä–µ–∂–µ–º;

max_angle ‚Äî –Ω–∞ —Å–∫–æ–ª—å–∫–æ –≥—Ä–∞–¥—É—Å–æ–≤ –∫–∞–∂–¥–∞—è –ø–æ–ª–æ—Å–∞ –º–æ–∂–µ—Ç –∫—Ä—É—Ç–∏—Ç—å—Å—è;

max_shift_frac ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –ø–æ–ª–æ—Å–∞ –º–æ–∂–µ—Ç
—Å—ä–µ—Ö–∞—Ç—å –≤ —Å—Ç–æ—Ä–æ–Ω—É (—á–∞—Å—Ç—å —à–∏—Ä–∏–Ω—ã –∫–∞–¥—Ä–∞).
    '''
    def strip_slicing(self, frame, t, duration, num_strips=12, max_angle=30, max_shift_frac=0.25):
        """
    –ù—É —á—ë, –±—Ä–∞—Ç, –¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º —ç—Ç–æ—Ç –¥–≤–∏–∂ –ø–æ —Ñ–µ–Ω—à—É—é.
    –≠—Ç–æ —É –Ω–∞—Å —ç—Ñ—Ñ–µ–∫—Ç "–ø–æ–ª–æ—Å—ã —Ä–∞–∑–¥–≤–∏–≥–∞—é—Ç—Å—è –∏ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è"
    ‚Äî —Ç–∏–ø–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ä–µ–∂–µ—Ç—Å—è –Ω–∞ –ø–æ–ª–æ—Å—ã –∏ –∫–∞–∂–¥–∞—è –ø–æ-—Å–≤–æ–µ–º—É —Å–º–µ—â–∞–µ—Ç—Å—è –∏ –∫—Ä—É—Ç–∏—Ç—Å—è.
    –†–∞–∑–ª–æ–∂—É —Ç–µ–±–µ —Å—Ç—Ä–æ—á–∫—É –∑–∞ —Å—Ç—Ä–æ—á–∫–æ–π, –∫–∞–∫ –≤ —Ö–∞—Ç–µ –∫–∞—Ä—Ç—ã –Ω–∞ —Å—Ç–æ–ª.
        """
        h, w = frame.shape[:2] #–°–Ω–∏–º–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞–¥—Ä–∞: –≤—ã—Å–æ—Ç–∞ –∏ —à–∏—Ä–∏–Ω–∞.
        '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ñ—Ñ–µ–∫—Ç–∞ ‚Äî –æ—Ç 0 (–Ω–∞—á–∞–ª–æ) –¥–æ 1 (–∫–æ–Ω–µ—Ü).
clip –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ–∑–ª–æ –∑–∞ —Ä–∞–º–∫–∏.
        '''
        progress = np.clip(t / duration, 0.0, 1.0)
        '''
–¢—É—Ç –¥–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ —Ç–∏—Ö–æ,
–ø–æ—Ç–æ–º –±—ã—Å—Ç—Ä–µ–µ (–∫—É–±–∏—á–µ—Å–∫–∞—è "ease out").
        '''
        ease = 1.0 - (1.0 - progress) ** 3 #(–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π easing)

        # –ù–∞—á–∏–Ω–∞–µ–º —Å –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞, –±—É–¥–µ–º —á–∞—Å—Ç–∏—á–Ω–æ –µ–≥–æ —Å–º–µ—à–∏–≤–∞—Ç—å —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º
        out = frame.copy()

        # —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞–∑–±–∏–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª–∏,
        #—á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –Ω–∏–∂–Ω—é—é/–≤–µ—Ä—Ö–Ω—é—é —á–∞—Å—Ç—å
        ys = np.linspace(0, h, num_strips + 1, dtype=int)

        for i in range(num_strips): #–ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª: –∏–¥—ë–º –ø–æ –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å–µ.
            '''
–ë–µ—Ä—ë–º –ø–æ–ª–æ—Å—É –æ—Ç y0 –¥–æ y1. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–ª–æ—Å–∞ –ø—É—Å—Ç–∞—è ‚Äî —Å–∫–∏–ø–∞–µ–º.
            '''
            y0, y1 = ys[i], ys[i + 1]
            strip = frame[y0:y1, :, :]
            sh = y1 - y0
            if sh <= 0:
                continue

            '''
–ó–∞–¥–∞—ë–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è.
‚Äî –ß—ë—Ç–Ω—ã–µ –ø–æ–ª–æ—Å—ã –∏–¥—É—Ç –≤–ª–µ–≤–æ (-1).
‚Äî –ù–µ—á—ë—Ç–Ω—ã–µ ‚Äî –≤–ø—Ä–∞–≤–æ (+1).
–¢–∏–ø–∞ —à–∞—Ö–º–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫.
            '''
            direction = -1 if (i % 2 == 0) else 1  # —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π

            # –ü–ª–∞–≤–Ω—ã–π —É–≥–æ–ª –∏ —Å–º–µ—â–µ–Ω–∏–µ
            '''
–°—á–∏—Ç–∞–µ–º:

angle ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—å –ø–æ–ª–æ—Å—É (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞).

dx ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–º–µ—Å—Ç–∏—Ç—å –µ—ë –≤–±–æ–∫.
            '''
            angle = direction * max_angle * ease
            dx = int(direction * w * max_shift_frac * ease)

            # –¶–µ–Ω—Ç—Ä –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–æ–ª–æ—Å—ã
            '''
‚Äî center ‚Äî —Ü–µ–Ω—Ç—Ä –ø–æ–ª–æ—Å—ã, –≤–æ–∫—Ä—É–≥ –Ω–µ–≥–æ –∫—Ä—É—Ç–∏–º.
‚Äî M ‚Äî –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞.
‚Äî M[0,2] += dx ‚Äî —Å—Ä–∞–∑—É –≤ –º–∞—Ç—Ä–∏—Ü—É –¥–æ–∫–∏–¥—ã–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥.
            '''
            center = (w / 2.0, sh / 2.0)
            M = cv2.getRotationMatrix2D(center, angle, 1.0)
            M[0, 2] += dx  # –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –ø—Ä—è–º–æ –≤ –º–∞—Ç—Ä–∏—Ü—É

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∞—Ñ—Ñ–∏–Ω–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫ –ø–æ–ª–æ—Å–µ
            '''
–ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:
‚Äî warpAffine –∫—Ä—É—Ç–∏—Ç –∏ —Å–¥–≤–∏–≥–∞–µ—Ç –ø–æ–ª–æ—Å—É –ø–æ –º–∞—Ç—Ä–∏—Ü–µ M.
‚Äî –ï—Å–ª–∏ –ø–∏–∫—Å–µ–ª–µ–π –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –±–µ—Ä—ë–º –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Å –∫—Ä–∞—ë–≤, —á—Ç–æ–± –¥—ã—Ä –Ω–µ –±—ã–ª–æ.
            '''
            rotated = cv2.warpAffine(strip, M, (w, sh),
                                 flags=cv2.INTER_LINEAR,
                                 borderMode=cv2.BORDER_REFLECT_101)
            '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—É—é –ø–æ–ª–æ—Å—É:

–ö–æ–≥–¥–∞ —ç—Ñ—Ñ–µ–∫—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç ‚Äî –±–æ–ª—å—à–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.

–ö–æ–≥–¥–∞ –ø–æ–¥ –∫–æ–Ω–µ—Ü ‚Äî –±–æ–ª—å—à–µ –∫—Ä—É—á—ë–Ω–æ–π –≤–µ—Ä—Å–∏–∏.
            '''
            # –°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–ª–æ—Å—É (–º—è–≥–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥)
            alpha = ease  # –º–æ–∂–Ω–æ —Å–º–µ—â–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä ease*0.9) –¥–ª—è –±–æ–ª–µ–µ –º—è–≥–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
            blended = cv2.addWeighted(strip, 1.0 - alpha, rotated, alpha, 0)

            '''
–°—Ç–∞–≤–∏–º –æ–±—Ä–∞—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –ø–æ–ª–æ—Å—É –Ω–∞ –µ—ë –º–µ—Å—Ç–æ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É.
            '''
            out[y0:y1, :, :] = blended

            '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä, –≥–¥–µ –ø–æ–ª–æ—Å—ã —É–∂–µ –∫—Ä–∞—Å–∏–≤–æ —Ä–∞–∑—ä–µ—Ö–∞–ª–∏—Å—å.
            '''
        return out
    '''
–ö–æ—Ä–æ—á–µ, –±—Ä–∞—Ç, —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç —Ç–∞–∫,
—á—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞–∫ –±—É–¥—Ç–æ –Ω–∞—Ä–µ–∑–∞–Ω–∞ –Ω–∞ –ª–µ–Ω—Ç—ã,
–∏ –æ–Ω–∏ –ø–æ–æ—á–µ—Ä—ë–¥–Ω–æ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã,
–µ—â—ë –∏ —Å–ª–µ–≥–∫–∞ –∫—Ä—É—Ç—è—Ç—Å—è ‚Äî —Å–º–æ—Ç—Ä–∏—Ç—Å—è –∫–∞–∫ –∫–∏–Ω–æ—à–Ω–∞—è –∑–∞—Å—Ç–∞–≤–∫–∞. üî•
    '''





    
    def vortex_rotation(self, frame, t, duration):
        h, w = frame.shape[:2]
        cx, cy = w / 2, h / 2
        progress = t / duration

        # —Å–µ—Ç–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        '''
–°—Ç—Ä–æ–∏–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –∑–Ω–∞–µ–º –µ–≥–æ x –∏ y.
        '''
        x, y = np.meshgrid(np.arange(w), np.arange(h))
        '''
‚Äî dx, dy ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª—è –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.
‚Äî r ‚Äî —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ (—Ä–∞–¥–∏—É—Å).
‚Äî theta ‚Äî —É–≥–æ–ª —ç—Ç–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ (–≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö).
–¢–∏–ø–∞ –º—ã –ø–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –ø–æ–ª—è—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.
        '''
        dx = x - cx
        dy = y - cy
        r = np.sqrt(dx**2 + dy**2)
        theta = np.arctan2(dy, dx)

        # —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ (—É—Å–∏–ª–µ–Ω–∏–µ –ø–æ —Ä–∞–¥–∏—É—Å—É –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "–≤–∏—Ö—Ä—è")
        '''
‚Äî swirl_strength ‚Äî —Å–∏–ª–∞ –∑–∞–∫—Ä—É—Ç–∫–∏, —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º (–æ—Ç 0 –¥–æ 2œÄ).
‚Äî theta_new ‚Äî –Ω–æ–≤—ã–π —É–≥–æ–ª: —á–µ–º –¥–∞–ª—å—à–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ (r), —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –ø–∏—Ö–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç.
–ö–æ—Ä–æ—á–µ, —á–µ–º –¥–∞–ª—å—à–µ –ø–∏–∫—Å–µ–ª—å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –µ–≥–æ –∑–∞–∫—Ä—É—Ç–∏–ª–æ –≤ –≤–∏—Ö—Ä—å.
        '''
        swirl_strength = 2 * math.pi * progress
        theta_new = theta + swirl_strength * (r / max(cx, cy))

        # –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ —Ü–µ–Ω—Ç—Ä—É
        '''
–î–µ–ª–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤—Å—ë –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ç—è–Ω–µ—Ç—Å—è –∫ —Ü–µ–Ω—Ç—Ä—É.
scale —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, –∏ —Ä–∞–¥–∏—É—Å r_new —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–µ–Ω—å—à–µ.
        '''
        scale = 1 - 0.3 * progress
        r_new = r * scale

        # –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        '''
–°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è:
–±–µ—Ä—ë–º —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–¥–∏—É—Å –∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—ã–π —É–≥–æ–ª, –ø–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—Ä–∞—Ç–Ω–æ –≤ XY.
        '''
        map_x = (cx + r_new * np.cos(theta_new)).astype(np.float32)
        map_y = (cy + r_new * np.sin(theta_new)).astype(np.float32)

        # —Ä–µ–º–∞–ø–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É (–±—ã—Å—Ç—Ä–æ!)
        '''
cv2.remap ‚Äî –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –ø–∏–∫—Å–µ–ª–∏ –Ω–∞ –Ω–æ–≤—ã–µ –º–µ—Å—Ç–∞.
‚Äî INTER_LINEAR ‚Äî —Å–≥–ª–∞–∂–∏–≤–∞–µ–º, —á—Ç–æ–± –Ω–µ –±—ã–ª–æ —Å—Ç—É–ø–µ–Ω–µ–∫.
‚Äî BORDER_REFLECT ‚Äî –µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—ã–ª–µ–∑–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É,
–æ—Ç—Ä–∞–∂–∞–µ–º –æ—Ç –∫—Ä–∞—è, –∫–∞–∫ –±—É–¥—Ç–æ –≤ –∑–µ—Ä–∫–∞–ª–æ.
        '''
        new_frame = cv2.remap(frame, map_x, map_y, interpolation=cv2.INTER_LINEAR,
                              borderMode=cv2.BORDER_REFLECT)

        '''
–ö–æ—Ä–æ—á–µ, –±—Ä–∞—Ç, —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç —Ç–∞–∫,
–±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —É—Ö–æ–¥–∏—Ç –≤ —á—ë—Ä–Ω—É—é –¥—ã—Ä—É:
–≤—Å—ë –∑–∞–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è –ø–æ —Å–ø–∏—Ä–∞–ª–∏ –∏ –∑–∞—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä—å. üî•
        '''
        return new_frame




    '''
–§—É–Ω–∫—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞. –ë–µ—Ä—ë—Ç –∫–∞–¥—Ä (frame), –≤—Ä–µ–º—è (t), –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (duration).
grid_size=10 ‚Äî —ç—Ç–æ —Å–∫–æ–ª—å–∫–æ –∫—É—Å–æ—á–∫–æ–≤ –ø–æ —Å–µ—Ç–∫–µ
(—Ç–∏–ø–∞ –¥–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç—ã 10√ó10).
    '''
    def explosion_shatter_forward(self, frame, t, duration, grid_size=10):
        """–§—Ä–∞–≥–º–µ–Ω—Ç—ã –≤—ã–ª–µ—Ç–∞—é—Ç –í–ü–ï–†–Å–î (—É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è)"""
        progress = t / duration
        h, w = frame.shape[:2]
        '''
–î–µ–ª–∞–µ–º –ø—É—Å—Ç–æ–π –∫–∞–¥—Ä (—á—ë—Ä–Ω—ã–π), –Ω–∞ –Ω–µ–≥–æ –±—É–¥–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ –æ–±–ª–æ–º–∫–∏.
        '''
        new_frame = np.zeros_like(frame)


        '''
–î–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Å–µ—Ç–∫—É: gh √ó gw –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤. –ò–¥—ë–º –ø–æ –∫–∞–∂–¥–æ–π –∫–ª–µ—Ç–∫–µ.
        '''
        gh, gw = grid_size, grid_size
        for i in range(gh):
            for j in range(gw):
                '''
–í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Ç–µ–∫—É—â–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ (—Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É –∏ —Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É).
                '''
                x1, y1 = j * w // gw, i * h // gh
                x2, y2 = (j+1) * w // gw, (i+1) * h // gh
                '''
–í—ã—Ä–µ–∑–∞–µ–º –∫—É—Å–æ–∫ (frag) –∏–∑ –∫–∞–¥—Ä–∞ –∏ —Å–º–æ—Ç—Ä–∏–º –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã.
                '''
                frag = frame[y1:y2, x1:x2]
                fh, fw = frag.shape[:2]

                # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ (–≤—ã–ª–µ—Ç–∞–µ—Ç –Ω–∞ –∫–∞–º–µ—Ä—É)
                '''
–ö–∞–∂–¥—ã–π –∫—É—Å–æ–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º:
‚Äî scale —Ä–∞—Å—Ç—ë—Ç –æ—Ç 1 –¥–æ 3 (—Ç.–µ. –≤ 3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –∫ –∫–æ–Ω—Ü—É).
‚Äî –†–µ—Å–∞–π–∑–∏–º –∫—É—Å–æ–∫.
‚Äî rh, rw ‚Äî –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã —ç—Ç–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞.
                '''
                scale = 1 + progress * 2.0
                frag_resized = cv2.resize(frag, (max(1, int(fw*scale)), max(1, int(fh*scale))))
                rh, rw = frag_resized.shape[:2]

                # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
                '''
–°—Ç–∞–≤–∏–º –∫—É—Å–æ–∫ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤—ã–ª–µ—Ç–∞–ª –∏–∑ —Å–≤–æ–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∞
(–∞ –Ω–µ —Å–¥–≤–∏–≥–∞–ª—Å—è –∫—É–¥–∞ –ø–æ–ø–∞–ª–æ).
–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –¥–≤–∏–≥–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞–∑–∞–¥, —á—Ç–æ–±—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ ¬´–≤ –∫–∞–º–µ—Ä—É¬ª.
                '''
                fx = (x1 + x2)//2 - rw//2
                fy = (y1 + y2)//2 - rh//2

                # –û—Ç—Ä–∏—Å–æ–≤–∫–∞
                '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–± –∫—É—Å–æ–∫ –Ω–µ –≤—ã–ª–µ–∑ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞–¥—Ä–∞.
‚Äî frag_crop ‚Äî –æ–±—Ä–µ–∑–∞–µ–º –µ–≥–æ, –µ—Å–ª–∏ –æ–Ω –≤—Å—ë-—Ç–∞–∫–∏ –±–æ–ª—å—à–µ —ç–∫—Ä–∞–Ω–∞.
‚Äî roi ‚Äî –æ–±–ª–∞—Å—Ç—å –Ω–∞ –ø—É—Å—Ç–æ–º –∫–∞–¥—Ä–µ, –∫—É–¥–∞ —ç—Ç–æ—Ç –∫—É—Å–æ–∫ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è.
                '''
                if 0 <= fx < w and 0 <= fy < h:
                    x_end, y_end = min(w, fx+rw), min(h, fy+rh)
                    frag_crop = frag_resized[:y_end-fy, :x_end-fx]
                    roi = new_frame[fy:y_end, fx:x_end]
                    '''
–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: –≤ –Ω–∞—á–∞–ª–µ –∫—É—Å–∫–∏ —á—ë—Ç–∫–∏–µ (alpha ~ 1),
–∫ –∫–æ–Ω—Ü—É –ø–æ—á—Ç–∏ –∏—Å—á–µ–∑–∞—é—Ç (alpha ~ 0).
                    '''
                    alpha = max(0, 1 - progress**1.8)
                    '''
–ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∫—É—Å–æ–∫ –Ω–∞ —Ñ–æ–Ω —Å –ø–ª–∞–≤–Ω—ã–º –∑–∞—Ç—É—Ö–∞–Ω–∏–µ–º.
cv2.addWeighted —Å–º–µ—à–∏–≤–∞–µ—Ç –¥–≤–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Å–∞–º–∏.
                    '''
                    blended = cv2.addWeighted(frag_crop, alpha, roi, 1 - alpha, 0)
                    new_frame[fy:y_end, fx:x_end] = blended
                    '''
–ö–æ—Ä–æ—á–µ, –±—Ä–∞—Ç, —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫,
–±—É–¥—Ç–æ —ç–∫—Ä–∞–Ω –≤–∑–æ—Ä–≤–∞–ª—Å—è –Ω–∞ –æ—Å–∫–æ–ª–∫–∏,
–∏ –æ–Ω–∏ –ª–µ—Ç—è—Ç –ø—Ä—è–º–æ –≤ –∫–∞–º–µ—Ä—É.
–ß–∏—Å—Ç–æ –∫–∞–∫ –Ω–∞—Ä–µ–∑–∫–∞ –≤ –∫–∏–Ω–æ, –∫–æ–≥–¥–∞ –≥—Ä–∞–Ω–∞—Ç–∞ –∑–∞–ª–µ—Ç–µ–ª–∞ –≤ –∏–∑–æ–ª—è—Ç–æ—Ä üí•.
                    '''
        return new_frame

    

    def wave_morphing(self, frame, t, duration):
        # –≠—Ñ—Ñ–µ–∫—Ç: –í–æ–ª–Ω–æ–≤–æ–µ –∏—Å–∫–∞–∂–µ–Ω–∏–µ, –∫–∞–∫ —Ä–∞–∑—Ä–µ–∑–∞–Ω–∏–µ –≤–æ–ª–Ω–∞–º–∏
        progress = t / duration
        '''
–ê–º–ø–ª–∏—Ç—É–¥–∞ –≤–æ–ª–Ω—ã. –ß–µ–º –¥–∞–ª—å—à–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏,
—Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –∫–æ–ª–±–∞—Å–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
(–≤ –Ω–∞—á–∞–ª–µ —á—É—Ç—å-—á—É—Ç—å, –ø–æ–¥ –∫–æ–Ω–µ—Ü ‚Äî –≤–∞—â–µ –∫—Ä—É—Ç–∏—Ç).
        '''
        amplitude = 50 * progress
        '''
–ß–∞—Å—Ç–æ—Ç–∞ –≤–æ–ª–Ω—ã ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–æ –±—É–¥–µ—Ç —Ä—è–±–∏—Ç—å –ø–æ —ç–∫—Ä–∞–Ω—É.
        '''
        frequency = 0.1

        h, w = frame.shape[:2]

        # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        y, x = np.meshgrid(np.arange(h), np.arange(w), indexing="ij")

        # –°–º–µ—â–µ–Ω–∏–µ –ø–æ x –∏ y
        '''
–í–æ—Ç —Ç—É—Ç –≤—Å—è –º–∞–≥–∏—è:

–î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –ø–æ X –¥–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –≤–∏–¥–µ —Å–∏–Ω—É—Å–∞ ‚Üí —ç—Ç–æ –¥–∞—ë—Ç ¬´–∑–º–µ–π–∫—É¬ª,
–∫–∞–∫ –≤–æ–ª–Ω–∞.

–î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –ø–æ Y –¥–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –≤–∏–¥–µ –∫–æ—Å–∏–Ω—É—Å–∞ ‚Üí –µ—â—ë –±–æ–ª—å—à–µ –∫—Ä–∏–≤–∏—Ç,
—Ç–∏–ø–∞ –≤–æ–ª–Ω–∞ –∏–¥—ë—Ç –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏.

t * 10 ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è, —á—Ç–æ–±—ã —Ä—è–±—å –¥–≤–∏–≥–∞–ª–∞—Å—å, –∞ –Ω–µ —Å—Ç–æ—è–ª–∞.

–ö–æ—Ä–æ—á–µ, –ø–∏–∫—Å–µ–ª–∏ —Ç—É–ø–æ –ø–ª–∞–≤–∞—é—Ç —Ç—É–¥–∞-—Å—é–¥–∞,
–∫–∞–∫ –±—É–¥—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å —á–µ—Ä–µ–∑ –≥–æ—Ä—è—á–∏–π –≤–æ–∑–¥—É—Ö –Ω–∞–¥ –∫–æ—Å—Ç—Ä–æ–º üî•.
        '''
        new_x = (x + amplitude * np.sin(2 * np.pi * frequency * y + t * 10)).astype(np.float32)
        new_y = (y + amplitude * np.cos(2 * np.pi * frequency * x + t * 10)).astype(np.float32)

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º cv2.remap –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
        new_frame = cv2.remap(frame, new_x, new_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        '''
‚ö° –ö–æ—Ä–æ—á–µ, —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç, –±—Ä–∞—Ç–∞–Ω, —ç—Ç–æ –∫–∞–∫ –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –Ω–∞—Ç—É—Ä–µ –≥–Ω—ë—Ç
–≤–æ–¥—è–Ω–æ–π —Ä—è–±—å—é, –æ–Ω–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è —Ç—É–¥–∞-—Å—é–¥–∞, –ø—Ä—è–º–æ –≥–ª–∞–∑–∞ –¥—É—Ä–∏—Ç.
–ß–∏—Å—Ç–æ –∏–ª–ª—é–∑–∏—è, –±—É–¥—Ç–æ —Å–∏–¥–∏—à—å —É —Ä–µ—á–∫–∏ –ø–æ—Å–ª–µ ¬´–º–∞–ª—è–≤—ã¬ª –∏ —Å–º–æ—Ç—Ä–∏—à—å,
–∫–∞–∫ —Ç–µ—á–µ–Ω–∏–µ –≤–æ–¥—É –∫–æ–ª—ã—à–µ—Ç üåä.
        '''
        return new_frame


    '''
–§—É–Ω–∫—Ü–∏—è cartoonify –¥–µ–ª–∞–µ—Ç –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ —Ç–∞–∫—É—é ¬´–º—É–ª—å—Ç—è—à–∫—É¬ª,
–ø—Ä—è–º –∫–∞–∫ –±—É–¥—Ç–æ —Ö—É–¥–æ–∂–Ω–∏–∫ —Ñ–ª–æ–º–∞—Å—Ç–µ—Ä–æ–º –æ–±–≤—ë–ª –∏ –∫—Ä–∞—Å–∫–∞–º–∏ –∑–∞–ª–∏–ª.
    '''
    def cartoonify(self, frame, t, duration):
        '''
—Ç—É—Ç –æ–Ω–æ –æ—Å–æ–±–æ –Ω–µ —Ä–µ—à–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ —á—Ç–æ–± –±—ã–ª —Ä–∞—Å—á—ë—Ç.
        '''
        progress = t / duration

        '''
cv2.pyrDown(frame)
–¢—É—Ç –º—ã –∫–∞—Ä—Ç–∏–Ω–∫—É ¬´—Å–∂–∏–º–∞–µ–º¬ª,
—Ç–∏–ø–∞ –≤ –ø–æ–ª—Ä–∞–∑–∞ —É–º–µ–Ω—å—à–∞–µ–º. –ó–∞—á–µ–º?
–ù—É —á—Ç–æ–± –±—ã—Å—Ç—Ä–µ–µ –¥–∞–ª—å—à–µ –º—É—Ç–∏—Ç—å, –º–µ–Ω—å—à–µ –¥–µ—Ç–∞–ª–µ–π ‚Äî –º–µ–Ω—å—à–µ –≤–æ–∑–Ω–∏.
        '''
        small = cv2.pyrDown(frame) #(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        # –î–µ–ª–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ (–º—è–≥–∫–∏–µ –∑–∞–ª–∏–≤–∫–∏)
        '''
cv2.bilateralFilter(...)
–≠—Ç–æ —Ç–∞–∫–æ–π —Ñ–∏–ª—å—Ç—Ä,
–∫–æ—Ç–æ—Ä—ã–π —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç —Ü–≤–µ—Ç–∞, –Ω–æ –Ω–µ —Ä–∞–∑–º—ã–≤–∞–µ—Ç –∫—Ä–∞—è.
–¢–∏–ø–∞ –∫–∞–∫ –µ—Å–ª–∏ –±—ã ¬´—Ä–∞–∑–º–∞–∑–∞–ª¬ª –ø—è—Ç–Ω–∞,
–Ω–æ —á—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Å—Ç–∞–≤–∏–ª.
–î–µ–ª–∞–µ—Ç—Å—è –ø–∞—Ä—É —Ä–∞–∑, —á—Ç–æ–± –º—è–≥—á–µ —Å–º–æ—Ç—Ä–µ–ª–æ—Å—å, –∫–∞–∫ –∫—Ä–∞—Å–∫–æ–π –∑–∞–ª–∏–ª–∏.
        '''
        for _ in range(2):
            small = cv2.bilateralFilter(small, d=9, sigmaColor=75, sigmaSpace=75)

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        smooth = cv2.pyrUp(small)

        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–µ—Ä—ã–π –∏ –∏—â–µ–º –∫—Ä–∞—è
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        gray = cv2.medianBlur(gray, 7)
        '''
–í–æ—Ç —Ç—É—Ç –ø—Ä—è–º –∏—â–µ–º ¬´–∫–æ–Ω—Ç—É—Ä—ã¬ª ‚Äî –ª–∏–Ω–∏–∏, –≥–¥–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è —Å–∏–ª—å–Ω–æ.
–¢–∏–ø–∞ –æ—á–µ—Ä—Ç–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.
        '''
        edges = cv2.Canny(gray, 50, 150)
        '''
dilate ‚Äî —É—Ç–æ–ª—â–∞–µ—Ç –ª–∏–Ω–∏–∏, —á—Ç–æ–± –∂–∏—Ä–Ω–æ —Å–º–æ—Ç—Ä–µ–ª–æ—Å—å.

bitwise_not ‚Äî –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç: –±–µ–ª—ã–π —Ñ–æ–Ω, —á—ë—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏.
–ß—Ç–æ–±—ã –±—ã–ª–æ –ø–æ-–º—É–ª—å—Ç—è—à–Ω–æ–º—É.
        '''
        edges = cv2.dilate(edges, None)   # —É—Ç–æ–ª—â–∞–µ–º –ª–∏–Ω–∏–∏
        edges = cv2.bitwise_not(edges)    # –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º (—á—Ç–æ–±—ã –±–µ–ª—ã–π —Ñ–æ–Ω, —á—ë—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏)

        # –ú–∞—Å–∫–∞ –∫–æ–Ω—Ç—É—Ä–æ–≤ –≤ 3 –∫–∞–Ω–∞–ª–∞
        '''
–ö—Ä–∞—Å–∏–º —ç—Ç–∏ –ª–∏–Ω–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ 3 –∫–∞–Ω–∞–ª–∞, —á—Ç–æ–± —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å —Ü–≤–µ—Ç–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.
        '''
        edges_colored = cv2.cvtColor(edges, cv2.COLOR_GRAY2BGR)

        # –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –º—É–ª—å—Ç—è—à–Ω—ã–µ –∑–∞–ª–∏–≤–∫–∏ + –ª–∏–Ω–∏–∏
        '''
–ò –≤–æ—Ç —Ñ–∏–Ω—Ç —É—à–∞–º–∏: —Å–∫–ª–µ–∏–≤–∞–µ–º ¬´—Ü–≤–µ—Ç–Ω—ã–µ –∑–∞–ª–∏–≤–∫–∏¬ª (smooth)
–∏ ¬´—á—ë—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏¬ª (edges).
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ –º—É–ª—å—Ç–∏–∫ –∏–ª–∏ –∫–æ–º–∏–∫—Å.
        '''
        cartoon = cv2.bitwise_and(smooth, edges_colored)

        return cartoon


    
    def infinity_spiral(self, frame, t, duration):
        progress = t / duration
        h, w = frame.shape[:2]
        '''
–í—ã—á–∏—Å–ª—è–µ–º —Å–µ—Ä–µ–¥–∏–Ω—É –∫–∞–¥—Ä–∞ ‚Äî –≥–¥–µ —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è.
        '''
        center_x, center_y = w / 2, h / 2

        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞
        '''
–°—Ç—Ä–æ–∏–º —Ç–∞–∫—É—é —Ä–µ—à—ë—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å
–ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –∞–¥—Ä–µ—Å ¬´–≥–¥–µ –æ–Ω –∂–∏–≤—ë—Ç¬ª.
        '''
        y, x = np.indices((h, w))
        '''
–°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏—è: –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å –æ—Ç—ä–µ—Ö–∞–ª –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
–ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (dx) –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (dy).
        '''
        dx = x - center_x
        dy = y - center_y

        # –ü–æ–ª—è—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        '''
–°—á–∏—Ç–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ (–∫–∞–∫ –¥–ª–∏–Ω—É –≤–µ–∫—Ç–æ—Ä–∞).
–ò –µ—â—ë —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –µ–≥–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç progress, —Ç–∏–ø–∞ –≤—Å—ë –≤—Ä–µ–º—è –¥–∞–ª—å—à–µ —Ç—è–Ω–µ—Ç—Å—è.
        '''
        r = np.sqrt(dx**2 + dy**2) * (1 + progress)
        '''
–≠—Ç–æ —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è ‚Äî –∫—É–¥–∞ –æ–Ω —Å–º–æ—Ç—Ä–∏—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞
        '''
        theta = np.arctan2(dy, dx)
        '''
–ê –≤–æ—Ç —Ç—É—Ç –¥–≤–∏–∂—É—Ö–∞: –∫–∞–∂–¥–æ–º—É —É–≥–ª—É –º—ã –ø–æ–¥–∫–∏–¥—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ,
—á—Ç–æ–± –æ–Ω–æ –∑–∞–∫—Ä—É—á–∏–≤–∞–ª–æ—Å—å –≤ —Å–ø–∏—Ä–∞–ª—å.
–ï—Å–ª–∏ —Ä–∞–¥–∏—É—Å (r) –Ω–µ –Ω–æ–ª—å, –¥–æ–±–∞–≤–ª—è–µ–º –∫ —É–≥–ª—É —à—Ç—É–∫—É, –∑–∞–≤–∏—Å—è—â—É—é –æ—Ç –≤—Ä–µ–º–µ–Ω–∏.
–í –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫–æ–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –∑–∞–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ.
        '''
        theta += np.where(r != 0, progress * 10 * np.pi / r, 0)

        # –ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ –ø–æ–ª—è—Ä–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –æ–±—ã—á–Ω—ã–µ.
–ë–µ—Ä—ë–º –Ω–æ–≤—ã–π X –∏ Y –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è,
–æ–∫—Ä—É–≥–ª—è–µ–º –∏—Ö –∏ –¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–± –æ–Ω–∏ –Ω–µ –≤—ã–≤–∞–ª–∏–≤–∞–ª–∏—Å—å –∑–∞ –∫—Ä–∞—è (–ø–æ –º–æ–¥—É–ª—é %).
        '''
        src_x = (center_x + r * np.cos(theta)).astype(np.int32) % w
        src_y = (center_y + r * np.sin(theta)).astype(np.int32) % h

        # –ë–µ—Ä—ë–º –ø–∏–∫—Å–µ–ª–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        '''
–¢–µ–ø–µ—Ä—å –±–µ—Ä—ë–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º –ø–∏–∫—Å–µ–ª–∏ –ø–æ –Ω–æ–≤—ã–º –∞–¥—Ä–µ—Å–∞–º.
–¢–∏–ø–∞ –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å –≤—Å—Ç–∞–ª –Ω–µ –Ω–∞ —Å–≤–æ—ë –º–µ—Å—Ç–æ, –∞ –Ω–∞ –∑–∞–∫—Ä—É—á–µ–Ω–Ω–æ–µ.
        '''
        new_frame = frame[src_y, src_x]

        return new_frame

    '''
–û—Ñ–æ—Ä–º–ª—è–µ–º –¥–≤–∏–∂—É—Ö—É: —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –º—É—Ç–∏—Ç —Å –∫–∞–¥—Ä–æ–º —Ç–∞–∫—É—é —Ç–µ–º—É,
–±—É–¥—Ç–æ —Ç—ã –ø–æ–ø–∞–ª –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç –∏–∑ –∑–µ—Ä–∫–∞–ª.
    '''
    def mirror_maze(self, frame, t, duration):
        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ –æ—Ç –Ω–∞—á–∞–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞.
–¢–∏–ø–∞ –µ—Å–ª–∏ –≤—Å—è —Ö–æ–¥–∫–∞ (duration) ‚Äî 5 –ª–µ—Ç, –∞ –æ—Ç—Å–∏–¥–µ–ª —É–∂–µ 2 (t), —Ç–æ progress = 0.4
        '''
        progress = t / duration
        h, w = frame.shape[:2]
        '''
–î–µ–ª–∞–µ–º –∫–æ–ø–∏—é –∫–∞–¥—Ä–∞, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—É–¥–∞ –º—É—Ç–∏—Ç—å –æ—Ç—Ä–∞–∂–µ–Ω–∏—è.
–û—Ä–∏–≥–∏–Ω–∞–ª –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –∫–∞–∫ ¬´–æ–±—â–∞–∫¬ª ‚Äî —Å–≤—è—Ç–æ–µ.
        '''
        new_frame = frame.copy()
        '''
–û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –∑–µ—Ä–∫–∞–ª. –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –±–æ–ª—å—à–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–π.
–¢–∏–ø–∞ —Å–Ω–∞—á–∞–ª–∞ 2 –∑–µ—Ä–∫–∞–ª–∞, –ø–æ—Ç–æ–º 3, –ø–æ—Ç–æ–º 4, –∏ —Ç–∞–∫ –¥–æ 6.
        '''
        num_mirrors = int(2 + progress * 4)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        '''
–ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–µ—Ä–∫–∞–ª–∞ –º—É—Ç–∏–º –∫–æ–ø–∏—é –∫–∞–¥—Ä–∞.
        '''
        for i in range(1, num_mirrors):
            '''
–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–º–µ–Ω—å—à–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É.
–ß–µ–º –±–æ–ª—å—à–µ i (–Ω–æ–º–µ—Ä –∑–µ—Ä–∫–∞–ª–∞), —Ç–µ–º –º–µ–Ω—å—à–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞.
–¢–∏–ø–∞ –¥–∞–ª—å–Ω–∏–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –º–µ–ª–∫–∏–º–∏.
            '''
            scale = 1 - i * 0.1 * progress
            '''
–°–æ–∑–¥–∞—ë–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–∞–¥—Ä–∞.
            '''
            small = cv2.resize(frame, (int(w * scale), int(h * scale)))
            '''
–°–¥–≤–∏–≥–∞–µ–º –∫–æ–ø–∏—é —á—É—Ç—å –≤ —Å—Ç–æ—Ä–æ–Ω—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.
–ß–µ–º –±–æ–ª—å—à–µ i –∏ progress, —Ç–µ–º –¥–∞–ª—å—à–µ —ç—Ç–∞ –∫–æ–ø–∏—è —É–µ–∑–∂–∞–µ—Ç.
            '''
            offset = int(i * 20 * progress)
            '''
–°—Ç–∞–≤–∏–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª —Å —É—á—ë—Ç–æ–º —Å–¥–≤–∏–≥–∞ (offset).
            '''
            new_frame[offset:offset+small.shape[0], offset:offset+small.shape[1]] = small
            '''
–î–µ–ª–∞–µ–º –∑–µ—Ä–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ (–ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏).
–¢–∏–ø–∞ –∫–∞–∫ –±—É–¥—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å –≤ –∑–µ—Ä–∫–∞–ª–æ.
            '''
            flipped = cv2.flip(small, 1)  # –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ
            '''
–°—Ç–∞–≤–∏–º –∑–µ—Ä–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –≤ –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å –∫–∞–¥—Ä–∞.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç –∫–æ—Ä–∏–¥–æ—Ä–∞ –∏–∑ –∑–µ—Ä–∫–∞–ª:
—Å–ª–µ–≤–∞ –æ–±—ã—á–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ, —Å–ø—Ä–∞–≤–∞ ‚Äî –∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ.
            '''
            new_frame[offset:offset+small.shape[0], w - offset - small.shape[1]:w - offset] = flipped
            '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä, –≥–¥–µ —Ç—ã —É–∂–µ –≤ ¬´–∑–µ—Ä–∫–∞–ª—å–Ω–æ–º –ª–∞–±–∏—Ä–∏–Ω—Ç–µ¬ª.
            '''
        return new_frame

    '''
–û—Ñ–æ—Ä–º–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é: –±–µ—Ä—ë–º –∫–∞–¥—Ä –∏ –¥–µ–ª–∞–µ–º –∏–∑ –Ω–µ–≥–æ –≥–ª—é–∫-–∞–Ω–∏–º–∞—Ü–∏—é,
–∫–∞–∫ –±—É–¥—Ç–æ —Ç–µ–ª–µ–∫ —á–µ—Ä–µ–∑ —Ñ–æ–ª—å–≥—É —Å–º–æ—Ç—Ä–∏—à—å –∏–ª–∏ –∫–∞—Å—Å–µ—Ç–∞ –ø–µ—Ä–µ–º–æ—Ç–∞–ª–∞—Å—å.
max_shift = 20 ‚Äî —ç—Ç–æ —Ç–∏–ø–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª–µ–π.
    '''
    def glitch_art(self, frame, t, duration, max_shift=20):
            # –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1
            progress = float(np.clip(t / float(duration), 0.0, 1.0))

            new_frame = frame.copy()
            h, w = new_frame.shape[:2]

            # –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ (–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Ö–æ—Ç—è –±—ã –Ω–µ–±–æ–ª—å—à–æ–π —ç—Ñ—Ñ–µ–∫—Ç)
            '''
–°—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å –ø–∏–∫—Å–µ–ª–∏.
–í –Ω–∞—á–∞–ª–µ (–º–∞–ª—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å) ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –º–∞–ª–µ–Ω—å–∫–æ–µ,
–¥–∞–ª—å—à–µ –æ–Ω–æ —Ä–∞—Å—Ç—ë—Ç, —ç—Ñ—Ñ–µ–∫—Ç –∂—ë—Å—Ç—á–µ.
            '''
            shift = max(1, int(max_shift * (0.15 + 0.85 * progress)))

            # 1) –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è: —Ä–∞–∑–Ω—ã–µ —Å–¥–≤–∏–≥–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
            '''
–†–∞–∑–¥–µ–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫–∞–Ω–∞–ª—ã: —Å–∏–Ω–∏–π (b), –∑–µ–ª—ë–Ω—ã–π (g), –∫—Ä–∞—Å–Ω—ã–π (r).
            '''
            b, g, r = cv2.split(new_frame)
            '''
–î–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ-—Ä–∞–∑–Ω–æ–º—É: –∫–∞–∂–¥—ã–π —É–µ–∑–∂–∞–µ—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—É —Å–ª—É—á–∞–π–Ω–æ.
–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç ¬´—Ä–∞—Å—Ö–æ–¥—è—â–∏—Ö—Å—è —Ü–≤–µ—Ç–æ–≤¬ª,
–∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö VHS –∫–∞—Å—Å–µ—Ç–∞—Ö.
            '''
            b = np.roll(b, int(random.uniform(-shift, shift)), axis=1)
            g = np.roll(g, int(random.uniform(-shift//2, shift//2)), axis=1)
            r = np.roll(r, int(random.uniform(-shift, shift)), axis=1)
            '''
–°–∫–ª–µ–∏–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ü–≤–µ—Ç–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É. –¢–µ–ø–µ—Ä—å –æ–Ω–∞ —É–∂–µ —Å ¬´—Ä–∞—Å—Ñ–æ–∫—É—Å–æ–º¬ª.
            '''
            new_frame = cv2.merge([b, g, r])

            # 2) –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã ‚Äî —Å–¥–≤–∏–≥–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ª–æ—Å—ã –ø–æ X
            '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –≥–ª—é–∫-–ø–æ–ª–æ—Å. –ß–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ–ª–æ—Å.
            '''
            num_bands = 1 + int(progress * 6)  # –æ—Ç 1 –¥–æ ~7 –ø–æ–ª–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            '''
–í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–ª–æ—Å–∫—É –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (band_h), –≥–¥–µ –±—É–¥–µ–º –≥–ª—é—á–∏—Ç—å.
–û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ—ë —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Ç–æ—á–∫—É (y).
–ò —Ä–µ—à–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–º–µ—Å—Ç–∏—Ç—å –µ—ë –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (shift_x).
            '''
            for _ in range(num_bands):
                band_h = random.randint(1, max(1, int(h * 0.06)))
                y = random.randint(0, max(0, h - band_h))
                shift_x = random.randint(-shift, shift)
                '''
–ï—Å–ª–∏ —Å–¥–≤–∏–≥ –µ—Å—Ç—å ‚Äî –∫—Ä—É—Ç–∏–º —ç—Ç—É –ø–æ–ª–æ—Å–∫—É –≤–ª–µ–≤–æ –∏–ª–∏ –≤–ø—Ä–∞–≤–æ.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç, –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ä–≤—ë—Ç—Å—è –Ω–∞ –∫—É—Å–∫–∏.
                '''
                if shift_x != 0:
                    new_frame[y:y + band_h] = np.roll(new_frame[y:y + band_h], shift_x, axis=1)

            # 3) –ë–ª–æ–∫–æ–≤—ã–µ –≥–ª–∏—Ç—á–∏:
            #–∫–æ–ø–∏—Ä—É–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Å–º–µ—â—ë–Ω–Ω—ã–º–∏
            '''
–∑–∞–ø—É—Å–∫–∞–µ–º –µ—â—ë –æ–¥–∏–Ω —ç—Ñ—Ñ–µ–∫—Ç: –±–ª–æ—á–Ω—ã–µ –≥–ª—é–∫–∏.
            '''
            if random.random() < 0.8 * progress:
                '''
–ß–µ–º –¥–∞–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –±–æ–ª—å—à–µ –±–ª–æ–∫–æ–≤-–æ–±—Ä—ã–≤–∫–æ–≤ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–æ.
                '''
                blocks = 1 + int(4 * progress)
                '''
–í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫—É—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–º–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫).
bw ‚Äî —à–∏—Ä–∏–Ω–∞ –±–ª–æ–∫–∞, bh ‚Äî –≤—ã—Å–æ—Ç–∞, x/y ‚Äî –µ–≥–æ –º–µ—Å—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
                '''
                for _ in range(blocks):
                    bw = random.randint(8, max(8, int(w * 0.18)))
                    bh = random.randint(2, max(2, int(h * 0.12)))
                    x = random.randint(0, max(0, w - bw))
                    y = random.randint(0, max(0, h - bh))
                    '''
–ë–µ—Ä—ë–º —ç—Ç–æ—Ç –∫—É—Å–æ–∫, –¥–≤–∏–≥–∞–µ–º –µ–≥–æ –≤ —Å—Ç–æ—Ä–æ–Ω—É (dx),
–∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ (nx).
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç ¬´–≥–ª—é—á–∞—â–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤¬ª.
                    '''
                    dx = random.randint(-shift, shift)
                    nx = np.clip(x + dx, 0, w - bw)
                    patch = new_frame[y:y + bh, x:x + bw].copy()
                    new_frame[y:y + bh, nx:nx + bw] = patch

            # 4) –°–∫–∞–Ω–ª–∞–π–Ω—ã (—Ç–æ–Ω–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏)
            '''
–†–∏—Å—É–µ–º —Ç–∞–∫–∏–µ —Ç–æ–Ω–∫–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ (–∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∞—Ö).
–ß–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —Ç–µ–º–Ω–µ–µ –ø–æ–ª–æ—Å–∫–∏.
            '''
            line_dark = int(18 * progress)
            '''
–ë–µ—Ä—ë–º –∫–∞–∂–¥—É—é –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ—á–∫—É –ø–∏–∫—Å–µ–ª–µ–π –∏ –∑–∞—Ç–µ–º–Ω—è–µ–º –µ—ë.
–°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ int16,
—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è¬ª,
–ø–æ—Ç–æ–º –æ–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω (0‚Äì255).
            '''
            if line_dark > 0:
                # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å int16, –∑–∞—Ç–µ–º –æ–±—Ä–µ–∑–∞—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å wrap-around
                tmp = new_frame[::2].astype(np.int16) - line_dark
                new_frame[::2] = np.clip(tmp, 0, 255).astype(np.uint8)

            # 5) –®—É–º ‚Äî –∞–¥–¥–∏—Ç–∏–≤–Ω–æ —Å saturating add, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ wrap-around
            '''
–î–æ–±–∞–≤–ª—è–µ–º —à—É–º. –ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –æ–Ω –ª–µ–∑–µ—Ç.
            '''
            noise_amp = int(28 * progress)  # –∞–º–ø–ª–∏—Ç—É–¥–∞ —à—É–º–∞
            '''
–°–æ–∑–¥–∞—ë–º —Å–ª—É—á–∞–π–Ω—ã–π —à—É–º (—Ä–∞–Ω–¥–æ–º–Ω—ã–µ —Ç–æ—á–∫–∏),
—Ä–∞–∑–º–Ω–æ–∂–∞–µ–º –µ–≥–æ –Ω–∞ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ.
–ò—Å–ø–æ–ª—å–∑—É–µ–º cv2.add, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è ‚Äî –≤–º–µ—Å—Ç–æ —É—Ö–æ–¥–∞ –≤ –º–∏–Ω—É—Å,
–∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏–∂–∏–º–∞—é—Ç—Å—è –∫ –º–∞–∫—Å–∏–º—É–º—É.
            '''
            if noise_amp > 0:
                noise = np.random.randint(0, noise_amp, (h, w, 1), dtype=np.uint8)
                noise = np.repeat(noise, 3, axis=2)
                new_frame = cv2.add(new_frame, noise)  # cv2.add ‚Äî saturating

                '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä: –≥–ª—é–∫–∏, –ø–æ–ª–æ—Å—ã, —à—É–º,
–≤—Å—ë –≤–º–µ—Å—Ç–µ ‚Äî —á–∏—Å—Ç–æ –∞—Ä—Ç–æ–≤—ã–π —Ö–∞–æ—Å,
–±—É–¥—Ç–æ —Ç–µ–ª–µ–∫ —Å –∞–Ω—Ç–µ–Ω–Ω—ã –ª–æ–≤–∏—Ç ¬´–†–ï–ù-–¢–í¬ª —á–µ—Ä–µ–∑ –Ω–æ—Å–æ–∫ –Ω–∞ –±–∞–ª–∫–æ–Ω–µ.
                '''
            return new_frame

    def fire_burst(self, frame, t, duration):
        progress = float(np.clip(t / duration, 0.0, 1.0))
        '''
–£—Å–∏–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: –≤ –¥–≤–∞ —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç—ë—Ç.
–ß—Ç–æ–±—ã ¬´–æ–≥–æ–Ω—å¬ª –±—ã—Å—Ç—Ä–µ–µ –≤–∫–ª—é—á–∞–ª—Å—è.
        '''
        eff = float(np.clip(progress * 2.0, 0.0, 1.0))
        '''
–ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –ø–æ—á—Ç–∏ –Ω–µ –≤–∫–ª—é—á–∏–ª—Å—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª.
–¢–∏–ø–∞ ¬´–æ–≥–Ω—è –ø–æ–∫–∞ –Ω–µ—Ç¬ª.
        '''
        if eff < 0.02:
            return frame

        h, w = frame.shape[:2]
        '''
–í—ã—á–∏—Å–ª—è–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ–≥–Ω—è.
–ú—è–≥–∫–æ –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç (—á–µ—Ä–µ–∑ —Å—Ç–µ–ø–µ–Ω—å).
        '''
        intensity = eff ** 0.9
        '''
–û–±—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ¬´–º–æ—â–Ω–æ—Å—Ç–∏ –ø–æ–∂–∞—Ä–∞¬ª. –ß–µ–º –≤—ã—à–µ intensity,
—Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.
        '''
        global_strength = 0.9 + 1.5 * intensity

        '''
–î–µ–ª–∞–µ–º —Å–∏–¥ –¥–ª—è —Ä–∞–Ω–¥–æ–º–∞, –∑–∞–≤—è–∑–∞–Ω–Ω—ã–π –Ω–∞ –≤—Ä–µ–º—è t.
–ß—Ç–æ–±—ã —à—É–º –±—ã–ª —Å–ª—É—á–∞–π–Ω—ã–π, –Ω–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞.
        '''
        seed = int(t * 1000) & 0xFFFFFFFF
        rng = np.random.RandomState(seed)

        '''
–°–æ–∑–¥–∞—ë–º —à—É–º —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º (–≥–∞—É—Å—Å–æ–≤—Å–∫–∏–π).
–≠—Ç–æ –æ—Å–Ω–æ–≤–∞ ¬´–ø–æ–º–µ—Ö¬ª –∏ ¬´–∏—Å–∫—Ä¬ª.
        '''
        noise_sigma = 80.0 * global_strength
        base_noise = rng.normal(0.0, noise_sigma, size=(h, w)).astype(np.float32)

        '''
–î–µ–ª–∞–µ–º ¬´—Å–∫—Ä—É—á–µ–Ω–Ω—ã–π —à—É–º¬ª:
‚Äî –ø–æ —Å—Ç—Ä–æ–∫–∞–º —Å–∏–Ω—É—Å–æ–º —Å–¥–≤–∏–≥–∞–µ–º –ø–∏–∫—Å–µ–ª–∏,
‚Äî –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ-—Å–≤–æ–µ–º—É –µ–¥–µ—Ç –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ,
‚Äî –ø–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç ¬´–¥—Ä–æ–∂–∞—â–µ–≥–æ –æ–≥–Ω—è¬ª.
        '''
        rows = np.arange(h)
        roll_amp = int(38 * global_strength)
        roll = (np.sin(rows * 0.12 + t * 5.0) * roll_amp).astype(np.int32)
        x_idx = (np.arange(w)[None, :] - roll[:, None]) % w
        rolled_noise = base_noise[np.arange(h)[:, None], x_idx]

        '''
–ò–º–∏—Ç–∏—Ä—É–µ–º ¬´–ø—Ä–æ–≤–∞–ª—ã¬ª —Å—Ç—Ä–æ–∫ ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–≥–æ—Ä–∞—é—Ç.
–¢–∏–ø–∞ –≤ –æ–≥–Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—É—Å—Ç–æ—Ç—ã –∏ —Ä–≤–∞–Ω—ã–µ –¥—ã—Ä—ã.
        '''
        dropout_prob = 0.03 + 0.28 * intensity
        rnd_rows = rng.rand(h)
        dropout_mask = (rnd_rows < dropout_prob).astype(np.float32)[:, None]
        dropout_depth = (0.25 + 0.70 * rng.rand(h) * intensity)[:, None].astype(np.float32)
        rolled_noise *= (1.0 - dropout_mask * dropout_depth)

        '''
–î–æ–±–∞–≤–ª—è–µ–º ¬´—Å–∫–∞–Ω–ª–∞–π–Ω—ã¬ª ‚Äî —Ç—ë–º–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å—Ç—Ä–æ–∫—É.
–û–≥–æ–Ω—å –∫–∞–∫ –±—É–¥—Ç–æ –º–µ—Ä—Ü–∞–µ—Ç.
        '''
        scan_strength = 0.65 * intensity
        scan = 1.0 - scan_strength * ((rows % 2)[:, None].astype(np.float32))
        rolled_noise *= scan

        '''
–§–æ—Ä–º–∏—Ä—É–µ–º —Ü–≤–µ—Ç –ø–ª–∞–º–µ–Ω–∏:
‚Äî —Å–∏–Ω–∏–π –ø–æ—á—Ç–∏ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç,
‚Äî –∑–µ–ª—ë–Ω—ã–π —Å—Ä–µ–¥–Ω–∏–π.
        '''
        noise_b = rolled_noise * 0.45
        noise_g = rolled_noise * 0.9
        '''
–ö—Ä–∞—Å–Ω—ã–π –∫–∞–Ω–∞–ª –≤–µ–¥—ë—Ç —Å–µ–±—è –æ—Ç–¥–µ–ª—å–Ω–æ:
‚Äî –µ–≥–æ —Å–º–µ—â–∞–µ–º —Å–∏–ª—å–Ω–µ–µ,
‚Äî –æ–Ω —è—Ä—á–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.
–í –∏—Ç–æ–≥–µ –≤–µ—Å—å —ç—Ñ—Ñ–µ–∫—Ç —Ç—è–Ω–µ—Ç –≤ –∫—Ä–∞—Å–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—É—é –≥–∞–º–º—É, –∫–∞–∫ –ø–ª–∞–º—è.
        '''
        shift_r = (np.sin(rows * 0.08 + t * 3.2) * (6.0 * global_strength)).astype(np.int32)
        x_idx_r = (np.arange(w)[None, :] - shift_r[:, None]) % w
        noise_r = base_noise[np.arange(h)[:, None], x_idx_r].astype(np.float32) * 1.35
        noise_r *= (1.0 - dropout_mask * dropout_depth) * scan

        '''
–°–æ–±–∏—Ä–∞–µ–º —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ (BGR) –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ü–≤–µ—Ç–Ω–æ–µ —à—É–º–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
        '''
        noise_rgb = np.stack([noise_b, noise_g, noise_r], axis=2)

        '''
–î–µ–ª–∞–µ–º ¬´–º–∏–≥–∞–Ω–∏–µ –æ–≥–Ω—è¬ª:
‚Äî —Å–æ–∑–¥–∞—ë–º –º–∞–ª–µ–Ω—å–∫—É—é –º–∞—Ç—Ä–∏—Ü—É —à—É–º–∞,
‚Äî —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –µ—ë –±–ª–æ–∫–∞–º–∏ –Ω–∞ –≤–µ—Å—å –∫–∞–¥—Ä,
‚Äî –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∫—Ä—É–ø–Ω–æ–∑–µ—Ä–Ω–∏—Å—Ç–æ–µ –º–µ—Ä—Ü–∞–Ω–∏–µ, –±—É–¥—Ç–æ –ø–ª–∞–º—è –¥—ã—à–∏—Ç.
        '''
        block_h = max(4, h // 36)
        block_w = max(4, w // 56)
        bh = (h + block_h - 1) // block_h
        bw = (w + block_w - 1) // block_w
        small = rng.rand(bh, bw).astype(np.float32) - 0.5
        flicker = np.repeat(np.repeat(small, block_h, axis=0)[:h, :], block_w, axis=1)[:h, :w]
        flicker = 1.0 + flicker * (0.5 * global_strength)
        flicker = flicker[..., None]  # shape (h,w,1), –±—É–¥–µ—Ç broadcast –ø–æ –∫–∞–Ω–∞–ª–∞–º

        '''
–ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —à—É–º –ø–æ–≤–µ—Ä—Ö –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞–¥—Ä–∞.
–¢–∏–ø–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —É–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç ¬´–≥–æ—Ä–µ—Ç—å¬ª.
        '''
        frame_f = frame.astype(np.float32)
        overlay_strength = 1.05 * global_strength
        noisy_overlay = frame_f + noise_rgb * (0.95 * intensity) * overlay_strength

        # –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: intensity ‚Äî —Å–∫–∞–ª—è—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–ø—Ä—è–º—É—é (broadcast –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        '''
–¢—É—à–∏–º —á–∞—Å—Ç—å —è—Ä–∫–æ—Å—Ç–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –º–µ—Ä—Ü–∞–Ω–∏—è (flicker).
–¢–µ–ø–µ—Ä—å –æ–≥–æ–Ω—å ¬´–ø—É–ª—å—Å–∏—Ä—É–µ—Ç¬ª.
        '''
        noisy_overlay = noisy_overlay * (1.0 - 0.7 * intensity)
        noisy_overlay = noisy_overlay * (1.0 - 0.9 * intensity) + noisy_overlay * (0.9 * intensity) * flicker

        '''
–ö–æ–≥–¥–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Ö–æ–¥–∏—Ç –ø–æ—á—Ç–∏ –¥–æ –∫–æ–Ω—Ü–∞ (92%),
–∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è –æ–≥–Ω—ë–º.
cover ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç–∫—Ä–∞–Ω —É–∂–µ —Å–≥–æ—Ä–µ–ª.
        '''
        cover_start = 0.92
        if progress <= cover_start:
            cover = 0.0
        else:
            c = (progress - cover_start) / (1.0 - cover_start + 1e-6)
            cover = float(np.clip(c ** 2.0, 0.0, 1.0))
        
        '''
–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è: –≤—Å—ë –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è ¬´—á–∏—Å—Ç—ã–º –æ–≥–Ω—ë–º¬ª.
‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —à—É–º–æ–≤–æ–µ –∫—Ä–∞—Å–Ω–æ-–∂—ë–ª—Ç–æ–µ –ø–æ–ª–µ (pure_noise),
‚Äî –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ–º –∫–∞–¥—Ä –∏–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ.
–í –∏—Ç–æ–≥–µ –∫ –∫–æ–Ω—Ü—É —ç–∫—Ä–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–ª–∞–º–µ–Ω–µ–º.
        '''
        if cover > 0.0:
            pure_sigma = 100.0 * global_strength
            pure_base = rng.normal(127.0, pure_sigma, size=(h, w)).astype(np.float32)
            pure_b = pure_base * 0.5 + 80.0
            pure_g = pure_base * 0.9 + 50.0
            pure_r = pure_base * 1.1 + 40.0
            pure_noise = np.stack([pure_b, pure_g, pure_r], axis=2)
            gs = (np.sin(rows * 0.11 + t * 7.0) * 3.0).astype(np.int32)
            x_idx_end = (np.arange(w)[None, :] - gs[:, None]) % w
            pure_noise[..., 2] = pure_noise[np.arange(h)[:, None], x_idx_end, 2]
            out = noisy_overlay * (1.0 - cover) + pure_noise * cover
            '''
–ï—Å–ª–∏ –µ—â—ë –Ω–µ –¥–æ—à–ª–æ –¥–æ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
            '''
        else:
            out = noisy_overlay
            '''
–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞:
‚Äî —É–±–∞–≤–ª—è–µ–º —Å–∏–Ω–∏–π –∏ –∑–µ–ª—ë–Ω—ã–π,
‚Äî —É—Å–∏–ª–∏–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π.
–ß—Ç–æ–±—ã –ø–ª–∞–º—è –±—ã–ª–æ –Ω–∞—Å—Ç–æ—è—â–∏–º, –∞ –Ω–µ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º.
            '''
        out[..., 0] *= 1.0 - (0.06 * intensity)
        out[..., 1] *= 1.0 - (0.03 * intensity)
        out[..., 2] *= 1.0 + (0.08 * intensity)
        '''
–û–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ—Ç–µ–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã (0‚Äì255).
        '''
        np.clip(out, 0, 255, out=out)
        return out.astype(np.uint8)


    def water_ripple(self, frame, t, duration):
        H, W = frame.shape[:2]
        '''
–ü—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∫–µ—à ‚Äî —á—Ç–æ–±
–∑–∞–Ω–æ–≤–æ –Ω–µ —Å—á–∏—Ç–∞—Ç—å —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑.
–ï—Å–ª–∏ –Ω–µ—Ç, –≤–µ—Ä–Ω—ë—Ç None.
        '''
        cache = getattr(self, "_ripple_cache_cv", None)
        '''
–ï—Å–ª–∏ –∫–µ—à–∞ –Ω–µ—Ç –∏–ª–∏ —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ–º–µ–Ω—è–ª—Å—è ‚Äî –Ω–∞–¥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å.
        '''
        if cache is None or cache.get("shape") != (H, W):
            '''
–°–æ–∑–¥–∞—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ X –∏ Y:
‚Äî xs —ç—Ç–æ —Ä—è–¥ –æ—Ç 0 –¥–æ W (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å),
‚Äî ys —ç—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç 0 –¥–æ H (–≤–µ—Ä—Ç–∏–∫–∞–ª—å).
            '''
            xs = np.arange(W, dtype=np.float32)[None, :]
            ys = np.arange(H, dtype=np.float32)[:, None]
            '''
–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë –≤ –∫–µ—à, —á—Ç–æ–± –ø–æ—Ç–æ–º –Ω–µ –ø–∞—Ä–∏—Ç—å—Å—è.
            '''
            self._ripple_cache_cv = {"shape": (H, W), "xs": xs, "ys": ys}
            cache = self._ripple_cache_cv
        '''
–ë–µ—Ä—ë–º –∏–∑ –∫–µ—à–∞ –≥–æ—Ç–æ–≤—ã–µ —Å–µ—Ç–∫–∏ X –∏ Y.
        '''
        xs = cache["xs"]; ys = cache["ys"]

        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ.
–ï—Å–ª–∏ duration = 0, —Ç–æ —Å—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å 1 (—á—Ç–æ–± –Ω–µ –¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–æ–ª—å).
        '''
        progress = float(t) / float(duration) if duration != 0 else 1.0
        progress = np.clip(progress, 0.0, 1.0)
        '''
–ê–º–ø–ª–∏—Ç—É–¥–∞ –∫–æ–ª–µ–±–∞–Ω–∏–π: —á–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ä—è–±—å.
        '''
        amplitude = 20.0 * progress
        '''
–§–∞–∑–∞ –∫–æ–ª–µ–±–∞–Ω–∏–π ‚Äî —Ç–∏–ø–∞ —É–≥–æ–ª –≤–æ–ª–Ω—ã.
–ß–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º –≤–æ–ª–Ω—ã —Å–∏–ª—å–Ω–µ–µ –≥—É–ª—è—é—Ç.
        '''
        phi = float(t) * 5.0

        '''
–°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏—è –ø–æ X:
–±–µ—Ä—ë–º —Å–∏–Ω—É—Å, –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç —Å—Ç—Ä–æ–∫–∏ (ys).
–¢–æ –µ—Å—Ç—å –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–æ–ª—ã—à–µ—Ç—Å—è, –∫–∞–∫ –≤–æ–ª–Ω–∞.
        '''
        offset_x = amplitude * np.sin(phi + 0.05 * ys)
        '''
–°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏—è –ø–æ Y:
–±–µ—Ä—ë–º –∫–æ—Å–∏–Ω—É—Å, –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç —Å—Ç–æ–ª–±—Ü–∞ (xs).
–¢–æ –µ—Å—Ç—å –∫–∞–∂–¥—ã–π —Å—Ç–æ–ª–±–µ—Ü —Ç–æ–∂–µ –∫–æ–ª—ã—à–µ—Ç—Å—è.
        '''
        offset_y = amplitude * np.cos(phi + 0.05 * xs)
        '''
–î–µ–ª–∞–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:
–∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å —Å–º–µ—â–∞–µ–º –Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –æ—Ñ—Å–µ—Ç—ã.
        '''
        map_x = (xs + offset_x).astype(np.float32)  # (H, W)
        map_y = (ys + offset_y).astype(np.float32)

        # remap –æ–∂–∏–¥–∞–µ—Ç map_x/map_y —Ñ–æ—Ä–º–∞—Ç–∞ (H, W) float32
        # cv2.remap: dst(y,x) = src(map_y(y,x), map_x(y,x))
        '''
–ò—Å–ø–æ–ª—å–∑—É–µ–º cv2.remap:
–±–µ—Ä—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–∞–¥—Ä –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ø–∏–∫—Å–µ–ª–∏ –ø–æ –Ω–æ–≤—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º.
BORDER_REFLECT –∑–Ω–∞—á–∏—Ç: –µ—Å–ª–∏ –≤—ã–ª–µ–∑ –∑–∞ –∫—Ä–∞–π ‚Äî –æ—Ç—Ä–∞–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É,
–∫–∞–∫ –∑–µ—Ä–∫–∞–ª–æ –ø–æ –≥—Ä–∞–Ω–∏—Ü–µ.
–í –∏—Ç–æ–≥–µ –≤—ã—Ö–æ–¥–∏—Ç —Ä—è–±—å ‚Äî –±—É–¥—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É —á–µ—Ä–µ–∑ –≤–æ–¥—É.
        '''
        return cv2.remap(frame, map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

    def pixel_rain(self, frame, t, duration):

        h, w = frame.shape[:2]
        progress = float(np.clip(t / duration, 0.0, 1.0))

        '''
üëâ –°–æ–∑–¥–∞—ë–º —Ä–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä, –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–± –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä –∏–º–µ–ª —Å–≤–æ–∏ —Å–ª—É—á–∞–π–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
        '''
        rng = np.random.RandomState(int(t * 1000) % 100000)

        # –ö–æ–ª–æ–Ω–∫–∏ —Å —Ä–∞–∑–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
        '''
–ö–æ—Ä–æ—á–µ —Ç—É—Ç –º—ã –º–æ–¥–µ–ª–∏—Ä—É–µ–º —Ä–∞–∑–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ (—Ç–∏–ø–∞ –ø–∏–∫—Å–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∏ –¥–æ–∂–¥—è).

base_speed ‚Äî –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, —á–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ.

noise_col ‚Äî —à—É–º –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏, —á—Ç–æ–± –≤—Å—ë –±—ã–ª–æ —Ö–∞–æ—Ç–∏—á–Ω–æ.

offsets ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏.
        '''
        base_speed = 6 + int(90 * progress)
        noise_col = rng.rand(w).astype(np.float32)
        offsets = (base_speed * (0.35 + 0.9 * noise_col)).astype(int)

        # –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π roll –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º
        '''
–¢—É—Ç –º—É—Ç–∏–º "—Å–¥–≤–∏–≥ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏".

rows_idx –≥–æ–≤–æ—Ä–∏—Ç –∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ –±—Ä–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏, —Ç–∏–ø–∞ —Å–¥–≤–∏–≥–∞–µ–º –≤–Ω–∏–∑.

rolled ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π –∫–∞–¥—Ä –ø–æ—Å–ª–µ —ç—Ç–∏—Ö —Å–¥–≤–∏–≥–æ–≤: –∫–æ–ª–æ–Ω–∫–∏ –ø–∞–¥–∞—é—Ç –≤–Ω–∏–∑ –∫–∞–∫ –¥–æ–∂–¥—å.
        '''
        rows_idx = (np.arange(h)[:, None] - offsets[None, :]) % h
        rolled = np.take_along_axis(frame, rows_idx[:, :, None], axis=0)

        # Motion trails: —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤–µ—Å
        '''
–ó–¥–µ—Å—å –º—ã –¥–µ–ª–∞–µ–º –∑–∞—Ç—É—Ö–∞–Ω–∏–µ (—à–ª–µ–π—Ñ –∑–∞ –∫–∞–ø–ª—è–º–∏).

trail_len ‚Äî –¥–ª–∏–Ω–∞ —Å–ª–µ–¥–∞ (—á–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º –¥–ª–∏–Ω–Ω–µ–µ).

decay ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —É–±—ã–≤–∞–Ω–∏—è —è—Ä–∫–æ—Å—Ç–∏, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —á—Ç–æ–± —Å—É–º–º–∞ = 1.
        '''
        trail_len = 1 + int(20 * progress)
        decay = np.exp(-np.linspace(0.0, 3.0, trail_len)).astype(np.float32)
        decay = decay / decay.sum()  # —Å—É–º–º—ã 1

        '''
üëâ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ float32, —á—Ç–æ–± —É–º–Ω–æ–∂–∞—Ç—å –∏ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
        '''
        rolled_f = rolled.astype(np.float32)

        # –í–º–µ—Å—Ç–æ cv2.filter2D ‚Äî —Å—É–º–º–∏—Ä—É–µ–º —Å–¥–≤–∏–Ω—É—Ç—ã–µ –∫–æ–ø–∏–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å wrap)
        # –≠—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é —Å–≤–µ—Ä—Ç–∫—É —Å kernel=(decay,1)
        '''
–¢—É—Ç —Ä—É–∫–∞–º–∏ –¥–µ–ª–∞–µ–º —Ç–∏–ø–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ –≤–Ω–∏–∑.
–ë–µ—Ä—ë–º –∫–æ–ø–∏–∏ –∫–∞–¥—Ä–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–º–µ—â–µ–Ω–∏—è–º–∏ –∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∏—Ö —Å –≤–µ—Å–∞–º–∏ (decay).
–¢–∞–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫—Ä–∞—Å–∏–≤—ã–π —à–ª–µ–π—Ñ.
        '''
        trailed_f = np.zeros_like(rolled_f)
        # –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–¥–≤–∏–≥–∏: weight * np.roll(rolled_f, shift=k, axis=0)
        for k, wgt in enumerate(decay):
            if wgt == 0.0:
                continue
            # —Å–¥–≤–∏–≥: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π k —Å–¥–≤–∏–≥–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω–∏–∑ ‚Äî –ø–æ–¥–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–∫ –Ω—É–∂–Ω–æ
            trailed_f += np.roll(rolled_f, shift=-k, axis=0) * wgt
        '''
üëâ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–∏–∫—Å–µ–ª–µ–π (0‚Äì255), —Ç–∏–ø uint8.
        '''
        trailed = np.clip(trailed_f, 0, 255).astype(np.uint8)

        # –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è
        '''
–î–æ–±–∞–≤–ª—è–µ–º –≥–æ–ø-—ç—Ñ—Ñ–µ–∫—Ç "—Ä–∞–∑–¥–≤–æ–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞" (—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è).

–°–¥–≤–∏–≥–∞–µ–º —Å–∏–Ω–∏–π –≤–ø—Ä–∞–≤–æ, –∫—Ä–∞—Å–Ω—ã–π –≤–ª–µ–≤–æ, –∑–µ–ª—ë–Ω—ã–π –æ—Å—Ç–∞–≤–ª—è–µ–º.

–°–∫–ª–∞–¥—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        max_ch_shift = 2 + int(6 * progress)
        b = np.roll(trailed[:, :, 0],  max_ch_shift, axis=1)
        g = np.roll(trailed[:, :, 1],  0, axis=1)
        r = np.roll(trailed[:, :, 2], -max_ch_shift, axis=1)
        out = np.stack([b, g, r], axis=2)

        # Highlights (–∫–∞–ø–ª–∏)
        '''
–ì–æ—Ç–æ–≤–∏–º —è—Ä–∫–∏–µ "–∫–∞–ø–ª–∏ –¥–æ–∂–¥—è".

highlights ‚Äî –ø—É—Å—Ç–∞—è –º–∞—Å–∫–∞.

drop_prob ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —á—Ç–æ –≤ –∫–æ–ª–æ–Ω–∫–µ –±—É–¥–µ—Ç –∫–∞–ø–ª—è.

cols_with_drop ‚Äî –∫–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤—ã–±—Ä–∞–ª–∏—Å—å.

ys ‚Äî —Å–ª—É—á–∞–π–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –≤—ã—Å–æ—Ç–µ –¥–ª—è –∫–∞–ø–µ–ª—å.
        '''
        highlights = np.zeros((h, w), dtype=np.float32)
        drop_prob = 0.02 + 0.25 * progress
        cols_with_drop = rng.rand(w) < drop_prob
        ys = (rng.rand(cols_with_drop.sum()) * (0.6 * h)).astype(int)
        drop_idx = np.where(cols_with_drop)[0]
        '''
üëâ –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–ø–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ, –¥–µ–ª–∞–µ–º –∏—Ö –¥–ª–∏–Ω–Ω–µ–µ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.
        '''
        for j, y0 in zip(drop_idx, ys):
            y0 = np.clip(y0, 1, h - 2)
            height = 1 + int(3 + 6 * progress)
            y1 = min(h, y0 + height)
            highlights[y0:y1, j] = 1.0

        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–µ—á—ë—Ç–Ω–æ–≥–æ ksize –¥–ª—è GaussianBlur
        '''
üëâ –†–∞–∑–º—ã–≤–∞–µ–º –∫–∞–ø–ª–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏, —á—Ç–æ–± –Ω–µ –±—ã–ª–∏ —Ä–µ–∑–∫–∏–µ.
        '''
        ksize_x = 1
        ksize_y = 1 + int(5 * progress)
        if ksize_y % 2 == 0:
            ksize_y += 1
        highlights = cv2.GaussianBlur(highlights, (ksize_x, ksize_y), 0)

        '''
üëâ –ö—Ä–∞—Å–∏–º –∫–∞–ø–ª–∏ –≤ —Å–≤–µ—Ç–ª—ã–π —Ü–≤–µ—Ç –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        '''
        highlight_color = np.array([220, 240, 255], dtype=np.float32)
        highlight_layer = (highlights[:, :, None] * highlight_color).astype(np.uint8)
        out = cv2.addWeighted(out, 1.0, highlight_layer, 0.55 * progress, 0)

        # –û—Ç—Ä–∞–∂–µ–Ω–∏–µ —Å–Ω–∏–∑—É —Å –≤–æ–ª–Ω–æ–π
        '''
üëâ –ë—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Å–Ω–∏–∑—É, –∫–∞–∫ –±—É–¥—Ç–æ –¥–æ–∂–¥—å –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –º–æ–∫—Ä–æ–π –∑–µ–º–ª–µ.
        '''
        refl_h = int(h * 0.22 * progress)
        '''
üëâ –ë–µ—Ä—ë–º –∫—É—Å–æ–∫ —Å–Ω–∏–∑—É –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è.
        '''
        if refl_h >= 2:
            src_start = max(0, h - refl_h * 2)
            src = out[src_start: h - refl_h, :, :]
            if src.shape[0] > 0:
                '''
üëâ –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (—á—Ç–æ–± –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ).
                '''
                refl = cv2.flip(src, 0)
                rows, cols = refl.shape[:2]
                # –∫–∞—Ä—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                '''
–ú—É—Ç–∏–º –≤–æ–ª–Ω–æ–≤–æ–µ –∏—Å–∫–∞–∂–µ–Ω–∏–µ, —á—Ç–æ–± –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ –Ω–∞ –≤–æ–¥–µ.
–°—á–∏—Ç–∞–µ–º —Å–∏–Ω—É—Å–æ–∏–¥—É –ø–æ X –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º Y.
                '''
                map_x, map_y = np.meshgrid(np.arange(cols, dtype=np.float32),
                                       np.arange(rows, dtype=np.float32))
                # –≤–æ–ª–Ω–∞ –ø–æ X, –¥–æ–±–∞–≤–ª—è–µ–º –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ Y
                wave = np.sin((map_x / 12.0) + (t * 6.0)) * (1.0 + 4.0 * progress)
                map_y = map_y + wave.astype(np.float32)

                # –°–æ–±–∏—Ä–∞–µ–º 2-–∫–∞–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –∏ —è–≤–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–º —Ç–∏–ø
                '''
üëâ –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –≤–æ–ª–Ω–µ.
                '''
                map_xy = np.dstack((map_x, map_y)).astype(np.float32)  # CV_32FC2
                # –≤—ã–∑—ã–≤–∞–µ–º remap —Å map2 = None
                remapped = cv2.remap(refl, map_xy, None,
                                     interpolation=cv2.INTER_LINEAR,
                                     borderMode=cv2.BORDER_REFLECT)
                '''
üëâ –ß—É—Ç—å —Ä–∞–∑–º—ã–≤–∞–µ–º –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ, —á—Ç–æ–± –º—è–≥—á–µ —Å–º–æ—Ç—Ä–µ–ª–æ—Å—å.
                '''
                ksize = 1 + int(5 * progress)
                if ksize % 2 == 0:
                    ksize += 1
                remapped = cv2.GaussianBlur(remapped, (ksize, 1), 0)
                '''
üëâ –°–∫–ª–µ–∏–≤–∞–µ–º –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç—å—é –∫–∞–¥—Ä–∞.
                '''
                target_y0 = h - refl_h
                bottom_slice = out[target_y0:h, :, :].astype(np.float32)
                remapped = remapped.astype(np.float32)
                blended = cv2.addWeighted(bottom_slice, 0.35, remapped, 0.65, 0)
                out[target_y0:h, :, :] = np.clip(blended, 0, 255).astype(np.uint8)

        # –¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è
        '''
–í –∫–æ–Ω—Ü–µ –¥–µ–ª–∞–µ–º —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—é: —á—É—Ç—å —Å–∏–Ω–µ–≤—ã –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ–º, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –∫–∏–Ω–æ—à–Ω–æ.
        '''
        out_f = out.astype(np.float32) / 255.0
        color_grade = out_f * np.array([0.95, 0.98, 1.06], dtype=np.float32)
        color_grade = np.clip((color_grade - 0.5) * (1.0 + 0.25 * progress) + 0.5, 0.0, 1.0)
        out = (color_grade * 255.0).astype(np.uint8)

        return out


    def kaleidoscope(self, frame, t, duration):
        progress = t / duration
        '''
üëâ –£–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ ‚Äî —á–µ–º –¥–∞–ª—å—à–µ –∏–¥—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –±–æ–ª—å—à–µ –∫—Ä—É—Ç–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É. –ü–æ–ª–Ω—ã–π –∫—Ä—É–≥ ‚Äî 360 –≥—Ä–∞–¥—É—Å–æ–≤.
        '''
        angle = progress * 360
        h, w = frame.shape[:2]
        '''
üëâ –ë–µ—Ä—ë–º –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π –∫—É—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî —Ç–∏–ø–∞ –æ–¥–Ω—É —á–µ—Ç–≤–µ—Ä—Ç–∏–Ω–∫—É. –° –Ω–µ—ë –±—É–¥–µ–º –º—É—Ç–∏—Ç—å –≤—Å–µ –∑–µ—Ä–∫–∞–ª–∞.
        '''
        segment = frame[0:h//2, 0:w//2]
        '''
–¢—É—Ç –º—ã –¥–µ–ª–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞.

–¶–µ–Ω—Ç—Ä –≤—Ä–∞—â–µ–Ω–∏—è ‚Äî —Å–µ—Ä–µ–¥–∏–Ω–∞ —Ç–æ–≥–æ –∫—É—Å–æ—á–∫–∞ (w//4, h//4).

angle ‚Äî —Å–∫–æ–ª—å–∫–æ –∫—Ä—É—Ç–∏–º.

1 ‚Äî –º–∞—Å—à—Ç–∞–± (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–∫ –µ—Å—Ç—å).
        '''
        M = cv2.getRotationMatrix2D((w//4, h//4), angle, 1)
        '''
üëâ –ö—Ä—É—Ç–∏–º —Ç—É —á–µ—Ç–≤–µ—Ä—Ç–∏–Ω–∫—É –ø–æ –º–∞—Ç—Ä–∏—Ü–µ, –ø–æ–ª—É—á–∞–µ–º –ø–æ–≤–µ—Ä–Ω—É—Ç—ã–π –∫—É—Å–æ–∫.
        '''
        rotated = cv2.warpAffine(segment, M, (w//2, h//2))
        '''
üëâ –°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –∫–∞–¥—Ä, –≤–µ—Å—å —á—ë—Ä–Ω—ã–π ‚Äî –∫–∞–∫ –ø—É—Å—Ç–∞—è –º–∞–ª—è–≤–∞, –∫—É–¥–∞ –±—É–¥–µ–º –≤—Å—Ç–∞–≤–ª—è—Ç—å –∫—É—Å–∫–∏.
        '''
        new_frame = np.zeros_like(frame)
        # –°–æ–∑–¥–∞—ë–º 4 —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ —á–∞—Å—Ç–∏
        '''
üëâ –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–≤–µ—Ä–Ω—É—Ç—ã–π –∫—É—Å–æ–∫ –≤ –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª.
        '''
        new_frame[0:h//2, 0:w//2] = rotated
        '''
üëâ –í –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª –≤—Å—Ç–∞–≤–ª—è–µ–º –∑–µ—Ä–∫–∞–ª–∫—É –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
        '''
        new_frame[0:h//2, w//2:] = cv2.flip(rotated, 1)
        '''
üëâ –í –Ω–∏–∂–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª ‚Äî –∑–µ—Ä–∫–∞–ª–∫—É –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏.
        '''
        new_frame[h//2:, 0:w//2] = cv2.flip(rotated, 0)
        '''
üëâ –í –Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª ‚Äî –¥–≤–æ–π–Ω–æ–µ –∑–µ—Ä–∫–∞–ª–æ: –∏ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏, –∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏.
        '''
        new_frame[h//2:, w//2:] = cv2.flip(rotated, -1)
        return new_frame

    def time_tunnel(self, frame, t, duration, clip):
        '''
üëâ –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ñ—Ñ–µ–∫—Ç–∞, –æ—Ç 0 –¥–æ 1, —Ç–∏–ø–∞ "—Å–∫–æ–ª—å–∫–æ —Å—Ä–æ–∫–∞ —É–∂–µ –æ—Ç—Å–∏–¥–µ–ª".
        '''
        progress = t / duration
        '''
–°–º–æ—Ç—Ä–∏–º, –µ—Å–ª–∏ –≤ –∫–µ—à–µ –∫–∞–¥—Ä–æ–≤ –±–æ–ª—å—à–µ –ø—è—Ç–∏ ‚Äî –≤—ã–∫–∏–¥—ã–≤–∞–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π.
–ß—Ç–æ–±—ã –ø–∞–º—è—Ç—å –Ω–µ –∂—Ä–∞–ª–∞ –∫–∞–∫ –≥–æ–ª–æ–¥–Ω—ã–π –±–∏—á –Ω–∞ —Ö–∞–≤—á–∏–∫–µ.
        '''
        if len(self.frame_cache) > 5: self.frame_cache.pop(0)  # –õ–∏–º–∏—Ç –∫—ç—à–∞ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
        '''
üëâ –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤ –∫—ç—à.
        '''
        self.frame_cache.append(frame.copy())
        '''
üëâ –î–µ–ª–∞–µ–º –∫–æ–ø–∏—é –∫–∞–¥—Ä–∞, –±—É–¥–µ–º –≤ –Ω–µ—ë –≤—Å—ë —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å ‚Äî —Ç–∏–ø–∞ —á–∏—Å—Ç—ã–π –ª–∏—Å—Ç –ø–æ–¥ —Ä–∏—Å—É–Ω–∫–∏.
        '''
        new_frame = frame.copy()
        '''
üëâ –ë–µ–∂–∏–º –ø–æ –≤—Å–µ–º –ø—Ä–æ—à–ª—ã–º –∫–∞–¥—Ä–∞–º (–∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ).
i ‚Äî –Ω–æ–º–µ—Ä –∫–∞–¥—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ, prev_frame ‚Äî —Å–∞–º –∫–∞–¥—Ä.
        '''
        for i, prev_frame in enumerate(self.frame_cache[:-1]):
            '''
üëâ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª). –ß–µ–º –¥–∞–ª—å—à–µ —Å—Ç–∞—Ä—ã–π –∫–∞–¥—Ä, —Ç–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ.
            '''
            alpha = 0.5 / (i + 1) * progress
            '''
üëâ –ú–∞—Å—à—Ç–∞–±: –∫–∞–∂–¥—ã–π –ø—Ä–æ—à–ª—ã–π –∫–∞–¥—Ä –¥–µ–ª–∞–µ–º –º–µ–Ω—å—à–µ, —á—Ç–æ–± –±—ã–ª —ç—Ñ—Ñ–µ–∫—Ç —Ç–æ–Ω–Ω–µ–ª—è.
            '''
            scale = 1 - 0.1 * i * progress
            '''
üëâ –°–∂–∏–º–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–∞–¥—Ä –ø–æ —ç—Ç–æ–º—É –º–∞—Å—à—Ç–∞–±—É.
            '''
            small = cv2.resize(prev_frame, (int(frame.shape[1] * scale), int(frame.shape[0] * scale)))
            '''
üëâ –°—á–∏—Ç–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∏—Ç—å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –∫–∞–¥—Ä —Ä–æ–≤–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É.
            '''
            offset = (frame.shape[1] - small.shape[1]) // 2, (frame.shape[0] - small.shape[0]) // 2
            '''
–í–æ—Ç —Ç—É—Ç —Å–∞–º—ã–π –¥–≤–∏–∂:

–ë–µ—Ä—ë–º –º–∞–ª–µ–Ω—å–∫–∏–π –∫–∞–¥—Ä –∏ –∫–ª–∞–¥—ë–º –µ–≥–æ –≤ —Ü–µ–Ω—Ç—Ä –±–æ–ª—å—à–æ–≥–æ.

cv2.addWeighted –º–µ—à–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –∫–∞–¥—Ä –∏ —Ç–µ–∫—É—â–∏–π –∫—É—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å —Ä–∞–∑–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é (alpha –∏ 1-alpha).

–¢–∞–∫ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —á—Ç–æ –∫–∞–¥—Ä—ã –Ω–∞—Å–ª–∞–∏–≤–∞—é—Ç—Å—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ ‚Äî –∏ –≤—ã—Ö–æ–¥–∏—Ç —Ç–æ–Ω–Ω–µ–ª—å.
            '''
            new_frame[offset[1]:offset[1]+small.shape[0], offset[0]:offset[0]+small.shape[1]] = cv2.addWeighted(
                small, alpha, new_frame[offset[1]:offset[1]+small.shape[0], offset[0]:offset[0]+small.shape[1]], 1 - alpha, 0)
        return new_frame

    def neon_glow(self, frame, t, duration):
        # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –∫–∞–¥—Ä–∞
        '''
–¢—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Å—è–∫–∏: –µ—Å–ª–∏ –∫–∞–¥—Ä–∞ –Ω–µ—Ç ‚Äî

–ï—Å–ª–∏ –º—ã –¥–æ —ç—Ç–æ–≥–æ —É–∂–µ —á—Ç–æ-—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ (last_frame), —Ç–æ –æ—Ç–¥–∞–µ–º –µ–≥–æ.

–ï—Å–ª–∏ –≤–æ–æ–±—â–µ –ø—É—Å—Ç–æ, —Ç–æ –¥–µ–ª–∞–µ–º —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω 480—Ö640.
–≠—Ç–æ —á—Ç–æ–± –ø—Ä–æ–≥–∞ –Ω–µ –≤—ã—Ä—É–±–∏–ª–∞—Å—å –∫–∞–∫ –±–∏—á –±–µ–∑ —Ö–∞–≤–∫–∏.
        '''
        if frame is None:
            if hasattr(self, 'last_frame') and self.last_frame is not None:
                return self.last_frame.copy()
            return np.zeros((480, 640, 3), dtype=np.uint8)

        # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
        '''
–¢—É—Ç —á–∏—Å—Ç–∏–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —á—ë—Ä–Ω–æ-–±–µ–ª–∞—è (2D), –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ —Ü–≤–µ—Ç–Ω—É—é.

–ï—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª (4 –∫–∞–Ω–∞–ª–∞), —É–±–∏—Ä–∞–µ–º –µ–≥–æ, –æ—Å—Ç–∞–≤–ª—è–µ–º 3.

–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –æ–±—ã—á–Ω—ã–π —Ç–∏–ø uint8.

–ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–∞–¥—Ä –∫–∞–∫ last_frame, —á—Ç–æ–± –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å—Å—è.
        '''
        frame = np.asarray(frame)
        if frame.ndim == 2:
            frame = cv2.cvtColor(frame, cv2.COLOR_GRAY2BGR)
        elif frame.ndim == 3 and frame.shape[2] == 4:
            frame = cv2.cvtColor(frame, cv2.COLOR_BGRA2BGR)
        frame = frame.astype(np.uint8)
        self.last_frame = frame.copy()

        h, w = frame.shape[:2]
        progress = float(t) / max(1e-6, float(duration))
        progress = np.clip(progress, 0.0, 1.0)

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–∑—É–∞–ª–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ)
        '''
–¢—É—Ç –∑–∞–¥–∞—ë–º –¥–≤–∏–∂—É—Ö—É:

pulse ‚Äî –ø—É–ª—å—Å–∏—Ä—É–µ—Ç —Å–∏–Ω—É—Å–æ–º, –¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç "–º–∏–≥–∞–Ω–∏—è" –Ω–µ–æ–Ω–∞.

hue_base ‚Äî —Ü–≤–µ—Ç–æ–≤–∞—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–º–µ–Ω—è–µ—Ç—Å—è –æ—Ç –∑–µ–ª—ë–Ω–æ–≥–æ –∫ —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–º—É –∏ –æ–±—Ä–∞—Ç–Ω–æ).

edge_blur_levels ‚Äî —Ç—Ä–∏ —É—Ä–æ–≤–Ω—è –±–ª—é—Ä–∞ (—Ä–∞–∑–º—ã—Ç–∏—è), —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –º—è–≥–∫–∏–µ –Ω–µ–æ–Ω–æ–≤—ã–µ —Å–ª–æ–∏.
        '''
        pulse = 0.5 * (1.0 + math.sin(t * 6.0))        # 0..1 –ø—É–ª—å—Å–∞—Ü–∏—è
        hue_base = int((90 + 100.0 * math.sin(t * 3.0)) % 180)  # –±–∞–∑–æ–≤—ã–π —Ç–æ–Ω (0..179)
        edge_blur_levels = [(3, 0.55), (8, 0.32), (20, 0.13)]   # (sigma, weight)

        # –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞–µ–≤—ã–µ –∫–æ–Ω—Ç—É—Ä—ã
        '''
–î–æ—Å—Ç–∞—ë–º –∫—Ä–∞—è –æ–±—ä–µ–∫—Ç–æ–≤:

–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–µ—Ä—ã–π.

–†–∞–∑–º—ã–≤–∞–µ–º –¥–ª—è –º—è–≥–∫–æ—Å—Ç–∏.

–°—á–∏—Ç–∞–µ–º –ø–æ—Ä–æ–≥–∏ (low_thr, high_thr), —á–µ–º –¥–∞–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –∂–µ—Å—Ç—á–µ –≥—Ä–∞–Ω–∏—Ü—ã.

–ó–∞–ø—É—Å–∫–∞–µ–º Canny ‚Äî –ø–æ–ª—É—á–∞–µ–º —á—ë—Ä–Ω–æ-–±–µ–ª—ã–µ –ª–∏–Ω–∏–∏ –∫—Ä–∞—ë–≤.
        '''
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        blurred = cv2.GaussianBlur(gray, (5, 5), 0)
        low_thr = max(1, int(40 * (0.7 + 0.6 * progress)))
        high_thr = max(low_thr + 1, int(120 * (0.9 + 0.6 * progress)))
        edges = cv2.Canny(blurred, low_thr, high_thr)

        # –ú–∞—Å–∫–∞ –∫—Ä–∞—ë–≤ -> —É—Å–∏–ª–µ–Ω–∏–µ –∏ –º—è–≥–∫–æ–µ —Ä–∞—Å—Ç—É—à—ë–≤—ã–≤–∞–Ω–∏–µ
        '''
–ò–∑ –∫–æ–Ω—Ç—É—Ä–æ–≤ –¥–µ–ª–∞–µ–º –º–∞—Å–∫—É:

–ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 0..1.

–î–µ–ª–∞–µ–º —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–æ–µ —è–¥—Ä–æ (kernel).

–†–∞—Å—à–∏—Ä—è–µ–º –∫—Ä–∞—è (dilate), —á—Ç–æ–± –ª–∏–Ω–∏–∏ –±—ã–ª–∏ —Ç–æ–ª—â–µ –∏ –ø–ª–∞–≤–Ω–µ–π.
        '''
        mask = edges.astype(np.float32) / 255.0
        kernel_size = max(3, int(3 + progress * 10))
        kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (kernel_size, kernel_size))
        mask = cv2.dilate((mask * 255).astype(np.uint8), kernel, iterations=1).astype(np.float32) / 255.0

        # –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ —Ü–≤–µ—Ç–Ω–æ–µ –≥–ª–æ—É (—Å—É–º–º–∏—Ä—É–µ–º —Å–ª–æ–∏)
        '''
–í–æ—Ç —Ç—É—Ç –º–∞–≥–∏—è –Ω–µ–æ–Ω–∞:

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è –±–ª—é—Ä–∞ (sigma) –¥–µ–ª–∞–µ–º –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ.

–ö—Ä–∞—Å–∏–º –µ–≥–æ –≤ —Ü–≤–µ—Ç –ø–æ hue_base, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –∏ —è—Ä–∫–æ—Å—Ç—å –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø—É–ª—å—Å–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

–°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —Å–ª–æ–∏ —Å –≤–µ—Å–∞–º–∏ (weight), –ø–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –º–Ω–æ–≥–æ—Ü–≤–µ—Ç–Ω—ã–π –≥–ª–æ—É.
        '''
        glow_acc = np.zeros_like(frame, dtype=np.float32)
        for sigma, weight in edge_blur_levels:
            # –±–ª—é—Ä–∏–º –º–∞—Å–∫—É
            g = cv2.GaussianBlur((mask * 255).astype(np.uint8), (0, 0), sigmaX=sigma)
            # —Å–æ–∑–¥–∞—ë–º RGB-—Ü–≤–µ—Ç –ø–æ hue + value = g
            hsv_col = np.zeros((h, w, 3), dtype=np.uint8)
            hsv_col[..., 0] = hue_base                             # H (0..179)
            sat_val = int(np.clip(180 * (0.6 + 0.4 * pulse * (1.0 - progress)), 0, 255))
            hsv_col[..., 1] = sat_val                              # S
            hsv_col[..., 2] = g                                    # V = –º–∞—Å–∫–∞-–±–ª—é—Ä
            col = cv2.cvtColor(hsv_col, cv2.COLOR_HSV2BGR).astype(np.float32)
            glow_acc += col * weight
        '''
üëâ –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–± –Ω–µ —É–ª–µ—Ç–µ–ª–æ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —è—Ä–∫–æ—Å—Ç–∏.
        '''
        glow_acc = np.clip(glow_acc, 0.0, 255.0)
        
        # –ö–æ–º–ø–æ–∑–∏—Ç: "color dodge" (—è—Ä–∫–∏–π –Ω–µ–æ–Ω) + —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
        '''
–ú—É—Ç–∏–º —Ä–µ–∂–∏–º "color dodge" ‚Äî –æ–Ω –¥–µ–ª–∞–µ—Ç —Å–≤–µ—Ç–ª—ã–µ –æ–±–ª–∞—Å—Ç–∏ –µ—â—ë —è—Ä—á–µ.
–¢–∏–ø–∞ –ø–∏–∫—Å–µ–ª–∏ –Ω–∞—á–∏–Ω–∞—é—Ç –≥–æ—Ä–µ—Ç—å –∫–∞–∫ –ª–∞–º–ø—ã –≤ –Ω–æ—á–Ω–æ–º –∫–ª—É–±–µ.
        '''
        frame_f = frame.astype(np.float32)
        dodge = frame_f * 255.0 / (255.0 - glow_acc + 1.0)   # –±–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–∞ float
        dodge = np.clip(dodge, 0.0, 255.0)

        '''
üëâ –°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –Ω–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É—Å–∏–ª–∏–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
        '''
        mix_strength = 0.6 * (0.25 + 0.75 * progress)  # —Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É
        out = cv2.addWeighted(frame_f, 1.0 - mix_strength, dodge, mix_strength, 0.0)

        # –ù–µ–º–Ω–æ–≥–æ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å/—è—Ä–∫–æ—Å—Ç—å
        '''
–§–∏–Ω–∞–ª—å–Ω–∞—è –¥–æ–≤–æ–¥–∫–∞:

–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ HSV, –≥–¥–µ –ª–µ–≥–∫–æ –∫—Ä—É—Ç–∏—Ç—å –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –∏ —è—Ä–∫–æ—Å—Ç—å.

–î–µ–ª–∞–µ–º —Ü–≤–µ—Ç–∞ —è—Ä—á–µ –∏ —Å–æ—á–Ω–µ–µ.

–Ø—Ä–∫–æ—Å—Ç—å –∫–∞—á–∞–µ—Ç –≤–º–µ—Å—Ç–µ —Å –ø—É–ª—å—Å–æ–º ‚Äî —Ç–∏–ø–∞ –ª–∞–º–ø–∞ –º–æ—Ä–≥–∞–µ—Ç.

–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—ë –æ–±—Ä–∞—Ç–Ω–æ –≤ BGR.
        '''
        hsv = cv2.cvtColor(np.clip(out, 0, 255).astype(np.uint8), cv2.COLOR_BGR2HSV).astype(np.float32)
        hsv[..., 1] = np.clip(hsv[..., 1] * (1.0 + 0.9 * progress), 0, 255)  # S boost
        hsv[..., 2] = np.clip(hsv[..., 2] * (1.0 + 0.45 * progress + 0.18 * pulse), 0, 255)  # V boost —Å –ø—É–ª—å—Å–æ–º
        result = cv2.cvtColor(hsv.astype(np.uint8), cv2.COLOR_HSV2BGR)

        return result

    
    def glitch_shift(self, frame, t, duration):
        # –ì–ª–∏—Ç—á —Å RGB-—Å–¥–≤–∏–≥–∞–º–∏ –∏ —Ä–∞–∑—Ä–µ–∑–∞–Ω–∏–µ–º –Ω–∞ –¥–µ—Ä–≥–∞—é—â–∏–µ—Å—è —á–∞—Å—Ç–∏
        progress = t / duration
        '''
üëâ –°—á–∏—Ç–∞–µ–º –≤–µ–ª–∏—á–∏–Ω—É —Å–¥–≤–∏–≥–∞, –∑–∞–≤–∏—Å—è—â—É—é –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
–ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –¥–≤–∏–≥–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É, –¥–æ 50 –ø–∏–∫—Å–µ–ª–µ–π.
        '''
        shift = int(progress * 50)
        '''
üëâ –°—é–¥–∞ –Ω–∞–∫–∏–¥—ã–≤–∞–µ–º —à—É–º, –∫–∞–∫ –±—É–¥—Ç–æ —Ç–µ–ª–µ–∫ –ª–æ–≤–∏—Ç —Å–∏–≥–Ω–∞–ª —á–µ—Ä–µ–∑ –≤–µ—à–∞–ª–∫—É –≤–º–µ—Å—Ç–æ –∞–Ω—Ç–µ–Ω–Ω—ã.
np.random.randint –≤—ã–¥–∞—ë—Ç —á–∏—Å–ª–∞ –æ—Ç -10 –¥–æ 10 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è.
        '''
        noise = np.random.randint(-10, 10, frame.shape, dtype=np.int16)
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞–¥—Ä –≤ int16, —á—Ç–æ–± –ø—Ä–∏ —Å–ª–æ–∂–µ–Ω–∏–∏ —Å —à—É–º–æ–º –Ω–µ –≤—ã–ª–µ—Ç–µ–ª–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã.

–î–æ–±–∞–≤–ª—è–µ–º —à—É–º.

np.clip –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç 0 –¥–æ 255, –∏–Ω–∞—á–µ –±—É–¥—É—Ç –≤—ã–∂–∂–µ–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏.

–í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ uint8, –∫–∞–∫ –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        frame = np.clip(frame.astype(np.int16) + noise, 0, 255).astype(np.uint8)
        '''
üëâ –î–µ–ª–∏–º –∫–∞–¥—Ä –Ω–∞ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞: –∫—Ä–∞—Å–Ω—ã–π, –∑–µ–ª—ë–Ω—ã–π –∏ —Å–∏–Ω–∏–π.
        '''
        r, g, b = cv2.split(frame)
        '''
üëâ –ö—Ä–∞—Å–Ω—ã–π –∫–∞–Ω–∞–ª –¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ –Ω–∞ shift –ø–∏–∫—Å–µ–ª–µ–π.
        '''
        r = np.roll(r, shift, axis=1)
        '''
üëâ –ó–µ–ª—ë–Ω—ã–π –Ω–∞–æ–±–æ—Ä–æ—Ç –¥–≤–∏–≥–∞–µ–º –≤–ª–µ–≤–æ –Ω–∞ shift.
(–¢–∞–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è RGB-—Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ, —Ç–∏–ø–∞ –¥–≤–æ–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏).
        '''
        g = np.roll(g, -shift, axis=1)
        '''
üëâ –°–æ–±–∏—Ä–∞–µ–º –≤—Å—ë –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —É–∂–µ –≥–ª—é—á–Ω–æ–µ –∏ —Ü–≤–µ—Ç–∞—Å—Ç–æ–µ.
        '''
        frame = cv2.merge([r, g, b])
        '''
üëâ –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏, –∫–∞–∂–¥—ã–µ 50 –ø–∏–∫—Å–µ–ª–µ–π –±–µ—Ä—ë–º –ø–æ–ª–æ—Å—É.
        '''
        for i in range(0, frame.shape[0], 50):  # –†–∞–∑—Ä–µ–∑–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª–æ—Å—ã
            '''
üëâ –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã —Å—á–∏—Ç–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å–¥–≤–∏–≥ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ. –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –¥—ë—Ä–≥–∞–µ—Ç.
            '''
            dx = int(random.uniform(-shift, shift) * progress)
            '''
üëâ –ë–µ—Ä—ë–º —ç—Ç—É –ø–æ–ª–æ—Å—É –∏ –¥–≤–∏–≥–∞–µ–º –µ—ë –Ω–∞ dx –ø–∏–∫—Å–µ–ª–µ–π.
–ö–∞–∂–¥–∞—è –ø–æ–ª–æ—Å–∞ –µ–¥–µ—Ç –≤ —Å–≤–æ—é —Å—Ç–æ—Ä–æ–Ω—É ‚Äî –≤–æ—Ç —Ç–µ–±–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç "–±–∏—Ç–æ–≥–æ VHS".
            '''
            frame[i:i+50] = np.roll(frame[i:i+50], dx, axis=1)
        return frame


    
    def starburst_explosion(self, frame, t, duration):
        # –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1 —Å easing (–ø–ª–∞–≤–Ω—ã–π –≤—ã—Ö–æ–¥)
        '''
–ë–µ—Ä—ë–º –≤—Ä–µ–º—è t –∏ –¥–µ–ª–∏–º –Ω–∞ –≤—Å—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞.
–î–µ–ª–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 1, —á—Ç–æ–± –Ω–µ —É–ª–µ—Ç–µ–ª–æ –∑–∞ —Ä–∞–º–∫–∏.
1e-6 –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å –Ω–µ —Å–ª—É—á–∏–ª–æ—Å—å.
        '''
        progress = float(t) / max(1e-6, duration)
        progress = max(0.0, min(1.0, progress))
        '''
üëâ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–±–ª—É–¥–∞ ‚Äî –¥–µ–ª–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞–≤–Ω—ã–º:
—Å–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä–æ, –ø–æ—Ç–æ–º –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è. –ß—Ç–æ–±—ã –≤–∑—Ä—ã–≤ –≤—ã–≥–ª—è–¥–µ–ª –Ω–µ –∫–∞–∫ –¥–µ—Ä–≥–∞–Ω—ã–π, –∞ –∫–∞–∫ –∫–∏–Ω–æ.
        '''
        # easing: –º—è–≥–∫–∏–π ease-out –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è
        def ease_out_cubic(x): return 1 - (1 - x) ** 3
        p = ease_out_cubic(progress)

        h, w = frame.shape[:2]
        out = frame.copy().astype(np.uint8)

        # ---- BLOOM / –∑–≤–µ–∑–¥–æ—á–∫–∏ (–Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–º —Å–ª–æ–µ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏) ----
        '''
–°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ–º–µ–Ω—å—à–µ (—É–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –≤ 4 —Ä–∞–∑–∞).
–ù–∞ –Ω–µ–π –±—É–¥–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å —Å–≤–µ—á–µ–Ω–∏–µ/–∑–≤—ë–∑–¥–æ—á–∫–∏, –ø–æ—Ç–æ–º —É–≤–µ–ª–∏—á–∏–º –æ–±—Ä–∞—Ç–Ω–æ.
–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, –±—Ä–∞—Ç.
        '''
        scale = 4  # —á–µ–º –±–æ–ª—å—à–µ ‚Äî —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ –±–æ–ª–µ–µ –º—è–≥–∫–∏–π bloom
        sw, sh = max(1, w // scale), max(1, h // scale)
        glow = np.zeros((sh, sw, 3), dtype=np.uint8)

        '''
üëâ –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –±–æ–ª—å—à–µ –∑–≤—ë–∑–¥–æ—á–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è (–Ω–æ –Ω–µ –±–æ–ª—å—à–µ 200).
        '''
        max_stars = 80
        num_stars = int(max_stars * (p ** 0.9))
        num_stars = min(num_stars, 200)

        '''
üëâ –ì–µ–Ω–µ—Ä–∏–º —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–≤–µ–∑–¥—ã –Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ.
        '''
        for _ in range(num_stars):
            # –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–¥–∏—É—Å –≤ –º–∞–ª–µ–Ω—å–∫–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ
            gx = random.randint(0, sw - 1)
            gy = random.randint(0, sh - 1)
            # —Ä–∞–¥–∏—É—Å —Ä–∞—Å—Ç—ë—Ç –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É, –Ω–æ –æ—Å—Ç–∞—ë—Ç—Å—è –º—è–≥–∫–∏–º
            '''
üëâ –†–∞–¥–∏—É—Å –∑–≤–µ–∑–¥—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: —á–µ–º –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É, —Ç–µ–º –æ–Ω–∏ –±–æ–ª—å—à–µ.
            '''
            r = max(1, int(1 + 6 * p * (0.6 + random.random() * 0.8)))
            # —Ü–≤–µ—Ç: –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —Ç—ë–ø–ª—ã–π/—Ä–æ–∑–æ–≤–∞—Ç—ã–π —Å –ª—ë–≥–∫–æ–π –≤–∞—Ä–∏–∞—Ü–∏–µ–π
            '''
üëâ –¶–≤–µ—Ç –¥–µ–ª–∞–µ–º –≤ —Ä–æ–∑–æ–≤–æ-—Ç—ë–ø–ª—ã—Ö —Ç–æ–Ω–∞—Ö, —Å –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∞–Ω–¥–æ–º–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–µ–π.
üëâ –†–∏—Å—É–µ–º –∫—Ä—É–≥ (–∑–≤–µ–∑–¥—É).
            '''
            color = (int(180 + random.random() * 75),
                     int(150 + random.random() * 105),
                     int(200 + random.random() * 55))
            cv2.circle(glow, (gx, gy), r, color, -1, lineType=cv2.LINE_AA)

        # –º—è–≥–∫–∏–π blur –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–º —Å–ª–æ–µ –∏ –∞–ø—Å–∫–µ–π–ª
        '''
–†–∞–∑–º—ã–≤–∞–µ–º —Å–≤–µ—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –º—è–≥–∫–æ –∏ –∫—Ä–∞—Å–∏–≤–æ.
–ü–æ—Ç–æ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –¥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–¥—Ä–∞.
        '''
        k = max(1, int(3 + 10 * p))
        if k % 2 == 0:
            k += 1
        glow = cv2.GaussianBlur(glow, (k, k), 0)
        glow_up = cv2.resize(glow, (w, h), interpolation=cv2.INTER_LINEAR)
        # –¥–æ–±–∞–≤–ª—è–µ–º bloom —Å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é
        '''
üëâ –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º glow –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É—Å–∏–ª–∏–≤–∞—è —è—Ä–∫–æ—Å—Ç—å –∫ —Ñ–∏–Ω–∞–ª—É –≤–∑—Ä—ã–≤–∞.
        '''
        intensity = 0.18 + 0.6 * p
        out = cv2.addWeighted(out, 1.0, glow_up, intensity, 0)

        # ---- —Å—Ç—Ä–∏–ø—ã-—Ö–≤–æ—Å—Ç—ã (–º—è–≥–∫–∏–µ) ----
        '''
üëâ –°–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –¥–ª—è "—Ö–≤–æ—Å—Ç–æ–≤" ‚Äî —Å–≤–µ—Ç–ª—ã—Ö –ø–æ–ª–æ—Å, –∫–∞–∫ –æ—Ç –≤–∑—Ä—ã–≤–∞.
üëâ –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ–ª–æ—Å.
        '''
        streaks = np.zeros_like(out)
        num_streaks = int(20 * p) + 6
        '''
üëâ –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å–∫–∏ —Å–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ —Å—Ç–∞—Ä—Ç–∞ –∏ —É–≥–æ–ª –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
        '''
        for _ in range(num_streaks):
            x = random.randint(0, w - 1)
            y = random.randint(0, h - 1)
            angle = random.uniform(0, 2 * math.pi)
            '''
üëâ –ü–æ–ª–æ—Å–∫–∏ –¥–ª–∏–Ω–Ω—ã–µ, —Å–≤–µ—Ç–ª—ã–µ, —á—É—Ç—å —Å—É–∂–µ–Ω–Ω—ã–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏, —Ç–æ–ª—â–∏–Ω—É —Ç–æ–∂–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É.
            '''
            length = int(30 + 220 * (p ** 1.1))
            dx = int(math.cos(angle) * length)
            dy = int(math.sin(angle) * length * 0.7)
            thickness = max(1, int(1 + 2 * p))
            col = (230, 230, 255)
            '''
üëâ –†–∏—Å—É–µ–º —Å–≤–µ—Ç–ª—ã–µ –ø–æ–ª–æ—Å–∫–∏, —á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ —Ä–∞–∑–ª–µ—Ç–∞—é—â–∏–µ—Å—è –∏—Å–∫—Ä—ã.
            '''
            cv2.line(streaks, (x, y), (max(0, min(w - 1, x + dx)), max(0, min(h - 1, y + dy))),
                     col, thickness, lineType=cv2.LINE_AA)
        # –º—è–≥–∫–æ —Ä–∞–∑–º—ã–≤–∞–µ–º streaks
        '''
üëâ –†–∞–∑–º—ã–≤–∞–µ–º –ø–æ–ª–æ—Å–∫–∏ –¥–ª—è –º—è–≥–∫–æ—Å—Ç–∏ –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∏—Ö –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        '''
        streaks = cv2.GaussianBlur(streaks, (7, 7), 0)
        out = cv2.addWeighted(out, 1.0, streaks, 0.28 * p, 0)

        # ---- –®–∞—Ä–¥—ã: –ø–ª–∞–≤–Ω—ã–µ "—Ä–∞–∑—Ä–µ–∑—ã" —Å –º—è–≥–∫–∏–º–∏ –∫—Ä–∞—è–º–∏ ----
        '''
üëâ –ü–æ—Å–ª–µ 30% –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞—á–∏–Ω–∞–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –æ—Å–∫–æ–ª–∫–æ–≤ (—Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∫–∞—Ä—Ç–∏–Ω–∫–∏).
        '''
        if p > 0.3:
            # shard_size –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é
            '''
‚Äî –†–∞–∑–º–µ—Ä –æ—Å–∫–æ–ª–∫–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–¥—Ä–∞.
‚Äî move_strength ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –¥–≤–∏–≥–∞—é—Ç—Å—è –æ—Å–∫–æ–ª–∫–∏ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º).
‚Äî move_prob ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –∫—É—Å–æ–∫ –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è.
‚Äî –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ (–ø–æ–≤–æ—Ä–æ—Ç —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏–π).
            '''
            shard_size = max(64, min(160, int(min(h, w) / 8)))
            move_strength = (p - 0.3) / (1.0 - 0.3)
            move_strength = max(0.0, min(1.0, move_strength))
            # —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —à–∞—Ä–¥–æ–≤ –ø–æ–¥–≤–µ—Ä–≥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—ç–∫–æ–Ω–æ–º–∏—è)
            move_prob = 0.35 + 0.55 * move_strength
            # –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ (warpAffine –¥–æ—Ä–æ–∂–µ)
            max_rotates = 12
            rotates_done = 0

            '''
üëâ –î–≤–∏–≥–∞–µ–º—Å—è –ø–æ –∫–∞–¥—Ä—É –±–ª–æ–∫–∞–º–∏ ‚Äî —Ç–∏–ø–∞ —Ä–µ–∂–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç—ã (–æ—Å–∫–æ–ª–∫–∏).
            '''
            for i in range(0, h, shard_size):
                ph = min(shard_size, h - i)
                for j in range(0, w, shard_size):
                    pw = min(shard_size, w - j)
                    # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
                    '''
üëâ –ù–µ –∫–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–≤–∏–≥–∞–µ—Ç—Å—è ‚Äî –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏.
                    '''
                    if random.random() > move_prob:
                        continue

                    '''
üëâ –ë–µ—Ä—ë–º –∫—É—Å–æ—á–µ–∫ –∫–∞–¥—Ä–∞.
                    '''
                    src = frame[i:i + ph, j:j + pw].astype(np.uint8)

                    # –°–º–µ—â–µ–Ω–∏–µ: –º—è–≥–∫–æ–µ, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞—Ä—É–∂—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
                    '''
üëâ –°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Å–∫–æ–ª–∫–∞ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∫–∞–¥—Ä–∞.
                    '''
                    cx, cy = w / 2.0, h / 2.0
                    sx = (j + pw / 2.0) - cx
                    sy = (i + ph / 2.0) - cy
                    # –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏ —É—Å–∏–ª–∏–≤–∞–µ–º –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É
                    '''
üëâ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–ª—É—á–∞–µ–º –≤–µ–∫—Ç–æ—Ä –Ω–∞—Ä—É–∂—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.
                    '''
                    dist = math.hypot(sx, sy) + 1e-6
                    nx, ny = sx / dist, sy / dist
                    '''
üëâ –ß–µ–º –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É —ç—Ñ—Ñ–µ–∫—Ç–∞, —Ç–µ–º –¥–∞–ª—å—à–µ —É–ª–µ—Ç–∞—é—Ç –æ—Å–∫–æ–ª–∫–∏ –Ω–∞—Ä—É–∂—É.
                    '''
                    base_shift = 0.2 + 0.8 * move_strength  # –º–Ω–æ–∂–∏—Ç–µ–ª—å
                    max_shift = int(min(w, h) * 0.5 * base_shift)
                    dx = int(nx * max_shift * (0.4 + 0.6 * random.random()))
                    dy = int(ny * max_shift * (0.2 + 0.6 * random.random()))


                    '''
üëâ –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Å–∫–æ–ª–∫–∞, —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ—Ç–∞–ª –∑–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É.
                    '''
                    new_j = j + dx
                    new_i = i + dy
                    # –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø–æ–º–µ—â–∞–ª—Å—è
                    new_j = max(0, min(w - pw, new_j))
                    new_i = max(0, min(h - ph, new_i))

                    '''
üëâ –ò–Ω–æ–≥–¥–∞ –æ—Å–∫–æ–ª–∫–∏ —á—É—Ç—å –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º, —á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–µ–µ.
                    '''
                    dst_patch = src

                    # –∏–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç –¥–ª—è –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ —Ä–µ–¥–∫–æ
                    if rotates_done < max_rotates and random.random() < 0.18:
                        angle = random.uniform(-8.0, 8.0) * move_strength
                        M = cv2.getRotationMatrix2D((pw / 2.0, ph / 2.0), angle, 1.0)
                        rotated = cv2.warpAffine(src, M, (pw, ph), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
                        dst_patch = rotated
                        rotates_done += 1
                    
                    # —Å–æ–∑–¥–∞—ë–º –º—è–≥–∫—É—é –º–∞—Å–∫—É (–ø–æ —è—Ä–∫–æ—Å—Ç–∏) –∏ —Ä–∞–∑–º—ã–≤–∞–µ–º –µ—ë
                    '''
üëâ –°–æ–∑–¥–∞—ë–º –º—è–≥–∫—É—é –º–∞—Å–∫—É, —á—Ç–æ–±—ã –∫—Ä–∞—è –æ—Å–∫–æ–ª–∫–æ–≤ –≤—ã–≥–ª—è–¥–µ–ª–∏ –Ω–µ –∂—ë—Å—Ç–∫–æ, –∞ —Å —Ä–∞–∑–º—ã—Ç–∏–µ–º.
                    '''
                    gray = cv2.cvtColor(dst_patch, cv2.COLOR_BGR2GRAY)
                    _, mask = cv2.threshold(gray, 6, 255, cv2.THRESH_BINARY)
                    mk = max(3, int(5 + 6 * (1 - move_strength)))
                    if mk % 2 == 0:
                        mk += 1
                    mask = cv2.GaussianBlur(mask, (mk, mk), 0).astype(np.float32) / 255.0
                    mask3 = np.repeat(mask[:, :, None], 3, axis=2)

                    # –º—è–≥–∫–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —Å —Ç–µ–∫—É—â–∏–º —Ñ—Ä–µ–π–º–æ–º
                    '''
üëâ –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –æ—Å–∫–æ–ª–æ–∫ –Ω–∞ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ —Å –ø–ª–∞–≤–Ω—ã–º —Å–º–µ—à–∏–≤–∞–Ω–∏–µ–º.
                    '''
                    dst_roi = out[new_i:new_i + ph, new_j:new_j + pw].astype(np.float32)
                    src_f = dst_patch.astype(np.float32)
                    blended = (src_f * mask3 + dst_roi * (1.0 - mask3)).astype(np.uint8)
                    out[new_i:new_i + ph, new_j:new_j + pw] = blended

                    # –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–Ω–∫—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫—Ä–∞—è, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ–∑ –≤—ã–≥–ª—è–¥–µ–ª –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
                    '''
üëâ –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫—Ä–∞—è, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ, –±—É–¥—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —Ç—Ä–µ—Å–Ω—É–ª–æ.
                    '''
                    if pw > 6 and ph > 6:
                        edge_alpha = 0.25 * (0.3 + move_strength)
                        # —Ä–∏—Å—É–µ–º —Å–≤–µ—Ç–ª—É—é —Ç–æ–Ω–∫—É—é –ª–∏–Ω–∏—é —Å–≤–µ—Ä—Ö—É-—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
                        cv2.line(out, (new_j, new_i), (new_j + pw - 1, new_i), (230, 230, 255),
                                 max(1, int(1 + move_strength)), lineType=cv2.LINE_AA)

        # ---- –ª—ë–≥–∫–æ–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –∏ –≤–∏–Ω—å–µ—Ç–∫–∞ (–¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏) ----
        # –ª—ë–≥–∫–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞, —á—Ç–æ–±—ã –∫–∞–¥—Ä –≤—ã–≥–ª—è–¥–µ–ª –≥–ª—É–±–∂–µ
        '''
üëâ –î–µ–ª–∞–µ–º –≤–∏–Ω—å–µ—Ç–∫—É ‚Äî –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º –∫–∞–¥—Ä–∞.
        '''
        vx = cv2.getGaussianKernel(w, w * 0.9)
        vy = cv2.getGaussianKernel(h, h * 0.9)
        vignette = vy * vx.T
        '''
üëâ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–∏–Ω—å–µ—Ç–∫—É (–º–∞—Å–∫—É), —á—Ç–æ–±—ã –∑–Ω–∞—á–µ–Ω–∏—è –±—ã–ª–∏ –æ—Ç 0 –¥–æ 1.
        '''
        vmin = vignette.min()
        vmax = vignette.max()
        vnorm = (vignette - vmin) / (vmax - vmin + 1e-9)
        # —É—Å–∏–ª–∏–≤–∞–µ–º –≤–∏–Ω—å–µ—Ç–∫—É –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        '''
üëâ –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–∏–Ω—å–µ—Ç–∫—É –Ω–∞ –∫–∞–¥—Ä: —á–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º.
        '''
        vign_strength = 0.25 * p
        for c in range(3):
            out[:, :, c] = (out[:, :, c].astype(np.float32) * (1.0 - vign_strength * (1.0 - vnorm))).astype(np.uint8)

        return out

    def mirror_shatter(self, frame, t, duration):
        # –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Å —Ä–∞–∑–±–∏–µ–Ω–∏–µ–º –Ω–∞ —É–ª–µ—Ç–∞—é—â–∏–µ –∫—É—Å–∫–∏
        progress = t / duration
        '''
‚Äî –ë–µ—Ä—ë–º –∫–∞–¥—Ä –∏ –æ—Ç—Ä–∞–∂–∞–µ–º –µ–≥–æ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
–¢–æ –µ—Å—Ç—å –∫–∞–∫ –±—É–¥—Ç–æ –≤ –∑–µ—Ä–∫–∞–ª–æ –≥–ª—è–Ω—É–ª ‚Äî —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ –ø–æ–º–µ–Ω—è–ª–æ—Å—å.
        '''
        mirrored = cv2.flip(frame, 1)  # –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ
        '''
‚Äî –¢—É—Ç –º—ã –º–µ—à–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –∑–µ—Ä–∫–∞–ª–∫—É –≤ —Ä–∞–≤–Ω—ã—Ö –¥–æ–ª—è—Ö 50/50.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç —Ç–∏–ø–∞ "—Ä–∞–∑–¥–≤–æ–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏" ‚Äî –ø–æ–ª–æ–≤–∏–Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∞—è, –ø–æ–ª–æ–≤–∏–Ω–∞ –∑–µ—Ä–∫–∞–ª—å–Ω–∞—è.
        '''
        new_frame = cv2.addWeighted(frame, 0.5, mirrored, 0.5, 0)
        '''
‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞: —ç—Ñ—Ñ–µ–∫—Ç –æ—Å–∫–æ–ª–∫–æ–≤ –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø—Ä–æ—à–ª–æ 30% –≤—Ä–µ–º–µ–Ω–∏.
–î–æ —ç—Ç–æ–≥–æ –ø—Ä–æ—Å—Ç–æ –∑–µ—Ä–∫–∞–ª–æ –º—É—Ç–∏—Ç, –∞ –ø–æ—Ç–æ–º ‚Äî –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–∞–∑–ª—ë—Ç –∫—É—Å–∫–æ–≤.
        '''
        if progress > 0.3:
            '''
‚Äî –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å–∫–æ–ª–∫–æ–≤ —Ä–∞—Å—Ç—ë—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.
–ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –∫—É—Å–æ—á–∫–æ–≤ –æ—Ç–ª–µ—Ç–∞–µ—Ç.
            '''
            num_shards = int(10 * progress)
            '''
‚Äî –ë–µ—Ä—ë–º –≤—ã—Å–æ—Ç—É (h) –∏ —à–∏—Ä–∏–Ω—É (w) –∫–∞–¥—Ä–∞, —á—Ç–æ–± –∑–Ω–∞—Ç—å, –≥–¥–µ —Ä–µ–∑–∞—Ç—å –∏ –∫–∏–¥–∞—Ç—å –∫—É—Å–∫–∏.
            '''
            h, w = frame.shape[:2]
            '''
‚Äî –¶–∏–∫–ª –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—Å–∫–æ–ª–∫–æ–≤.
–¢–æ –µ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—É—Å–∫–∞ –¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ "—Ä–∞–∑–ª–µ—Ç–∞–Ω–∏–µ".
            '''
            for _ in range(num_shards):
                '''
‚Äî –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª –∫—É—Å–æ—á–∫–∞) –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–æ–ª–æ–≤–∏–Ω—ã –∫–∞–¥—Ä–∞.
–¢–∏–ø–∞ –æ—Å–∫–æ–ª–∫–∏ –Ω–µ –ø–æ –≤—Å–µ–º—É —ç–∫—Ä–∞–Ω—É —Å—Ä–∞–∑—É, –∞ —Å –ø–æ–ª–æ–≤–∏–Ω—ã –Ω–∞—á–∏–Ω–∞—é—Ç.
                '''
                sx, sy = random.randint(0, w//2), random.randint(0, h//2)
                '''
‚Äî –í—ã—Ä–µ–∑–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ —Ä–∞–∑–º–µ—Ä–æ–º 50x50 –ø–∏–∫—Å–µ–ª–µ–π –∏–∑ –∫–∞–¥—Ä–∞ ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å –æ—Å–∫–æ–ª–æ–∫ (shard).
                '''
                shard = new_frame[sy:sy+50, sx:sx+50]
                '''
‚Äî –°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ: –∫—É–¥–∞ —É–ª–µ—Ç–∏—Ç –æ—Å–∫–æ–ª–æ–∫.
–ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —à–∏—Ä–∏–Ω—ã/–≤—ã—Å–æ—Ç—ã –∫–∞–¥—Ä–∞ –∏ —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å.
–¢–æ –µ—Å—Ç—å —Å–Ω–∞—á–∞–ª–∞ –¥–≤–∏–≥–∞—é—Ç—Å—è —á—É—Ç—å-—á—É—Ç—å, –∞ –ø–æ–¥ –∫–æ–Ω–µ—Ü —É–∂–µ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–π.
                '''
                dx, dy = int(random.uniform(-w, w) * progress), int(random.uniform(-h, h) * progress)
                '''
‚Äî –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –æ—Å–∫–æ–ª–æ–∫ –Ω–µ –≤—ã–ª–µ—Ç–µ–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞–¥—Ä–∞.
–ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º —É—à—ë–ª –≤–ª–µ–≤–æ/–≤–≤–µ—Ä—Ö ‚Äî –ø—Ä–∏–∂–∏–º–∞–µ–º –∫ 0,
–µ—Å–ª–∏ –≤–ø—Ä–∞–≤–æ/–≤–Ω–∏–∑ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä–æ–º –∫–∞–¥—Ä–∞ –º–∏–Ω—É—Å 50 (—Ä–∞–∑–º–µ—Ä –æ—Å–∫–æ–ª–∫–∞).
                '''
                new_sx = max(0, min(w - 50, sx + dx))
                new_sy = max(0, min(h - 50, sy + dy))
                '''
‚Äî –°—Ç–∞–≤–∏–º –æ—Å–∫–æ–ª–æ–∫ –≤ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ.
–¢–∏–ø–∞ –∫—É—Å–æ—á–µ–∫ —Å—Ç–µ–∫–ª–∞ —É–ª–µ—Ç–µ–ª –∏ –ø—Ä–∏–∫–ª–µ–∏–ª—Å—è –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ.
                '''
                new_frame[new_sy:new_sy+50, new_sx:new_sx+50] = shard
        '''
–ö–æ—Ä–æ—á–µ, –±—Ä–∞—Ç, —ç—Ç–æ—Ç –∫–æ–¥ –º—É—Ç–∏—Ç —Ç–∞–∫—É—é –¥–≤–∏–∂—É—Ö—É:
—Å–Ω–∞—á–∞–ª–∞ —ç–∫—Ä–∞–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–µ—Ä–∫–∞–ª—å–Ω–æ-–¥–≤–æ–π–Ω—ã–º,
–∞ –ø–æ—Ç–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ –∫–≤–∞–¥—Ä–∞—Ç—ã-–æ—Å–∫–æ–ª–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç
—Ä–∞–Ω–¥–æ–º–Ω–æ —Ä–∞–∑–ª–µ—Ç–∞—Ç—å—Å—è –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã,
–Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ ‚Äî —á—Ç–æ–±—ã –Ω–µ —É–ª–µ—Ç–µ–ª–∏ –∑–∞ —ç–∫—Ä–∞–Ω.
        '''
        return new_frame

    def color_wave_glitch(self, frame, t, duration):
        """
        –£–ª—É—á—à–µ–Ω–Ω—ã–π color + wave + glitch —ç—Ñ—Ñ–µ–∫—Ç.
        frame: BGR uint8 numpy array
        t: –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (float)
        duration: –æ–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞ (float)
        """

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∞ (–º–æ–∂–µ—Ç–µ –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å)
        hue_amp_max = 45           # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ hue –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (0..179)
        hue_freq = 1.5             # —á–∞—Å—Ç–æ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è hue (Hz)
        slice_width = 24           # —à–∏—Ä–∏–Ω–∞ "–ø–æ–ª–æ—Å" –¥–ª—è —Å—Ä–µ–∑–æ–≤
        slice_freq = 0.9           # —á–∞—Å—Ç–æ—Ç–∞ —Å–º–µ—â–µ–Ω–∏–π –ø–æ–ª–æ—Å
        channel_shift_max = 12     # –º–∞–∫—Å —Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ X
        scanline_strength = 0.12   # —Å–∏–ª–∞ —Å–∫–∞–Ω–ª–∞–π–Ω–æ–≤ (0..1)
        noise_amount = 0.025       # –¥–æ–ª—è –ø–∏–∫—Å–µ–ª–µ–π —Å —à—É–º–æ–º (0..1)

        # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1
        progress = float(t) / max(float(duration), 1e-6)
        progress = max(0.0, min(1.0, progress))

        h, w = frame.shape[:2]

        # 1) Hue-–≤–æ–ª–Ω–∞: —Ä–∞–±–æ—Ç–∞–µ–º –≤ HSV –Ω–∞ signed dtype, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–π
        '''
‚Äî –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ HSV (–æ—Ç—Ç–µ–Ω–æ–∫, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å, —è—Ä–∫–æ—Å—Ç—å).
–î–µ–ª–∞–µ–º –µ—ë int16, —á—Ç–æ–± —Ü–≤–µ—Ç–∞ –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∏—Å—å, –∫–æ–≥–¥–∞ –∏—Ö –∫—Ä—É—Ç–∏—Ç—å –±—É–¥–µ–º.
        '''
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV).astype(np.int16)
        # –≤—ã—á–∏—Å–ª—è–µ–º —Å–¥–≤–∏–≥ –ø–æ hue (—Ü–µ–ª–æ–µ, –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
        '''
‚Äî –°—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –Ω–∞–¥–æ —Å–º–µ—Å—Ç–∏—Ç—å —Ü–≤–µ—Ç–æ–≤–æ–π —Ç–æ–Ω (hue).
–ë–µ—Ä—ë–º —Å–∏–Ω—É—Å, —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî –∏ –ø–æ–ª—É—á–∞–µ–º, —á—Ç–æ –æ—Ç—Ç–µ–Ω–∫–∏ –ø–æ –∫—Ä—É–≥—É –±–µ–≥–∞—é—Ç.
        '''
        hue_shift = int(round(hue_amp_max * progress * math.sin(2 * math.pi * hue_freq * t)))
        # –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º % 180 –Ω–∞ signed –º–∞—Å—Å–∏–≤–µ –∏ –æ—Å—Ç–∞—ë–º—Å—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0..179
        '''
‚Äî –î–æ–±–∞–≤–ª—è–µ–º —Å–¥–≤–∏–≥ –∫ –æ—Ç—Ç–µ–Ω–∫—É –∏ –∑–∞–≥–æ–Ω—è–µ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0..179.
–ò–Ω–∞—á–µ hue –≤ OpenCV —Å—Ö–æ–¥–∏—Ç —Å —É–º–∞.
        '''
        hsv[..., 0] = (hsv[..., 0] + hue_shift) % 180

        # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –Ω–µ–º–Ω–æ–≥–æ –ø–æ—Ç—Ä—è—Å—ë–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è –∂–∏–≤–æ—Å—Ç–∏
        '''
‚Äî –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ –∫–æ–ª–µ–±–∞–Ω–∏–π –≤ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ–± —Ü–≤–µ—Ç–∞ –∂–∏–≤–µ–µ —Å–º–æ—Ç—Ä–µ–ª–∏—Å—å.
–°—á–∏—Ç–∞–π, –∫—Ä–∞—Å–∫–∏ –¥—ã—à–∞—Ç —Ç—É–¥–∞-—Å—é–¥–∞.
        '''
        sat_variation = 1.0 + 0.25 * math.sin(t * 3.0 + progress * 5.0)
        hsv[..., 1] = np.clip((hsv[..., 1].astype(np.float32) * sat_variation), 0, 255).astype(np.int16)

        # –ü–µ—Ä–µ–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–∑–∞–¥ –≤ uint8
        '''
‚Äî –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—ë –æ–±—Ä–∞—Ç–Ω–æ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç uint8 –∏ —Å–Ω–æ–≤–∞ –≤ BGR.
        '''
        hsv = np.clip(hsv, 0, 255).astype(np.uint8)
        colored = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR)

        # 2) –ü–æ–ª–æ—Å–æ–≤–æ–π (slice) –≥–ª–∏—Ç—á: —Å–¥–≤–∏–≥–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –¥–ª—è –∫–∞–∂–¥—ã—Ö –ø–æ–ª–æ—Å
        '''
‚Äî –¢—É—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–ª–∏—Ç—á-–ø–æ–ª–æ—Å—ã.
–ë–µ—Ä—ë–º –ø–æ –∫—É—Å–∫–∞–º (—à–∏—Ä–∏–Ω–æ–π slice_width) –∏ —Å–¥–≤–∏–≥–∞–µ–º –∏—Ö –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –Ω–∞ —Å–ª—É—á–∞–π–Ω—É—é –≤–µ–ª–∏—á–∏–Ω—É.
–ò–∑-–∑–∞ cos —ç—Ç–∏ –ø–æ–ª–æ—Å—ã –¥—ë—Ä–≥–∞—é—Ç—Å—è —Ç—É–¥–∞-—Å—é–¥–∞.
        '''
        out = colored.copy()
        # –í–µ–∫—Ç–æ—Ä–∏–∑—É–µ–º: –ø–µ—Ä–µ–±–æ—Ä –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º —Å —à–∞–≥–æ–º slice_width
        for x in range(0, w, slice_width):
            x2 = min(w, x + slice_width)
            # shift –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º ‚Äì roll –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
            shift = int(round((10.0 * progress) * math.cos(t * slice_freq + x * 0.03)))
            if shift != 0:
                out[:, x:x2] = np.roll(out[:, x:x2], shift, axis=0)

        # 3) –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏—Å–ø–µ—Ä—Å–∏—è / —Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ X (–º–∏–Ω–∏ –≥–ª–∏—Ç—á)
        '''
‚Äî –†–∞–∑–¥–µ–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞: —Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∫—Ä–∞—Å–Ω—ã–π.
        '''
        b, g, r = cv2.split(out)
        # –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–¥–≤–∏–≥ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
        '''
‚Äî –°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∏ –¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã:
—Å–∏–Ω–∏–π —É—Ö–æ–¥–∏—Ç –≤–ø—Ä–∞–≤–æ, –∫—Ä–∞—Å–Ω—ã–π –≤–ª–µ–≤–æ.
–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞–∫ –±—É–¥—Ç–æ –ª–æ–º–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä–æ–º VHS.
        '''
        dx = int(round(channel_shift_max * (0.2 + 0.8 * progress) * math.sin(t * 2.5)))
        if dx != 0:
            b = np.roll(b, dx, axis=1)
            r = np.roll(r, -dx, axis=1)
        out = cv2.merge([b, g, r])

        # 4) –õ—ë–≥–∫–∏–µ —Å–∫–∞–Ω–ª–∞–π–Ω—ã –¥–ª—è "–≤–∏–¥–µ–æ—â—É–º–∞"
        '''
‚Äî –†–∏—Å—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏, –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞—Ö.
–ö–∞–∂–¥–∞—è –≤—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á—É—Ç—å —Ç–µ–º–Ω–µ–µ.
        '''
        if scanline_strength > 0:
            # –¥–µ–ª–∞–µ–º –∫–∞–∂–¥—ã–µ 2-–π –ø–∏–∫—Å–µ–ª–∏ —á—É—Ç—å —Ç–µ–º–Ω–µ–µ
            mask = np.ones((h, 1), dtype=np.float32)
            mask[::2, 0] = 1.0 - scanline_strength
            out = (out.astype(np.float32) * mask[:, :, None]).astype(np.uint8)

        # 5) –ù–µ–±–æ–ª—å—à–æ–π –ø–æ–ª–æ—Å–æ–≤–æ–π —Å–ª—É—á–∞–π–Ω—ã–π —à—É–º (–¥–ª—è –≥–ª–∏—Ç—á-—Å—Ç–∏–ª—è)
        '''
‚Äî –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–Ω–¥–æ–º–Ω—ã–π —à—É–º:
–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–∏–∫—Å–µ–ª—è—Ö —Ä–∞—Å–∫–∏–¥—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç -40 –¥–æ +40.
–≠—Ç–æ –ø—Ä–∏–¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç "–ø–æ–º–µ—Ö" –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
        '''
        if noise_amount > 0:
            noise_mask = (np.random.rand(h, w) < noise_amount)
            if noise_mask.any():
                # —Å–æ–∑–¥–∞—ë–º —à—É–º–Ω—ã–µ –ø–æ–ª–æ—Å—ã –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ-—Å–∂–∞—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                noise_vals = np.random.randint(-40, 41, size=(h, w, 1)).astype(np.int16)
                tmp = out.astype(np.int16)
                tmp += (noise_mask[:, :, None].astype(np.int16) * noise_vals)
                out = np.clip(tmp, 0, 255).astype(np.uint8)

        '''
–ö–æ—Ä–æ—á–µ, –±—Ä–∞—Ç–∞–Ω, —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç —Ç–∞–∫:
—Å–Ω–∞—á–∞–ª–∞ —Ü–≤–µ—Ç –ø–æ –∫—Ä—É–≥—É –±–µ–≥–∞–µ—Ç –∏ –ø–µ—Ä–µ–ª–∏–≤–∞–µ—Ç—Å—è,
–ø–æ—Ç–æ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã –¥—ë—Ä–≥–∞—é—Ç—Å—è,
–∫–∞–Ω–∞–ª—ã –∫—Ä–∞—Å–Ω—ã–π/—Å–∏–Ω–∏–π —Ä–∞–∑—ä–µ–∑–∂–∞—é—Ç—Å—è,
—Å–≤–µ—Ä—Ö—É –Ω–∞–∫–∏–¥—ã–≤–∞–µ—Ç—Å—è —Ä–µ—Ç—Ä–æ-—Ç–µ–ª–µ–≤–∏–∑–æ—Ä (–ø–æ–ª–æ—Å—ã),
–∞ –≤ –∫–æ–Ω—Ü–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç—Ä–µ—â–∏—Ç –æ—Ç —à—É–º–æ–≤. üí•üì∫
        '''
        return out

    def pixel_fly_out(self, frame, t, duration, pixel_size=8, max_disp_factor=1.2, star_chance=0.12):
        """
        –≠—Ñ—Ñ–µ–∫—Ç: –ø–∏–∫—Å–µ–ª–∏ —É–ª–µ—Ç–∞—é—Ç –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ –±–ª–æ–∫–∞ —Å –º—è–≥–∫–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π, –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è
        –º–µ—Ä—Ü–∞—é—â–∏–µ –∑–≤–µ–∑–¥—ã –∏ –ª—ë–≥–∫–∏–π ¬´—à–ª–µ–π—Ñ¬ª.
        - self: –æ–±—ä–µ–∫—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à (self._pf_cache)
        - frame: BGR uint8 image
        - t: —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        - duration: –æ–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        - pixel_size: —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ –ø–∏–∫—Å–µ–ª—è (–≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∏–ª—å)
        - max_disp_factor: –º–Ω–æ–∂–∏—Ç–µ–ª—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –∫–∞–¥—Ä–∞
        - star_chance: –±–∞–∑–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥—ã –≤ –±–ª–æ–∫–µ (—É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å)
        """

        h, w = frame.shape[:2]
        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (progress).
–î–µ–ª–∏–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è t –Ω–∞ duration, –∏ –∑–∞–∂–∏–º–∞–µ–º –æ—Ç 0 –¥–æ 1.
–ß—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –ø–ª–∞–≤–Ω–æ —à—ë–ª, –±–µ–∑ –≤—ã—Ö–æ–¥–∞ –∑–∞ —Ä–∞–º–∫–∏.
        '''
        progress = np.clip(float(t) / float(max(duration, 1e-9)), 0.0, 1.0)
        # ease-out (cubic)
        '''
–≠—Ç–æ "ease-out" ‚Äî –ø–ª–∞–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ü–µ.
–¢–∏–ø–∞ —Å–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä–æ –ø–∏–∫—Å–µ–ª–∏ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è, –ø–æ—Ç–æ–º ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ,
–∫–∞–∫ –ø–∞—Ü–∞–Ω, —á—Ç–æ –±–µ–≥–∞–ª –æ—Ç –º–µ–Ω—Ç–æ–≤, –∞ –ø–æ—Ç–æ–º –ø–æ–¥—É—Å—Ç–∞–ª.
        '''
        eased = 1 - (1 - progress) ** 3

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ (–≤–µ–∫—Ç–æ—Ä—ã –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞, —Ñ–ª–∞–≥–∏ –∑–≤—ë–∑–¥)
        '''
–¢—É—Ç –º—É—Ç–∏–º –∫—ç—à ‚Äî —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ –ø–∏–∫—Å–µ–ª–∏, —á—Ç–æ–± –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ç—å.
–ï—Å–ª–∏ –∫—ç—à–∞ –µ—â—ë –Ω–µ—Ç, –∏–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –∫–∞–¥—Ä–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞–Ω–æ–≤–æ.
        '''
        if not hasattr(self, "_pf_cache") or self._pf_cache.get("shape") != (h, w, pixel_size):
            '''
–°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å cache –∏ —Ç—É–¥–∞ –∫–∏–¥–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã.
–¢–∏–ø–∞ "–ø–∞—Å–ø–æ—Ä—Ç" –¥–ª—è –∫—ç—à–∞.
            '''
            cache = {}
            cache["shape"] = (h, w, pixel_size)
            # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
            '''
–°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (bh) –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (bw).
–¢–æ –µ—Å—Ç—å –Ω–∞ —Å–∫–æ–ª—å–∫–æ "–∫–∏—Ä–ø–∏—á–∏–∫–æ–≤" —Ä–∞–∑—Ä–µ–∂–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É.
            '''
            bh = (h + pixel_size - 1) // pixel_size
            bw = (w + pixel_size - 1) // pixel_size
            # –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º numpy RNG —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∏–¥–æ–º, –∑–∞–≤–∏—Å—è—â–∏–º –æ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤
            '''
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ —Ä–∞–∑–º–µ—Ä—É –∫–∞–¥—Ä–∞.
–ß—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞,
–∞ –Ω–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤—ã–π —Ö–∞–æ—Å.
            '''
            rng = np.random.RandomState(abs(h * 1231 + w * 7919) % (2**31 - 1))
            '''
–ö–∞–∂–¥–æ–º—É –±–ª–æ–∫—É –∑–∞–¥–∞—ë–º —É–≥–æ–ª, –∫—É–¥–∞ –æ–Ω –±—É–¥–µ—Ç –ª–µ—Ç–µ—Ç—å.
–í —Ä–∞–¥–∏–∞–Ω–∞—Ö, –æ—Ç -œÄ –¥–æ œÄ.
            '''
            angles = rng.uniform(-math.pi, math.pi, size=(bh, bw)).astype(np.float32)
            # –±–∞–∑–æ–≤–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –¥–ª—è –±–ª–æ–∫–∞ (—á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –≤—ã–ª–µ—Ç–∞–ª–æ –∑–∞ –∫–∞–¥—Ä)
            '''
–°—á–∏—Ç–∞–µ–º –¥–∏–∞–≥–æ–Ω–∞–ª—å –∫–∞—Ä—Ç–∏–Ω–∫–∏, —Ç–∏–ø–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ.
–ò —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ‚Äî —ç—Ç–æ –ª–∏–º–∏—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–ª–µ–∫–æ –∫—É—Å–∫–∏ –º–æ–≥—É—Ç —É–ª–µ—Ç–µ—Ç—å.
            '''
            diag = math.hypot(w, h)
            max_disp = max_disp_factor * diag
            # —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏–º —Ä–∞–∑–Ω—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏: –Ω–µ–±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –º–µ–ª–∫–æ–º–æ—Ç–æ—Ä–Ω–∞—è, —á–∞—Å—Ç—å —Å–∏–ª—å–Ω–æ —É–ª–µ—Ç–∞–µ—Ç
            '''
–°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑–ª—ë—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞: –æ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –¥–æ –¥–∏–∫–æ–≥–æ.
–ß–∞—Å—Ç—å –ø–∏–∫—Å–µ–ª–µ–π —á—É—Ç—å –¥–µ—Ä–Ω–µ—Ç—Å—è, —á–∞—Å—Ç—å ‚Äî —É–ª–µ—Ç–∏—Ç –¥–∞–ª–µ–∫–æ.
            '''
            speeds = rng.uniform(0.15, 1.0, size=(bh, bw)).astype(np.float32) * max_disp
            # —Ñ–ª–∞–≥–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥—ã –∏ –∏—Ö —Ñ–∞–∑—ã/—è—Ä–∫–æ—Å—Ç–∏
            '''
–ó–∞–¥–∞—ë–º, –≥–¥–µ –º–æ–≥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–≤—ë–∑–¥—ã. –¢–æ–ª—å–∫–æ –≤ —á–∞—Å—Ç–∏ –±–ª–æ–∫–æ–≤ (0.25).
–ê –µ—â—ë ‚Äî —Ñ–∞–∑—ã –∑–≤—ë–∑–¥, —á—Ç–æ–± –º–µ—Ä—Ü–∞–ª–∏ –ø–æ-—Ä–∞–∑–Ω–æ–º—É.
            '''
            star_flags = rng.rand(bh, bw) < 0.25  # —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±–ª–æ–∫–∞—Ö –≤–æ–æ–±—â–µ –≤–æ–∑–º–æ–∂–Ω—ã –∑–≤—ë–∑–¥—ã
            star_phases = rng.uniform(0.8, 1.4, size=(bh, bw)).astype(np.float32)
            cache["angles"] = angles
            cache["speeds"] = speeds
            cache["star_flags"] = star_flags
            cache["star_phases"] = star_phases
            cache["bh"] = bh
            cache["bw"] = bw
            cache["rng"] = rng  # —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –±—ã–ª–æ –≥–µ–Ω–µ—Ä–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
            '''
–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë —ç—Ç–æ –¥–æ–±—Ä–æ –≤ –æ–±—ä–µ–∫—Ç, —á—Ç–æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ç–æ–º.
            '''
            self._pf_cache = cache
        else:
            cache = self._pf_cache

        bh = cache["bh"]
        bw = cache["bw"]
        angles = cache["angles"]
        speeds = cache["speeds"]
        star_flags = cache["star_flags"]
        star_phases = cache["star_phases"]
        rng = cache["rng"]

        # —Å–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è remap (map_x, map_y) ‚Äî —Ç–∏–ø float32
        # grid –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (x,y) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è (map expects map_x for cols)
        grid_x, grid_y = np.meshgrid(np.arange(w, dtype=np.float32), np.arange(h, dtype=np.float32))

        # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ –≤—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö) –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤ —Å–º–µ—â–µ–Ω–∏–π
        disp_x = np.zeros((h, w), dtype=np.float32)
        disp_y = np.zeros((h, w), dtype=np.float32)
        #–î–∞–ª—å—à–µ –∏–¥—ë—Ç –±–ª–æ–∫ —Å —Ü–∏–∫–ª–∞–º–∏, –≥–¥–µ –ø–∏–∫—Å–µ–ª–∏ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è:
        '''
–¢—É—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ (dx, dy) –ø–æ —É–≥–ª—É –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏.
–¢–æ –µ—Å—Ç—å –≤ –∫–∞–∫—É—é —Å—Ç–æ—Ä–æ–Ω—É –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω —É–ª–µ—Ç–∏—Ç.
–ò –∑–∞–Ω–æ—Å–∏–º —ç—Ç–æ –≤ –∫–∞—Ä—Ç—ã —Å–º–µ—â–µ–Ω–∏–π.
        '''
        for by in range(bh):
            y0 = by * pixel_size
            y1 = min(h, y0 + pixel_size)
            for bx in range(bw):
                x0 = bx * pixel_size
                x1 = min(w, x0 + pixel_size)
                ang = angles[by, bx]
                spd = speeds[by, bx]
                # –∏—Å—Ç–∏–Ω–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç eased –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                dx = math.cos(ang) * spd * eased
                dy = math.sin(ang) * spd * eased
                disp_y[y0:y1, x0:x1] = float(dy)
                disp_x[y0:y1, x0:x1] = float(dx)

        # –î–ª—è remap: –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (u,v) –±–µ—Ä–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ (u - dx, v - dy)
        '''
remap –¥–µ–ª–∞–µ—Ç –º–∞–≥–∏—é: –±–µ—Ä—ë—Ç –ø–∏–∫—Å–µ–ª–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞,
—Å–¥–≤–∏–≥–∞–µ—Ç –ø–æ –Ω–∞—à–∏–º —Å–º–µ—â–µ–Ω–∏—è–º, –∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–ª–µ—Ç–∞—é—â–∏—Ö—Å—è –ø–∏–∫—Å–µ–ª–µ–π.
        '''
        map_x = (grid_x - disp_x).astype(np.float32)
        map_y = (grid_y - disp_y).astype(np.float32)

        # –†–µ–º–∞–ø–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–µ–ª–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –≥–ª–∞–¥–∫–∏–º)
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤–æ float32 –¥–ª—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–≥–æ —Å–ª–æ–∂–µ–Ω–∏—è —Å–æ –∑–≤—ë–∑–¥–∞–º–∏
        frame_f = frame.astype(np.float32)
        remapped = cv2.remap(frame_f, map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_CONSTANT, borderValue=0)

        # –°–æ–∑–¥–∞—ë–º —Å–ª–æ–π –∑–≤—ë–∑–¥–æ—á–µ–∫
        '''
–ü—É—Å—Ç–æ–π —Å–ª–æ–π –ø–æ–¥ –∑–≤—ë–∑–¥—ã.
        '''
        star_layer = np.zeros_like(frame_f)
        # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥—ã —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        cur_star_prob = star_chance * progress
        # –¥–æ–±–∞–≤–ª—è–µ–º –∑–≤—ë–∑–¥—ã –≤ —Ü–µ–Ω—Ç—Ä –±–ª–æ–∫–æ–≤ (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ñ–∞–∑–∞ –¥–∞—é—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ)
        for by in range(bh):
            y0 = by * pixel_size
            y1 = min(h, y0 + pixel_size)
            cy = (y0 + y1) / 2.0
            for bx in range(bw):
                if not star_flags[by, bx]:
                    continue
                '''
–¢—É—Ç –∑–≤–µ–∑–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–µ –≤—Å–µ–≥–¥–∞ ‚Äî –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏.
–¢–∏–ø–∞ "–ø–æ —Ñ–∞—Ä—Ç—É –ø–æ–≤–µ–∑—ë—Ç ‚Äî –±—É–¥–µ—Ç –∑–≤–µ–∑–¥–∞, –Ω–µ—Ç ‚Äî —Ç–∞–∫ –Ω–µ—Ç".
                '''
                if rng.rand() > cur_star_prob:
                    continue
                x0 = bx * pixel_size
                x1 = min(w, x0 + pixel_size)
                cx = (x0 + x1) / 2.0
                # –≤—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∑–≤–µ–∑–¥—ã (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –∏ –¥–ª—è –ø–∏–∫—Å–µ–ª–µ–π)
                ang = angles[by, bx]
                spd = speeds[by, bx]
                dx = math.cos(ang) * spd * eased
                dy = math.sin(ang) * spd * eased
                dst_x = int(np.clip(cx + dx, 0, w - 1))
                dst_y = int(np.clip(cy + dy, 0, h - 1))
                # —è—Ä–∫–æ—Å—Ç—å –∏ —Ä–∞–¥–∏—É—Å –∑–≤–µ–∑–¥—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ñ–∞–∑—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                phase = star_phases[by, bx]
                br = float(180.0 * min(1.0, 0.6 + 0.6 * progress) * phase)
                radius = max(1, int(pixel_size * (0.6 + 0.8 * progress)))
                # —Ä–∏—Å—É–µ–º –±–µ–ª—É—é –∑–≤–µ–∑–¥—É (additive)
                '''
–†–∏—Å—É–µ–º –±–µ–ª—É—é –∑–≤–µ–∑–¥—É –∫—Ä—É–∂–æ—á–∫–æ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–ª–æ–µ.
–Ø—Ä–∫–æ—Å—Ç—å –∏ —Ä–∞–¥–∏—É—Å –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
                '''
                cv2.circle(star_layer, (dst_x, dst_y), radius, (br, br, br), -1, lineType=cv2.LINE_AA)

        # –ú—è–≥–∫–æ —Ä–∞–∑–º—ã–≤–∞–µ–º —Å–ª–æ–π –∑–≤—ë–∑–¥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–≤–µ—á–µ–Ω–∏—è
        if progress > 0.02:
            glow_sigma = max(1.0, 2.0 + 8.0 * progress)
            '''
–†–∞–∑–º—ã–≤–∞–µ–º –∑–≤—ë–∑–¥—ã, —á—Ç–æ–±—ã —Å–≤–µ—Ç–∏–ª–∏—Å—å, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–æ—á–∫–∏ –±—ã–ª–∏.
            '''
            star_layer = cv2.GaussianBlur(star_layer, ksize=(0, 0), sigmaX=glow_sigma, sigmaY=glow_sigma)

        # –õ—ë–≥–∫–∏–π —à–ª–µ–π—Ñ / –ø–æ–¥—Å–≤–µ—Ç–∫–∞: —Å–º–µ—à–∏–≤–∞–µ–º —Ä–∞–∑–º—ã—Ç—É—é –≤–µ—Ä—Å–∏—é –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞
        '''
–î–µ–ª–∞–µ–º "—à–ª–µ–π—Ñ" ‚Äî —Ä–∞–∑–º—ã—Ç—É—é –∫–æ–ø–∏—é –∫–∞–¥—Ä–∞, —Å–º–µ—à–∏–≤–∞–µ–º –µ—ë —Å –æ—Å–Ω–æ–≤–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º –∏ –∑–≤—ë–∑–¥–∞–º–∏.
–í—ã—Ö–æ–¥–∏—Ç –∫—Ä–∞—Å–∏–≤–æ: —Ä–∞–∑–ª—ë—Ç + —Å–∏—è–Ω–∏–µ + –¥–≤–∏–∂–µ–Ω–∏–µ.
        '''
        trail = cv2.GaussianBlur(frame_f, ksize=(0, 0), sigmaX=3.0 + 12.0 * progress)
        trail_alpha = 0.08 + 0.4 * eased  # —á–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —Ç–µ–º –∑–∞–º–µ—Ç–Ω–µ–µ —à–ª–µ–π—Ñ
        # –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º: remapped + star_layer (–∞–¥–¥–∏—Ç–∏–≤–Ω–æ) + trail (—Å–ª–∞–±–∞—è –Ω–∞–ª–æ–∂–µ–Ω–Ω–∞—è —Å–º–µ—Å—å)
        combined = remapped * (1.0 - 0.15 * eased) + trail * (0.15 * eased) + star_layer

        # –ü–æ –º–µ—Ä–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–µ–º–Ω–æ–≥–æ –∑–∞—Ç–µ–º–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –æ–±–ª–∞—Å—Ç–∏ (–ø–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–∞–Ω–∏–µ)
        '''
–ù–∞ —Ñ–∏–Ω–∞–ª–µ —ç—Ñ—Ñ–µ–∫—Ç –∑–∞—Ç—É—Ö–∞–µ—Ç, —Ç–∏–ø–∞ –ø–∏–∫—Å–µ–ª–∏ –∏—Å—á–µ–∑–∞—é—Ç,
–∞ –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á—É—Ç—å –ø—Ä–æ—Å—Ç—É–ø–∞–µ—Ç.
        '''
        fade_out = 1.0 - 0.8 * eased
        combined = combined * fade_out + frame_f * (1.0 - fade_out) * 0.6

        # –ö–ª–∏–ø –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ uint8
        '''
–û–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –≤—ã—à–ª–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã 0‚Äì255,
–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        '''
        combined = np.clip(combined, 0, 255).astype(np.uint8)
        return combined

    def hologram_flicker(self, frame, t, duration):
        '''
–ó–∞–±–∏—Ä–∞–µ–º —É –∫–∞–¥—Ä–∞ –≤—ã—Å–æ—Ç—É –∏ —à–∏—Ä–∏–Ω—É, —Ç–∏–ø–∞ —Ä–∞–∑–º–µ—Ä—ã –Ω–∞—à–µ–π –º–∞–ª—è–≤—ã.
        '''
        h, w = frame.shape[:2]
        '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ñ—Ñ–µ–∫—Ç–∞: –¥–µ–ª–∏–º –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è t –Ω–∞ –≤—Å—ë –≤—Ä–µ–º—è duration.
max(duration, 1e-6) ‚Äî —á—Ç–æ–± –Ω–µ –¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–æ–ª—å.
np.clip(..., 0.0, 1.0) ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, —á—Ç–æ–± –æ–Ω –±—ã–ª —Å—Ç—Ä–æ–≥–æ –æ—Ç 0 –¥–æ 1.
–ö–æ—Ä–æ—á–µ, –ø–æ–ª—É—á–∞–µ–º: 0 = –Ω–∞—á–∞–ª–æ, 1 = –∫–æ–Ω–µ—Ü.
        '''
        progress = float(np.clip(t / float(max(duration, 1e-6)), 0.0, 1.0))

        # –ö–æ–ø–∏—Ä—É–µ–º –∫–∞–¥—Ä –≤ float –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        '''
–î–µ–ª–∞–µ–º –∫–æ–ø–∏—é –∫–∞–¥—Ä–∞, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Ç–∏–ø float32 –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0..1].
–≠—Ç–æ —á—Ç–æ–± –¥–∞–ª—å—à–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π –∂–æ–Ω–≥–ª–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –ø–æ—Ç–µ—Ä—å.
        '''
        f = frame.astype(np.float32) / 255.0

        # ------------------------
        # 1) –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–∏–Ω–∏–π/—Ü–∏–∞–Ω–æ–≤—ã–π —Ç–∏–Ω—Ç
        # ------------------------
        # BGR: –¥–µ–ª–∞–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–∏–Ω–∏–π –∏ —á—É—Ç—å –ø—É—Ä–ø—É—Ä–Ω—ã–π –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≥–æ–ª–æ–≥—Ä–∞–º–º—ã
        tint_color = np.array([0.95, 0.35, 0.9], dtype=np.float32)  # B, G, R (0..1)
        '''
–ê–ª—å—Ñ–∞-–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å ‚Äî —á–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ü–≤–µ—Ç–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä.
        '''
        base_alpha = 0.12 + 0.25 * progress  # —É—Å–∏–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É
        # –Ω–µ–±–æ–ª—å—à–æ–π —Ñ–ª–∏–∫–µ—Ä –≤ –∞–ª—å—Ñ–µ
        '''
–°—é–¥–∞ –¥–æ–±–∞–≤–∏–ª–∏ —Ñ–ª–∏–∫–µ—Ä (–º–∏–≥–∞–Ω–∏–µ).
–ë–µ—Ä—ë–º —Å–∏–Ω—É—Å –æ—Ç –≤—Ä–µ–º–µ–Ω–∏, –ø–ª—é—Å —Ä–∞–Ω–¥–æ–º, —á—Ç–æ–± –¥—Ä–æ–∂–∞–ª–æ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É, –∫–∞–∫ –±—É–¥—Ç–æ –ø–æ–º–µ—Ö–∏.
        '''
        alpha = base_alpha * (1.0 + 0.06 * math.sin(t * 12.0 + random.random() * 6.28))
        '''
–°–æ–∑–¥–∞—ë–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π —Å–ª–æ–π ‚Äî –≤–µ—Å—å –∑–∞–∫—Ä–∞—à–µ–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç.
        '''
        overlay = np.ones_like(f) * tint_color
        '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ —Ü–≤–µ—Ç–Ω–æ–π —Å–ª–æ–π. –ß–µ–º –≤—ã—à–µ alpha, —Ç–µ–º –±–æ–ª—å—à–µ —Å–∏–Ω–µ–≤—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
        '''
        f = cv2.addWeighted(f, 1.0 - alpha, overlay, alpha, 0.0)

        # ------------------------
        # 2) –õ—ë–≥–∫–∏–π —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–¥–≤–∏–≥ (cheap chromatic aberration)
        # ------------------------
        # –°–¥–≤–∏–≥ –∫–∞–∂–¥–æ–π –∫–∞–Ω–∞–ª–∞ –ø–æ x –Ω–µ–º–Ω–æ–≥–æ: –∑–µ–ª—ë–Ω—ã–π/–∫—Ä–∞—Å–Ω—ã–π –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ
        '''
–ß–µ–º –¥–∞–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã (—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è, —Ç–∏–ø–∞ —Ü–≤–µ—Ç–Ω—ã–µ –ø–æ–ª–æ—Å—ã).
        '''
        max_shift = int(6 * progress)  # –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –ø–∏–∫—Å–µ–ª–µ–π
        '''
–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫—Ä–∞—Å–Ω—ã–π –∏ —Å–∏–Ω–∏–π –∫–∞–Ω–∞–ª—ã —Å–º–µ—â–∞—é—Ç—Å—è –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
–ó–µ–ª—ë–Ω—ã–π –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ —Å—ä–µ–∑–∂–∞–ª–∞ —Å–æ–≤—Å–µ–º.
        '''
        if max_shift > 0:
            shift_r = int((max_shift) * (0.5 + 0.5 * math.sin(t * 7.0)))
            shift_b = -int((max_shift) * (0.5 + 0.5 * math.cos(t * 6.0)))
            # —Å–æ–∑–¥–∞—ë–º –∫–æ–ø–∏–∏ –∫–∞–Ω–∞–ª–æ–≤ –∏ —Å–º–µ—â–∞–µ–º
            '''
–ë–µ—Ä—ë–º –∫–∞–∂–¥—ã–π —Ü–≤–µ—Ç–æ–≤–æ–π –∫–∞–Ω–∞–ª, —Å–¥–≤–∏–≥–∞–µ–º, –∏ –ø–æ—Ç–æ–º —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ.
–ò –≤—É–∞–ª—è ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞–∫ –±—É–¥—Ç–æ –±—å—ë—Ç—Å—è —Ü–≤–µ—Ç–Ω—ã–º–∏ —Ç–µ–Ω—è–º–∏ –ø–æ –∫—Ä–∞—è–º.
            '''
            b_ch = np.roll(f[:, :, 0], shift_b, axis=1)
            g_ch = np.roll(f[:, :, 1], 0, axis=1)
            r_ch = np.roll(f[:, :, 2], shift_r, axis=1)
            f = np.stack([b_ch, g_ch, r_ch], axis=2)

        # ------------------------
        # 3) –°–∫–∞–Ω–ª–∞–π–Ω—ã (cheap)
        # ------------------------
        '''
–°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ ‚Äî –±—É–¥–µ–º –ø–æ –Ω–∏–º –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å "—Å–∫–∞–Ω–ª–∞–π–Ω—ã".
        '''
        y = np.arange(h, dtype=np.float32)[:, None]
        '''
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏–ª—É, —á–∞—Å—Ç–æ—Ç—É –∏ —Ñ–∞–∑—É –ø–æ–ª–æ—Å ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç –º–∏–≥–∞—Ç—å –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏, –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–µ–ª–∏–∫–∞—Ö.
        '''
        scan_strength = 0.04 + 0.08 * progress
        scan_freq = 1.5 + 2.5 * progress
        scan_phase = t * 40.0
        '''
–°—á–∏—Ç–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–ª–æ—Å–æ—á–µ–∫.
        '''
        scan = 1.0 - scan_strength * (0.5 + 0.5 * np.sin(y * scan_freq + scan_phase))
        # Broadcasting –ø–æ —à–∏—Ä–∏–Ω–µ –∏ –∫–∞–Ω–∞–ª–∞–º
        '''
–£–º–Ω–æ–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —ç—Ç–∏ –ø–æ–ª–æ—Å–∫–∏ ‚Äî –≤–æ—Ç —Ç–µ–±–µ –∏ —Å–∫–∞–Ω–ª–∞–π–Ω—ã.
        '''
        f *= scan[:, :, None]

        # ------------------------
        # 4) –õ—ë–≥–∫–∏–π —à—É–º / ¬´–ø–æ–º–µ—Ö–∏¬ª
        # ------------------------
        '''
–î–æ–±–∞–≤–ª—è–µ–º —à—É–º, –∫–∞–∫ –±—É–¥—Ç–æ –ø–æ–º–µ—Ö–∏ –ø–æ —ç–∫—Ä–∞–Ω—É –±–µ–≥–∞—é—Ç.
–®—É–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤, —á—Ç–æ–± –Ω–µ —Ä—è–±–∏–ª–æ –¥–∏–∫–æ.
        '''
        noise_strength = 0.02 + 0.06 * progress
        noise = (np.random.randn(h, w, 1).astype(np.float32)) * noise_strength
        f += noise  # —à—É–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ (–º–æ–∂–Ω–æ —Ä–∞–∑–Ω–µ—Å—Ç–∏, –Ω–æ –¥–æ—Ä–æ–∂–µ)

        # ------------------------
        # 5) –ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π —Å–¥–≤–∏–≥ (ghosting) ‚Äî –¥–µ–ª–∞–µ—Ç —Å–ª–æ–∏—Å—Ç–æ—Å—Ç—å –≥–æ–ª–æ–≥—Ä–∞–º–º—ã
        # ------------------------
        '''
–°–∏–ª–∞ "–ø—Ä–∏–∑—Ä–∞—á–Ω–æ–≥–æ —Å–¥–≤–∏–≥–∞". –ß–µ–º –¥–æ–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –±–æ–ª—å—à–µ –ø—Ä–∏–∑—Ä–∞–∫ –∑–∞–º–µ—Ç–µ–Ω.
        '''
        ghost_alpha = 0.10 * progress
        '''
–°–æ–∑–¥–∞—ë–º –∫–æ–ø–∏—é –∫–∞–¥—Ä–∞, —á—É—Ç—å —Å–º–µ—â–∞–µ–º –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ–≤–µ—Ä—Ö —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é.
–í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –±—É–¥—Ç–æ –¥–≤–æ–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä—è–º –≥–æ–ª–æ–≥—Ä–∞–º–º–Ω—ã–π —Å—Ç–∏–ª—å.
        '''
        if ghost_alpha > 0.003:
            ghost_shift = int(10 * progress * (0.5 + 0.5 * math.sin(t * 3.3)))
            ghost = np.roll(f, ghost_shift, axis=1)
            f = cv2.addWeighted(f, 1.0, ghost, ghost_alpha, 0.0)

        # ------------------------
        # 6) –†–∞–∑—Ä–µ–∑—ã/—Å–¥–≤–∏–≥–∏ –ø–æ –ø–æ–ª–æ—Å–∞–º (–≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ —Å —Ä–µ–¥–∫–∏–º —à–∞–≥–æ–º)
        # ------------------------
        '''
–®–∞–≥ –∏ –∞–º–ø–ª–∏—Ç—É–¥–∞ –¥–ª—è –ø–æ–ª–æ—Å–æ–≤—ã—Ö —Å–¥–≤–∏–≥–æ–≤. –¢–∏–ø–∞ —Ä—è–±—å, –∫–æ—Ç–æ—Ä–∞—è –ª–æ–º–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –∫—É—Å–∫–∞–º–∏.
        '''
        step = 8  # —à–∞–≥ –ø–æ–ª–æ—Å –≤ –ø–∏–∫—Å–µ–ª—è—Ö ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å, —á—Ç–æ–±—ã –±—ã–ª–æ –µ—â—ë –ª–µ–≥—á–µ
        amp = max(1, int(12 * progress))
        # –ø–µ—Ä–µ–±–æ—Ä –ø–æ–ª–æ—Å, –Ω–æ —à–∞–≥ —É–≤–µ–ª–∏—á–µ–Ω ‚Äî –¥–µ—à—ë–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
        '''
–î–≤–∏–≥–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∫—É—Å–∫–∞–º–∏ (–ø–æ –ø–æ–ª–æ—Å–∞–º).
–ö–∞–∂–¥–∞—è –ø–æ–ª–æ—Å–∞ –≥—É–ª—è–µ—Ç —Å–∞–º–∞ –ø–æ —Å–µ–±–µ, —Å–æ–∑–¥–∞–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑—Ä—ã–≤–∞ —Å–∏–≥–Ω–∞–ª–∞.
        '''
        for y0 in range(0, h, step):
            # –Ω–µ–±–æ–ª—å—à–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã
            local_shift = int(amp * math.sin(t * 6.0 + y0 * 0.08 + random.random() * 2.0))
            if local_shift != 0:
                f[y0:y0 + step, :, :] = np.roll(f[y0:y0 + step, :, :], local_shift, axis=1)

        # ------------------------
        # 7) –£–º–µ—Ä–µ–Ω–Ω–∞—è –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –Ω–µ–¥–æ—Ä–æ–≥–æ)
        # ------------------------
        '''
–ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç —É–∂–µ –¥–∞–ª–µ–∫–æ –∑–∞—à—ë–ª (60%+), –Ω–∞—á–∏–Ω–∞–µ–º –ø–∏–∫—Å–µ–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–¥—Ä.
factor ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ —Å–∂–∏–º–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        if progress > 0.6:
            # —Ñ–∞–∫—Ç–æ—Ä –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è 0.6..0.3
            factor = 1.0 - 0.5 * ((progress - 0.6) / 0.4)
            factor = float(np.clip(factor, 0.3, 1.0))
            '''
–°–∂–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –æ–±—Ä–∞—Ç–Ω–æ —Ä–∞—Å—Ç—è–Ω—É–ª–∏ ‚Äî –ø–æ–ª—É—á–∏–ª–∞—Å—å –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è, –∫–∞–∫ –±—É–¥—Ç–æ —Å–∏–≥–Ω–∞–ª —Å–æ–≤—Å–µ–º —Å—ã–ø–µ—Ç—Å—è.
            '''
            if factor < 0.99:
                small_w = max(2, int(w * factor))
                small_h = max(2, int(h * factor))
                small = cv2.resize((f * 255.0).astype(np.uint8), (small_w, small_h), interpolation=cv2.INTER_LINEAR)
                f = cv2.resize(small, (w, h), interpolation=cv2.INTER_NEAREST).astype(np.float32) / 255.0

        # ------------------------
        # 8) –§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —è—Ä–∫–æ—Å—Ç–∏/—Ñ–ª–∏–∫–µ—Ä
        # ------------------------
        '''
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–ª–∏–∫–µ—Ä: –∏–Ω–æ–≥–¥–∞ —è—Ä–∫–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç/–ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è, –∫–∞–∫ –±—É–¥—Ç–æ –ª–∞–º–ø–∞ –º–æ—Ä–æ—Å–∏—Ç.
        '''
        flicker = 1.0
        if random.random() < 0.5 + 0.5 * progress:
            flicker *= 0.9 + 0.2 * random.random()
        # –Ω–µ–±–æ–ª—å—à–æ–π –ø—É–ª—å—Å
        '''
–î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é —è—Ä–∫–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ —Å–∏–Ω—É—Å.
        '''
        flicker *= 1.0 + 0.03 * math.sin(t * 18.0)
        '''
–ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ç–æ—Ç —Ñ–ª–∏–∫–µ—Ä –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ, –Ω–æ –∑–∞–∂–∏–º–∞–µ–º –≤—Å—ë –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0..1].
        '''
        f = np.clip(f * flicker, 0.0, 1.0)

        '''
–§–∏–Ω–∞–ª–æ—á–∫–∞: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π uint8 (0..255).
üëä –í—Å—ë, –±—Ä–∞—Ç–∞–Ω, —Ä–∞–∑–æ–±—Ä–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é –ø–æ –∫–æ—Å—Ç–æ—á–∫–∞–º.
        '''
        return (f * 255.0).astype(np.uint8)

    def fireworks_overlay(self, frame, t, duration):
        h, w = frame.shape[:2]
        progress = float(np.clip(t / float(max(duration, 1e-6)), 0.0, 1.0))

        base = frame.astype(np.float32) / 255.0
        '''
–°–æ–∑–¥–∞–ª–∏ –ø—É—Å—Ç–æ–π —Å–ª–æ–π ‚Äî —Å—é–¥–∞ –±—É–¥–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏.
        '''
        overlay = np.zeros_like(base, dtype=np.float32)

        # --- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–≤ (–ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å) ---
        '''
–ß–µ–º –¥–∞–ª—å—à–µ –∏–¥—ë–º, —Ç–µ–º –±–æ–ª—å—à–µ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–≤. –ú–∞–∫—Å–∏–º—É–º ‚Äî 8.
        '''
        max_fireworks = min(8, 1 + int(progress * 6))
        '''
–ë–∞–∑–∞ –∏—Å–∫—Ä —É –∫–∞–∂–¥–æ–π —Ä–∞–∫–µ—Ç—ã.
        '''
        sparks_base = 8
        '''
–†–∞–¥–∏—É—Å –≤–∑—Ä—ã–≤–∞ —Ä–∞—Å—Ç—ë—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.
        '''
        radius_scale = 0.08 + 0.20 * progress

        '''
–¶–∏–∫–ª ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∞.
        '''
        for i in range(max_fireworks):
            '''
–®–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∞: —á–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å.
–í –Ω–∞—á–∞–ª–µ –º–∞–ª–æ, –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É ‚Äî –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –±–∞—Ö–∞–µ—Ç.
            '''
            if random.random() > 0.25 + 0.75 * progress:
                continue
            '''
–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–¥–∏—É—Å —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∞.
–ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π (<6 –ø–∏–∫—Å–µ–ª–µ–π) ‚Äî —Å–∫–∏–ø–∞–µ–º, –æ–Ω –±—É–¥–µ—Ç –Ω–µ–≤–∏–¥–∏–º.
            '''
            radius = int(min(w, h) * radius_scale * (0.8 + 0.8 * random.random()))
            if radius < 6:
                continue
            '''
–°–ª—É—á–∞–π–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ (—á—Ç–æ–± —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ –±—ã–ª –≥–¥–µ-—Ç–æ —Å–≤–µ—Ä—Ö—É, –Ω–µ —É –∑–µ–º–ª–∏).
            '''
            cx = random.randint(radius, w - radius - 1)
            cy = random.randint(int(h * 0.05), max(radius, int(h * 0.55)))
            '''
–°–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º, —á—Ç–æ–± –Ω–µ –±—ã–ª —Å–ª–∏—à–∫–æ–º —Ç—ë–º–Ω—ã–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —è—Ä–∫–∏–π.
–î–æ–º–Ω–æ–∂–∞–µ–º –Ω–∞ 0.6 ‚Äî –ø—Ä–∏–≥–ª—É—à–∞–µ–º —á—É—Ç–æ–∫.
            '''
            col = np.array([random.random(), random.random(), random.random()], dtype=np.float32)
            col = 0.6 * col / (col.max() + 1e-6)
            '''
–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å–≤–µ—á–µ–Ω–∏—è, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
            '''
            intensity = 0.6 + 1.4 * random.random() * progress

            '''
–ó–æ–Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç–∞, –≥–¥–µ –±—É–¥–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å –∫—Ä—É–≥ –≤–∑—Ä—ã–≤–∞.
            '''
            x0, x1 = max(0, cx - radius), min(w, cx + radius + 1)
            y0, y1 = max(0, cy - radius), min(h, cy + radius + 1)
            '''
–ú–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤–Ω—É—Ç—Ä–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞.
            '''
            ys = np.arange(y0, y1, dtype=np.float32)[:, None]
            xs = np.arange(x0, x1, dtype=np.float32)[None, :]
            '''
–°—á–∏—Ç–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ (—Ä–∞–¥–∏–∞–ª—å–Ω–∞—è –º–∞—Å–∫–∞).
            '''
            dist = np.sqrt((xs - float(cx)) ** 2 + (ys - float(cy)) ** 2)
            '''
–°–æ–∑–¥–∞—ë–º –º–∞—Å–∫—É –¥–ª—è –∫—Ä—É–≥–ª–æ–≥–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞: –≤ —Ü–µ–Ω—Ç—Ä–µ —è—Ä–∫–æ, –∫ –∫—Ä–∞—é ‚Äî —Ç–µ–º–Ω–µ–µ—Ç.
–°—Ç–µ–ø–µ–Ω—å 1.8 –¥–µ–ª–∞–µ—Ç –∫—Ä–∞—è –º—è–≥—á–µ.
            '''
            mask = np.clip(1.0 - dist / float(radius), 0.0, 1.0)
            mask = mask ** 1.8
            '''
–ö—Ä–∞—Å–∏–º –æ–±–ª–∞—Å—Ç—å –ø–æ–¥ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ –≤ –Ω—É–∂–Ω—ã–π —Ü–≤–µ—Ç.
            '''
            for ch in range(3):
                overlay[y0:y1, x0:x1, ch] += (col[ch] * intensity) * mask

            '''
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–∫—Ä = –±–∞–∑–æ–≤–æ–µ + –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
            '''
            n_sparks = int(sparks_base + 10 * progress)
            '''
–ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª –¥–ª—è –∏—Å–∫—Ä ‚Äî —Ä–∞–Ω–¥–æ–º.
            '''
            base_angle = random.random() * 2.0 * math.pi
            '''
–¶–∏–∫–ª –¥–ª—è –∫–∞–∂–¥–æ–π –∏—Å–∫—Ä—ã.
            '''
            for s in range(n_sparks):
                '''
–ö–∞–∂–¥–æ–π –∏—Å–∫—Ä–µ —Å–≤–æ–π —É–≥–æ–ª + —Å–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ.
                '''
                ang = base_angle + (s / float(n_sparks)) * 2.0 * math.pi + (random.random() - 0.5) * 0.3
                '''
–î–ª–∏–Ω–∞ –∏—Å–∫—Ä—ã ‚Äî –æ—Ç –ø–æ–ª–æ–≤–∏–Ω—ã –¥–æ –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–¥–∏—É—Å–∞.
                '''
                length = radius * (0.5 + 0.6 * random.random())
                '''
–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ–Ω—Ü–∞ –∏—Å–∫—Ä—ã.
                '''
                x2 = int(cx + math.cos(ang) * length)
                y2 = int(cy + math.sin(ang) * length)
                '''
–°–∏–ª–∞ —Å–≤–µ—á–µ–Ω–∏—è –∏—Å–∫—Ä—ã.
                '''
                spark_strength = 0.6 * (0.8 + 0.6 * random.random()) * progress
                '''
–¶–≤–µ—Ç –∏—Å–∫—Ä—ã = —Ü–≤–µ—Ç –≤–∑—Ä—ã–≤–∞, —É–º–Ω–æ–∂–µ–Ω–Ω—ã–π –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã.
                '''
                color_float = (col * (1.0 + 0.6 * random.random()) * spark_strength).tolist()
                '''
–†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–æ –∫–æ–Ω—Ü–∞ –∏—Å–∫—Ä—ã.
                '''
                cv2.line(overlay, (cx, cy), (x2, y2),
                         color=(float(color_float[0]), float(color_float[1]), float(color_float[2])),
                         thickness=1, lineType=cv2.LINE_AA)
                '''
–ù–∞ –∫–æ–Ω—Ü–µ –∏—Å–∫—Ä—ã —Å—Ç–∞–≤–∏–º —è—Ä–∫—É—é —Ç–æ—á–∫—É-–±–ª–∏–∫.
                '''
                rr = max(1, int(radius * 0.06))
                cv2.circle(overlay, (x2, y2), rr,
                           color=(float(color_float[0]), float(color_float[1]), float(color_float[2])),
                           thickness=-1, lineType=cv2.LINE_AA)

        '''
–†–∞–∑–º–∞–∑—ã–≤–∞–µ–º –≤—Å—ë, —á—Ç–æ–± —Å–∏—è–ª–æ –º—è–≥–∫–æ, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫.
        '''
        sigma = 1.0 + 2.0 * progress
        overlay = cv2.GaussianBlur(overlay, ksize=(0, 0), sigmaX=sigma, sigmaY=sigma)

        '''
–°–º–µ—à–∏–≤–∞–µ–º —Ñ–æ–Ω –∏ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏.
–û–±—Ä–µ–∑–∞–µ–º —è—Ä–∫–æ—Å—Ç—å (clip).
–î–µ–ª–∏–º –Ω–∞ (1+0.2*out), —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –±—ã–ª–∞ –ø–µ—Ä–µ—Å–≤–µ—á–µ–Ω–Ω–æ–π.
        '''
        out = base + overlay
        out = np.clip(out, 0.0, 1.2)
        out = out / (1.0 + 0.2 * out)

        # --- –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ä–∞–∑—Ä–µ–∑—ã/—Å–¥–≤–∏–≥–∏: —Ç–µ–ø–µ—Ä—å –ø–æ–ª–æ—Å—ã –º–æ–≥—É—Ç –ø–æ–∫—Ä—ã–≤–∞—Ç—å –≤—Å—é —à–∏—Ä–∏–Ω—É ---
        '''
–ü–æ—Å–ª–µ —Å–µ—Ä–µ–¥–∏–Ω—ã –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç "—Ä–∞–∑—Ä–µ–∑–æ–≤".
        '''
        if progress > 0.45:
            # –ï—Å–ª–∏ —Ö–æ—Ç–∏–º –±–æ–ª–µ–µ –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã–≤–∞—Ç—å —É–∂–µ –ø—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ > 0.75
            '''
–ò–Ω–æ–≥–¥–∞ —Ä–∞–∑—Ä–µ–∑ –∏–¥—ë—Ç –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –∫–∞–¥—Ä–∞ (–ø—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ > 0.75 –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞).
            '''
            full_width_threshold = 0.75
            use_full_width = progress >= full_width_threshold or (random.random() < 0.35 * progress)
            # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª–æ—Å
            '''
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª–æ—Å:
‚Äî step: –≤—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å—ã (—á–µ–º –¥–∞–ª—å—à–µ ‚Äî —Ç–µ–º —Ç–æ–Ω—å—à–µ).
‚Äî max_shift: –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ–º –ø–æ–ª–æ—Å—É.
‚Äî edge_highlight: —è—Ä–∫–æ—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫—Ä–∞—ë–≤.
            '''
            step = max(6, int(6 + 18 * (1.0 - progress)))   # –ø—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –ø–æ–ª–æ—Å—ã —Ç–æ–Ω—å—à–µ
            max_shift = int(40 * progress)                  # –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∏–∫—Å–µ–ª—å–Ω—ã–π —Å–¥–≤–∏–≥
            edge_highlight = 0.35 + 0.65 * progress         # —è—Ä–∫–æ—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫—Ä–∞—è —Ä–∞–∑—Ä–µ–∑–∞

            '''
–ë–µ–∂–∏–º –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ –ø–æ–ª–æ—Å–∞–º–∏.
            '''
            for y0 in range(0, h, step):
                # –Ω–µ–º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∏–Ω–æ–≥–¥–∞ —Å–∏–ª—å–Ω—ã–π —Ä–∞–∑—Ä–µ–∑, –∏–Ω–æ–≥–¥–∞ –ø–æ—á—Ç–∏ –Ω–µ—Ç
                '''
–†–µ–¥–∫–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–æ—Å—É –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–µ.
                '''
                local_rand = random.random()
                if local_rand > 0.95 and progress < 0.6:
                    continue  # —Ä–µ–¥–∫–∏–µ –ø—Ä–æ–ø—É—Å–∫–∏ –Ω–∞ –Ω–∏–∑–∫–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
                # –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –≤–µ–ª–∏—á–∏–Ω–∞ —Å–¥–≤–∏–≥–∞
                '''
–°–¥–≤–∏–≥ –ø–æ–ª–æ—Å—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏.
                '''
                shift = int(max_shift * math.sin(t * 3.0 + y0 * 0.08 + random.random()))
                # —Å–¥–≤–∏–≥ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π: —Ä–∞–±–æ—Ç–∞–µ–º –ø–æ –ø–æ–ª–æ—Å–∫–µ
                '''
–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–æ—Å—ã.
                '''
                y1 = min(h, y0 + step)
                '''
–ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ "–ø–æ–ª–Ω—ã–π —Ä–∞–∑—Ä–µ–∑".
                '''
                if use_full_width:
                    # —Å–¥–≤–∏–≥–∞–µ–º –≤—Å—é —Å—Ç—Ä–æ–∫—É —Ü–µ–ª–∏–∫–æ–º (–ø–æ–ª–Ω–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ)
                    if shift != 0:
                        out[y0:y1, :, :] = np.roll(out[y0:y1, :, :], shift, axis=1)
                    # –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑—Ä–µ–∑–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–Ω–∫—É—é —Å–≤–µ—Ç—è—â—É—é—Å—è –ª–∏–Ω–∏—é
                    # –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "—Ä–µ–∑–∞" –ø–æ–¥—Å–≤–µ—Ç–∏–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –≥—Ä–∞–Ω–∏—Ü—É –ø–æ—Å—Ä–µ–¥–∏–Ω–µ –ø–æ–ª–æ—Å—ã
                    '''
–ü–æ—Å–µ—Ä–µ–¥–∏–Ω–µ –ø–æ–ª–æ—Å—ã –¥–µ–ª–∞–µ–º —è—Ä–∫—É—é –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É ‚Äî —Ç–∏–ø–∞ "—Ä–∞–∑—Ä–µ–∑".
–®–∏—Ä–∏–Ω–∞ –ª–∏–Ω–∏–∏ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.
                    '''
                    mid_x = w // 2
                    bw = max(1, int(2 * (1.0 - progress)))  # —à–∏—Ä–∏–Ω–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º)
                    lx = max(0, mid_x - bw)
                    rx = min(w, mid_x + bw)
                    # –ø—Ä–æ—Å—Ç–æ–π –¥–æ–±–∞–≤–æ—á–Ω—ã–π —Å–ª–æ–π –≤ –ø–æ–ª–æ—Å–µ (–±–µ—Ä–µ–∂–Ω–æ)
                    out[y0:y1, lx:rx, :] += edge_highlight * (0.5 + 0.5 * random.random())
                    '''
–ò–Ω–∞—á–µ —Å–¥–≤–∏–≥–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –∫–∞–¥—Ä–∞.
                    '''
                else:
                    # —Ä–∞–Ω–µ–µ –ø—Ä–∏–º–µ–Ω—è–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –∫ —á–∞—Å—Ç–∏; —Ç–µ–ø–µ—Ä—å –¥–∞—ë–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞—Ç—å
                    #—Ü–µ–Ω—Ç—Ä–Ω—É—é –∏–ª–∏ –ª–µ–≤—É—é —á–∞—Å—Ç—å
                    '''
–®–∏—Ä–∏–Ω–∞ –±–ª–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–≤–∏–≥–∞–µ–º.
                    '''
                    slice_w = int(w * (0.25 + 0.6 * progress))  # —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–æ–ª—è
                    # –¥–µ–ª–∞–µ–º –∏–Ω–æ–≥–¥–∞ –ª–µ–≤—É—é, –∏–Ω–æ–≥–¥–∞ –ø—Ä–∞–≤—É—é, –∏–Ω–æ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é
                    mode = random.choice(['left', 'right', 'center'])
                    if mode == 'left':
                        x0s, x1s = 0, slice_w
                    elif mode == 'right':
                        x0s, x1s = max(0, w - slice_w), w
                    else:
                        x0s = max(0, (w - slice_w) // 2)
                        x1s = x0s + slice_w
                    '''
–°–¥–≤–∏–≥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Å–æ–∫ –∫–∞–¥—Ä–∞.
                    '''
                    if x1s - x0s > 2 and shift != 0:
                        block = out[y0:y1, x0s:x1s, :].copy()
                        out[y0:y1, x0s:x1s, :] = np.roll(block, shift, axis=1)
                        # –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ –∫—Ä–∞—é —Å–¥–≤–∏–≥–∞ (—Ç—ë–º–Ω–æ/—Å–≤–µ—Ç–ª–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç)
                        '''
–ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –Ω–∞ –∫—Ä–∞—é —Å–¥–≤–∏–≥–∞.
–¢–∏–ø–∞ —à—Ä–∞–º –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ ‚Äî —Å–≤–µ—Ç–∏—Ç—Å—è, —á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª –∂—ë—Å—Ç—á–µ.
                        '''
                        if random.random() < 0.6:
                            # –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ —Å–ø—Ä–∞–≤–∞/—Å–ª–µ–≤–∞ –±–ª–æ–∫–∞
                            if shift > 0:
                                # –ª–µ–≤—ã–π –∫—Ä–∞–π –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
                                lx = x0s
                                rx = min(w, x0s + 2 + int(2 * progress))
                            else:
                                lx = max(0, x1s - (2 + int(2 * progress)))
                                rx = x1s
                            out[y0:y1, lx:rx, :] += 0.25 * edge_highlight

        # --- —Ä–µ–¥–∫–∏–µ –±–µ–ª—ã–µ —Ç–æ—á–∫–∏ (–±–ª–∏–∫–∏) ---
        '''
–ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º "–∑–≤—ë–∑–¥—ã" (–±–µ–ª—ã–µ —Ç–æ—á–∫–∏ –±–ª–∏–∫–∞).
        '''
        if random.random() < 0.25 * progress:
            stars = 6 + int(10 * progress)
            '''
–†–∏—Å—É–µ–º –±–µ–ª—ã–µ —Ç–æ—á–∫–∏-–±–ª–∏–∫–∏ —Å–ª—É—á–∞–π–Ω–æ –ø–æ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞.
            '''
            for _ in range(stars):
                sx = random.randint(0, w - 1)
                sy = random.randint(0, int(h * 0.6))
                rr = max(1, int(1 + 2 * progress))
                out[sy:sy + rr + 1, sx:sx + rr + 1, :] += 0.6

        out = np.clip(out, 0.0, 1.0)
        '''
üëä –í—Å—ë, –±—Ä–∞—Ç—É—Ö–∞.
–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–ª–∞–µ—Ç –º–æ—â–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–≤ —Å –∏—Å–∫—Ä–∞–º–∏, –≤—Å–ø—ã—à–∫–∞–º–∏ –∏ —Ä–∞–∑—Ä–µ–∑–∞–º–∏,
–∫–∞–∫ –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ª–æ–º–∞–µ—Ç—Å—è –ø–æ–¥ –Ω–∞–ø–æ—Ä–æ–º —Å–∞–ª—é—Ç–∞.
        '''
        return (out * 255.0).astype(np.uint8)



    '''
–û—Ñ–æ—Ä–º–ª—è–µ–º –¥–≤–∏–∂—É—Ö—É: —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø–ª–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É, —Ç–∏–ø–∞ –∫–∞–∫ –º–æ—Ä–æ–∂–µ–Ω–æ–µ —Ç–∞–µ—Ç.
    '''
    def liquid_melt(self, frame, t, duration):
        h, w = frame.shape[:2]
        progress = float(np.clip(t / float(max(duration, 1e-6)), 0.0, 1.0))
        '''
–ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—á—Ç–∏ –Ω—É–ª–µ–≤–æ–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª, —Ç–∏–ø–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ.
        '''
        if progress <= 1e-6:
            return frame

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∞ (–ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è)
        '''
–ú–∞–∫—Å–∏–º—É–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–∏ –±—É–¥—É—Ç —Å—ä–µ–∑–∂–∞—Ç—å.
–ß–µ–º –≤—ã—à–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ç–∞–µ—Ç, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 80 –ø–∏–∫—Å–µ–ª–µ–π.
        '''
        max_amp = max(8, int(min(h * 0.20, 80)))   # –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        '''
–°—á–∏—Ç–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–¥–≤–∏–≥: —á–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ç–∞–µ—Ç.
        '''
        amp = int(max_amp * progress)
        '''
–ß–∞—Å—Ç–æ—Ç–∞ –≤–æ–ª–Ω, –∫–∞–∫ —Å–∏–ª—å–Ω–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ ¬´–ø—É–ª—å—Å–∏—Ä—É–µ—Ç¬ª –ø–æ —à–∏—Ä–∏–Ω–µ.
        '''
        freq = 2.0 * math.pi / max(40.0, w * 0.06)  # –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø–æ —à–∏—Ä–∏–Ω–µ
        '''
–°–∫–æ—Ä–æ—Å—Ç—å –ø–ª–∞–≤–ª–µ–Ω–∏—è ‚Äî —á–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –∫–∞–ø–∞–µ—Ç.
        '''
        speed = 1.6 + 1.4 * progress                 # —Å–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
        '''
–°–∏–ª–∞ —à—É–º–∞: –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –º–∏–∫—Ä–æ-–∫–æ–ª–µ–±–∞–Ω–∏—è –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏.
        '''
        noise_strength = 0.08 * amp                  # –º–∞–ª—ã–π —à—É–º –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º

        # –ü–µ—Ä–µ—Å—á—ë—Ç —Å–º–µ—â–µ–Ω–∏–π –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º (–≤–µ–∫—Ç–æ—Ä–Ω–æ)
        '''
–°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ —à–∏—Ä–∏–Ω–µ.
        '''
        xs = np.arange(w, dtype=np.float32)
        '''
–û—Å–Ω–æ–≤–Ω–æ–π —Å–¥–≤–∏–≥: —Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–∞—è –≤–æ–ª–Ω–∞, —Ç–∏–ø–∞ –≤–æ–ª–Ω—ã –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ –∏–¥—É—Ç.
        '''
        base_shift = amp * np.sin(xs * freq + t * speed).astype(np.float32)
        '''
–°–ª—É—á–∞–π–Ω—ã–π —à—É–º, —á—Ç–æ–± –Ω–µ –≤—Å—ë –±—ã–ª–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ.
        '''
        noise = (np.random.randn(w).astype(np.float32)) * noise_strength
        '''
–û–±—â–∏–π —Å–¥–≤–∏–≥: –≤–æ–ª–Ω–∞ + —à—É–º.
        '''
        disp = base_shift + noise  # —Å–º–µ—â–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)

        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è remap: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ dst (y,x) –±–µ—Ä–µ–º src_y = y - disp[x] * weight(y)
        '''
–ú–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ –≤—ã—Å–æ—Ç–µ, –≤ —Å—Ç–æ–ª–±–∏–∫.
        '''
        ys = np.arange(h, dtype=np.float32)[:, None]  # —Ñ–æ—Ä–º–∞ (h,1)
        # –í–µ—Å —Å–º–µ—â–µ–Ω–∏—è –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏: –±–æ–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ —É –≤–µ—Ä—Ö–Ω–∏—Ö –ø–∏–∫—Å–µ–ª–µ–π (–∫–∞–∫ –±—É–¥—Ç–æ —Å—Ç–µ–∫–∞–µ—Ç –≤–Ω–∏–∑)
        '''
–í–µ—Å —ç—Ñ—Ñ–µ–∫—Ç–∞: —Å–≤–µ—Ä—Ö—É —Ç–∞–µ—Ç —Å–∏–ª—å–Ω–µ–µ, —Å–Ω–∏–∑—É –ø–æ—á—Ç–∏ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è (–∏–º–∏—Ç–∞—Ü–∏—è —Å—Ç–µ–∫–∞–Ω–∏—è).
        '''
        power = 1.2
        weight = (1.0 - ys / float(max(1, h - 1))) ** power  # (h,1)
        '''
–î–≤–∏–≥–∞–µ–º –ø–∏–∫—Å–µ–ª–∏ –≤–Ω–∏–∑ –ø–æ –º–∞—Å—Å–µ.
        '''
        map_y = ys - (disp[None, :] * weight)                # (h,w)
        '''
–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, –∫–æ–ø–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –ø–æ –≤—ã—Å–æ—Ç–µ.
        '''
        map_x = np.tile(xs[None, :], (h, 1)).astype(np.float32)

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º map_y –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
        '''
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–∏–∫—Å–µ–ª–∏ –Ω–µ —É–ª–µ—Ç–µ–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–∞–¥—Ä–∞.
        '''
        map_y = np.clip(map_y, 0.0, float(h - 1)).astype(np.float32)

        # –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ–º–∞–ø–ø–∏–Ω–≥ (C-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
        '''
–ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–¥—Ä —Å —É—á—ë—Ç–æ–º –Ω–∞—à–∏—Ö —Å–º–µ—â–µ–Ω–∏–π. –ü–æ–ª—É—á–∞–µ–º ¬´—Ä–∞—Å—Ç–∞—è–≤—à—É—é¬ª –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        melted = cv2.remap(frame, map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        # –ù–µ–±–æ–ª—å—à–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–∞–∑–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤—è–∑–∫–æ—Å—Ç–∏ (–¥–µ—à–µ–≤–∞—è)
        '''
–ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç —É–∂–µ –≤–∏–¥–∏–º—ã–π, –¥–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –±–ª—É—Ä, —Ç–∏–ø–∞ –∫–∞–ø–ª—è –≤—è–∑–∫–æ —Ç—è–Ω–µ—Ç—Å—è –≤–Ω–∏–∑.
        '''
        if amp > 2:
            blur_k = 1 + int(2 * progress)  # 1..3
            # blur —Ç–æ–ª—å–∫–æ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏: (1, k)
            melted = cv2.blur(melted, (1, blur_k))

        # –°–æ–∑–¥–∞—ë–º overlay –¥–ª—è –∫–∞–ø–µ–ª—å/–±–ª–µ—Å–∫–∞ (uint8, —á—Ç–æ–±—ã —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º)
        '''
–ü—É—Å—Ç–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–¥ –∫–∞–ø–ª–∏.
        '''
        overlay = np.zeros_like(frame, dtype=np.uint8)

        # –†–∏—Å—É–µ–º —Ä–µ–¥–∫–∏–µ –∫–∞–ø–ª–∏/–≤—ã–ª–µ—Ç—ã (–º–∞–ª–æ–µ —á–∏—Å–ª–æ ‚Äî –¥–µ—à—ë–≤–æ)
        '''
–ö–æ–ª-–≤–æ –∫–∞–ø–µ–ª—å: —á–µ–º –¥–∞–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –±–æ–ª—å—à–µ –∏—Ö –ø–∞–¥–∞–µ—Ç.
        '''
        max_drops = min(14, int(12 * progress) + 1)
        '''
–ò–Ω–æ–≥–¥–∞ –∫–∞–ø–ª—è –≤–æ–æ–±—â–µ –Ω–µ —Ä–∏—Å—É–µ—Ç—Å—è, —á—Ç–æ–± –±—ã–ª–æ —Å–ª—É—á–∞–π–Ω–æ.
        '''
        for i in range(max_drops):
            if random.random() > 0.8 + 0.2 * progress:
                continue
            '''
–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å—Ç–∞—Ä—Ç–∞ –∫–∞–ø–ª–∏ (–≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏).
            '''
            sx = random.randint(0, w - 1)
            sy = random.randint(0, max(1, int(h * 0.6)))
            '''
–î–ª–∏–Ω–∞ –∫–∞–ø–ª–∏: —á–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º –¥–ª–∏–Ω–Ω–µ–µ.
            '''
            drop_len = int(min(h * 0.18, 6 + 36 * progress * random.random()))
            '''
–ö–æ–Ω–µ—Ü –∫–∞–ø–ª–∏: –≤–Ω–∏–∑ –ø–æ Y.
            '''
            ex = sx
            ey = min(h - 1, sy + drop_len)

            # –ë–µ—Ä—ë–º —Ü–≤–µ—Ç –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ tuple int)
            '''
–ë–µ—Ä—ë–º —Ü–≤–µ—Ç –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ –≤ —Ç–æ—á–∫–µ —Å—Ç–∞—Ä—Ç–∞, —á—Ç–æ–±—ã –∫–∞–ø–ª—è –±—ã–ª–∞ ¬´—Ü–≤–µ—Ç–Ω–∞—è¬ª.
            '''
            src_y = min(max(0, sy), h - 1)
            src_x = min(max(0, sx), w - 1)
            c = frame[src_y, src_x]
            color = (int(c[0]), int(c[1]), int(c[2]))  # BGR tuple ints

            '''
–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏ –∫–∞–ø–ª–∏.
            '''
            thickness = 1 if w < 1000 else 2
            '''
–†–∏—Å—É–µ–º –∫–∞–ø–ª—é –ª–∏–Ω–∏–µ–π.
            '''
            cv2.line(overlay, (sx, sy), (ex, ey), color, thickness=thickness, lineType=cv2.LINE_AA)
            # –í –∫–æ–Ω—Ü–µ –∫–∞–ø–ª–∏ ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è –±–µ–ª–∞—è –±–ª–∏–∫-—Ç–æ—á–∫–∞
            '''
–ù–∞ –∫–æ–Ω—á–∏–∫–µ –∫–∞–ø–ª–∏ —Å—Ç–∞–≤–∏–º –±–µ–ª—ã–π –±–ª–∏–∫ ‚Äî —Ç–∏–ø–∞ —Å–≤–µ—Ç –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è.
            '''
            tip_r = max(1, int(1 + 2 * progress))
            cv2.circle(overlay, (ex, ey), tip_r, (255, 255, 255), -1, lineType=cv2.LINE_AA)
            # –ù–∞–ª–æ–∂–µ–Ω–∏–µ overlay'–∞ –Ω–∞ —Ä–∞—Å—Ç–∞—è–≤—à–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–º—è–≥–∫–æ)
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ float –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø—Ä–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–∏.
        '''
        melted_f = melted.astype(np.float32)
        overlay_f = overlay.astype(np.float32)
        '''
–°–º–µ—à–∏–≤–∞–µ–º –∫–∞–¥—Ä —Å –∫–∞–ø–ª—è–º–∏ (–∫–∞–ø–ª–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–Ω–µ–µ –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞).
        '''
        alpha = 0.45 * progress  # —Å–∏–ª–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–∞–ø–µ–ª—å
        out_f = melted_f + overlay_f * alpha

        # –õ—ë–≥–∫–∞—è —Ç–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è + –∫–ª–∏–ø
        '''
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0‚Äì255.
        '''
        out = np.clip(out_f, 0.0, 255.0).astype(np.uint8)

        return out


    '''
–§—É–Ω–∫—Ü–∏—è –º—É—Ç–∏—Ç —ç—Ñ—Ñ–µ–∫—Ç "–Ω–µ–æ–Ω–æ–≤–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è" —Å –≥–ª–∏—Ç—á–∞–º–∏.
    '''
    def neon_glow2(self, frame, t, duration):
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
        progress = max(0.0, min(1.0, t / float(duration)))
        h, w = frame.shape[:2]
        '''
–î–µ–ª–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–æ–ø–∏—é (–≤ 2 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ), —á—Ç–æ–± –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–æ—Ü, —Ç–∏–ø–∞ —ç–∫–æ–Ω–æ–º–∏–º —Ä–µ—Å—É—Ä—Å—ã.
        '''
        scale = 0.5  # –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–æ–ø–∏—é –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        small_w, small_h = max(1, int(w * scale)), max(1, int(h * scale))

        # —É–º–µ–Ω—å—à–∏—Ç—å
        '''
–°–∂–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–æ –º–∞–ª–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
        '''
        small = cv2.resize(frame, (small_w, small_h), interpolation=cv2.INTER_LINEAR)

        # –ú—É–ª—å—Ç—è—à–Ω—ã–π –±–∞–∑–æ–≤—ã–π —Å–ª–æ–π:
        #–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ö–æ–¥–æ–≤ bilateral –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–∞–µ–≤ –∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤
        '''
–î–≤–∞ —Ä–∞–∑–∞ –ø—Ä–æ–≥–Ω–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä bilateral: –æ–Ω —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç —Ü–≤–µ—Ç–∞, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫—Ä–∞—è.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è –º—É–ª—å—Ç—è—à–Ω—ã–π —Å—Ç–∏–ª—å.
        '''
        filtered = small.copy()
        for _ in range(2):
            filtered = cv2.bilateralFilter(filtered, d=9, sigmaColor=75, sigmaSpace=75)

        # –ö—Ä–∞—è (—Ç–æ–Ω–∫–∏–µ –∫–æ–Ω—Ç—É—Ä—ã) –¥–ª—è —Ä–∏—Å—É–Ω–∫–∞
        '''
–î–µ–ª–∞–µ–º —á—ë—Ä–Ω–æ-–±–µ–ª—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        gray = cv2.cvtColor(filtered, cv2.COLOR_BGR2GRAY)
        '''
–ß—É—Ç–∫–∞ –∑–∞–º—ã–ª–∏–ª–∏, —á—Ç–æ–± —à—É–º –ø—Ä–∏–±–∏—Ç—å.
        '''
        gray = cv2.medianBlur(gray, 5)
        '''
–ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ –æ–±–≤–µ–ª–∏ —Ñ–ª–æ–º–∞—Å—Ç–µ—Ä–æ–º.
        '''
        edges = cv2.Canny(gray, 50, 150)
        # –£—Ç–æ–ª—â–∞–µ–º –∫–æ–Ω—Ç—É—Ä, —á—Ç–æ–±—ã –æ–Ω –≤—ã–≥–ª—è–¥–µ–ª –±–æ–ª–µ–µ –º—É–ª—å—Ç—è—à–Ω–æ
        kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (2, 2))
        edges = cv2.dilate(edges, kernel, iterations=1)  # 0/255

        # –ù–µ–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç (–ø–ª–∞–≤–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
        colorA = np.array([200, 40, 220], dtype=np.uint8)   # —Ä–æ–∑–æ–≤–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
        colorB = np.array([60, 220, 240], dtype=np.uint8)   # –±–∏—Ä—é–∑–æ–≤—ã–π
        '''
–î–≤–∏–≥–∞–µ–º —Ç—É–¥–∞-—Å—é–¥–∞ –ø–æ —Å–∏–Ω—É—Å—É, —á—Ç–æ–± —Ü–≤–µ—Ç –ø—É–ª—å—Å–∏—Ä–æ–≤–∞–ª.
        '''
        mix = 0.5 * (1.0 + math.sin(t * 1.5))
        '''
–°–º–µ—à–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞, –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∂–∏–≤–æ–π –ø–µ—Ä–µ–ª–∏–≤.
        '''
        neon_color = (colorA.astype(np.float32) * (1 - mix) + colorB.astype(np.float32) * mix).astype(np.uint8)

        # –°–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–Ω—É—é –º–∞—Å–∫—É –∫—Ä–∞–µ–≤ (–Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–æ–ø–∏–∏)
        '''
–ë–µ—Ä—ë–º –º–∞—Å–∫—É –∫–æ–Ω—Ç—É—Ä–æ–≤ –∏ –∫—Ä–∞—Å–∏–º –∏—Ö –≤ –Ω–µ–æ–Ω–æ–≤—ã–µ —Ü–≤–µ—Ç–∞.
        '''
        colored_edges_small = np.zeros_like(filtered)
        mask = edges == 255
        colored_edges_small[mask] = neon_color

        # –†–∞–∑–º—ã—Ç—ã–µ –æ—Ä–µ–æ–ª—ã (–≥–ª–æ—É) ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ö–æ–¥–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —è–¥—Ä–∞–º–∏
        '''
–†–∞–∑–º—ã–≤–∞–µ–º –∫–æ–Ω—Ç—É—Ä—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, —á—Ç–æ–± –≤–æ–∫—Ä—É–≥ –ø–æ—è–≤–∏–ª—Å—è –æ—Ä–µ–æ–ª (—Å–≤–µ—á–µ–Ω–∏–µ).
        '''
        glow_small = colored_edges_small.copy()
        glow_small = cv2.GaussianBlur(glow_small, (7, 7), 0)
        glow_small = cv2.addWeighted(glow_small, 1.0, cv2.GaussianBlur(glow_small, (13, 13), 0), 0.8, 0)

        # –ü—É–ª—å—Å–∞—Ü–∏—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —Å–≤–µ—á–µ–Ω–∏—è
        '''
–°–≤–µ—á–µ–Ω–∏–µ –¥—ã—à–∏—Ç, –ø—É–ª—å—Å–∏—Ä—É–µ—Ç.
        '''
        pulse = 0.6 * (0.6 + 0.4 * math.sin(t * 5))  # –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –ø—Ä–∏–º–µ—Ä–Ω–æ [0.36,0.96]

        # –°–º–µ—à–∏–≤–∞–µ–º –º—É–ª—å—Ç—è—à–Ω—ã–π —Å–ª–æ–π –∏ –≥–ª–æ—É –Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–æ–ø–∏–∏
        combined_small = cv2.addWeighted(filtered, 1.0, glow_small, pulse, 0)

        # –ú–∞—Å–∫–∞ —Ç–æ–Ω–∫–∏—Ö —è—Ä–∫–∏—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤ (—á—Ç–æ–±—ã –ª–∏–Ω–∏–∏ –±—ã–ª–∏ —è—Ä–∫–∏–º–∏ –ø–æ–≤–µ—Ä—Ö)
        '''
–î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–Ω–∫–∏–µ —è—Ä–∫–∏–µ –ª–∏–Ω–∏–∏ –ø–æ–≤–µ—Ä—Ö —Å–≤–µ—á–µ–Ω–∏—è.
        '''
        bright_edges_small = np.zeros_like(filtered)
        bright_edges_small[mask] = (neon_color.astype(np.float32) * 1.2).clip(0, 255).astype(np.uint8)

        '''
–ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∏—Ö –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        '''
        combined_small = cv2.addWeighted(combined_small, 1.0, bright_edges_small, 0.9 * pulse, 0)

        # –í–µ—Ä–Ω—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É
        combined = cv2.resize(combined_small, (w, h), interpolation=cv2.INTER_LINEAR)

        # –î–ª—è –≥–ª–∏—Ç—á-—Å—Ä–µ–∑–æ–≤ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
        result = combined.copy()

        # –ù–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–∑–æ–≤-–≥–ª–∏—Ç—á–µ–π (–Ω–µ —Ç—è–∂–µ–ª–æ: –º–∞–ª—ã–µ —à–∞–≥–∏)
        slice_h = max(4, int(h * 0.01))  # –≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞
        max_shift = max(4, int(w * 0.04))  # –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –ø–æ x
        # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è –≥–ª–∏—Ç—á–∞ —Ä–∞—Å—Ç–µ—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        glitch_chance = 0.02 + 0.45 * progress

        '''
–ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ –ø–æ–ª–æ—Å–∞–º–∏, –∏–Ω–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ–ª–æ—Å—É –¥–ª—è –≥–ª–∏—Ç—á–∞.
        '''
        for y in range(0, h, slice_h):
            if random.random() < glitch_chance:
                '''
–ì—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª–æ—Å—ã.
                '''
                dy = slice_h
                y2 = min(h, y + dy)
                # —Å–º–µ—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
                '''
–°—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ—Å—É —Å–¥–≤–∏–Ω—É—Ç—å. –ù–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –¥–ª—è —Ö–∞–æ—Å–∞.
                '''
                dx = int(max_shift * math.sin(t * 6.0 + y * 0.1))
                dx = dx + int((random.random() - 0.5) * max_shift * 0.6)
                # –°–¥–≤–∏–≥–∞–µ–º –±–ª–æ–∫
                '''
–ë–µ—Ä—ë–º –±–ª–æ–∫ –∏ —Å–¥–≤–∏–≥–∞–µ–º –µ–≥–æ –≤–±–æ–∫.
                '''
                block = result[y:y2].copy()
                block = np.roll(block, dx, axis=1)
                # –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è: —Å–ª–µ–≥–∫–∞ —Å–¥–≤–∏–Ω—É—Ç—å –∫–∞–Ω–∞–ª—ã –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
                '''
–•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è: –∫–∞–Ω–∞–ª—ã –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–∑—ä–µ–∑–∂–∞—é—Ç—Å—è, –∫–∞–∫ –≤ –≥–ª–∏—Ç—á–∞—Ö –Ω–∞ VHS.
                '''
                if dx != 0:
                    b, g, r = cv2.split(block)
                    shift_small = int(max(1, abs(dx) * 0.15))
                    b = np.roll(b, -shift_small, axis=1)
                    r = np.roll(r, shift_small, axis=1)
                    block = cv2.merge([b, g, r])
                '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ.
                '''
                result[y:y2] = block

        # –ù–µ–º–Ω–æ–≥–æ —É—Å–∏–ª–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç/–Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è "–Ω–µ–æ–Ω–æ–≤–æ–≥–æ" –≤–∏–¥–∞ (–ª–µ–≥–∫–∏–π LUT —á–µ—Ä–µ–∑ HSV)
        '''
–ù–µ–º–Ω–æ–≥–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –∏ —è—Ä–∫–æ—Å—Ç—å, —á—Ç–æ–± –±—ã–ª–æ ¬´–∫–∞–∫ –≤ –∫–ª—É–±–µ¬ª ‚Äî —á–∏—Å—Ç—ã–π –Ω–µ–æ–Ω.
        '''
        hsv = cv2.cvtColor(result, cv2.COLOR_BGR2HSV).astype(np.float32)
        hsv[..., 1] = (hsv[..., 1] * 1.05).clip(0, 255)  # –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å
        hsv[..., 2] = (hsv[..., 2] * 1.03).clip(0, 255)  # —è—Ä–∫–æ—Å—Ç—å
        result = cv2.cvtColor(hsv.astype(np.uint8), cv2.COLOR_HSV2BGR)

        return result

    def time_warp(self, frame, t, duration):
        h, w = frame.shape[:2]
        progress = float(np.clip(t / duration, 0.0, 1.0))
        # –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ, –ø–ª–∞–≤–Ω–æ–µ)
        warp = 1.0 + 0.6 * (progress ** 1.2)
        '''
–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–∞–¥—Ä. –¢–∏–ø–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É —Ä–∞–∑–¥—É–ª–∏, —á—Ç–æ–± –ø–æ –∫–∞–π—Ñ—É —Å–º–æ—Ç—Ä–µ–ª–æ—Å—å.
        '''
        scaled = cv2.resize(frame, None, fx=warp, fy=warp, interpolation=cv2.INTER_LINEAR)
        '''
–¶–µ–Ω—Ç—Ä —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ë–µ–∑ —Ü–µ–Ω—Ç—Ä–∞ ‚Äî –Ω–∏–∫—É–¥–∞, –≤—Å—ë –∫—Ä—É—Ç–∏—Ç—Å—è –≤–æ–∫—Ä—É–≥ –Ω–µ–≥–æ.
        '''
        cy, cx = scaled.shape[0] // 2, scaled.shape[1] // 2
        '''
–í—ã—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–¥–≤–∏–≥, —á—Ç–æ–± –≤—ã—Ä–µ–∑–∞—Ç—å –∫—É—Å–æ–∫ –ø–æ —Ä–∞–∑–º–µ—Ä—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏–∑ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        '''
        y0 = max(0, cy - h // 2); x0 = max(0, cx - w // 2)
        '''
–í—ã—Ä–µ–∑–∞–µ–º —Ü–µ–Ω—Ç—Ä –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ä–∞–∑–º–µ—Ä –æ—Ä–∏–≥–∏–Ω–∞–ª–∞. –ü–æ–ª—É—á–∞–µ–º —Ä–æ–≤–Ω—ã–π –∫–∞–¥—Ä –ø–æ—Å–ª–µ –∑—É–º–∞
        '''
        new_frame = scaled[y0:y0 + h, x0:x0 + w].copy()

        # —Å–ª–æ—ë–≤–æ–µ —Å–º–µ—â–µ–Ω–∏–µ: –∞–∫–∫—É–º—É–ª–∏—Ä—É–µ–º –≤ float32, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö –∫–æ–ø–∏–π
        '''
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—ë–≤ –¥–ª—è —Å–º–µ—â–µ–Ω–∏—è ‚Äî –±—É–¥–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–∞–¥—Ä –∏ –¥–≤–∏–≥–∞—Ç—å –ø–æ –±–æ–∫–∞–º.
        '''
        layers = 4
        '''
–ö–æ–ø–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ float32, —á—Ç–æ–± –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–∏.
        '''
        acc = new_frame.astype(np.float32)
        '''
–ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–º —Å–ª–æ—è–º.
        '''
        for i in range(1, layers + 1):
            '''
–ö–∞–∂–¥—ã–π —Å–ª–æ–π –¥–≤–∏–≥–∞–µ–º –ø–æ-—Ä–∞–∑–Ω–æ–º—É. –ß–µ–º –¥–∞–ª—å—à–µ —Å–ª–æ–π, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–¥–≤–∏–≥.
            '''
            shift = int((4 + 10 * i) * progress)  # –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥
            '''
–ï—Å–ª–∏ —Å–ª–æ–π —á—ë—Ç–Ω—ã–π ‚Äî –¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ, –µ—Å–ª–∏ –Ω–µ—á—ë—Ç–Ω—ã–π ‚Äî –≤–ª–µ–≤–æ. –¢–∏–ø–∞ –≤–æ–ª–Ω—ã.
            '''
            layer = np.roll(new_frame, shift if (i % 2 == 0) else -shift, axis=1)
            '''
–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å–ª–æ—è. –ß–µ–º –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É —ç—Ñ—Ñ–µ–∫—Ç–∞, —Ç–µ–º –º–µ–Ω—å—à–µ –µ–≥–æ –≤–∏–¥–Ω–æ.
            '''
            alpha = (i / (layers + 1)) * (0.55 * (1.0 - 0.45 * progress))
            # accumulateWeighted –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä—ã–π –∏ —ç–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å
            '''
–°–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–ª–æ–π —Å –æ–±—â–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º. –ì—Ä–∞–º–æ—Ç–Ω–æ –º–∏–∫—Å—É–µ–º, —á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –±—ã–ª–æ.
            '''
            cv2.accumulateWeighted(layer.astype(np.float32), acc, alpha)

        # —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è (–ª–µ–≥–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è "—Å—É–ø–µ—Ä" –≤–∏–¥–∞)
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ 8-–±–∏—Ç (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞).
        '''
        acc_u8 = np.clip(acc, 0, 255).astype(np.uint8)
        '''
–†–∞–∑–¥–µ–ª—è–µ–º –∫–∞–Ω–∞–ª—ã BGR.
        '''
        b, g, r = cv2.split(acc_u8)
        '''
–°–∫–æ–ª—å–∫–æ —Å–¥–≤–∏–≥–∞—Ç—å –∫–∞–Ω–∞–ª—ã –¥–ª—è –∞–±–µ—Ä—Ä–∞—Ü–∏–∏. –ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ.
        '''
        ch_shift = max(1, int(3 * progress))
        '''
–°–¥–≤–∏–≥–∞–µ–º —Å–∏–Ω–∏–π –≤–ª–µ–≤–æ, –∫—Ä–∞—Å–Ω—ã–π –≤–ø—Ä–∞–≤–æ. –ü–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∫–∏—Å–ª–æ—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç, —Ç–∏–ø–∞ –≥–ª–∞–∑–∞ –ª–æ–º–∞–µ—Ç.
        '''
        b = np.roll(b, -ch_shift, axis=1)
        r = np.roll(r, ch_shift, axis=1)
        '''
–°–∫–ª–µ–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –∫–∞–Ω–∞–ª—ã. –¢–µ–ø–µ—Ä—å —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≥–ª—é–∫–æ–º.
        '''
        merged = cv2.merge([b, g, r]).astype(np.float32)

        # –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –∫—ç—à–∏—Ä—É–µ–º –∑–≤—ë–∑–¥—ã –æ–¥–∏–Ω —Ä–∞–∑ (—Å–∞–º—ã–µ —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä)
        '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≥–æ—Ç–æ–≤—ã–µ "–∑–≤—ë–∑–¥—ã".
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –∏ —Ö—Ä–∞–Ω–∏–º –≤ –æ–±—ä–µ–∫—Ç–µ (—á—Ç–æ–± –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä).
        '''
        if not hasattr(self, '_tw_stars') or self._tw_stars.shape[0] < 1:
            '''
–°–æ–∑–¥–∞—ë–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª.
–° —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∏–¥–æ–º, —á—Ç–æ–± —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—ã–ª –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ.
            '''
            rng = np.random.default_rng(12345)  # —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏–¥ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            '''
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥. –ß–µ–º –±–æ–ª—å—à–µ —ç–∫—Ä–∞–Ω ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –∑–≤—ë–∑–¥.
            '''
            N = max(50, (w * h) // 20000)  # —Ä–∞–∑—É–º–Ω–æ–µ —á–∏—Å–ª–æ –∑–≤—ë–∑–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            '''
–ì–µ–Ω–µ—Ä–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–¥–∏—É—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–≤–µ–∑–¥—ã.
            '''
            xs = rng.integers(0, w, size=N)
            ys = rng.integers(0, h, size=N)
            rs = rng.integers(1, 3, size=N)
            '''
–°–∫–ª–∞–¥—ã–≤–∞–µ–º –≤—Å—ë –≤ –æ–¥–Ω—É –º–∞—Ç—Ä–∏—Ü—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º.
            '''
            self._tw_stars = np.column_stack((xs, ys, rs))
        # –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–æ–ª—é –∑–≤—ë–∑–¥ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ progress (–∏ –Ω–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –º–µ—Ä—Ü–∞–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
        '''
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∫–∞–¥—Ä–µ. –ß–µ–º –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ.
        '''
        star_count = int(len(self._tw_stars) * (0.2 + 0.8 * progress))
        '''
–°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∑–≤—ë–∑–¥.
        '''
        overlay = np.zeros((h, w, 3), dtype=np.uint8)
        '''
–ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –∑–≤—ë–∑–¥, –∫–æ—Ç–æ—Ä–∞—è –Ω—É–∂–Ω–∞ —Å–µ–π—á–∞—Å.
        '''
        for (x, y, r) in self._tw_stars[:star_count]:
            '''
–ó–≤—ë–∑–¥—ã —á—É—Ç—å —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
            '''
            radius = int(r + progress * 2)
            '''
–¶–≤–µ—Ç –∑–≤–µ–∑–¥—ã ‚Äî –±–µ–ª–æ-–∂—ë–ª—Ç—ã–π, —Å –æ—Ç—Ç–µ–Ω–∫–æ–º —è—Ä—á–µ –∫ –∫–æ–Ω—Ü—É.
            '''
            color = (255, 255, int(200 + 55 * progress))
            '''
–†–∏—Å—É–µ–º –∑–≤–µ–∑–¥—É –∫—Ä—É–∂–æ—á–∫–æ–º.
            '''
            cv2.circle(overlay, (int(x), int(y)), radius, color, -1, lineType=cv2.LINE_AA)
        # –¥–æ–±–∞–≤–ª—è–µ–º –∑–≤—ë–∑–¥—ã –≤ –≤–∏–¥–µ –ª—ë–≥–∫–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è (—É–º–Ω–æ–∂–∞–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ progress)
        '''
–î–æ–±–∞–≤–ª—è–µ–º –∑–≤—ë–∑–¥—ã –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ. –ß–µ–º –¥–∞–ª—å—à–µ ‚Äî —Ç–µ–º –æ–Ω–∏ —è—Ä—á–µ.
        '''
        merged += overlay.astype(np.float32) * (0.6 * progress)

        
        # –ø—Ä–æ—Å—Ç–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ (–±—ã—Å—Ç—Ä–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ)
        '''
–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å–µ—Ö —Ç–æ—á–µ–∫ –∫–∞–¥—Ä–∞ (—Å–µ—Ç–∫–∞).
        '''
        ys, xs = np.indices((h, w))
        '''
–¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏ (—Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π).
        '''
        cx_f, cy_f = w / 2.0, h / 2.0
        '''
–°—á–∏—Ç–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏.
        '''
        dist = np.sqrt((xs - cx_f) ** 2 + (ys - cy_f) ** 2)
        '''
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —É–≥–ª–æ–≤. –ù–æ—Ä–º–∏—Ä–æ–≤–∫–∞.
        '''
        maxd = np.sqrt(cx_f ** 2 + cy_f ** 2)
        '''
–°–æ–∑–¥–∞—ë–º –≤–∏–Ω—å–µ—Ç–∫—É: –∫—Ä–∞—è –∑–∞—Ç–µ–º–Ω—è—é—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ, —Ü–µ–Ω—Ç—Ä –æ—Å—Ç–∞—ë—Ç—Å—è —è—Ä–∫–∏–º.
        '''
        vign = 1.0 - 0.6 * (dist / maxd) ** 1.5 * progress
        '''
–ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–Ω—å–µ—Ç–∫—É –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ.
        '''
        merged *= vign[:, :, None]

        '''
üí° –ö–æ—Ä–æ—á–µ, –±—Ä–∞—Ç, —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫:
–°–Ω–∞—á–∞–ª–∞ –∑—É–º, –ø–æ—Ç–æ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ—ë–≤ —Å–º–µ—â–µ–Ω–∏—è ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≥–ª—é–∫,
–≤–µ—à–∞–µ–º –∑–≤—ë–∑–¥—ã, –∏ —Å–≤–µ—Ä—Ö—É ‚Äî –≤–∏–Ω—å–µ—Ç–∫–∞.
–í –∏—Ç–æ–≥–µ –≤—ã—Ö–æ–¥–∏—Ç –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π "–≤–∞—Ä–ø-—ç—Ñ—Ñ–µ–∫—Ç", –∫–∞–∫ –±—É–¥—Ç–æ –≤ –≥–∏–ø–µ—Ä–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤–ª–µ—Ç–∞–µ—à—å.
        '''
        return np.clip(merged, 0, 255).astype(frame.dtype)


    '''
üëâ –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Ä–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫—É—Å–∫–∏
–∏ –æ—Ç–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏—Ö –Ω–∞–∑–∞–¥, —Ç–∏–ø–∞ –æ–Ω–∏ —É–º–µ–Ω—å—à–∞—é—Ç—Å—è –∏ —É–ª–µ—Ç–∞—é—Ç.
grid_size ‚Äî —Å–∫–æ–ª—å–∫–æ –∫—É—Å–æ—á–∫–æ–≤ –±—É–¥–µ—Ç –ø–æ —Å–µ—Ç–∫–µ.
    '''
    def explosion_shatter_backward(self, frame, t, duration, grid_size=10):
        """–§—Ä–∞–≥–º–µ–Ω—Ç—ã —É–ª–µ—Ç–∞—é—Ç –ù–ê–ó–ê–î (—É–º–µ–Ω—å—à–∞—é—Ç—Å—è)"""
        progress = t / duration
        h, w = frame.shape[:2]
        '''
–°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —á—ë—Ä–Ω—ã–π –∫–∞–¥—Ä, –Ω–∞ –Ω–µ–≥–æ –±—É–¥–µ–º —Å–æ–±–∏—Ä–∞—Ç—å –≤—Å—é –¥–≤–∏–∂—É—Ö—É.
        '''
        new_frame = np.zeros_like(frame)

        '''
–î–µ–ª–∞–µ–º —Å–µ—Ç–∫—É –∏–∑ grid_size –Ω–∞ grid_size —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤. –¢–∏–ø–∞ –¥–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏.
        '''
        gh, gw = grid_size, grid_size
        '''
–ë–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–π —Å–µ—Ç–∫–µ: —Å—Ç—Ä–æ–∫–∞ –∑–∞ —Å—Ç—Ä–æ–∫–æ–π, –∫—É—Å–æ–∫ –∑–∞ –∫—É—Å–∫–æ–º.
        '''
        for i in range(gh):
            for j in range(gw):
                '''
–°—á–∏—Ç–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–≥–ª–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Å–∫–∞ (–ª–µ–≤—ã–π –≤–µ—Ä—Ö –∏ –ø—Ä–∞–≤—ã–π –Ω–∏–∑).
–¢–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞.
                '''
                x1, y1 = j * w // gw, i * h // gh
                x2, y2 = (j+1) * w // gw, (i+1) * h // gh
                '''
–í—ã—Ä–µ–∑–∞–µ–º –∫—É—Å–æ–∫ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞–¥—Ä–∞. –≠—Ç–æ –∏ –µ—Å—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏.
                '''
                frag = frame[y1:y2, x1:x2]
                '''
–ë–µ—Ä—ë–º –≤—ã—Å–æ—Ç—É –∏ —à–∏—Ä–∏–Ω—É —ç—Ç–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞. –ù—É–∂–Ω–æ –¥–ª—è —Ä–µ—Å–∞–π–∑–∞.
                '''
                fh, fw = frag.shape[:2]

                # –£–º–µ–Ω—å—à–µ–Ω–∏–µ (—É–ª–µ—Ç–∞–µ—Ç –Ω–∞–∑–∞–¥)
                '''
–ß–µ–º –¥–∞–ª—å—à–µ –∏–¥—ë–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏,
—Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —É–º–µ–Ω—å—à–∞–µ–º –∫—É—Å–æ–∫.
–í –Ω–∞—á–∞–ª–µ scale ‚âà 1 (–æ—Ä–∏–≥–∏–Ω–∞–ª), –≤ –∫–æ–Ω—Ü–µ –ø–æ—á—Ç–∏ 0.1 (–æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π).
–ù–∏–∂–µ 0.1 –Ω–µ –¥–∞—ë–º, —á—Ç–æ–± —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å–æ–≤—Å–µ–º –Ω–µ –∏—Å—á–µ–∑–ª–∏.
                '''
                scale = max(0.1, 1 - progress * 0.9)
                '''
–£–º–µ–Ω—å—à–∞–µ–º –∫—É—Å–æ–∫ –ø–æ –º–∞—Å—à—Ç–∞–±—É. –ú–∏–Ω–∏–º—É–º 1 –ø–∏–∫—Å–µ–ª—å, —á—Ç–æ–±—ã OpenCV –Ω–µ —É–ø–∞–ª.
                '''
                frag_resized = cv2.resize(frag, (max(1, int(fw*scale)), max(1, int(fh*scale))))
                '''
–ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞.
                '''
                rh, rw = frag_resized.shape[:2]

                # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
                '''
–í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —Ç–∞–∫,
—á—Ç–æ–±—ã –æ–Ω –æ—Å—Ç–∞–≤–∞–ª—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–≤–æ–µ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞.
–ò–Ω–∞—á–µ –æ–Ω –±—ã —Å—ä–µ–∑–∂–∞–ª –∫—É–¥–∞-—Ç–æ –≤ —Å—Ç–æ—Ä–æ–Ω—É.
                '''
                fx = (x1 + x2)//2 - rw//2
                fy = (y1 + y2)//2 - rh//2

                '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –Ω–µ –≤—ã–ª–µ–∑ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞–¥—Ä–∞. –ê —Ç–æ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞.
                '''
                if 0 <= fx < w and 0 <= fy < h:
                    '''
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª, —á—Ç–æ–± —Ç–æ—á–Ω–æ –≤–ª–µ–∑–ª–æ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É.
                    '''
                    x_end, y_end = min(w, fx+rw), min(h, fy+rh)
                    '''
–ï—Å–ª–∏ –∫—É—Å–æ–∫ —Ç–æ—Ä—á–∏—Ç, –ø–æ–¥—Ä–µ–∑–∞–µ–º –µ–≥–æ, —á—Ç–æ–± –Ω–µ –≤—ã—à–µ–ª –∑–∞ –∫–∞–¥—Ä.
                    '''
                    frag_crop = frag_resized[:y_end-fy, :x_end-fx]
                    '''
–ë–µ—Ä—ë–º —Ä–µ–≥–∏–æ–Ω –≤ –Ω–æ–≤–æ–º –∫–∞–¥—Ä–µ, –∫—É–¥–∞ –±—É–¥–µ–º –≤—Å—Ç–∞–≤–ª—è—Ç—å –∫—É—Å–æ–∫.
                    '''
                    roi = new_frame[fy:y_end, fx:x_end]
                    '''
–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: –≤ –Ω–∞—á–∞–ª–µ –∫—É—Å–∫–∏ —è—Ä–∫–∏–µ (alpha ‚âà 1), –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É –ø–æ—á—Ç–∏ –∏—Å—á–µ–∑–∞—é—Ç.
–ë–µ—Ä—ë–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Å—Ç–µ–ø–µ–Ω–∏ 1.5, —á—Ç–æ–± –ø–ª–∞–≤–Ω–µ–µ —É—Ö–æ–¥–∏–ª–æ.
                    '''
                    alpha = max(0, 1 - progress**1.5)
                    '''
–°–º–µ—à–∏–≤–∞–µ–º –∫—É—Å–æ–∫ —Å —Ñ–æ–Ω–æ–º. –ß–µ–º –¥–∞–ª—å—à–µ ‚Äî —Ç–µ–º –∫—É—Å–∫–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ.
                    '''
                    blended = cv2.addWeighted(frag_crop, alpha, roi, 1 - alpha, 0)
                    '''
–í—Å—Ç–∞–≤–ª—è–µ–º —Å–º–µ—à–∞–Ω–Ω—ã–π –∫—É—Å–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ –≤ –Ω–æ–≤—ã–π –∫–∞–¥—Ä.
                    '''
                    new_frame[fy:y_end, fx:x_end] = blended
        '''
üí° –í –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç: –≤—Å—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç—ã,
–∏ –æ–Ω–∏ –∫–∞–∫ –±—É–¥—Ç–æ —É–ª–µ—Ç–∞—é—Ç –≤ –≥–ª—É–±–∏–Ω—É,
—É–º–µ–Ω—å—à–∞—è—Å—å –∏ —Ä–∞—Å—Ç–≤–æ—Ä—è—è—Å—å. –¢–∏–ø–∞ "–≤–∑–æ—Ä–≤–∞–ª–æ—Å—å, –Ω–æ –≤ –æ–±—Ä–∞—Ç–∫—É".
        '''
        return new_frame

    def explosion_shatter_sides(self, frame, t, duration, grid_size=10):
        """–§—Ä–∞–≥–º–µ–Ω—Ç—ã: –ª–µ–≤—ã–µ —É–ª–µ—Ç–∞—é—Ç –≤–ø—Ä–∞–≤–æ, –ø—Ä–∞–≤—ã–µ ‚Äî –≤–ª–µ–≤–æ"""
        progress = t / duration
        h, w = frame.shape[:2]
        new_frame = np.zeros_like(frame)

        gh, gw = grid_size, grid_size
        '''
mid_x ‚Äî —Å–µ—Ä–µ–¥–∏–Ω–∞ –∫–∞–¥—Ä–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏. –ü–æ —ç—Ç–æ–π –ª–∏–Ω–∏–∏ —Ä–µ—à–∞–µ–º: –∫—É—Å–æ–∫ –ª–µ–≤—ã–π –∏–ª–∏ –ø—Ä–∞–≤—ã–π.
        '''
        mid_x = w // 2

        for i in range(gh):
            for j in range(gw):
                x1, y1 = j * w // gw, i * h // gh
                x2, y2 = (j+1) * w // gw, (i+1) * h // gh
                '''
–í—ã—Ä–µ–∑–∞–µ–º –∫—É—Å–æ–∫ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞. –≠—Ç–æ –Ω–∞—à —Ñ—Ä–∞–≥–º–µ–Ω—Ç.
                '''
                frag = frame[y1:y2, x1:x2]
                '''
–ó–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã.
                '''
                fh, fw = frag.shape[:2]

                '''
–í–æ—Ç —Ç—É—Ç –¥–≤–∏–∂—É—Ö–∞:

–ï—Å–ª–∏ –∫—É—Å–æ–∫ —Å–ª–µ–≤–∞ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ (x1 < mid_x) ‚Üí —Ç–∞—â–∏–º –≤–ø—Ä–∞–≤–æ (dx –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π).

–ï—Å–ª–∏ —Å–ø—Ä–∞–≤–∞ ‚Üí —Ç–∞—â–∏–º –≤–ª–µ–≤–æ (dx –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π).
üëâ –°–∏–ª–∞ —Å–¥–≤–∏–≥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç progress
(—á–µ–º –¥–∞–ª—å—à–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —É–ª–µ—Ç–∞–µ—Ç),
–∏ –º–∞—Å—à—Ç–∞–±–∞–µ–º –Ω–∞ 1.2*—à–∏—Ä–∏–Ω–∞, —á—Ç–æ–± —Ç–æ—á–Ω–æ —É–ª–µ—Ç–µ–ª–∏ –∑–∞ —ç–∫—Ä–∞–Ω.
                '''
                dx = int(progress * w * 1.2) if x1 < mid_x else -int(progress * w * 1.2)


                '''
–ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞:

fx ‚Äî –∫—É–¥–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ —Å–¥–≤–∏–Ω–µ–º,

fy ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–∞.
                '''
                fx = x1 + dx
                fy = y1


                '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–ª–µ—Ç–µ–ª –ª–∏ –∫—É—Å–æ–∫ —Å–æ–≤—Å–µ–º –∑–∞ –∫–∞–¥—Ä. –ï—Å–ª–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º.
                '''
                if 0 <= fx < w and 0 <= fy < h:
                    '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–º–∫–∞–º–∏ –∫–∞–¥—Ä–∞.
                    '''
                    x_end, y_end = min(w, fx+fw), min(h, fy+fh)
                    '''
–ï—Å–ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É ‚Äî –ø–æ–¥—Ä–µ–∑–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å.
                    '''
                    frag_crop = frag[:y_end-fy, :x_end-fx]
                    '''
–ë–µ—Ä—ë–º –æ–±–ª–∞—Å—Ç—å –Ω–∞ –Ω–æ–≤–æ–º –∫–∞–¥—Ä–µ, –∫—É–¥–∞ —ç—Ç–æ—Ç –∫—É—Å–æ–∫ –≤—Å—Ç–∞–Ω–µ—Ç.
                    '''
                    roi = new_frame[fy:y_end, fx:x_end]
                    '''
–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: –≤ –Ω–∞—á–∞–ª–µ –∫—É—Å–æ–∫ —è—Ä–∫–∏–π (alpha‚âà1), –ø–æ–¥ –∫–æ–Ω–µ—Ü —Ä–∞—Å—Ç–≤–æ—Ä—è–µ—Ç—Å—è (alpha‚Üí0).
                    '''
                    alpha = max(0, 1 - progress**1.5)
                    '''
–°–º–µ—à–∏–≤–∞–µ–º –∫—É—Å–æ–∫ —Å —Ç–µ–∫—É—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏, –ø–ª–∞–≤–Ω–æ –¥–µ–ª–∞—è –µ–≥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º.
                    '''
                    blended = cv2.addWeighted(frag_crop, alpha, roi, 1 - alpha, 0)
                    new_frame[fy:y_end, fx:x_end] = blended
        return new_frame

    def cartoonify2(self, frame, t, duration):
        progress = t / duration

        # --- 1. –£–º–µ–Ω—å—à–∞–µ–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ ---
        '''
–î–µ–ª–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –º–µ–Ω—å—à–µ –≤ –¥–≤–∞ —Ä–∞–∑–∞. –¢–∞–∫ –±—ã—Å—Ç—Ä–µ–µ —Å—á–∏—Ç–∞—Ç—å –∏ –º–µ–Ω—å—à–µ –Ω–∞–ø—Ä—è–≥–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä.
        '''
        small = cv2.pyrDown(frame)

        # --- 2. –ü–æ–≤—ã—à–∞–µ–º —è—Ä–∫–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç –¥–ª—è –º—É–ª—å—Ç—è—à–Ω–æ–≥–æ –≤–∏–¥–∞ ---
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ —Ü–≤–µ—Ç–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É HSV
(–≥–¥–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã: –æ—Ç—Ç–µ–Ω–æ–∫, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –∏ —è—Ä–∫–æ—Å—Ç—å). –£–¥–æ–±–Ω–µ–µ –∫—Ä—É—Ç–∏—Ç—å —Ü–≤–µ—Ç–∞.
        '''
        hsv = cv2.cvtColor(small, cv2.COLOR_BGR2HSV)
        '''
–†–∞–∑–¥–µ–ª–∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞: h ‚Äî —Ü–≤–µ—Ç, s ‚Äî –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å, v ‚Äî —è—Ä–∫–æ—Å—Ç—å.
        '''
        h, s, v = cv2.split(hsv)
        '''
–ü–æ–¥–∫—Ä—É—Ç–∏–ª–∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å (—á—Ç–æ–± —Ü–≤–µ—Ç–∞ –±—ã–ª–∏ —è—Ä—á–µ) –∏ —è—Ä–∫–æ—Å—Ç—å (—á—Ç–æ–± –≤—Å—ë —Å–∏—è–ª–æ).
        '''
        s = cv2.add(s, 30)   # –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å
        v = cv2.add(v, 20)   # —è—Ä–∫–æ—Å—Ç—å
        '''
–°–æ–±—Ä–∞–ª–∏ –∫–∞–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ.
        '''
        hsv = cv2.merge((h, s, v))
        '''
–í–µ—Ä–Ω—É–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±—ã—á–Ω—ã–π BGR (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ü–≤–µ—Ç –≤ OpenCV).
        '''
        small = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR)

        # --- 3. –ö–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ K-means ---
        '''
–î–µ–ª–∞–µ–º –∏–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫
(–∫–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –ø–∏–∫—Å–µ–ª—å —Å 3 —á–∏—Å–ª–∞–º–∏: —Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∫—Ä–∞—Å–Ω—ã–π).
        '''
        data = np.float32(small).reshape((-1, 3))
        '''
–ì–æ–≤–æ—Ä–∏–º: "–û—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ 9 —Ü–≤–µ—Ç–æ–≤". –ë—É–¥–µ—Ç –∫–∞–∫ —Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–µ, –±–µ–∑ –ø–ª–∞–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤.
        '''
        K = 9  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–≤–µ—Ç–æ–≤
        '''
–ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é K-means:

data ‚Äî –≤—Å–µ –ø–∏–∫—Å–µ–ª–∏.

K ‚Äî —á–∏—Å–ª–æ —Ü–≤–µ—Ç–æ–≤.

–ö—Ä–∏—Ç–µ—Ä–∏–∏ ‚Äî –ª–∏–±–æ 20 –∏—Ç–µ—Ä–∞—Ü–∏–π, –ª–∏–±–æ —Ç–æ—á–Ω–æ—Å—Ç—å 1.0.

10 —Ä–∞–∑ –ø—Ä–æ–±—É–µ–º, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

PP_CENTERS ‚Äî —É–º–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ç–æ—á–∫–∏.
        '''
        _, labels, centers = cv2.kmeans(
            data, K, None,
            (cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, 20, 1.0),
            10, cv2.KMEANS_PP_CENTERS
        )
        '''
–ó–∞–º–µ–Ω—è–µ–º –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –∏–∑ 9 —Ü–≤–µ—Ç–æ–≤.
–ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É, –∫–∞–∫ –±—É–¥—Ç–æ —Ö—É–¥–æ–∂–Ω–∏–∫ –Ω–∞—Ä–∏—Å–æ–≤–∞–ª –∑–∞–ª–∏–≤–∫–∞–º–∏.
        '''
        centers = np.uint8(centers)
        quantized = centers[labels.flatten()].reshape(small.shape)

        # --- 4. –û–±–≤–æ–¥–∫–∞ –∫–æ–Ω—Ç—É—Ä–æ–≤ ---
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —á—ë—Ä–Ω–æ-–±–µ–ª–æ–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –≥—Ä–∞–Ω–∏—Ü—ã.
        '''
        gray = cv2.cvtColor(small, cv2.COLOR_BGR2GRAY)
        '''
–ê–ª–≥–æ—Ä–∏—Ç–º –ö–∞–Ω–Ω–∏ –∏—â–µ—Ç —á—ë—Ç–∫–∏–µ –ª–∏–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ.
        '''
        edges = cv2.Canny(gray, 100, 200)
        '''
–î–µ–ª–∞–µ–º –ª–∏–Ω–∏–∏ —Ç–æ–ª—â–µ, —á—Ç–æ–± –±–æ–ª—å—à–µ –ø–æ—Ö–æ–¥–∏–ª–æ –Ω–∞ –º—É–ª—å—Ç—è—à–∫—É.
        '''
        edges = cv2.dilate(edges, None)   # —É—Ç–æ–ª—â–∞–µ–º –ª–∏–Ω–∏–∏
        '''
–ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º: –ª–∏–Ω–∏–∏ —Å—Ç–∞–ª–∏ —á—ë—Ä–Ω—ã–µ, —Ñ–æ–Ω –±–µ–ª—ã–π.
        '''
        edges = cv2.bitwise_not(edges)    # —á—ë—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏ –Ω–∞ –±–µ–ª–æ–º
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –ª–∏–Ω–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ç—Ä—ë—Ö–∫–∞–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç, —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–æ–≤–º–µ—â–∞—Ç—å —Å —Ü–≤–µ—Ç–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.
        '''
        edges_colored = cv2.cvtColor(edges, cv2.COLOR_GRAY2BGR)

        # --- 5. –°–æ–µ–¥–∏–Ω—è–µ–º –∑–∞–ª–∏–≤–∫–∏ –∏ –ª–∏–Ω–∏–∏ ---
        '''
–ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —á—ë—Ç–∫–∏–µ –ª–∏–Ω–∏–∏ –Ω–∞ –∑–∞–ª–∏–≤–∫—É —Ü–≤–µ—Ç–æ–≤. –ü–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç —Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–º–∏–∫—Å–∞.
        '''
        cartoon_small = cv2.bitwise_and(quantized, edges_colored)

        # --- 6. –õ—ë–≥–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å ‚Äú—à—É–º‚Äù ---
        '''
–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç —Ü–≤–µ—Ç–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫—Ä–∞—è. –¢–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–º–æ—Ç—Ä–∏—Ç—Å—è –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ.
        '''
        cartoon_small = cv2.bilateralFilter(cartoon_small, d=5, sigmaColor=50, sigmaSpace=50)

        # --- 7. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º–µ—Ä ---
        '''
–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –¥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–¥—Ä–∞.
        '''
        cartoon = cv2.pyrUp(cartoon_small)

        # --- 8. –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ (–æ–±—ã—á–Ω–æ–µ ‚Üí –º—É–ª—å—Ç—è—à–Ω–æ–µ) ---
        '''
–î–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ:

–í –Ω–∞—á–∞–ª–µ (progress=0) –≤–∏–¥–∏–º –æ–±—ã—á–Ω–æ–µ –≤–∏–¥–µ–æ.

–í –∫–æ–Ω—Ü–µ (progress=1) –≤–∏–¥–∏–º –º—É–ª—å—Ç—è—à–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.
        '''
        cartoon = cv2.addWeighted(frame, 1 - progress, cartoon, progress, 0)

        '''
‚ö° –í –∏—Ç–æ–≥–µ: –∫–∞—Ä—Ç–∏–Ω–∫–∞ —è—Ä—á–µ, —Ü–≤–µ—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã, –∫–æ–Ω—Ç—É—Ä—ã –∂–∏—Ä–Ω—ã–µ,
–≤—Å—ë –ø–ª–∞–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –æ—Ç —Ä–µ–∞–ª–∞ –≤ "–º—É–ª—å—Ç". –í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –±—É–¥—Ç–æ –Ω–∞—Ä–∏—Å–æ–≤–∞–ª–∏.
        '''
        return cartoon

    def infinity_spiral2(self, frame, t, duration, twist=3.0, pull=0.5, spins=2.0):
        """
    –ü–ª–∞–≤–Ω–∞—è –Ω–∞—Å—ã—â–µ–Ω–Ω–∞—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Å–ø–∏—Ä–∞–ª—å.
    - twist: —Å–∏–ª–∞ –∑–∞–∫—Ä—É—á–∏–≤–∞–Ω–∏—è (–±–æ–ª—å—à–µ = –±–æ–ª–µ–µ –≥—É—Å—Ç–∞—è —Å–ø–∏—Ä–∞–ª—å)
    - pull: –∑–∞—Ç—è–≥–∏–≤–∞–Ω–∏–µ –≤ —Ü–µ–Ω—Ç—Ä
    - spins: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä–æ—Ç–æ–≤ –∑–∞ –∞–Ω–∏–º–∞—Ü–∏—é
        """
        # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
        progress = t / duration
        # –ü–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è (ease-in-out, —Å–∏–Ω—É—Å–æ–∏–¥–∞)
        '''
–ß—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫—Ä—É—Ç–∏–ª–∞—Å—å –Ω–µ –¥—ë—Ä–≥–∞–Ω–æ, –∞ –ø–ª–∞–≤–Ω–æ,
–¥–µ–ª–∞–µ–º ¬´—Å–∏–Ω—É—Å–æ–≤—É—é¬ª –ø–ª–∞–≤–Ω–æ—Å—Ç—å:
–º–µ–¥–ª–µ–Ω–Ω–æ —Å—Ç–∞—Ä—Ç–∞–Ω—É–ª–∞, —Ä–∞–∑–æ–≥–Ω–∞–ª–∞—Å—å –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∑–∞—Ç–æ—Ä–º–æ–∑–∏–ª–∞.
        '''
        smooth_progress = 0.5 * (1 - np.cos(progress * np.pi))

        '''
–ë–µ—Ä—ë–º –≤—ã—Å–æ—Ç—É –∏ —à–∏—Ä–∏–Ω—É –∫–∞–¥—Ä–∞.
–ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—Ç—Ä, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç—É–¥–∞ –±—É–¥–µ–º —Ç—è–Ω—É—Ç—å –∏ –≤–æ–∫—Ä—É–≥ –Ω–µ–≥–æ –∫—Ä—É—Ç–∏—Ç—å.
        '''
        h, w = frame.shape[:2]
        center_x, center_y = w / 2, h / 2

        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–µ—Ç–∫–∞
        '''
–°—Ç—Ä–æ–∏–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: x –∏ y ‚Äî —ç—Ç–æ –º–∞—Ç—Ä–∏—Ü—ã,
–≥–¥–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ —É–∫–∞–∑–∞–Ω–æ –µ—ë –º–µ—Å—Ç–æ. –ë–µ–∑ —ç—Ç–æ–≥–æ –Ω–∏–∫–∞–∫ –Ω–µ –∑–∞–∫—Ä—É—Ç–∏—à—å –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        y, x = np.indices((h, w))
        '''
–°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏—è: –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏.
        '''
        dx = x - center_x
        dy = y - center_y

        # –ü–æ–ª—è—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –ø–æ–ª—è—Ä–∫—É:

r ‚Äî —ç—Ç–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ (—Ä–∞–¥–∏—É—Å).

theta ‚Äî —É–≥–æ–ª –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.
        '''
        r = np.sqrt(dx**2 + dy**2)
        theta = np.arctan2(dy, dx)

        # –°–ø–∏—Ä–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ
        '''
–í–æ—Ç —Ç—É—Ç —Å–∞–º–æ–µ –º—è—Å–æ:

–∫—Ä—É—Ç–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —É–≥–æ–ª,
–∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (smooth_progress * spins * 2œÄ = —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–≤–µ—Ä–Ω—ë—Ç—Å—è).

–ø–ª—é—Å –¥–æ–±–∞–≤–ª—è–µ–º ¬´twist¬ª ‚Äî —á–µ–º –¥–∞–ª—å—à–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç (–≥—É—Å—Ç–∞—è —Å–ø–∏—Ä–∞–ª—å).
        '''
        theta += smooth_progress * spins * 2 * np.pi + twist * (r / max(w, h))

        # –ó–∞—Ç—è–≥–∏–≤–∞–Ω–∏–µ –≤ —Ü–µ–Ω—Ç—Ä
        '''
–†–∞–¥–∏—É—Å —É–º–µ–Ω—å—à–∞–µ–º ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ –ø–∏–∫—Å–µ–ª–∏ –∑–∞—Å–∞—Å—ã–≤–∞–µ—Ç –≤ —Ü–µ–Ω—Ç—Ä. –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ç—è–Ω–µ—Ç.
        '''
        r = r * (1 - pull * smooth_progress)

        # –ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        '''
–ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∏–∫—Å–µ–ª–µ–π –ø–æ—Å–ª–µ –∫—Ä—É—á–µ–Ω–∏—è.

cos –∏ sin –ø–µ—Ä–µ–≤–æ–¥—è—Ç –ø–æ–ª—è—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±—ã—á–Ω—ã–µ.

% w –∏ % h –Ω–µ –¥–∞—é—Ç –∫–∞—Ä—Ç–∏–Ω–∫–µ –≤—ã–≤–∞–ª–∏—Ç—å—Å—è –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã ‚Äî —Ç–∏–ø–∞ –∑–∞–º—ã–∫–∞–µ–º –µ—ë –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.
        '''
        src_x = (center_x + r * np.cos(theta)).astype(np.int32) % w
        src_y = (center_y + r * np.sin(theta)).astype(np.int32) % h

        '''
–°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –∫–∞–¥—Ä: –±–µ—Ä—ë–º –ø–∏–∫—Å–µ–ª–∏ –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ –Ω–æ–≤–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É.
–í—Å—ë –ø–µ—Ä–µ–º–µ—à–∞–ª–æ—Å—å ‚Äî –ø–æ–ª—É—á–∏–ª–∞—Å—å –∫—Ä—É—á—ë–Ω–∞—è —Å–ø–∏—Ä–∞–ª—å.
        '''
        new_frame = frame[src_y, src_x]

        '''
üëâ –û—Ç–¥–∞—ë–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä. –í—Å—ë,
–≤–∏–¥–æ—Å –∑–∞–∫—Ä—É—Ç–∏–ª—Å—è –∫–∞–∫ –≤–æ—Ä–æ–Ω–∫–∞, –±—É–¥—Ç–æ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –º–∏—Ä –∑–∞—Ç—è–≥–∏–≤–∞–µ—Ç. üå™Ô∏è
        '''
        return new_frame

    
    def mirror_maze2(self, frame, t, duration):
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        progress = max(0.0, min(1.0, t / duration))
        '''
–ï—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–æ–ª—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –±–µ–∑ –≤—Å—è–∫–∏—Ö —Ñ–æ–∫—É—Å–æ–≤. –ù–µ—á–µ–≥–æ –¥–µ—Ä–≥–∞—Ç—å—Å—è.
        '''
        if progress == 0.0:
            return frame.copy()

        h, w = frame.shape[:2]
        out = frame.copy()

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å
        '''
–†–µ—à–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –∑–µ—Ä–∫–∞–ª –±—É–¥–µ—Ç.

–±–∞–∑–æ–≤–æ 2.

–¥–æ–±–∞–≤–ª—è–µ–º –µ—â—ë, –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–º–∞–∫—Å–∏–º—É–º –¥–æ 5).
        '''
        base_mirrors = 2
        extra_max = 3             # –≤—Å–µ–≥–æ –¥–æ 5 –∑–µ—Ä–∫–∞–ª
        num_mirrors = base_mirrors + int(progress * extra_max)
        '''
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã:

offset ‚Äî –æ—Ç—Å—Ç—É–ø –∑–µ—Ä–∫–∞–ª –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.

scale ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–º–µ–Ω—å—à–∞—é—Ç—Å—è –¥–∞–ª—å–Ω–∏–µ –∑–µ—Ä–∫–∞–ª–∞.

rotation_max ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –º–æ–≥—É—Ç –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è.

shear_max ‚Äî –Ω–∞–∫–ª–æ–Ω –≤–±–æ–∫.

alpha ‚Äî –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –±–ª–∏–∂–Ω–∏—Ö —Å–ª–æ—ë–≤.
        '''
        base_offset = int(20 + 10 * progress)
        max_depth_scale = 0.7     # –Ω–∞—Å–∫–æ–ª—å–∫–æ –≥–ª—É–±–∂–µ –∑–µ—Ä–∫–∞–ª–æ –º–æ–∂–µ—Ç —Å–∂–∏–º–∞—Ç—å
        rotation_max = 8.0        # –≥—Ä–∞–¥—É—Å—ã
        shear_max = 0.15          # –Ω–µ–±–æ–ª—å—à–∞—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è
        base_alpha = 0.85         # –±–∞–∑–æ–≤–∞—è –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –±–ª–∏–∂–Ω–∏—Ö –∑–µ—Ä–∫–∞–ª

        '''
–ü–æ–≥–Ω–∞–ª–∏ –¥–µ–ª–∞—Ç—å –≤—Å–µ –∑–µ—Ä–∫–∞–ª–∞ –ø–æ –æ—á–µ—Ä–µ–¥–∏.
        '''
        for i in range(1, num_mirrors + 1):
            '''
–ì–ª—É–±–∏–Ω–∞ –∑–µ—Ä–∫–∞–ª–∞: —á–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –Ω–æ–º–µ—Ä ‚Üí —Ç–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ –∏ –º–µ–Ω—å—à–µ.
            '''
            depth = i / float(num_mirrors)                 # [0..1]
            # –º–∞—Å—à—Ç–∞–±: –≥–ª—É–±–∂–µ -> –º–µ–Ω—å—à–µ (–ø–∞—Ä–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç —á—É—Ç—å –∑–∞–º–µ—Ç–Ω–µ–µ)
            '''
–ß–µ–º –≥–ª—É–±–∂–µ –∑–µ—Ä–∫–∞–ª–æ, —Ç–µ–º –æ–Ω–æ –º–µ–Ω—å—à–µ. –ï—Å–ª–∏ —Å—Ç–∞–ª–æ —Å–æ–≤—Å–µ–º –º–∏–∫—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∏–º ‚Äî —Å–∫–∏–ø–∞–µ–º.
            '''
            scale = 1.0 - (max_depth_scale * (depth ** 1.2) * progress)
            if scale <= 0.05:
                continue

            # –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ: —à–∏—Ä–∏–Ω–∞ —É–º–µ–Ω—å—à–∞–µ–º —Å–∏–ª—å–Ω–µ–µ
            '''
–£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–ª—É–±–∏–Ω—ã.
–ü–æ —à–∏—Ä–∏–Ω–µ —Ä–µ–∂–µ–º —Å–∏–ª—å–Ω–µ–µ ‚Äî —á—Ç–æ–± —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã.
            '''
            small_w = max(2, int(w * scale * (1.0 - 0.25 * depth * progress)))
            small_h = max(2, int(h * scale))

            # resize (–±—ã—Å—Ç—Ä–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ ‚Äî INTER_AREA)
            '''
–°–∂–∏–º–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–æ —ç—Ç–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤.
            '''
            small = cv2.resize(frame, (small_w, small_h), interpolation=cv2.INTER_AREA)

            # –ª—ë–≥–∫–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ (–ø–æ–ø–µ—Ä–µ–º–µ–Ω–Ω–æ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ)
            '''
–ö–∞–∂–¥–æ–µ –∑–µ—Ä–∫–∞–ª–æ —á—É—Ç–∫–∞ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–æ –≤–ª–µ–≤–æ, —Ç–æ –≤–ø—Ä–∞–≤–æ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–æ–º–µ—Ä–∞).
            '''
            angle = ((-1) ** i) * rotation_max * depth * progress
            '''
–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, –∫—Ä—É—Ç–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–∏ —ç—Ç–æ–º –∫—Ä–∞—è –∑–µ—Ä–∫–∞–ª–∏–º, —á—Ç–æ–± –¥—ã—Ä –Ω–µ –±—ã–ª–æ.
            '''
            Mrot = cv2.getRotationMatrix2D((small_w / 2.0, small_h / 2.0), angle, 1.0)
            small = cv2.warpAffine(small, Mrot, (small_w, small_h), flags=cv2.INTER_LINEAR,
                                   borderMode=cv2.BORDER_REFLECT)

            # –ª—ë–≥–∫–∞—è "—Å–¥–≤–∏–≥-–Ω–∞–∫–ª–æ–Ω" (shear) –ø–æ X –¥–ª—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
            '''
–î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞.
            '''
            shear = ((-1) ** (i + 1)) * shear_max * depth * progress
            # affine matrix: [1, shear, 0; 0,1,0]
            '''
–®–∏—Ñ—Ç—É–µ–º –ø–æ –æ—Å–∏ X (—Ç–∏–ø–∞ ¬´shear¬ª). –ß—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ ‚Äî —Ä–∞—Å—à–∏—Ä—è–µ–º —à–∏—Ä–∏–Ω—É.
            '''
            A = np.float32([[1.0, shear, 0.0], [0.0, 1.0, 0.0]])
            # —Ä–∞—Å—à–∏—Ä–∏–º —à–∏—Ä–∏–Ω—É –Ω–∞ –∑–∞–ø–∞—Å, –µ—Å–ª–∏ shear –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
            add_w = int(abs(shear) * small_h) + 2
            small = cv2.warpAffine(small, A, (small_w + add_w, small_h), flags=cv2.INTER_LINEAR,
                                   borderMode=cv2.BORDER_REFLECT)
            '''
–û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—É—é —à–∏—Ä–∏–Ω—É –ø–æ—Å–ª–µ –Ω–∞–∫–ª–æ–Ω–∞.
            '''
            small_w = small.shape[1]  # –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞

            # –ª—ë–≥–∫–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ –¥–ª—è –≥–ª—É–±–∏–Ω—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è i>1)
            '''
–î–∞–ª—å–Ω–∏–µ –∑–µ—Ä–∫–∞–ª–∞ —Å–ª–µ–≥–∫–∞ —Ä–∞–∑–º—ã–≤–∞–µ–º ‚Äî —á—Ç–æ–± –æ—â—É—â–µ–Ω–∏–µ –≥–ª—É–±–∏–Ω—ã.
            '''
            if i > 1:
                small = cv2.GaussianBlur(small, (3, 3), 0)

            # –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–ª—è –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
            '''
–î–µ–ª–∞–µ–º –∑–µ—Ä–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é (–ø—Ä–∞–≤—É—é —Å—Ç–æ—Ä–æ–Ω—É).
            '''
            flipped = cv2.flip(small, 1)

            # –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –æ—Ç —Å–º–µ—â–µ–Ω–∏—è –∫ —Ü–µ–Ω—Ç—Ä—É –∏ –≤–Ω–∏–∑ (–ø–∞—Ä–∞–ª–ª–∞–∫—Å)
            '''
–°–º–µ—â–∞–µ–º –∑–µ—Ä–∫–∞–ª–∞: —á–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –≤–±–æ–∫ –∏ –≤–Ω–∏–∑ —É—Ö–æ–¥–∏—Ç.
            '''
            offset_x = int(i * base_offset * progress + depth * 8)
            offset_y = int(depth * 18 * progress)

            # –∞–ª—å—Ñ–∞: –±–ª–∏–∂–Ω–∏–µ –±–æ–ª–µ–µ —è—Ä–∫–∏–µ, –¥–∞–ª—å–Ω–∏–µ –±–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã
            '''
–ß–µ–º –¥–∞–ª—å—à–µ –∑–µ—Ä–∫–∞–ª–æ, —Ç–µ–º –±–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ.
            '''
            alpha_global = base_alpha * (1.0 - 0.6 * depth * progress)
            alpha_global = float(np.clip(alpha_global, 0.08, 0.95))

            # —Ü–≤–µ—Ç–æ–≤–∞—è —Ç–æ–Ω–∏—Ä–æ–≤–∫–∞: –±–ª–∏–∂–µ ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ, –¥–∞–ª—å—à–µ ‚Äî —Ö–æ–ª–æ–¥/—Ç—ë–ø–ª–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
            # —Å–æ–∑–¥–∞—ë–º –º–∞—Ç—Ä–∏—Ü—É –æ–¥–Ω–æ—Ç–æ–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ —Å–º–µ—à–∏–≤–∞–µ–º
            '''
–î–∞–ª—å–Ω–∏–º –∑–µ—Ä–∫–∞–ª–∞–º –ø–æ–¥–º–µ—à–∏–≤–∞–µ–º —Ü–≤–µ—Ç ‚Äî —Ç–æ —Ö–æ–ª–æ–¥–Ω—ã–π, —Ç–æ —Ç—ë–ø–ª—ã–π, —á—Ç–æ–± –±—ã–ª —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã—Ö –æ—Ç—Ä–∞–∂–µ–Ω–∏–π.
            '''
            tint_strength = 0.12 * depth * progress  # 0..~0.12
            # example: —á–µ—Ä–µ–¥—É–µ–º —Ç–µ–ø–ª—É—é –∏ —Ö–æ–ª–æ–¥–Ω—É—é —Ç–æ–Ω–∏—Ä–æ–≤–∫–∏
            if i % 2 == 0:
                tint_color = np.full_like(small, (12, 0, 0))      # –ª—ë–≥–∫–∏–π —Ç—ë–ø–ª—ã–π (BGR)
            else:
                tint_color = np.full_like(small, (0, 8, 16))      # –ª—ë–≥–∫–∏–π —Ö–æ–ª–æ–¥–Ω—ã–π
            small = cv2.addWeighted(small, 1.0 - tint_strength, tint_color, tint_strength, 0)

            # prepare alpha mask: –ø–ª–∞–≤–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (–ø–æ –∫—Ä–∞—è–º)
            '''
–î–µ–ª–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç (–º–∞—Å–∫—É –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏).
            '''
            w_s = small_w
            ramp = np.linspace(1.0, 0.0, w_s).astype(np.float32)
            # —Å–æ–∑–¥–∞—ë–º –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –º–∞—Å–∫—É (—Ü–µ–Ω—Ç—Ä –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ, –∫—Ä–∞—è ‚Äî –±–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ)
            # –ª—É—á—à–µ —Å–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø–∏–∫–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å:
            '''
–ú–∞—Å–∫–∞ –¥–µ–ª–∞–µ—Ç—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ –∫—Ä–∞—è–º –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ, –∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –ø–ª–æ—Ç–Ω–µ–µ. –≠—Ç–æ –¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –∑–µ—Ä–∫–∞–ª–∞.
            '''
            center = w_s // 2
            left = np.linspace(0.0, 1.0, center, endpoint=False)
            right = left[::-1]
            if w_s % 2 == 1:
                profile = np.concatenate([left, [1.0], right])
            else:
                profile = np.concatenate([left, right])
            profile = profile * alpha_global  # –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∞–ª—å—Ñ–µ
            alpha_mask = np.tile(profile[np.newaxis, :], (small.shape[0], 1))  # H x W
            alpha_mask = np.expand_dims(alpha_mask, axis=2)  # H x W x 1

            # –§—É–Ω–∫—Ü–∏—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è –±–ª–æ–∫–∞ —Å –º–∞—Å–∫–æ–π –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤)
            '''
–¢—É—Ç –º–∏–Ω–∏-—Ñ—É–Ω–∫—Ü–∏—è: –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∑–µ—Ä–∫–∞–ª–æ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å–º–µ—à–∏–≤–∞—è –ø–æ –∞–ª—å—Ñ–∞-–º–∞—Å–∫–µ.
            '''
            def blend_to(dst, src, top, left):
                h_s, w_s = src.shape[:2]
                y1 = max(0, top)
                y2 = min(h, top + h_s)
                x1 = max(0, left)
                x2 = min(w, left + w_s)
                if y1 >= y2 or x1 >= x2:
                    return
                sy1 = y1 - top
                sy2 = sy1 + (y2 - y1)
                sx1 = x1 - left
                sx2 = sx1 + (x2 - x1)
                src_part = src[sy1:sy2, sx1:sx2].astype(np.float32)
                dst_part = dst[y1:y2, x1:x2].astype(np.float32)

                am = alpha_mask[sy1:sy2, sx1:sx2]
                # 3-channel alpha
                am3 = np.repeat(am, 3, axis=2)
                blended = src_part * am3 + dst_part * (1.0 - am3)
                dst[y1:y2, x1:x2] = np.clip(blended, 0, 255).astype(np.uint8)

            # –ù–∞–ª–æ–∂–µ–Ω–∏–µ –ª–µ–≤–æ–≥–æ –∑–µ—Ä–∫–∞–ª–∞
            blend_to(out, small, offset_y, offset_x)

            # –ù–∞–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–≥–æ –∑–µ—Ä–∫–∞–ª–∞ (—Å —É—á—ë—Ç–æ–º –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü—ã)
            right_x = w - offset_x - small_w
            blend_to(out, flipped, offset_y, right_x)

        '''
üî• –ë—Ä–∞—Ç–∞–Ω, —ç—Ñ—Ñ–µ–∫—Ç —Ä–µ–∞–ª—å–Ω–æ —Å–æ–ª–∏–¥–Ω—ã–π, –∫–∞–∫ –±—É–¥—Ç–æ –≤ ¬´–î–æ–º —Å–º–µ—Ö–∞¬ª –ø–æ–ø–∞–ª.
        '''
        return out



    '''
–§—É–Ω–∫—Ü–∏—è –º—É—Ç–∏—Ç —ç—Ñ—Ñ–µ–∫—Ç –≥–ª–∏—Ç—á–∞.
–ë–µ—Ä—ë—Ç –∫–∞–¥—Ä frame, –≤—Ä–µ–º—è t, —Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç duration,
–Ω—É –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
–Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –¥—ë—Ä–≥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É (max_vshift)
–∏ —Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π —Ü–≤–µ—Ç–∞ –æ—Å—Ç–∞–≤–ª—è—Ç—å (posterize_max_levels).
    '''
    def glitch_art2(self, frame, t, duration, max_vshift=24, posterize_max_levels=16):
        # –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1
        progress = float(np.clip(t / float(duration), 0.0, 1.0))

        h, w = frame.shape[:2]
        new_frame = frame.copy()

        # 1) –ü–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (—É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π —Ü–≤–µ—Ç–∞ –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)
        # levels: –æ—Ç posterize_max_levels (–º–∞–ª—ã–π –≥–ª–∏—Ç—á) –¥–æ 2 (—Å–∏–ª—å–Ω—ã–π –≥–ª–∏—Ç—á)
        '''
–°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ü–≤–µ—Ç–æ–≤ –æ—Å—Ç–∞–≤–∏–º.
–í –Ω–∞—á–∞–ª–µ –º–Ω–æ–≥–æ (–ø–æ—á—Ç–∏ –±–µ–∑ –≥–ª–∏—Ç—á–∞),
–∫ –∫–æ–Ω—Ü—É –≤—Å—ë —Å–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ 2 —É—Ä–æ–≤–Ω–µ–π (–∂—ë—Å—Ç–∫–∏–π –≥–ª–∏—Ç—á, –≤—Å—ë –≤ –∫–∏—Å–ª–æ—Ç–Ω—ã—Ö –ø—è—Ç–Ω–∞—Ö).
        '''
        levels = max(2, int(posterize_max_levels - (posterize_max_levels - 2) * progress))
        '''
–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∞–≥ –∫–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏–∏. –ß–µ–º –º–µ–Ω—å—à–µ —É—Ä–æ–≤–Ω–µ–π ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ —à–∞–≥.
        '''
        quant = max(1, 256 // levels)
        # integer posterize: —É–±—Ä–∞—Ç—å –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å —Ü–≤–µ—Ç–æ–≤
        '''
–ñ—ë—Å—Ç–∫–æ –æ–∫—Ä—É–≥–ª—è–µ–º —Ü–≤–µ—Ç–∞ –∫ –±–ª–∏–∂–∞–π—à–µ–º—É "—É—Ä–æ–≤–Ω—é". –≠—Ç–æ –∏ –µ—Å—Ç—å –ø–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è.
–î–æ–±–∞–≤–ª—è–µ–º quant//2, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª–∞ —á–µ—Ä–µ—Å—á—É—Ä —Ç—É—Ö–ª–æ–π.
        '''
        new_frame = (new_frame // quant) * quant + quant // 2
        '''
–û–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ 0‚Äì255. –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Ü–µ–ª–æ–º—É —Ç–∏–ø—É –ø–∏–∫—Å–µ–ª–µ–π.
        '''
        new_frame = np.clip(new_frame, 0, 255).astype(np.uint8)

        # 2) –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã: —Å–æ–∑–¥–∞—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ —Å–¥–≤–∏–≥–∞–µ–º –∏—Ö –ø–æ Y
        '''
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–æ—Å (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –∫—É—Å–∫–æ–≤). –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –±–æ–ª—å—à–µ —ç—Ç–∏—Ö –ø–æ–ª–æ—Å.
        '''
        bands = 2 + int(progress * 6)  # –æ—Ç 2 –¥–æ ~8
        '''
–ù–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥—ë—Ä–≥–∞—Ç—å –ø–æ–ª–æ—Å—ã –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑. –í –Ω–∞—á–∞–ª–µ —á—É—Ç—å-—á—É—Ç—å, –ø–æ—Ç–æ–º –≤—Å—ë —Å–∏–ª—å–Ω–µ–µ.
        '''
        max_shift = max(0, int(max_vshift * (0.15 + 0.85 * progress)))
        '''
–ë—É–¥–µ–º –≥–æ–Ω—è—Ç—å –∫–∞–∂–¥—É—é –ø–æ–ª–æ—Å—É.
        '''
        for _ in range(bands):
            '''
–®–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ—Å—ã —Å–ª—É—á–∞–π–Ω–∞—è: –æ—Ç –º–∞–ª–µ–Ω—å–∫–æ–π –¥–æ –¥–æ–≤–æ–ª—å–Ω–æ —à–∏—Ä–æ–∫–æ–π.
            '''
            bw = random.randint(max(1, int(w * 0.03)), max(2, int(w * 0.18)))
            '''
–í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ, –≥–¥–µ –∏–º–µ–Ω–Ω–æ —ç—Ç–∞ –ø–æ–ª–æ—Å–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
            '''
            x = random.randint(0, max(0, w - bw))
            '''
–†–µ—à–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –µ—ë —Å–¥–≤–∏–Ω—É—Ç—å –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (–≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑).
            '''
            shift_y = random.randint(-max_shift, max_shift)
            '''
–ï—Å–ª–∏ –µ—Å—Ç—å —Å–¥–≤–∏–≥ ‚Äî –±–µ—Ä—ë–º —ç—Ç—É –ø–æ–ª–æ—Å—É –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ (–∫–∞–∫ —Ç–µ–ª–µ–∫ –±–µ–∑ –∞–Ω—Ç–µ–Ω–Ω—ã).
            '''
            if shift_y != 0:
                # np.roll –±—ã—Å—Ç—Ä–æ –¥–µ–ª–∞–µ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥
                new_frame[:, x:x + bw] = np.roll(new_frame[:, x:x + bw], shift_y, axis=0)

        # 3) –ö–æ—Ä–æ—Ç–∫–∏–µ —è—Ä–∫–∏–µ –ª–∏–Ω–∏–π–∫–∏ (scan streaks), –∏–Ω–æ–≥–¥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ, –∏–Ω–æ–≥–¥–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ
        '''
–° —à–∞–Ω—Å–æ–º (–∑–∞–≤–∏—Å—è—â–∏–º –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞) –¥–æ–±–∞–≤–ª—è–µ–º —è—Ä–∫–∏–µ –ª–∏–Ω–∏–∏.
        '''
        if random.random() < 0.9 * (0.3 + 0.7 * progress):
            '''
–ß–µ–º –¥–∞–ª—å—à–µ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –ª–∏–Ω–∏–π.
            '''
            lines = 1 + int(progress * 8)
            '''
–ù–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ —ç—Ç–∏ –ª–∏–Ω–∏–∏ —Å–≤–µ—Ç—è—Ç—Å—è (–∞–º–ø–ª–∏—Ç—É–¥–∞ —è—Ä–∫–æ—Å—Ç–∏).
            '''
            amp = int(80 * progress) + 10  # —è—Ä–∫–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            '''
–†–∏—Å—É–µ–º –∫–∞–∂–¥—É—é –ª–∏–Ω–∏—é.
            '''
            for _ in range(lines):
                '''
–° 60% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é ‚Äî –¥–µ–ª–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é. –ò–Ω–∞—á–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é.
                '''
                if random.random() < 0.6:
                    # –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
                    '''
–ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ –ø–æ –≤—ã—Å–æ—Ç–µ, –∑–∞–¥–∞—ë–º —Ç–æ–ª—â–∏–Ω—É –ª–∏–Ω–∏–∏ (1‚Äì4 –ø–∏–∫—Å–µ–ª—è).
                    '''
                    y = random.randint(0, max(0, h - 1))
                    th = random.randint(1, min(4, max(1, int(h * 0.02))))
                    '''
–°–æ–∑–¥–∞—ë–º –ø–æ–ª–æ—Å–∫—É —Ç–∞–∫–æ–≥–æ –∂–µ —Ä–∞–∑–º–µ—Ä–∞, –∑–∞–ø–æ–ª–Ω—è–µ–º —è—Ä–∫–∏–º —Ü–≤–µ—Ç–æ–º.
                    '''
                    tmp = np.zeros((th, w, 3), dtype=np.uint8) + random.randint(amp//2, amp)
                    '''
–ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ–ª–æ—Å–∫—É –ø–æ–≤–µ—Ä—Ö –∫–∞–¥—Ä–∞. –û–Ω–∞ –∫–∞–∫ –≤—Å–ø—ã—à–∫–∞.
                    '''
                    y1 = np.clip(y, 0, h - th)
                    new_frame[y1:y1 + th] = cv2.add(new_frame[y1:y1 + th], tmp)
                    '''
–≠—Ç–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏.
                    '''
                else:
                    # –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
                    x = random.randint(0, max(0, w - 1))
                    tw = random.randint(1, min(6, max(1, int(w * 0.02))))
                    tmp = np.zeros((h, tw, 3), dtype=np.uint8) + random.randint(amp//2, amp)
                    x1 = np.clip(x, 0, w - tw)
                    new_frame[:, x1:x1 + tw] = cv2.add(new_frame[:, x1:x1 + tw], tmp)

        # 4) –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –ª—ë–≥–∫–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ (–∏–º–∏—Ç–∞—Ü–∏—è motion smear)
        '''
–ß—É—Ç—å –ø–æ–∑–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ (–∫–æ–≥–¥–∞ —É–∂–µ >5% —ç—Ñ—Ñ–µ–∫—Ç–∞) –Ω–∞—á–∏–Ω–∞–µ–º –º—É—Ç–∏—Ç—å —Ä–∞–∑–º—ã—Ç–æ—Å—Ç—å.
        '''
        if progress > 0.05:
            '''
–†–∞–∑–º–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞ —Ä–∞–∑–º—ã—Ç–∏—è. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ—á—ë—Ç–Ω—ã–º. –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ä–∞–∑–º—ã–≤–∞–µ—Ç.
            '''
            k = 1 + int(progress * 8)  # kernel length
            if k % 2 == 0:
                k += 1
            # –∏–Ω–æ–≥–¥–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ, –∏–Ω–æ–≥–¥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ
            '''
–°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º: —Ä–∞–∑–º—ã—Ç–∏–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –∏–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ.
–≠—Ñ—Ñ–µ–∫—Ç "—Å–º–∞–∑–∞", –∫–∞–∫ –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –¥—ë—Ä–Ω—É–ª–∏.
            '''
            if random.random() < 0.5:
                # –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ: kernel (k,1)
                new_frame = cv2.blur(new_frame, (1, k))
            else:
                # –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ: kernel (1,k)
                new_frame = cv2.blur(new_frame, (k, 1))

        # 5) –õ—ë–≥–∫–∞—è —Ö—Ä–æ–º–∞-—Å–º–µ—Å—å: —Å–¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã –Ω–µ–º–Ω–æ–≥–æ –∏ —Å–º–µ—à–∏–≤–∞–µ–º
        '''
–†–∞–∑–¥–µ–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞: —Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∫—Ä–∞—Å–Ω—ã–π.
        '''
        b, g, r = cv2.split(new_frame)
        '''
–°—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–¥–≤–∏–≥–∞—Ç—å –∫—Ä–∞—Å–Ω—ã–π –∏ —Å–∏–Ω–∏–π –∫–∞–Ω–∞–ª—ã –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ.
        '''
        rx = int((2 + int(6 * progress)) * random.choice([-1, 1]))
        bx = -int((1 + int(4 * progress)) * random.choice([-1, 1]))
        '''
–°–¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã, –ø–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç —Ü–≤–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑–¥–≤–æ–µ–Ω–∏—è.
        '''
        r = np.roll(r, rx, axis=1)
        b = np.roll(b, bx, axis=1)
        # —Å–º–µ—à–∏–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ —Å –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç
        merged = cv2.merge([b, g, r])
        '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ —Å–¥–≤–∏–Ω—É—Ç—É—é –≤–µ—Ä—Å–∏—é —Å —Ä–∞–∑–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é. –≠—Ç–æ –¥–∞—ë—Ç –≥–ª–∏—Ç—á–µ–≤—ã–π –∫–æ–ª–æ—Ä–∏—Ç.
        '''
        alpha = 0.75 + 0.25 * random.random() * (1.0 - progress)
        new_frame = cv2.addWeighted(new_frame, alpha, merged, 1.0 - alpha, 0)

        # 6) –ù–µ–±–æ–ª—å—à–æ–π –∞–¥–¥–∏—Ç–∏–≤–Ω—ã–π —à—É–º (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å > 0)
        '''
–°–∏–ª–∞ —à—É–º–∞. –ß–µ–º –¥–∞–ª—å—à–µ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É, —Ç–µ–º –±–æ–ª—å—à–µ.
        '''
        noise_amp = int(18 * progress)
        '''
–ì–µ–Ω–µ—Ä–∏–º —Ä–∞–Ω–¥–æ–º–Ω—ã–π —à—É–º (–∑–µ—Ä–Ω–æ),
—Ä–∞–∑–º–Ω–æ–∂–∞–µ–º –Ω–∞ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ (RGB) –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É.
–≠—Ç–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç –≥—Ä—è–∑—å –∏ –≥–ª–∏—Ç—á.
        '''
        if noise_amp > 0:
            noise = np.random.randint(0, noise_amp, (h, w, 1), dtype=np.uint8)
            noise = np.repeat(noise, 3, axis=2)
            new_frame = cv2.add(new_frame, noise)

        return new_frame.astype(np.uint8)

    def glitch_art3(self, frame, t, duration, max_pixel_size=12, max_wave=18):
        # –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1
        progress = float(np.clip(t / float(duration), 0.0, 1.0))

        h, w = frame.shape[:2]
        new_frame = frame.copy()

        # 1) –ü–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è / –º–æ–∑–∞–π–∫–∞ (—á–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —Ç–µ–º –∫—Ä—É–ø–Ω–µ–µ –ø–∏–∫—Å–µ–ª–∏)
        '''
–†–∞–∑–º–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤ –¥–ª—è –º–æ–∑–∞–π–∫–∏ —Ä–∞—Å—Ç—ë—Ç –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
–í –Ω–∞—á–∞–ª–µ –ø–æ—á—Ç–∏ –≥–ª–∞–¥–∫–æ, –ø–æ—Ç–æ–º –≤—Å—ë –∫–≤–∞–¥—Ä–∞—Ç–∞–º–∏.
        '''
        pixel_size = 1 + int((max_pixel_size - 1) * progress)
        '''
–°–∂–∏–º–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä: —á–µ–º –∫—Ä—É–ø–Ω–µ–µ –ø–∏–∫—Å–µ–ª—å, —Ç–µ–º –º–µ–Ω—å—à–µ –∏—Ç–æ–≥–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
        '''
        if pixel_size > 1:
            small_w = max(1, w // pixel_size)
            small_h = max(1, h // pixel_size)
            # downscale + upscale (INTER_NEAREST –¥–∞—ë—Ç —á–µ—Ç–∫–∏–µ –±–ª–æ–∫–∏)
            '''
–ö–æ—Ä–æ—á–µ, —Å–Ω–∞—á–∞–ª–∞ –∂–º—ë–º –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–± –æ–Ω–∞ —Å—Ç–∞–ª–∞ –º–µ–ª–∫–æ–π –∏ –ø–æ—Ç–µ—Ä—è–ª–∞ –¥–µ—Ç–∞–ª–∏, –ø–æ—Ç–æ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ,
–Ω–æ –Ω–µ —Å–≥–ª–∞–∂–∏–≤–∞—è, –∞ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞–º–∏. –ü–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç –º–æ–∑–∞–π–∫–∏ ‚Äî –≤—Å—ë –∫–∞–∫ –±—É–¥—Ç–æ –≤ –ú–∞–π–Ω–∫—Ä–∞—Ñ—Ç–µ.
            '''
            small = cv2.resize(new_frame, (small_w, small_h), interpolation=cv2.INTER_LINEAR)
            new_frame = cv2.resize(small, (w, h), interpolation=cv2.INTER_NEAREST)

        # 2) –í–æ–ª–Ω–æ–≤—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã ‚Äî —Å–∏–Ω—É—Å–Ω—ã–µ —Å–¥–≤–∏–≥–∏ —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø–æ–ª–æ—Å
        '''
–¢—É—Ç –º—É—Ç–∏–º "–≤–æ–ª–Ω—É": –ø–æ –∫–∞–¥—Ä—É –≤—ã–±–∏—Ä–∞–µ–º –ø–æ–ª–æ—Å–∫–∏ –∏ –¥–≤–∏–≥–∞–µ–º –ø–∏–∫—Å–µ–ª–∏ —Ç—É–¥–∞-—Å—é–¥–∞ —Å–∏–Ω—É—Å–æ–º.
‚Äî bands: —Å–∫–æ–ª—å–∫–æ —Ç–∞–∫–∏—Ö –ø–æ–ª–æ—Å –±—É–¥–µ—Ç, —á–µ–º –¥–∞–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –∏—Ö –±–æ–ª—å—à–µ.
‚Äî max_band_h: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å—ã, —á—Ç–æ–± –Ω–µ –≤—Å—ë –ø–æ–ª–æ—Ç–Ω–æ –¥–≤–∏–≥–∞—Ç—å.
‚Äî wave_amp: —Å–∏–ª–∞ —Å–º–µ—â–µ–Ω–∏—è (–∞–º–ø–ª–∏—Ç—É–¥–∞), —Ä–∞—Å—Ç—ë—Ç –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
        '''
        bands = 1 + int(progress * 5)  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–æ—Å
        max_band_h = max(2, int(h * 0.12))
        wave_amp = max(1, int(max_wave * (0.1 + 0.9 * progress)))
        '''
–í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–ª–æ—Å—É –ø–æ –≤—ã—Å–æ—Ç–µ band_h,
–≥–¥–µ –æ–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è y0, –∑–∞–¥–∞—ë–º —á–∞—Å—Ç–æ—Ç—É –∏ —Ñ–∞–∑—É –¥–ª—è —Å–∏–Ω—É—Å–∞.
        '''
        for _ in range(bands):
            band_h = random.randint(2, max_band_h)
            y0 = random.randint(0, max(0, h - band_h))
            freq = random.uniform(0.02, 0.25)
            phase = random.uniform(0, 2 * np.pi)
            # –≥–µ–Ω–µ—Ä–∏–º —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –ø–æ–ª–æ—Å–µ (–º–µ–Ω—å—à–µ —Ä–∞–±–æ—Ç—ã, —á–µ–º –ø–æ –≤—Å–µ–º—É –∫–∞–¥—Ä—É)
            ys = np.arange(band_h)
            '''
–î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ —ç—Ç–æ–π –ø–æ–ª–æ—Å–µ —Å—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ offs –ø–æ X.
            '''
            offs = (np.sin(ys * freq + phase) * wave_amp * random.uniform(0.4, 1.0)).astype(int)
            # –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ ‚Äî band_h –æ–±—ã—á–Ω–æ –Ω–µ–≤–µ–ª–∏–∫
            '''
–ë–µ—Ä—ë–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ—á–∫—É –≤ –ø–æ–ª–æ—Å–µ, –∏ –µ—Å–ª–∏ —Å–º–µ—â–µ–Ω–∏–µ dx –Ω–µ –Ω–æ–ª—å, –¥–≤–∏–≥–∞–µ–º –µ—ë –≤–±–æ–∫.
–¢–∏–ø–∞ —É –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∂–∏–≤–æ—Ç —Ö–æ–¥—É–Ω–æ–º —Ö–æ–¥–∏—Ç ‚Äî –≥–ª–∏—á –≤–æ–ª–Ω–æ–π.
            '''
            for i, row in enumerate(range(y0, y0 + band_h)):
                dx = int(offs[i])
                if dx:
                    # —Å–¥–≤–∏–≥–∞–µ–º –ø–æ X (–∫–æ–ª–æ–Ω–∫–∏)
                    new_frame[row] = np.roll(new_frame[row], dx, axis=0)

        # 3) –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–∏–µ / ¬´–≤—Å–ø—ã—à–∫–∞¬ª –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ ‚Äî —Å –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
        '''
–ò–Ω–æ–≥–¥–∞ –±–∞—Ö–∞–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏, –≥–¥–µ —Ü–≤–µ—Ç–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è (—Ç–∏–ø–∞ –≤—Å–ø—ã—à–∫–∞).
–ß–µ–º –¥–∞–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –±–æ–ª—å—à–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤.
        '''
        if random.random() < 0.6 * progress:
            rects = 1 + int(progress * 3)
            '''
–†–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Å–ª—É—á–∞–π–Ω—ã–µ.
            '''
            for _ in range(rects):
                rw = random.randint(max(4, int(w * 0.04)), max(8, int(w * 0.25)))
                rh = random.randint(max(2, int(h * 0.03)), max(6, int(h * 0.2)))
                x = random.randint(0, max(0, w - rw))
                y = random.randint(0, max(0, h - rh))
                '''
–í—ã—Ä–µ–∑–∞–µ–º –∫—É—Å–æ–∫, –¥–µ–ª–∞–µ–º –µ–≥–æ –∏–Ω–≤–µ—Ä—Å–∏–µ–π (—á—ë—Ä–Ω–æ–µ-–±–µ–ª–æ–µ –º–µ–Ω—è–µ—Ç—Å—è –º–µ—Å—Ç–∞–º–∏),
–∏ –º–µ—à–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º —á–µ—Ä–µ–∑ addWeighted, —á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ, –∫–∞–∫ –±–ª–∏–∫.
                '''
                region = new_frame[y:y + rh, x:x + rw]
                inv = cv2.bitwise_not(region)
                alpha = 0.35 + 0.5 * random.random() * progress
                new_frame[y:y + rh, x:x + rw] = cv2.addWeighted(region, 1.0 - alpha, inv, alpha, 0)

        # 4) –†–µ–¥–∫–∏–µ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–Ω–∞–ª–æ–≤ (RGB shuffle) –¥–ª—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        '''
–ò–Ω–æ–≥–¥–∞ –≥–ª—é—á–∏–º —Ü–≤–µ—Ç–∞: –±–µ—Ä—ë–º –∫–∞–Ω–∞–ª—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ (—Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∫—Ä–∞—Å–Ω—ã–π).
        '''
        if random.random() < 0.45 * progress:
            b, g, r = cv2.split(new_frame)
            '''
–ú–µ—à–∞–µ–º –∫–∞–Ω–∞–ª—ã –º–µ—Å—Ç–∞–º–∏ –∏ —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ, —á—Ç–æ–± —Ü–≤–µ—Ç–∞ —Å—ä–µ–∑–∂–∞–ª–∏ –∏ –±–∞–≥–∞–ª–∏.
            '''
            perms = [
                (r, g, b),
                (g, r, b),
                (b, r, g),
                (r, b, g)
            ]
            pb, pg, pr = random.choice(perms)
            new_frame = cv2.merge([pb, pg, pr])

        # 5) –ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π —Å–¥–≤–∏–≥ (ghost) ‚Äî –Ω–µ–±–æ–ª—å—à–æ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —Å–º–µ—â—ë–Ω–Ω–æ–π –∫–æ–ø–∏–∏
        '''
–°–æ–∑–¥–∞—ë–º "–ø—Ä–∏–∑—Ä–∞–∫": –∫–æ–ø–∏—è –∫–∞–¥—Ä–∞ —á—É—Ç—å —Å–¥–≤–∏–Ω—É—Ç–∞—è –≤–ø—Ä–∞–≤–æ –∏–ª–∏ –≤–ª–µ–≤–æ. –ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–¥–≤–∏–≥.
        '''
        ghost_shift = int((3 + int(10 * progress)) * random.choice([-1, 1]))
        '''
–ë–µ—Ä—ë–º –∫–æ–ø–∏—é —Å–¥–≤–∏–Ω—É—Ç—É—é, –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª.
–í—ã—Ö–æ–¥–∏—Ç –∫–∞–∫ –±—É–¥—Ç–æ –¥–≤–æ–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –¥—Ä–æ–∂–∏—Ç –ø–æ —ç–∫—Ä–∞–Ω—É.
        '''
        if ghost_shift != 0:
            ghost = np.roll(new_frame, ghost_shift, axis=1)
            alpha = 0.12 + 0.18 * progress
            new_frame = cv2.addWeighted(new_frame, 1.0 - alpha, ghost, alpha, 0)

        # 6) –°–ø–æ—Ä–∞–¥–∏—á–µ—Å–∫–∏–π "salt & pepper" —à—É–º (—Å–¥–µ–ª–∞–Ω —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–º, —á—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã)
        '''
–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –ø–∏–∫—Å–µ–ª—å —Å—Ç–∞–Ω–µ—Ç –±–µ–ª—ã–º –∏–ª–∏ —á—ë—Ä–Ω—ã–º "—à—É–º–æ–º", —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
        '''
        sp_prob = 0.0008 + 0.006 * progress  # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞ –ø–∏–∫—Å–µ–ª—å
        '''
–ö–æ—Ä–æ—á–µ, –Ω–∞—É–≥–∞–¥ –±–µ—Ä—ë–º –ø–∏–∫—Å–µ–ª–∏, –ø–æ–ª–æ–≤–∏–Ω—É –¥–µ–ª–∞–µ–º –±–µ–ª—ã–º–∏, –ø–æ–ª–æ–≤–∏–Ω—É —á—ë—Ä–Ω—ã–º–∏.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —à—É–º "—Å–æ–ª—å –∏ –ø–µ—Ä–µ—Ü", –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä–æ–º —Ç–µ–ª–µ–∫–∞–Ω–∞–ª–µ –±–µ–∑ —Å–∏–≥–Ω–∞–ª–∞.
        '''
        if sp_prob > 0:
            mask = np.random.rand(h, w) < sp_prob
            if mask.any():
                ys, xs = np.nonzero(mask)
                # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –≤—ã–±–∏—Ä–∞–µ–º —á–µ—Ä–Ω—ã–π –∏–ª–∏ –±–µ–ª—ã–π
                choices = np.random.rand(len(ys)) < 0.5
                new_frame[ys[choices], xs[choices]] = 255  # –±–µ–ª—ã–µ
                new_frame[ys[~choices], xs[~choices]] = 0   # —á–µ—Ä–Ω—ã–µ

        return new_frame.astype(np.uint8)

    def glitch_art4(self, frame, t, duration, prev_frame=None, intensity=1.0):
        """
        VHS-–ø–æ–¥–æ–±–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.
        - frame: –≤—Ö–æ–¥–Ω–æ–π BGR uint8
        - t, duration: —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ 0..1)
        - prev_frame: –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–∞–¥—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¥–ª—è temporal ghost
        - intensity: 0..1 –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–∏–ª—ã —ç—Ñ—Ñ–µ–∫—Ç–∞
        """
        progress = float(np.clip(t / float(duration), 0.0, 1.0))
        '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç 0 –¥–æ 1, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ —Ñ–æ–∫—É—Å–æ–≤ –º—ã —â–∞—Å.
clip ‚Äî —ç—Ç–æ —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ–∑–ª–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã, —Ç–∏–ø–∞ ¬´–Ω–µ –±–æ–ª—å—à–µ –µ–¥–∏–Ω–∏—Ü—ã, –Ω–µ –º–µ–Ω—å—à–µ –Ω—É–ª—è¬ª.
        '''
        strength = float(np.clip(intensity, 0.0, 1.0)) * (0.4 + 0.6 * progress)
        '''
–ë–µ—Ä—ë–º —Å–∏–ª—É —ç—Ñ—Ñ–µ–∫—Ç–∞ (intensity) –∏ —É—Å–∏–ª–∏–≤–∞–µ–º –µ—ë –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
–¢–æ –µ—Å—Ç—å —á–µ–º –¥–∞–ª—å—à–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ VHS-—Ä–∞–∑—ä–µ–± –∏–¥—ë—Ç.
        '''

        h, w = frame.shape[:2]
        new_frame = frame.copy()

        # 1) –õ—ë–≥–∫–∏–π —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–¥–≤–∏–≥ (chroma bleed)
        # —Å–¥–≤–∏–≥–∞–µ–º R –∏ B –ø–æ X/Y –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏–∫—Å–µ–ª–µ–π
        '''
–≠—Ç–æ –∫–∞–∫ —Å—Ç–∞—Ä—ã–µ –∫–∞—Å—Å–µ—Ç—ã: —Ü–≤–µ—Ç–∞ –ø–æ–µ—Ö–∞–ª–∏, –∫—Ä–∞—Å–Ω—ã–π –∏ —Å–∏–Ω–∏–π —É–ø–æ–ª–∑–ª–∏.

bx –∏ ry ‚Äî —Å–ª—É—á–∞–π–Ω—ã–µ —Å–¥–≤–∏–≥–∏.

split ‚Äî –¥–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫–∞–Ω–∞–ª—ã (B, G, R).

roll ‚Äî —Å–¥–≤–∏–≥–∞–µ–º —Å–∏–Ω–∏–π –≤–±–æ–∫, –∫—Ä–∞—Å–Ω—ã–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑.

merge ‚Äî —Å–æ–±–∏—Ä–∞–µ–º –≤—Å—ë –æ–±—Ä–∞—Ç–Ω–æ. –ü–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π ¬´—Ü–≤–µ—Ç–æ–≤–æ–π —Ä–∞—Å–ø–ª—ã–≤¬ª.
        '''
        max_chroma = max(1, int(8 * strength))
        bx = random.randint(-max_chroma, max_chroma)
        ry = random.randint(-max_chroma, max_chroma)
        b, g, r = cv2.split(new_frame)
        b = np.roll(b, bx, axis=1)
        r = np.roll(r, ry, axis=0)
        new_frame = cv2.merge([b, g, r])

        # 2) –•–∞–±–∏–Ω–≥–æ–≤—ã–µ (tracking) –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ ¬´—Ä—ã–≤–∫–∏¬ª ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ—Å —Å –±–æ–ª—å—à–∏–º —Å–¥–≤–∏–≥–æ–º
        # (–≤—ã–±–∏—Ä–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ –ø–æ–ª–æ—Å, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å)
        '''
–î–µ–ª–∞–µ–º —Ç–µ —Å–∞–º—ã–µ –≥–ª—é–∫–∏, –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–ª–æ—Å–∞–º–∏ —Å–∫–∞—á–µ—Ç –≤–±–æ–∫.

–í—ã–±–∏—Ä–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–æ—Å.

–°–ª—É—á–∞–π–Ω–æ —Ä–µ—à–∞–µ–º, –∫—É–¥–∞ –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ –∏—Ö —Å–¥–≤–∏–Ω—É—Ç—å.

–ò–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º –∂—ë—Å—Ç–∫–∏–π —Ä–∞–∑—Ä—ã–≤ (–≤ 2 —Ä–∞–∑–∞ —Å–∏–ª—å–Ω–µ–µ).
        '''
        if random.random() < 0.9 * strength:
            bands = 1 + int(3 * strength)  # —á–∏—Å–ª–æ –ø–æ–ª–æ—Å
            max_band_h = max(2, int(0.06 * h))
            for _ in range(bands):
                bh = random.randint(1, max_band_h)
                y = random.randint(0, max(0, h - bh))
                shift_x = int((0.15 + 0.85 * random.random()) * w * (0.03 + 0.07 * strength))  # –¥–æ–ª—è —à–∏—Ä–∏–Ω—ã
                shift_x *= random.choice([-1, 1])
                # —Å–∏–ª—å–Ω—ã–µ —Ä–∞–∑—Ä—ã–≤—ã —Ä–µ–∂–µ
                if random.random() < 0.25:
                    shift_x *= 2
                new_frame[y:y + bh] = np.roll(new_frame[y:y + bh], shift_x, axis=1)

        # 3) –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ ¬´dropout¬ª –ø–æ–ª–æ—Å—ã (—á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞)
        '''
–ò–Ω–æ–≥–¥–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–∞–∫–∏–µ —Ç—ë–º–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ (–±—É–¥—Ç–æ —Å–∏–≥–Ω–∞–ª —Å–¥–æ—Ö).

dw ‚Äî —à–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ—Å—ã.

x ‚Äî –≥–¥–µ –æ–Ω–∞ –±—É–¥–µ—Ç.

val ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –∑–∞—Ç–µ–º–Ω–∏–º.
        '''
        if random.random() < 0.35 * strength:
            drops = 1 + int(2 * strength)
            for _ in range(drops):
                dw = random.randint(max(2, int(w * 0.02)), max(4, int(w * 0.12)))
                x = random.randint(0, max(0, w - dw))
                # –≥–ª—É–±–∏–Ω–∞ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                val = random.randint(int(40 * strength), int(160 * strength))
                new_frame[:, x:x + dw] = np.clip(new_frame[:, x:x + dw].astype(np.int16) - val, 0, 255).astype(np.uint8)

        # 4) –°–∏–º—É–ª—è—Ü–∏—è –Ω–∏–∑–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ö—Ä–æ–º—ã: downsample –ø–æ —à–∏—Ä–∏–Ω–µ/—Ü–≤–µ—Ç–æ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
        '''
–ß—Ç–æ–±—ã –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–µ –≤–∏–¥–µ–æ, —É–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É (–æ—Å–æ–±–µ–Ω–Ω–æ —Ü–≤–µ—Ç–∞),
–∞ –ø–æ—Ç–æ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è ¬´–∑–∞–º—ã–ª–µ–Ω–Ω—ã–π¬ª —Ü–≤–µ—Ç.
        '''
        if strength > 0.05:
            # —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ —Ö—Ä–æ–º—ã –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ ‚Äî —Ü–≤–µ—Ç–æ–≤—ã–π ¬´—Ä–∞–∑–º—ã–≤¬ª
            chroma_scale = 1 + int(4 * (1.0 - strength))  # –ø—Ä–∏ –º–∞–ª–æ–π —Å–∏–ª–µ ‚Äî —Å–∏–ª—å–Ω–µ–µ —Å—É–±—Å–∞–º–ø–ª–∏–Ω–≥
            small_w = max(1, w // chroma_scale)
            tiny = cv2.resize(new_frame, (small_w, h), interpolation=cv2.INTER_LINEAR)
            new_frame = cv2.resize(tiny, (w, h), interpolation=cv2.INTER_LINEAR)

        # 5) –°–∫–∞–Ω–ª–∞–π–Ω—ã ‚Äî –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Ç–æ–Ω–∫–∞—è –º–æ–¥—É–ª—è—Ü–∏—è —è—Ä–∫–æ—Å—Ç–∏
        '''
–ö–æ—Ä–æ—á–µ, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–æ—Å–æ—á–∫–∏ ‚Äî –∑–∞—Ç–µ–º–Ω—è–µ–º –∫–∞–∂–¥—É—é –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É.
–ü–ª—é—Å –µ—â—ë –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞–∫ –±—É–¥—Ç–æ ¬´–¥—Ä–æ–∂–∏—Ç¬ª —Å–∏–Ω—É—Å–æ–º ‚Äî —Ç–∏–ø–∏—á–Ω—ã–π VHS –≤–∞–π–±.
        '''
        scan_strength = int(28 * strength)
        if scan_strength > 0:
            # –∑–∞—Ç–µ–º–Ω—è–µ–º –∫–∞–∂–¥—É—é –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É
            tmp = new_frame[::2].astype(np.int16) - int(scan_strength * 0.6)
            new_frame[::2] = np.clip(tmp, 0, 255).astype(np.uint8)
            # –Ω–µ–±–æ–ª—å—à–∞—è —Å–∏–Ω—É—Å–Ω–∞—è –º–æ–¥—É–ª—è—Ü–∏—è –ø–æ Y –¥–ª—è VHS vibe (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)
            freq = 2.0 * (0.5 + 0.5 * random.random())  # —Ü–∏–∫–ª—ã –Ω–∞ –≤—ã—Å–æ—Ç—É
            amp = int(6 * strength)
            if amp > 0:
                ys = np.arange(h)
                offs = (np.sin(ys / h * 2 * np.pi * freq + random.random() * 6.28) * amp).astype(int)
                # –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ –Ω–µ–≤—ã—Å–æ–∫–∏–º –±–ª–æ–∫–∞–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ç—è–∂–µ–ª–æ
                band_h = max(4, int(h * 0.02))
                for y0 in range(0, h, band_h):
                    y1 = min(h, y0 + band_h)
                    dy = int(offs[y0])
                    if dy:
                        new_frame[y0:y1] = np.roll(new_frame[y0:y1], dy, axis=1)

        # 6) Tape grain / noise (–∞–¥–¥–∏—Ç–∏–≤–Ω—ã–π —à—É–º, —Ç–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Ö—Ä–æ–º–∞)
        '''
–î–æ–±–∞–≤–ª—è–µ–º —à—É–º, –∫–∞–∫ –±—É–¥—Ç–æ –ø–ª—ë–Ω–∫–∞ —Å—ã–ø–µ—Ç—Å—è.
–ö–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å —á—É—Ç—å-—á—É—Ç—å –¥–µ—Ä–≥–∞–µ—Ç—Å—è –ø–æ —Ü–≤–µ—Ç—É.
        '''
        noise_amp = int(14 * strength)
        if noise_amp > 0:
            # –¥–µ–ª–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ —à—É–º–∞ –æ–¥–∏–Ω–∞—Ä–Ω–æ–π –∫–∞–Ω–∞–ª –∏ –∑–∞—Ç–µ–º —Ä–∞—Å—à–∏—Ä—è–µ–º
            noise = np.random.randint(-noise_amp, noise_amp + 1, (h, w, 1), dtype=np.int16)
            noise = np.repeat(noise, 3, axis=2).astype(np.int16)
            tmp = new_frame.astype(np.int16) + noise
            new_frame = np.clip(tmp, 0, 255).astype(np.uint8)

        # 7) –¶–≤–µ—Ç–æ–≤–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è / –∫–æ–Ω—Ç—Ä–∞—Å—Ç VHS: –ª—ë–≥–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤–æ–π –≥–∞–º–º—ã –∏ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏
        '''
–¶–≤–µ—Ç–∞ —Ç—É—Ö–Ω—É—Ç, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç,
–∏ –∏–Ω–æ–≥–¥–∞ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ —É–µ–∑–∂–∞—é—Ç –≤ –¥—Ä—É–≥–æ–π –æ—Ç—Ç–µ–Ω–æ–∫.
–¢–∏–ø–∞ –ø–ª—ë–Ω–∫–∞ –≤—ã—Ü–≤–µ–ª–∞.
        '''
        if strength > 0.02:
            hsv = cv2.cvtColor(new_frame, cv2.COLOR_BGR2HSV).astype(np.int16)
            # —É–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–±–æ–ª—å—à–∞—è –Ω–µ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å –≤ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
            sat_delta = int(30 * strength * (random.random() - 0.3))
            hsv[:, :, 1] = np.clip(hsv[:, :, 1] - sat_delta, 0, 255)
            # —Å–ª—É—á–∞–π–Ω—ã–µ –≥–ª–∏—Ç—á–∏ –≤ —Ç–æ–Ω–∞–ª—å–Ω–æ–º –∫–∞–Ω–∞–ª–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–¥–≤–∏–≥–∏ hue)
            if random.random() < 0.45 * strength:
                rects = 1 + int(2 * strength)
                for _ in range(rects):
                    rw = random.randint(6, max(6, int(w * 0.12)))
                    rh = random.randint(4, max(4, int(h * 0.12)))
                    x = random.randint(0, max(0, w - rw))
                    y = random.randint(0, max(0, h - rh))
                    add_h = int(10 * (random.random() - 0.5) * strength)
                    hsv[y:y + rh, x:x + rw, 0] = (hsv[y:y + rh, x:x + rw, 0] + add_h) % 180
            new_frame = cv2.cvtColor(hsv.astype(np.uint8), cv2.COLOR_HSV2BGR)

        # 8) Temporal ghost / tracking smear: —Å–º–µ—à–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–∞–¥—Ä–æ–º —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–º–µ—â–µ–Ω–∏–µ–º
        '''
–°–º–µ—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º, –Ω–æ —á—É—Ç—å —Å–º–µ—â—ë–Ω–Ω—ã–º.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è ¬´–ø—Ä–∏–∑—Ä–∞–∫¬ª, –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞ —Å–æ–±–æ–π —Ç—è–Ω–µ—Ç—Å—è.
        '''
        if prev_frame is not None and strength > 0.02 and random.random() < 0.9:
            pf = prev_frame
            if pf.shape[:2] != (h, w):
                pf = cv2.resize(pf, (w, h), interpolation=cv2.INTER_LINEAR)
            ghost_shift = int(w * 0.02 * (0.5 + 0.5 * random.random()) * strength)
            ghost_shift *= random.choice([-1, 1])
            ghost = np.roll(pf, ghost_shift, axis=1)
            alpha = 0.04 + 0.18 * strength
            new_frame = cv2.addWeighted(new_frame, 1.0 - alpha, ghost, alpha, 0)

        # 9) –§–∏–Ω–∞–ª—å–Ω—ã–µ ¬´—Å–∫—Ä–∏–ø—ã¬ª (–∫–æ—Ä–æ—Ç–∫–∏–µ —Å–∏–ª—å–Ω—ã–µ —Å–¥–≤–∏–≥–∏ ‚Äî —Ä–µ–¥–∫–∏–µ)
        '''
–ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–¥–∫–∏–π, –º–æ—â–Ω—ã–π —Å–¥–≤–∏–≥ ‚Äî —Ç–∏–ø–∞ –∫–∞–¥—Ä –¥—ë—Ä–Ω—É–ª–æ –∂—ë—Å—Ç–∫–æ.
        '''
        if random.random() < 0.08 * strength:
            # —Å–ª—É—á–∞–π–Ω—ã–π –∫—Ä—É–ø–Ω—ã–π —Ä—ã–≤–æ–∫ –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–π –ø–æ–ª–æ—Å–µ
            th = random.randint(2, max(2, int(h * 0.08)))
            y = random.randint(0, max(0, h - th))
            shift_x = int(w * (0.05 + 0.2 * random.random()) * strength)
            shift_x *= random.choice([-1, 1])
            new_frame[y:y + th] = np.roll(new_frame[y:y + th], shift_x, axis=1)

        '''
üëä –í–æ—Ç —Ç–∞–∫, –±—Ä–∞—Ç. –¢–µ–ø–µ—Ä—å —Ç—ã —à–∞—Ä–∏—à—å, –∫–∞–∫ —ç—Ç–æ—Ç VHS-–≥–ª–∏—Ç—á —Ä–∞–±–æ—Ç–∞–µ—Ç.
        '''
        return new_frame.astype(np.uint8)

    def kaleidoscope2(self, frame, t, duration):
        '''
–°—á–∏—Ç–∞–µ–º, –≥–¥–µ –º—ã —â–∞—Å –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –æ—Ç 0 –¥–æ 1. –¢–∏–ø–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞.
–ï—Å–ª–∏ duration –Ω–æ–ª—å ‚Äî —á—Ç–æ–± –Ω–µ –≥–ª—é—á–∏–ª–æ, —Å—Ç–∞–≤–∏–º 0.
        '''
        progress = (t % duration) / float(duration) if duration else 0.0
        '''
—É–≥–æ–ª –≤ –≥—Ä–∞–¥—É—Å–∞—Ö. –¢–∏–ø–∞ –ø–æ–ª–Ω—ã–π –∫—Ä—É–≥ (360), –Ω–æ –±–µ—Ä—ë–º –∫—É—Å–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
        '''
        angle = 360.0 * progress

        '''
–ë–µ—Ä—ë–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞–¥—Ä–∞: –≤—ã—Å–æ—Ç—É (h) –∏ —à–∏—Ä–∏–Ω—É (w).
–ü–æ—Ç–æ–º –¥–µ–ª–∏–º –ø–æ–ø–æ–ª–∞–º, —á—Ç–æ–± –∑–Ω–∞—Ç—å –ø–æ–ª–æ–≤–∏–Ω–∫–∏ (h2, w2). –≠—Ç–æ –±—É–¥–µ—Ç –Ω–∞—à–∞ —Ä–∞–±–æ—á–∞—è –∑–æ–Ω–∞.
        '''
        h, w = frame.shape[:2]
        h2, w2 = h // 2, w // 2

        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ float-–∫–æ–ø–∏–∏ –∫–∞–¥—Ä–∞
        '''
–ø—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–¥—Ä —É –Ω–∞—Å –≤ –ø–ª–∞–≤–∞—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ (—Ç–∏–ø–∞ —Å —Ç–æ—á–∫–∞–º–∏) –∏–ª–∏ —Ç—É–ø–æ –≤ —Ü–µ–ª—ã—Ö —á–∏—Å–ª–∞—Ö (0‚Äì255).
        '''
        is_float = np.issubdtype(frame.dtype, np.floating)
        '''
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —á—ë—Ä–Ω–æ-–±–µ–ª–∞—è (2D), —Ç–æ —É –Ω–µ—ë –∫–∞–Ω–∞–ª–æ–≤ 1. –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ float32, —á—Ç–æ–± —É–¥–æ–±–Ω–µ–µ —Å—á–∏—Ç–∞—Ç—å.
–ï—Å–ª–∏ —Ü–≤–µ—Ç–Ω–∞—è, —Ç–æ –±–µ—Ä—ë–º –∫–æ–ª-–≤–æ –∫–∞–Ω–∞–ª–æ–≤ (–æ–±—ã—á–Ω–æ 3 ‚Äî RGB) –∏ —Ç–æ–∂–µ –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ float32.
        '''
        if frame.ndim == 2:
            channels = 1
            frame_f = frame.astype(np.float32).reshape(h, w, 1)
        else:
            channels = frame.shape[2]
            frame_f = frame.astype(np.float32)

        # –î–≤–∏–∂–µ–Ω–∏–µ / –º–∞—Å—à—Ç–∞–±
        '''
–¢—É—Ç –∑–∞–º—É—Ç–∏–º –ø—É–ª—å—Å–∞—Ü–∏—é ‚Äî —Ç–∏–ø–∞ –¥—ã—à–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∞.
–ê–º–ø–ª–∏—Ç—É–¥–∞ 0.05. –ë–µ—Ä—ë–º —Å–∏–Ω—É—Å ‚Äî –∏ —Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞ —á—É—Ç—å –ø–æ–¥—Ä–∞—Å—Ç–∞–µ—Ç –∏–ª–∏ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è.
        '''
        pulse_amp = 0.05
        pulse = 1.0 + pulse_amp * np.sin(2.0 * np.pi * progress * 2.0)
        '''
–°–¥–≤–∏–≥–∞–µ–º —Ü–µ–Ω—Ç—Ä –ø–æ —Å–∏–Ω—É—Å—É –∏ –∫–æ—Å–∏–Ω—É—Å—É, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ–º–Ω–æ–≥–æ –≥—É–ª—è–ª–∞ —Ç—É–¥–∞-—Å—é–¥–∞.
        '''
        cx_off = int(0.02 * w * np.sin(2.0 * np.pi * progress))
        cy_off = int(0.02 * h * np.cos(2.0 * np.pi * progress))

        '''
–°—á–∏—Ç–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –≤—ã—Ä–µ–∑–∞–µ–º–æ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞. –¢–∏–ø–∞ –±–µ—Ä–µ–º –∫—É—Å–æ–∫ –∫–∞–¥—Ä–∞ (—Å–µ—Ä–µ–¥–∏–Ω—É).
pad ‚Äî —ç—Ç–æ –∑–∞–ø–∞—Å, —á—Ç–æ–± –Ω–µ —Ä–µ–∑–∞–ª–æ –ø–æ-–∂—ë—Å—Ç–∫–æ–º—É.
        '''
        pad = max(0, int(min(w2, h2) * 0.08))
        x0 = max(0, w // 4 - pad + cx_off)
        y0 = max(0, h // 4 - pad + cy_off)
        x1 = min(w, x0 + w2 + 2 * pad)
        y1 = min(h, y0 + h2 + 2 * pad)
        '''
—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –æ—Ç—Ä–µ–∑–∞–ª –∫—Ä–∏–≤–æ (–∫—É—Å–æ–∫ –ø—É—Å—Ç–æ–π), —Ç–æ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.
        '''
        if x1 <= x0 or y1 <= y0:
            x0 = max(0, w // 4 - pad); y0 = max(0, h // 4 - pad)
            x1 = min(w, x0 + w2 + 2 * pad); y1 = min(h, y0 + h2 + 2 * pad)

        '''
–í—ã—Ä–µ–∑–∞–µ–º –∫—É—Å–æ–∫ –∫–∞–¥—Ä–∞. –ï—Å–ª–∏ —Ç–∞–º –ø—É—Å—Ç–æ (–≤—ã—Å–æ—Ç–∞ –∏–ª–∏ —à–∏—Ä–∏–Ω–∞ –Ω–æ–ª—å) ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª.
        '''
        segment = frame_f[y0:y1, x0:x1].astype(np.uint8).copy()
        seg_h, seg_w = segment.shape[:2]
        if seg_h == 0 or seg_w == 0:
            return frame

        '''
–°–æ–∑–¥–∞—ë–º –º–∞—Ç—Ä–∏—Ü—É –ø–æ–≤–æ—Ä–æ—Ç–∞ + –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (M).
–í—Ä–∞—â–∞–µ–º –∫—É—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –æ—Ç—Ä–∞–∂–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—ã—Ä.
        '''
        M = cv2.getRotationMatrix2D((seg_w / 2.0, seg_h / 2.0), angle, pulse)
        rotated_full = cv2.warpAffine(segment, M, (seg_w, seg_h),
                                      flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        '''
–í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –∫—É—Å–æ–∫.
–ï—Å–ª–∏ –≤—ã–ª–µ–∑–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã ‚Äî –¥–æ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–º–∫—É.
–ü–æ—Ç–æ–º –±–µ—Ä—ë–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —á–∞—Å—Ç—å.
        '''
        sx = max(0, (seg_w - w2) // 2); sy = max(0, (seg_h - h2) // 2)
        if sy + h2 > rotated_full.shape[0] or sx + w2 > rotated_full.shape[1]:
            pad_h = max(0, sy + h2 - rotated_full.shape[0])
            pad_w = max(0, sx + w2 - rotated_full.shape[1])
            rotated_full = cv2.copyMakeBorder(rotated_full, 0, pad_h, 0, pad_w,
                                          borderType=cv2.BORDER_REFLECT)
        rotated = rotated_full[sy:sy + h2, sx:sx + w2].astype(np.float32)

        # –ö—ç—à –º–∞—Å–∫–∏
        '''
–ø—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —É –Ω–∞—Å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Å–∫–∏ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä—ã (h2, w2).
        '''
        if not hasattr(self, '_kaleido_masks'):
            self._kaleido_masks = {}
        mask_key = (h2, w2)
        '''
–¢—É—Ç –º—É—Ç–∏–º –º–∞—Å–∫—É (–∑–∞—Ç—É—Ö–∞–Ω–∏–µ –∫ –∫—Ä–∞—è–º),
—á—Ç–æ–± –∫—Ä–∞—Å–∏–≤–æ –≤—ã–≥–ª—è–¥–µ–ª–æ. –ï—Å–ª–∏ —É–∂–µ —Å—á–∏—Ç–∞–ª–∏ ‚Äî –±–µ—Ä—ë–º –≥–æ—Ç–æ–≤—É—é.
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç —Ü–µ–Ω—Ç—Ä–∞, –Ω–æ—Ä–º–∏—Ä—É–µ–º –∏ –¥–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω—ã–π —Å–ø–∞–¥ —è—Ä–∫–æ—Å—Ç–∏.
        '''
        if mask_key in self._kaleido_masks:
            base_mask = self._kaleido_masks[mask_key]
        else:
            yy = np.linspace(0, h2 - 1, h2) - (h2 - 1) / 2.0
            xx = np.linspace(0, w2 - 1, w2) - (w2 - 1) / 2.0
            xxg, yyg = np.meshgrid(xx, yy)
            dist = np.sqrt(xxg + yyg)
            maxr = np.sqrt(((w2 - 1) / 2.0)**2 + ((h2 - 1) / 2.0)**2) + 1e-9
            base_mask = 1.0 - np.clip(dist / maxr, 0.0, 1.0)
            base_mask = np.power(base_mask, 1.2)
            self._kaleido_masks[mask_key] = base_mask.astype(np.float32)
        base_mask = base_mask.astype(np.float32)

        '''
–ø—É—Å—Ç—ã–µ –º–∞—Ç—Ä–∏—Ü—ã –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –≤–µ—Å–æ–≤ –º–∞—Å–æ–∫.
        '''
        accum = np.zeros((h, w, channels), dtype=np.float32)
        weight = np.zeros((h, w), dtype=np.float32)

        '''
–î–µ–ª–∞–µ–º —á–µ—Ç—ã—Ä–µ –∫—É—Å–∫–∞ (–∫–∞–∫ –∫–≤–∞–¥—Ä–∞–Ω—Ç—ã –∫–∞–ª–µ–π–¥–æ—Å–∫–æ–ø–∞):
–æ—Ä–∏–≥–∏–Ω–∞–ª, –æ—Ç—Ä–∞–∂—ë–Ω–Ω—ã–π –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏, –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏ –æ–±–∞ –≤–º–µ—Å—Ç–µ.
–£ –∫–∞–∂–¥–æ–≥–æ ‚Äî —Å–≤–æ—è –º–∞—Å–∫–∞ –∏ —Ñ–∞–∑–æ–≤—ã–π —Å–¥–≤–∏–≥.
        '''
        q = rotated.astype(np.float32)
        quads = [
            (q, 0, 0, base_mask, 0.0),
            (cv2.flip(q, 1), 0, w2, np.fliplr(base_mask), 0.25),
            (cv2.flip(q, 0), h2, 0, np.flipud(base_mask), 0.5),
            (cv2.flip(q, -1), h2, w2, np.flipud(np.fliplr(base_mask)), 0.75),
        ]

        '''
–¶–∏–∫–ª –ø–æ —á–µ—Ç—ã—Ä—ë–º –∫—É—Å–∫–∞–º:
‚Äî —Å—á–∏—Ç–∞–µ–º —è—Ä–∫–æ—Å—Ç—å (—á—É—Ç—å –ø—É–ª—å—Å–∏—Ä—É–µ—Ç)
‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É
‚Äî –ø–ª—é—Å—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É
‚Äî –∏ –≤–µ—Å –¥–æ–±–∞–≤–ª—è–µ–º.
        '''
        for img_q, y_off, x_off, mask_q, phase in quads:
            bright = 0.95 + 0.1 * np.sin(2.0 * np.pi * (progress + phase))
            mask3 = mask_q[..., None]
            part = img_q * (mask3 * bright)
            accum[y_off:y_off + h2, x_off:x_off + w2, :channels] += part
            weight[y_off:y_off + h2, x_off:x_off + w2] += (mask_q * bright)

        '''
–¥–µ–ª–∏–º –≤—Å—ë –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–µ –Ω–∞ –≤–µ—Å–∞, —á—Ç–æ–± —É—Å—Ä–µ–¥–Ω–∏—Ç—å. eps –Ω—É–∂–µ–Ω, —á—Ç–æ–± –Ω–µ –¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–æ–ª—å.
        '''
        eps = 1e-6
        out = accum / (weight[..., None] + eps)
        '''
–ï—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤–µ—Å –ø–æ—á—Ç–∏ –Ω—É–ª–µ–≤–æ–π ‚Äî –∑–Ω–∞—á–∏—Ç –ø—É—Å—Ç–æ—Ç–∞. –¢–æ–≥–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∫–∞–¥—Ä–∞.
        '''
        mask_zero = (weight < 1e-3)
        if np.any(mask_zero):
            frame_f_clip = frame_f.astype(np.float32)
            out = np.where(mask_zero[..., None], frame_f_clip, out)

        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ç–∏–ø: –µ—Å–ª–∏ –±—ã–ª float ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º.
–ï—Å–ª–∏ int (0‚Äì255) ‚Äî –æ–±—Ä–µ–∑–∞–µ–º, –æ–∫—Ä—É–≥–ª—è–µ–º –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞–∑–∞–¥.
        '''
        if is_float:
            out = out.astype(frame.dtype)
        else:
            out = np.clip(out, 0, 255)
            out = np.rint(out).astype(frame.dtype)
        '''
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —á—ë—Ä–Ω–æ-–±–µ–ª–∞—è (1 –∫–∞–Ω–∞–ª), —Ç–æ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–ª–µ–π–¥–æ—Å–∫–æ–ø.
        '''
        if channels == 1:
            out = out.reshape(h, w)
        return out

    def time_tunnel2(self, frame, t, duration, clip):

        # --- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –∫–∞–¥—Ä–∞ ---
        '''
–°–º–æ—Ç—Ä–∏–º: –µ—Å–ª–∏ –∫–∞–¥—Ä –ø—É—Å—Ç–æ–π, –∏–ª–∏ –≤–æ–æ–±—â–µ –µ–≥–æ –Ω–µ—Ç (None),
–∏–ª–∏ —É –Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä –Ω–æ–ª—å ‚Äî –∑–Ω–∞—á–∏—Ç, –ø–∏–∑–¥–µ—Ü, –Ω–∞–¥–æ —Å–ø–∞—Å–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é.
        '''
        if frame is None or (hasattr(frame, "size") and frame.size == 0):
            # –ü–æ–ø—ã—Ç–∫–∞ –≤–µ—Ä–Ω—É—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–ª–∏–¥–Ω—ã–π –∫–∞–¥—Ä
            '''
–ï—Å–ª–∏ —É –Ω–∞—Å –æ—Å—Ç–∞–ª—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–π –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∫–∞–¥—Ä, –¥–µ—Ä–∂–∏–º –µ–≥–æ –≤ –∑–∞–Ω–∞—á–∫–µ.
            '''
            if hasattr(self, 'last_frame') and self.last_frame is not None:
                # –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å)
                '''
–û—Ä–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª—å: –º–æ–ª, –∫–∞–¥—Ä –ø—É—Å—Ç–æ–π, –±–µ—Ä—É –ø—Ä–æ—à–ª—ã–π. –¢–∏–ø–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø–∞—Ü–∞–Ω–æ–≤-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
                '''
                print(f"warning: empty frame at t={t:.3f}, using last_frame")
                '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é —Å—Ç–∞—Ä–æ–≥–æ –∫–∞–¥—Ä–∞ ‚Äî –Ω–µ –ª–æ–º–∞–µ–º—Å—è.
                '''
                return self.last_frame.copy()
            # –µ—Å–ª–∏ –Ω–µ—Ç last_frame ‚Äî –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑ clip, –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞–ª–µ–Ω—å–∫–∏–π —á—ë—Ä–Ω—ã–π –∫–∞–¥—Ä
            if clip is not None and hasattr(clip, "size") and clip.size is not None:
                w, h = clip.size  # MoviePy: (w,h)
                '''
–î–µ–ª–∞–µ–º –ø—É—Å—Ç–æ–π —á—ë—Ä–Ω—ã–π –∫–∞–¥—Ä —Å —Ç–µ–º–∏ –∂–µ —Ä–∞–∑–º–µ—Ä–∞–º–∏.
                '''
                fallback = np.zeros((int(h), int(w), 3), dtype=np.uint8)
                '''
–°–Ω–æ–≤–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –º–æ–ª, –≤–µ—Ä–Ω—É–ª–∏ —á—ë—Ä–Ω—ã–π –∫–∞–¥—Ä —Ä–∞–∑–º–µ—Ä–æ–º –∫–∞–∫ —É –∫–ª–∏–ø–∞.
                '''
                print(f"warning: empty frame at t={t:.3f}, returning black frame of clip.size {clip.size}")
                '''
–°–æ—Ö—Ä–∞–Ω–∏–ª–∏ —á—ë—Ä–Ω—ã–π –∫–∞–¥—Ä –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏ –≤–µ—Ä–Ω—É–ª–∏.
                '''
                self.last_frame = fallback
                return fallback
            # –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π fallback
            '''
–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å: –¥–µ–ª–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —á—ë—Ä–Ω—ã–π –∫–∞–¥—Ä 640x480, –∫–∞–∫ —É —Å—Ç–∞—Ä—ã—Ö —Ç–µ–ª–∏–∫–æ–≤.
            '''
            fallback = np.zeros((480, 640, 3), dtype=np.uint8)
            '''
–í—ã–≤–æ–¥–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —ç—Ç–æ—Ç —á—ë—Ä–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç.
            '''
            print(f"warning: empty frame at t={t:.3f}, returning default black 640x480")
            self.last_frame = fallback
            return fallback

        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–∞–¥—Ä ‚Äî numpy array —Å 3 –∫–∞–Ω–∞–ª–∞–º–∏ –∏ uint8
        '''
–ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –∫–∞–¥—Ä –≤ numpy –º–∞—Å—Å–∏–≤, —á—Ç–æ–± —Ç–æ—á–Ω–æ –±—ã–ª –Ω—É–∂–Ω—ã–π —Ç–∏–ø.
        '''
        frame = np.asarray(frame)
        '''
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —á—ë—Ä–Ω–æ-–±–µ–ª–∞—è (2D).
        '''
        if frame.ndim == 2:
            '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Ü–≤–µ—Ç–Ω—É—é (BGR), —á—Ç–æ–± –±—ã–ª–æ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞.
            '''
            frame = cv2.cvtColor(frame, cv2.COLOR_GRAY2BGR)
            '''
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ 4-–∫–∞–Ω–∞–ª—å–Ω–∞—è (—Å –∞–ª—å—Ñ–æ–π, —Ç–∏–ø–∞ PNG).
            '''
        elif frame.ndim == 3 and frame.shape[2] == 4:
            # –µ—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å—Ñ–∞ ‚Äî –æ—Ç–±—Ä–æ—Å–∏–º –∏–ª–∏ –ø—Ä–µ–º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω–∏–º (–∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫–∏–¥—ã–≤–∞–µ–º)
            '''
–û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–ª—å—Ñ—É, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –æ–±—ã—á–Ω—É—é 3-–∫–∞–Ω–∞–ª—å–Ω—É—é.
–¢—É—Ç –±–µ–∑ –∑–∞–º–æ—Ä–æ—á–µ–∫, –ø—Ä–æ—Å—Ç–æ –Ω–∞—Ö—Ä–µ–Ω —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å.
            '''
            frame = cv2.cvtColor(frame, cv2.COLOR_BGRA2BGR)
            '''
–ï—Å–ª–∏ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–Ω–µ 8-–±–∏—Ç), –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –≤–∏–¥—É.
            '''
        if frame.dtype != np.uint8:
            # –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 0..255
            '''
–ö–æ—Ä–æ—á–µ, –µ—Å–ª–∏ —É –Ω–∞—Å –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∫–∏–µ-—Ç–æ –ª–µ–≤—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä float), –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏—Ö –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0‚Äì255.
–ò–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–º –∫ uint8.
            '''
            fmin, fmax = frame.min(), frame.max()
            if fmax > fmin:
                frame = ((frame - fmin) / (fmax - fmin) * 255.0).astype(np.uint8)
            else:
                frame = frame.astype(np.uint8)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–ª–∏–¥–Ω—ã–π –∫–∞–¥—Ä
        self.last_frame = frame.copy()

        # --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∞ (–º–æ–∂–Ω–æ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å) ---
        progress = np.clip(t / max(1e-6, duration), 0.0, 1.0)
        ease = 1.0 - (1.0 - progress) ** 3

        '''
–≠—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∞:

max_cache ‚Äî —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª—ã—Ö –∫–∞–¥—Ä–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—å.

downscale ‚Äî —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–∞–¥—Ä–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏.

alpha, scale_step, rotation_step ‚Äî –∫–∞–∫ —Å–∏–ª—å–Ω–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –º–∞—Å—à—Ç–∞–± –∏ –ø–æ–≤–æ—Ä–æ—Ç –º–µ–Ω—è—é—Ç—Å—è.

chroma_shift ‚Äî —Ü–≤–µ—Ç–æ–≤–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (–≥–ª–∏—Ç—á).

vignette_strength ‚Äî –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º.

glow_strength ‚Äî —Å–≤–µ—á–µ–Ω–∏–µ.

color_boost ‚Äî —É—Å–∏–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞.

min_side ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞ –ø–æ—Å–ª–µ —É–º–µ–Ω—å—à–µ–Ω–∏—è.
        '''
        max_cache = 6
        downscale = 0.45
        base_alpha = 0.9
        scale_step = 0.12
        rotation_step = 6.0
        chroma_shift = 3
        vignette_strength = 0.75
        glow_strength = 0.30
        color_boost = 0.18
        min_side = 64

        '''
–í—ã—Å–æ—Ç–∞ –∏ —à–∏—Ä–∏–Ω–∞ –∫–∞–¥—Ä–∞. –î–µ–ª–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é, –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º—É–º–∞.
        '''
        h, w = frame.shape[:2]
        small_w = max(min_side, int(w * downscale))
        small_h = max(min_side, int(h * downscale))

        # --- –∫–µ—à —É–º–µ–Ω—å—à–µ–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤ ---
        '''
–ï—Å–ª–∏ –Ω–µ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤ ‚Äî —Å–æ–∑–¥–∞—ë–º.
        '''
        if not hasattr(self, '_cache_small'):
            self._cache_small = []
        '''
–î–µ–ª–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –∫–∞–¥—Ä.
        '''
        cur_small = cv2.resize(frame, (small_w, small_h), interpolation=cv2.INTER_LINEAR)
        '''
–ó–∞–ø–æ–º–∏–Ω–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –∫–∞–¥—Ä –≤ –∫–µ—à. –ï—Å–ª–∏ –∫–∞–¥—Ä–æ–≤ —Å—Ç–∞–ª–æ –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞ ‚Äî –≤—ã–∫–∏–¥—ã–≤–∞–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π.
        '''
        self._cache_small.append(cur_small.copy())
        if len(self._cache_small) > max_cache:
            self._cache_small.pop(0)

        '''
–ù–∞—á–∏–Ω–∞–µ–º –∫–æ–º–ø–æ–∑–∏—Ü–∏—é —Å —Ç–µ–∫—É—â–µ–≥–æ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–≥–æ –∫–∞–¥—Ä–∞.
        '''
        comp = cur_small.astype(np.float32)
        # –ø—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–∏–Ω—å–µ—Ç–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–∏–Ω—å–µ—Ç–æ—á–Ω–∞—è –º–∞—Å–∫–∞ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
        '''
        if not hasattr(self, '_vignette_mask') or self._vignette_mask.shape[:2] != (small_h, small_w):
            '''
–ö–æ—Ä–æ—á–µ, –¥–µ–ª–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –≤–∏–Ω—å–µ—Ç–∫–∏:
‚Äî –°—á–∏—Ç–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞,
‚Äî –û–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è,
‚Äî –†–∞–∑–º—ã–≤–∞–µ–º –¥–ª—è –º—è–≥–∫–æ—Å—Ç–∏,
‚Äî –°–æ—Ö—Ä–∞–Ω—è–µ–º.
            '''
            yy, xx = np.mgrid[0:small_h, 0:small_w]
            cy, cx = small_h / 2.0, small_w / 2.0
            dist = np.sqrt(((yy - cy) / cy) ** 2 + ((xx - cx) / cx) ** 2)
            mask = np.clip(1.0 - dist, 0.0, 1.0)
            mask = cv2.GaussianBlur(mask.astype(np.float32), (0, 0), sigmaX=max(small_w, small_h) * 0.03)
            self._vignette_mask = mask.astype(np.float32)


        '''
–ë–µ—Ä—ë–º –ø—Ä–æ—à–ª—ã–µ –∫–∞–¥—Ä—ã (–∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ).
        '''
        layers = list(self._cache_small[:-1])
        '''
–î–∞–ª—å—à–µ —Ü–∏–∫–ª ‚Äî —Ç–∞–º –≤—Å—è –¥–≤–∏–∂—É—Ö–∞:
–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º, –∫—Ä—É—Ç–∏–º, –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Ü–≤–µ—Ç–æ–≤—ã–µ –≥–ª–∏—Ç—á–∏,
—É—Å–∏–ª–∏–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–∏. –≠—Ç–æ –∏ —Å–æ–∑–¥–∞—ë—Ç –∏–ª–ª—é–∑–∏—é —Ç—É–Ω–Ω–µ–ª—è.
        '''
        for i, prev in enumerate(layers):
            layer_index = i
            rel = (layer_index + 1) / max(1, len(layers))
            '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (alpha):
‚Äî –ß–µ–º —Å–ª–æ–π –≥–ª—É–±–∂–µ, —Ç–µ–º –æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ.
‚Äî –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ (ease) –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∞–Ω–∏–º–∞—Ü–∏–∏.
‚Äî –í –Ω–∞—á–∞–ª–µ (progress‚âà0) –∞–ª—å—Ñ–∞ –ø–æ—á—Ç–∏ –Ω—É–ª–µ–≤–∞—è, –∫ –∫–æ–Ω—Ü—É —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ.
            '''
            alpha = base_alpha * (1.0 - rel * 0.9) * (0.25 + 0.75 * ease)
            alpha *= (1.0 - np.exp(-2.5 * progress))
            '''
–ï—Å–ª–∏ —Å–ª–æ–π —Å–ª–∏—à–∫–æ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π ‚Äî –Ω–∞—Ö–µ—Ä –µ–≥–æ, –Ω–µ —Ä–∏—Å—É–µ–º.
            '''
            if alpha <= 0.01:
                continue

            '''
–ß–µ–º –≥–ª—É–±–∂–µ —Å–ª–æ–π, —Ç–µ–º –æ–Ω –º–µ–Ω—å—à–µ. –≠—Ç–æ –¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç —Ç—É–Ω–Ω–µ–ª—è.
            '''
            scale = 1.0 - scale_step * layer_index * (0.5 + 0.8 * ease)
            '''
–ö–∞–∂–¥—ã–π —Å–ª–æ–π —á—É—Ç—å-—á—É—Ç—å –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º.
‚Äî –ß–µ–º –¥–∞–ª—å—à–µ —Å–ª–æ–π, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —É–≥–æ–ª.
‚Äî –î–æ–±–∞–≤–ª—è–µ–º –µ—â—ë –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —É–≥–æ–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç ease –∏ –ø–æ–∑–∏—Ü–∏–∏.
            '''
            angle = rotation_step * layer_index * (0.6 + 0.4 * ease)
            angle += 4.0 * ease * (1.0 - rel)

            '''
–°—á–∏—Ç–∞–µ–º —Å–º–µ—â–µ–Ω–∏—è –ø–æ X –∏ Y ‚Äî —á—Ç–æ–± –∫–∞–¥—Ä—ã –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–≤–∏–≥–∞–ª–∏—Å—å –∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –≥–ª—É–±–∏–Ω—ã.
            '''
            tx = (small_w - small_w * scale) / 2.0 * (0.5 + 0.5 * ease) * (0.6 + 0.4 * rel)
            ty = (small_h - small_h * scale) / 2.0 * (0.5 + 0.5 * ease) * (0.6 + 0.4 * rel)

            '''
–î–µ–ª–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–º–∞—Å—à—Ç–∞–± + –ø–æ–≤–æ—Ä–æ—Ç + —Å–º–µ—â–µ–Ω–∏–µ).
–≠—Ç–æ, —Ç–∏–ø–∞, –∫–∞–∫ Photoshop‚Äô–æ–≤—Å–∫–∏–π "Free Transform".
            '''
            center = (small_w / 2.0, small_h / 2.0)
            M = cv2.getRotationMatrix2D(center, angle, scale)
            M[0, 2] += tx
            M[1, 2] += ty

            '''
–ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –∫–∞–¥—Ä—É.
–ï—Å–ª–∏ –≤—ã—Ö–æ–¥–∏–º –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã ‚Äî –æ—Ç—Ä–∞–∂–∞–µ–º –∫—Ä–∞—è (—á—Ç–æ–± –Ω–µ –±—ã–ª–æ –¥—ã—Ä–æ–∫).
            '''
            warped = cv2.warpAffine(prev, M, (small_w, small_h), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

            '''
–¶–≤–µ—Ç–æ–≤–æ–π –≥–ª–∏—Ç—á:
‚Äî –ë–µ—Ä—ë–º –∫–∞–Ω–∞–ª—ã BGR.
‚Äî –°–¥–≤–∏–≥–∞–µ–º —Å–∏–Ω–∏–π –≤–ø—Ä–∞–≤–æ, –∫—Ä–∞—Å–Ω—ã–π –≤–Ω–∏–∑, –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–µ–ª—ë–Ω—ã–π.
‚Äî –ü–æ–ª—É—á–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç "—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–±–µ—Ä—Ä–∞—Ü–∏–∏".
            '''
            if chroma_shift > 0:
                shift = int(np.round(chroma_shift * rel * ease * 1.6))
                if shift != 0:
                    b, g, r = cv2.split(warped)
                    b = np.roll(b, shift, axis=1)
                    r = np.roll(r, -shift, axis=0)
                    warped = cv2.merge((b, g, r))


            '''
–î–µ–ª–∞–µ–º —Ä–∞–¥–∏–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É: —á–µ–º –±–ª–∏–∂–µ –ø–∏–∫—Å–µ–ª—å –∫ —Ü–µ–Ω—Ç—Ä—É, —Ç–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ.
–≠—Ç–∞ —à—Ç—É–∫–∞ —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ü–µ–Ω—Ç—Ä –∫–∞–¥—Ä–∞.
            '''
            yy, xx = np.mgrid[0:small_h, 0:small_w]
            dy = (yy - small_h / 2.0) / (small_h / 2.0)
            dx = (xx - small_w / 2.0) / (small_w / 2.0)
            radial = np.clip(1.0 - (dx * dx + dy * dy), 0.0, 1.0)
            '''
–†–∞–∑–º—ã–≤–∞–µ–º —Ä–∞–¥–∏–∞–ª—å–Ω—É—é –º–∞—Å–∫—É, —á—Ç–æ–± –ø–ª–∞–≤–Ω–æ, –∏ —Å—á–∏—Ç–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞.
            '''
            radial = cv2.GaussianBlur(radial.astype(np.float32), (0, 0), sigmaX=min(small_w, small_h) * 0.05)
            center_boost = 1.0 + 0.6 * (1.0 - rel) * ease
            '''
–î–æ–±–∞–≤–ª—è–µ–º —è—Ä–∫–æ—Å—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–µ, —Ç–∏–ø–∞ —Å–≤–µ—Ç—è—â–∏–π—Å—è —Ç–æ–Ω–Ω–µ–ª—å.
            '''
            warped_f = warped.astype(np.float32)
            warped_f += (radial[..., None] * center_boost * 25.0)

            '''
–ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–ª–æ–π –ø–æ–≤–µ—Ä—Ö –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é alpha.
            '''
            comp = comp * (1.0 - alpha) + warped_f * alpha


        '''
–î–æ–±–∞–≤–ª—è–µ–º –≤–∏–Ω—å–µ—Ç–∫—É: –∑–∞—Ç–µ–º–Ω—è–µ–º –∫—Ä–∞—è –∫–∞–¥—Ä–∞, —Ü–µ–Ω—Ç—Ä –æ—Å—Ç–∞–≤–ª—è–µ–º —è—Ä–∫–∏–º.
        '''
        vmask = (1.0 - vignette_strength * ease) + (self._vignette_mask * vignette_strength * ease)
        comp *= vmask[..., None]

        '''
–î–µ–ª–∞–µ–º –±—É—Å—Ç —Ü–≤–µ—Ç–∞:
‚Äî –í HSV —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å (S) –∏ —è—Ä–∫–æ—Å—Ç—å (V).
‚Äî –ü–æ—Ç–æ–º –ø–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—Ä–∞—Ç–Ω–æ –≤ BGR.
        '''
        if color_boost > 0.001:
            hsv = cv2.cvtColor(np.clip(comp, 0, 255).astype(np.uint8), cv2.COLOR_BGR2HSV).astype(np.float32)
            hsv[..., 1] = np.clip(hsv[..., 1] * (1.0 + color_boost * ease), 0, 255)
            hsv[..., 2] = np.clip(hsv[..., 2] * (1.0 + 0.08 * ease), 0, 255)
            comp = cv2.cvtColor(hsv.astype(np.uint8), cv2.COLOR_HSV2BGR).astype(np.float32)

        '''
–î–µ–ª–∞–µ–º –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ (glow):
‚Äî –†–∞–∑–º—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É,
‚Äî –°–º–µ—à–∏–≤–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º.
        '''
        blur_sigma = max(1.0, (small_w + small_h) * 0.003 * (0.5 + ease))
        blur = cv2.GaussianBlur(comp.astype(np.uint8), (0, 0), sigmaX=blur_sigma)
        comp = comp * (1.0 - glow_strength * ease) + blur.astype(np.float32) * (glow_strength * ease)

        '''
–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –∫ —Ä–∞–∑–º–µ—Ä—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.
        '''
        up = cv2.resize(np.clip(comp, 0, 255).astype(np.uint8), (w, h), interpolation=cv2.INTER_LINEAR)

        '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–∞–¥—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º.
‚Äî –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –±–æ–ª—å—à–µ –≤–µ—Å —É —ç—Ñ—Ñ–µ–∫—Ç–∞.
        '''
        overlay_alpha = 0.85 * ease
        new_frame = cv2.addWeighted(frame.astype(np.uint8), 1.0 - overlay_alpha, up, overlay_alpha, 0)

        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä —Å —Ç—É–Ω–Ω–µ–ª–µ–º. üé•
        '''
        return new_frame

    def neon_glow3(self, frame, t, duration):

        # ---- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –∫–∞–¥—Ä–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ----
        '''
–ï—Å–ª–∏ –∫–∞–¥—Ä –ø—É—Å—Ç–æ–π ‚Äì –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –Ω–∞—Å –ø—Ä–æ—à–ª—ã–π.
–ï—Å–ª–∏ –±—ã–ª, –æ—Ç–¥–∞–µ–º –µ–≥–æ –∫–æ–ø–∏—é, —Ç–∏–ø–∞ ¬´–¥–µ—Ä–∂–∏ —Å—Ç–∞—Ä–æ–µ –∫–∏–Ω–æ¬ª.
–ï—Å–ª–∏ –¥–∞–∂–µ —ç—Ç–æ–≥–æ –Ω–µ—Ç ‚Äì —Å–æ–∑–¥–∞–µ–º —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω 480—Ö640.
–¢–∞–∫ –º—ã –Ω–µ —É–º–∏—Ä–∞–µ–º –æ—Ç –ø—É—Å—Ç–æ–≥–æ –≤—Ö–æ–¥–∞.
        '''
        if frame is None:
            if hasattr(self, 'last_frame') and self.last_frame is not None:
                return self.last_frame.copy()
            return np.zeros((480, 640, 3), dtype=np.uint8)

        '''
–ø–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞–¥—Ä –≤ numpy-–º–∞—Å—Å–∏–≤, —á—Ç–æ–± —É–¥–æ–±–Ω–æ —Å –Ω–∏–º —Ö–∏–º–∏—á–∏—Ç—å.
        '''
        frame = np.asarray(frame)
        '''
–ï—Å–ª–∏ –∫–∞–¥—Ä —á–µ—Ä–Ω–æ-–±–µ–ª—ã–π (2D) ‚Äì –∫—Ä–∞—Å–∏–º –≤ 3 –∫–∞–Ω–∞–ª–∞ (BGR), —á—Ç–æ–± —Ü–≤–µ—Ç–Ω–æ–π –±—ã–ª.
–ï—Å–ª–∏ –∫–∞–¥—Ä —Å –∞–ª—å—Ñ–æ–π (4 –∫–∞–Ω–∞–ª–∞) ‚Äì —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç—É–ø–æ BGR.
–ö–æ—Ä–æ—á–µ, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ–± –Ω–µ –±—ã–ª–æ –∫—Ä–∏–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
        '''
        if frame.ndim == 2:
            frame = cv2.cvtColor(frame, cv2.COLOR_GRAY2BGR)
        elif frame.ndim == 3 and frame.shape[2] == 4:
            frame = cv2.cvtColor(frame, cv2.COLOR_BGRA2BGR)
        '''
‚Äì‚Äì –µ—Å–ª–∏ –ø–∏–∫—Å–µ–ª–∏ –Ω–µ –≤ —Ç–∏–ø–µ uint8, –ø–æ–¥–≥–æ–Ω—è–µ–º: –æ–±—Ä–µ–∑–∞–µ–º –¥–æ 0..255
–∏ –¥–µ–ª–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –±–∞–π—Ç—ã. –í–∏–¥–µ–æ—Ñ–æ—Ä–º–∞—Ç —Ç—Ä–µ–±—É–µ—Ç —ç—Ç–æ–≥–æ.
        '''
        if frame.dtype != np.uint8:
            frame = np.clip(frame, 0, 255).astype(np.uint8)
        '''
—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é –∫–∞–∫ ¬´–ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–∞–¥—Ä¬ª –Ω–∞ —á–µ—Ä–Ω—ã–π –¥–µ–Ω—å.
        '''
        self.last_frame = frame.copy()

        # ---- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏/–≤–∏–¥–∞) ----
        '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç 0 –¥–æ 1.
–ü–æ—Ç–æ–º –¥–µ–ª–∞–µ–º –µ–≥–æ ¬´–ø–ª–∞–≤–Ω—ã–º¬ª —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é ease ‚Äì —Ç–∏–ø–∞ –≤ –Ω–∞—á–∞–ª–µ –∏ –≤ –∫–æ–Ω—Ü–µ –º–µ–¥–ª–µ–Ω–Ω–æ,
–∞ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –±–æ–¥—Ä–æ. –≠—Ç–æ —á—Ç–æ–± —ç—Ñ—Ñ–µ–∫—Ç—ã –∫—Ä–∞—Å–∏–≤–æ —Ä–∞–∑–≥–æ–Ω—è–ª–∏—Å—å.
        '''
        progress = float(t) / max(1e-6, float(duration))
        progress = np.clip(progress, 0.0, 1.0)
        ease = 1.0 - (1.0 - progress) ** 2.2


        '''
–¢—É—Ç –∫–æ—Ä–æ—á–µ —Ü–µ–ª–∞—è –ø–∞—á–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫:

—É–º–µ–Ω—å—à–∞–µ–º –∫–∞–¥—Ä –¥–æ 44% —Ä–∞–¥–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏.

glow_layers ‚Äì —Ç—Ä–∏ —É—Ä–æ–≤–Ω—è —Ä–∞–∑–º—ã—Ç–∏—è –¥–ª—è —Å–≤–µ—á–µ–Ω–∏—è.

edge_low / edge_high ‚Äì –ø–æ—Ä–æ–≥–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫—Ä–∞–µ–≤.

primary_hue_offset / secondary_hue_offset ‚Äì —Å–¥–≤–∏–≥–∏ —Ü–≤–µ—Ç–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏ –≤—Ç–æ—Ä–∏—á–Ω–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è.

sat_base ‚Äì –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å.

mix_strength ‚Äì —Å–∏–ª–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏—è —Å–≤–µ—á–µ–Ω–∏—è —Å –∫–∞–¥—Ä–æ–º.

temporal_smooth ‚Äì —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

vignette_strength ‚Äì –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º.

chroma_max_shift ‚Äì —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è (—Ü–≤–µ—Ç–Ω—ã–µ —Å–¥–≤–∏–≥–∏ –ø–∏–∫—Å–µ–ª–µ–π).

grain_strength ‚Äì –∑–µ—Ä–Ω–∏—Å—Ç–æ—Å—Ç—å (—à—É–º), —Å–∏–ª—å–Ω–µ–µ –≤ –Ω–∞—á–∞–ª–µ.
        '''
        downscale = 0.44                      # —É–º–µ–Ω—å—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        glow_layers = [(2.0, 0.62), (7.0, 0.28), (18.0, 0.10)]
        edge_low = 28
        edge_high = 120
        primary_hue_offset = 0                # –±–∞–∑–æ–≤—ã–π —Ç–æ–Ω —Å–º–µ—â–µ–Ω–∏—è
        secondary_hue_offset = 70             # –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–æ–Ω (–∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π)
        sat_base = 200
        mix_strength = 0.74 * ease
        temporal_smooth = 0.72
        vignette_strength = 0.45 * ease
        chroma_max_shift = int(2 + 4 * ease)  # –ø–∏–∫—Å–µ–ª–µ–π —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–±–µ—Ä—Ä–∞—Ü–∏–∏
        grain_strength = 0.02 + 0.05 * (1.0 - ease)  # —Å–∏–ª—å–Ω–µ–µ –≤ –Ω–∞—á–∞–ª–µ

        '''
–±–µ—Ä–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞–¥—Ä–∞, –¥–µ–ª–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–æ –Ω–µ –º–µ–Ω—å—à–µ 64 –ø–∏–∫—Å–µ–ª–µ–π).
        '''
        h, w = frame.shape[:2]
        small_w = max(64, int(w * downscale))
        small_h = max(64, int(h * downscale))

        # ---- –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤–∏–Ω—å–µ—Ç–∫–∏ (–Ω–∞ small) ----
        '''
–¢—É—Ç –∑–∞—Ä–∞–Ω–µ–µ —Å—á–∏—Ç–∞–µ–º –≤–∏–Ω—å–µ—Ç–∫—É (–∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º).
–ë–µ—Ä–µ–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, —Å—á–∏—Ç–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞,
–¥–µ–ª–∞–µ–º –º–∞—Å–∫—É –æ—Ç 1 –≤ —Ü–µ–Ω—Ç—Ä–µ –¥–æ 0 –ø–æ –∫—Ä–∞—è–º.
–†–∞–∑–º—ã–≤–∞–µ–º ‚Äì –∏ –≤—Å—ë, –∫—Ä–∞—Å–∏–≤–∞—è –ø–ª–∞–≤–Ω–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ –≥–æ—Ç–æ–≤–∞.
        '''
        if not hasattr(self, '_vignette_small') or self._vignette_small.shape[:2] != (small_h, small_w):
            yy, xx = np.mgrid[0:small_h, 0:small_w]
            cy, cx = small_h / 2.0, small_w / 2.0
            dist = np.sqrt(((yy - cy) / cy) ** 2 + ((xx - cx) / cx) ** 2)
            mask = np.clip(1.0 - dist, 0.0, 1.0)
            mask = cv2.GaussianBlur(mask.astype(np.float32), (0, 0), sigmaX=max(small_w, small_h) * 0.03)
            self._vignette_small = mask.astype(np.float32)

        # ---- –ú–∞—Å–∫–∞ –∫—Ä–∞—ë–≤ –Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–æ–ø–∏–∏ ----
        '''
—É–º–µ–Ω—å—à–∞–µ–º –∫–∞–¥—Ä, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–µ—Ä—ã–π –∏ —Å–ª–µ–≥–∫–∞ –±–ª—é—Ä–∏–º, —á—Ç–æ–± —à—É–º –Ω–µ –º–µ—à–∞–ª –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫—Ä–∞—ë–≤
        '''
        small = cv2.resize(frame, (small_w, small_h), interpolation=cv2.INTER_LINEAR)
        gray = cv2.cvtColor(small, cv2.COLOR_BGR2GRAY)
        blurred = cv2.GaussianBlur(gray, (3, 3), 0)

        '''
–°—á–∏—Ç–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ Canny.
–ü–æ—Ä–æ–≥–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ù–∞ –≤—ã—Ö–æ–¥–µ –ø–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç—É –∫—Ä–∞–µ–≤ –æ—Ç 0 –¥–æ 1.
        '''
        low_thr = max(1, int(edge_low * (0.6 + 0.8 * ease)))
        high_thr = max(low_thr + 1, int(edge_high * (0.9 + 0.6 * ease)))
        edges = cv2.Canny(blurred, low_thr, high_thr).astype(np.float32) / 255.0

        '''
—Ä–∞—Å—à–∏—Ä—è–µ–º –∫—Ä–∞—è (–¥–µ–ª–∞–µ–º –∏—Ö –∂–∏—Ä–Ω–µ–µ), —á—Ç–æ–± —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª –∑–∞–º–µ—Ç–Ω–µ–µ.
        '''
        kernel_sz = max(3, int(1 + ease * 6))
        kern = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (kernel_sz, kernel_sz))
        edges_dil = cv2.dilate((edges * 255).astype(np.uint8), kern, iterations=1).astype(np.float32) / 255.0

        # ---- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–∞—Å–∫–∏ –Ω–∞ primary (—Å–∏–ª—å–Ω—ã–µ –∫—Ä–∞—è) –∏ secondary (–º—è–≥–∫–∏–π –æ—Ä–µ–æ–ª) ----
        # threshold –∑–∞–≤–∏—Å–∏—Ç –æ—Ç progress: –ø—Ä–∏ –º–∞–ª–µ–Ω—å–∫–æ–º progress secondary –±–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–∞
        '''
–î–µ–ª–∏–º –º–∞—Å–∫—É –∫—Ä–∞—ë–≤ –Ω–∞ –¥–≤–µ:

strong ‚Äì —è—Ä–∫–∏–µ, –º–æ—â–Ω—ã–µ –ª–∏–Ω–∏–∏.

soft ‚Äì –º—è–≥–∫–∏–π –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥.
–≠—Ç–æ –¥–∞—Å—Ç –Ω–∞–º primary –∏ secondary —Å–≤–µ—á–µ–Ω–∏–µ.
        '''
        thresh = 0.42 * (0.7 + 0.6 * ease)
        strong = np.clip((edges_dil - thresh) / (1.0 - thresh + 1e-6), 0.0, 1.0)  # 0..1 strong mask
        soft = np.clip(edges_dil, 0.0, 1.0) - strong * (1.0 - 0.05 * ease)
        soft = np.clip(soft, 0.0, 1.0)

        # ---- Multi-layer glow: –¥–≤–∞ —Ç–æ–Ω–∞ (primary + secondary) ----
        # –±–∞–∑–æ–≤—ã–µ —Ç–æ–Ω–∞ –ø—É–ª—å—Å–∏—Ä—É—é—Ç –≤–æ –≤—Ä–µ–º–µ–Ω–∏
        '''
–±–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è –ø–æ —Å–∏–Ω—É—Å—É, —Ç–∞–∫ —á—Ç–æ –æ—Ç—Ç–µ–Ω–∫–∏ –ø—É–ª—å—Å–∏—Ä—É—é—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.
        '''
        hue_base = int((90 + 140.0 * math.sin(t * 2.1)) % 180)
        primary_hue = (hue_base + primary_hue_offset) % 180
        secondary_hue = int((hue_base + secondary_hue_offset + 10.0 * math.sin(t * 1.7)) % 180)

        '''
—Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –∫–æ–ø–∏–ª–∫—É –ø–æ–¥ —Å–≤–µ—á–µ–Ω–∏–µ, –≤—Å—ë –ø–æ–∫–∞ —á—ë—Ä–Ω–æ–µ.
        '''
        glow_acc = np.zeros_like(small, dtype=np.float32)
        # Primary: —Å–∏–ª—å–Ω—ã–µ –∫—Ä–∞—è -> —è—Ä–∫–∏–π –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç
        '''
–¢—É—Ç –º—É—Ç–∏–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –ø–æ —Å–∏–ª—å–Ω—ã–º –∫—Ä–∞—è–º.
‚Äì –ë–µ—Ä—ë–º –º–∞—Å–∫—É —Å–∏–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π, –±–ª—é—Ä–∏–º –µ—ë —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ (sigma).
‚Äì –°–æ–∑–¥–∞—ë–º HSV –∫–∞—Ä—Ç–∏–Ω–∫—É: –æ—Ç—Ç–µ–Ω–æ–∫ = –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è, —è—Ä–∫–æ—Å—Ç—å = —Ä–∞–∑–º—ã—Ç—ã–µ –∫—Ä–∞—è.
‚Äì –ö–æ–Ω–≤–µ—Ä—Ç–∏–º –≤ BGR –∏ –ø–ª—é—Å—É–µ–º –≤ –æ–±—â—É—é –∫–æ–ø–∏–ª–∫—É glow_acc.
–ö–æ—Ä–æ—á–µ, –ª–∏–Ω–∏–∏ –∑–∞–≥–æ—Ä–∞—é—Ç—Å—è —è—Ä–∫–∏–º –Ω–µ–æ–Ω–æ–≤—ã–º —Ü–≤–µ—Ç–æ–º.
        '''
        for sigma, weight in glow_layers:
            m = cv2.GaussianBlur((strong * 255).astype(np.uint8), (0, 0), sigmaX=sigma)
            hsvc = np.zeros((small_h, small_w, 3), dtype=np.uint8)
            hsvc[..., 0] = primary_hue
            hsvc[..., 1] = int(np.clip(sat_base * (0.85 + 0.45 * ease), 0, 255))
            hsvc[..., 2] = m
            col = cv2.cvtColor(hsvc, cv2.COLOR_HSV2BGR).astype(np.float32)
            glow_acc += col * weight * (1.0 + 0.9 * ease)

        # Secondary: –º—è–≥–∫–∏–π –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ / –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π —Ü–≤–µ—Ç
        '''
–¢—É—Ç –≤—Ç–æ—Ä–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ ‚Äì –º—è–≥–∫–∏–π –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ –∫—Ä–∞—ë–≤.
‚Äì –¶–≤–µ—Ç –¥—Ä—É–≥–æ–π (–∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π).
‚Äì –ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –Ω–∏–∂–µ, —á—Ç–æ–± –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞–ª–æ –æ—Å–Ω–æ–≤–Ω–æ–π.
‚Äì –°–∏–ª—å–Ω–µ–µ –≤–∏–¥–Ω–æ –≤ –Ω–∞—á–∞–ª–µ, –ø–æ—Ç–æ–º —É—Ö–æ–¥–∏—Ç.
–ö–æ—Ä–æ—á–µ, –¥–æ–ø–æ–ª–Ω—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –∫—Ä–∞—Å–∏–≤—ã–º –æ–±–≤–æ–¥–æ–º.
        '''
        for sigma, weight in [(6.0, 0.9), (14.0, 0.4)]:
            m2 = cv2.GaussianBlur((soft * 255).astype(np.uint8), (0, 0), sigmaX=sigma)
            hsvc2 = np.zeros((small_h, small_w, 3), dtype=np.uint8)
            hsvc2[..., 0] = secondary_hue
            hsvc2[..., 1] = int(np.clip(sat_base * 0.6 * (0.8 + 0.4 * (1.0 - ease)), 0, 255))
            hsvc2[..., 2] = m2
            col2 = cv2.cvtColor(hsvc2, cv2.COLOR_HSV2BGR).astype(np.float32)
            glow_acc += col2 * weight * (0.55 + 0.6 * (1.0 - ease))

        '''
–ø–æ–¥—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ–∑–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ü–≤–µ—Ç–∞.
        '''
        glow_acc = np.clip(glow_acc, 0.0, 255.0)

        # ---- –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–µ —Ä–∞–¥–∏–∞–ª—å–Ω—ã–µ –∫–æ–ª—å—Ü–∞ (cheap decorative) ----
        # —Å–æ–∑–¥–∞—ë–º —Ä–∞–¥–∏–∞–ª—å–Ω—É—é –≤–æ–ª–Ω–æ–≤—É—é –∫–∞—Ä—Ç—É –Ω–∞ small, —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –º—è–≥–∫–∏–π blur –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ glow
        '''
–†–∏—Å—É–µ–º –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–µ –∫—Ä—É–≥–∏ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ (–∫–∞–∫ –±—É–¥—Ç–æ –≤–æ–ª–Ω—ã).
‚Äì –°—á–∏—Ç–∞–µ–º —Ä–∞–¥–∏—É—Å –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.
‚Äì –ì–æ–Ω–∏–º —Å–∏–Ω—É—Å, —á—Ç–æ–±—ã –∫—Ä—É–≥–∏ –¥—ã—à–∞–ª–∏ –∏ –¥–≤–∏–≥–∞–ª–∏—Å—å.
‚Äì –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∏–∫–∏ –∏ —Ä–∞–∑–º—ã–≤–∞–µ–º.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç, –∫–∞–∫ –±—É–¥—Ç–æ —ç–Ω–µ—Ä–≥–∏—è –ø–æ –∫—Ä—É–≥–∞–º –∏–¥—ë—Ç.
        '''
        yy, xx = np.mgrid[0:small_h, 0:small_w]
        dx = (xx - small_w / 2.0) / (small_w / 2.0)
        dy = (yy - small_h / 2.0) / (small_h / 2.0)
        radius = np.sqrt(dx + dy)
        rings = 0.5 + 0.5 * np.sin((radius * 8.0 - t * 3.0) * (1.0 + 2.5 * (1.0 - ease)))
        rings = np.clip((rings - 0.6) * 3.0, 0.0, 1.0)  # –≤—ã–¥–µ–ª—è–µ–º –ø–∏–∫–∏
        rings_blur = cv2.GaussianBlur((rings * 255).astype(np.uint8), (0, 0), sigmaX=6.0)
        # —Ç–æ–Ω–∏—Ä—É–µ–º –∫–æ–ª—å—Ü–∞ –≤—Ç–æ—Ä–∏—á–Ω—ã–º —Ç–æ–Ω–æ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º
        '''
–∫—Ä–∞—Å–∏–º –∫—Ä—É–≥–∏ –≤–æ –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ü–≤–µ—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ —Å–≤–µ—á–µ–Ω–∏–µ. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π –æ—Ä–µ–æ–ª.
        '''
        hsv_ring = np.zeros((small_h, small_w, 3), dtype=np.uint8)
        hsv_ring[..., 0] = secondary_hue
        hsv_ring[..., 1] = int(np.clip(120 * (0.7 + 0.3 * ease), 0, 255))
        hsv_ring[..., 2] = rings_blur
        ring_col = cv2.cvtColor(hsv_ring, cv2.COLOR_HSV2BGR).astype(np.float32)
        glow_acc += ring_col * (0.18 * (1.0 + 0.8 * (1.0 - ease)))

        # ---- –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø–æ–¥—Å–≤–µ—Ç/–≤–∏–Ω—å–µ—Ç–∫—É –Ω–∞ small ----
        '''
–¥–æ–±–∞–≤–ª—è–µ–º —è—Ä–∫–æ—Å—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–µ (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞), —Ç–∏–ø–∞ ¬´—Å–∏—è–Ω–∏–µ –∏–∑–Ω—É—Ç—Ä–∏¬ª.
        '''
        glow_acc += (self._vignette_small[..., None] * 30.0 * (1.0 + 0.8 * (1.0 - progress)))

        # ---- Upscale + temporal smoothing ----
        '''
–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–≤–µ—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –¥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–¥—Ä–∞.
–î–∞–ª—å—à–µ —Å–≥–ª–∞–∂–∏–≤–∞–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Äì –±–µ—Ä—ë–º –∫—É—Å–æ–∫ –Ω–æ–≤–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è –∏ –∫—É—Å–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ, –º–µ—à–∞–µ–º.
–≠—Ç–æ —á—Ç–æ–± —ç—Ñ—Ñ–µ–∫—Ç –ø–ª–∞–≤–Ω–æ –º–µ–Ω—è–ª—Å—è, –∞ –Ω–µ –¥—ë—Ä–≥–∞–ª—Å—è.
        '''
        glow_up = cv2.resize(np.clip(glow_acc, 0, 255).astype(np.uint8), (w, h), interpolation=cv2.INTER_LINEAR).astype(np.float32)
        if not hasattr(self, '_prev_glow'):
            self._prev_glow = glow_up.copy()
        alpha = 1.0 - temporal_smooth
        self._prev_glow = glow_up * alpha + self._prev_glow * (1.0 - alpha)
        glow_up = self._prev_glow

        # ---- Color dodge composite (float-safe) ----
        '''
–¢—É—Ç –¥–µ–ª–∞–µ–º –∫—Ä—É—Ç–æ–π –ø—Ä–∏—ë–º ‚Äì color dodge.
–û–Ω —Å–º–µ—à–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Ç–∞–∫, —á—Ç–æ –∫—Ä–∞—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å—É–ø–µ—Ä —è—Ä–∫–∏–º–∏, –∫–∞–∫ –±—É–¥—Ç–æ —Å–≤–µ—Ç—è—Ç—Å—è.
–ü–æ—Ç–æ–º —Å–º–µ—à–∏–≤–∞–µ–º —ç—Ç–æ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—è —Å–∏–ª—É —ç—Ñ—Ñ–µ–∫—Ç–æ–º mix_strength.
        '''
        base_f = frame.astype(np.float32)
        eps = 1e-3
        dodge = base_f * 255.0 / (255.0 - glow_up + eps)
        dodge = np.clip(dodge, 0.0, 255.0)
        out = cv2.addWeighted(base_f, 1.0 - mix_strength, dodge, mix_strength, 0.0)

        # ---- –ü–æ–¥–Ω—è—Ç–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏/—è—Ä–∫–æ—Å—Ç–∏ ----
        '''
–ø–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –∏ —è—Ä–∫–æ—Å—Ç—å (–æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–∏–∂–µ –∫ —Å–µ—Ä–µ–¥–∏–Ω–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞).
–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª–µ–µ ¬´–∫–∏—Å–ª–æ—Ç–Ω–æ–π¬ª.
        '''
        out_uint = np.clip(out, 0, 255).astype(np.uint8)
        hsv = cv2.cvtColor(out_uint, cv2.COLOR_BGR2HSV).astype(np.float32)
        hsv[..., 1] = np.clip(hsv[..., 1] * (1.0 + 0.9 * ease), 0, 255)
        hsv[..., 2] = np.clip(hsv[..., 2] * (1.0 + 0.38 * ease), 0, 255)
        out_uint = cv2.cvtColor(hsv.astype(np.uint8), cv2.COLOR_HSV2BGR)

        # ---- –õ—ë–≥–∫–∞—è —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è (–Ω–∞ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ) ----
        '''
–°–¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ-—Ä–∞–∑–Ω–æ–º—É (—Å–∏–Ω–∏–π –≤–ø—Ä–∞–≤–æ, –∫—Ä–∞—Å–Ω—ã–π –≤–≤–µ—Ä—Ö).
–ü–æ–ª—É—á–∞–µ—Ç—Å—è –ª—ë–≥–∫–∏–π ¬´glitch¬ª —ç—Ñ—Ñ–µ–∫—Ç, –∫–∞–∫ –±—É–¥—Ç–æ –ª–∏–Ω–∑–∞ —Ö—Ä–æ–º–∞–µ—Ç.
–≠—Ç–æ –∏ –µ—Å—Ç—å —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è.
        '''
        if chroma_max_shift > 0:
            shift = int(np.clip(chroma_max_shift * (0.5 + 0.5 * math.sin(t * 2.7)), 0, chroma_max_shift))
            b, g, r = cv2.split(out_uint)
            if shift > 0:
                b = np.roll(b, shift, axis=1)
                r = np.roll(r, -shift, axis=0)
            out_uint = cv2.merge((b, g, r))

        # ---- –¢–æ–Ω–∫–∏–π film grain / —à—É–º ----
        '''
–¥–æ–±–∞–≤–ª—è–µ–º —à—É–º (–∑–µ—Ä–Ω–æ), —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –±–æ–ª–µ–µ ¬´–∂–∏–≤–æ–π¬ª, –Ω–µ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π.
        '''
        if grain_strength > 0.0001:
            noise = (np.random.randn(h, w, 1).astype(np.float32) * grain_strength * 255.0)
            out_f = out_uint.astype(np.float32) + noise
            out_uint = np.clip(out_f, 0, 255).astype(np.uint8)

        # ---- –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ (–Ω–∞ full) ----
        '''
–∑–∞—Ç–µ–º–Ω—è–µ–º –∫—Ä–∞—è (–≤–∏–Ω—å–µ—Ç–∫–∞), —á—Ç–æ–± –≤–∑–≥–ª—è–¥ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–ª—Å—è –Ω–∞ —Ü–µ–Ω—Ç—Ä–µ.
        '''
        vign_up = cv2.resize(self._vignette_small, (w, h), interpolation=cv2.INTER_LINEAR)
        vign_mask = (1.0 - vignette_strength) + (vign_up * vignette_strength)
        out_final = np.clip(out_uint.astype(np.float32) * vign_mask[..., None], 0, 255).astype(np.uint8)

        '''
üî• –ö–æ—Ä–æ—á–µ, –±—Ä–∞—Ç, —ç—Ç–æ —Ü–µ–ª—ã–π ¬´—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–∫—Ç–µ–π–ª—å¬ª —ç—Ñ—Ñ–µ–∫—Ç–æ–≤:
–∫—Ä–∞—è –≥–æ—Ä—è—Ç, —Ü–µ–Ω—Ç—Ä —Å–∏—è–µ—Ç, –∫–æ–ª—å—Ü–∞ –ø—É–ª—å—Å–∏—Ä—É—é—Ç,
–≤—Å—ë –¥–≤–∏–≥–∞–µ—Ç—Å—è –ø–ª–∞–≤–Ω–æ, –µ—â—ë –∏ –∫–∏–Ω–æ—à–Ω—ã–π –≤–∞–π–± —á–µ—Ä–µ–∑ –∑–µ—Ä–Ω–æ –∏ –≤–∏–Ω—å–µ—Ç–∫—É.
        '''
        return out_final

    def glitch_shift2(self, frame, t, duration):
        # frame: HxWx3 uint8, t: —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è, duration: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        h, w = frame.shape[:2]
        progress = float(np.clip(t / duration, 0.0, 1.0))
        '''
–ß–µ–º –¥–∞–ª—å—à–µ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–¥–≤–∏–≥–∏.
–ú–∞–∫—Å–∏–º—É–º = 60 –ø–∏–∫—Å–µ–ª–µ–π. –ù–æ –º–∏–Ω–∏–º—É–º —Ö–æ—Ç—è –±—ã 1, —á—Ç–æ–± —ç—Ñ—Ñ–µ–∫—Ç –≤—Å–µ–≥–¥–∞ –±—ã–ª.
        '''
        max_shift = max(1, int(60 * progress))
        '''
‚Äî –°–æ–∑–¥–∞—ë–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª, –Ω–æ –∑–∞–≤—è–∑—ã–≤–∞–µ–º –µ–≥–æ –Ω–∞ –≤—Ä–µ–º—è t.
‚Äî –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä –≤—Å–µ–≥–¥–∞ –¥–∞—ë—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–Ω–¥–æ–º (—á—Ç–æ–± –Ω–µ –¥—ë—Ä–≥–∞–ª–æ—Å—å –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ).
        '''
        rng = np.random.default_rng(int(t * 1000) & 0xffffffff)  # –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–∞ –∫–∞–¥—Ä

        # 1) –†–∞–∑—Ä–µ–∂—ë–Ω–Ω—ã–π —à—É–º (—á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ)
        '''
‚Äî –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —á—Ç–æ –Ω–∞ –ø–∏–∫—Å–µ–ª—å –Ω–∞–∫–∏–Ω–µ–º —à—É–º. –°–Ω–∞—á–∞–ª–∞ –º–∞–ª–æ (0.02), –ø–æ—Ç–æ–º –±–æ–ª—å—à–µ (–¥–æ 0.1).
        '''
        p_noise = 0.02 + 0.08 * progress  # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è
        '''
‚Äî –î–µ–ª–∞–µ–º –º–∞—Å–∫—É: –≥–¥–µ True, —Ç—É–¥–∞ –±–∞—Ö–Ω–µ–º —à—É–º. –¢–∏–ø–∞ —Å–ª—É—á–∞–π–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏ –±—É–¥—É—Ç "—à—É–º–µ—Ç—å".
        '''
        mask = rng.random((h, w)) < p_noise
        '''
–ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω –ø–∏–∫—Å–µ–ª—å –≤—ã–±—Ä–∞–Ω, –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ.
        '''
        if mask.any():
            '''
–ì–µ–Ω–µ—Ä–∏–º —à—É–º–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç -20 –¥–æ +20, –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π.
            '''
            noise_vals = rng.integers(-20, 21, size=(mask.sum(), 1), dtype=np.int16)
            '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ int16,
—á—Ç–æ–± –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏–ª–æ—Å—å
(–∞ —Ç–æ –±—É–¥–µ—Ç –∫–∞–∫ –ø–µ—Ä–µ–ø–∏–ª–µ–Ω–Ω—ã–π –±–∞—Ä—ã–≥–∞ ‚Äî –∑–∞—à–∫–∞–ª–∏–≤–∞—Ç—å).
            '''
            temp = frame.astype(np.int16)
            # –ø—Ä–∏–º–µ–Ω—è–µ–º —à—É–º —Ç–æ–ª—å–∫–æ –∫ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º –ø–∏–∫—Å–µ–ª—è–º, –∫–æ –≤—Å–µ–º –∫–∞–Ω–∞–ª–∞–º
            '''
–ú–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏ (–ø–æ –º–∞—Å–∫–µ) —Å—Ä–∞–∑—É –¥–ª—è –≤—Å–µ—Ö —Ç—Ä—ë—Ö –∫–∞–Ω–∞–ª–æ–≤ (BGR).
            '''
            temp.reshape(-1, 3)[mask.ravel()] += noise_vals
            '''
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –∑–Ω–∞—á–µ–Ω–∏—è –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –æ—Ç 0 –¥–æ 255 (–∏–Ω–∞—á–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–µ–¥–µ—Ç –Ω–∞—Ñ–∏–≥).
            '''
            np.clip(temp, 0, 255, out=temp)
            '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ç–∏–ø –±–∞–π—Ç.
            '''
            frame = temp.astype(np.uint8)

        # 2) –õ—ë–≥–∫–∏–π RGB-—Å–¥–≤–∏–≥ (—Ä–∞–∑–Ω—ã–µ —Å–¥–≤–∏–≥–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤)
        '''
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (R, G, B) –≤—ã–±–∏—Ä–∞–µ–º —Å–≤–æ–π —Å–¥–≤–∏–≥ –ø–æ —à–∏—Ä–∏–Ω–µ.
        '''
        shifts = rng.integers(-max_shift, max_shift + 1, size=3)
        # –ë–µ—Ä—ë–º –∫–∞–Ω–∞–ª—ã –∫–∞–∫ —Å—Ä–µ–∑—ã, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏—à–Ω–∏—Ö –∫–æ–ø–∏–π —á–µ—Ä–µ–∑ cv2.split
        '''
‚Äî –°–¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (axis=1). –£ –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π —Å–¥–≤–∏–≥.
‚Äî –ö—Ä–∞—Å–Ω—ã–π, –∑–µ–ª—ë–Ω—ã–π, —Å–∏–Ω–∏–π —Ç–µ–ø–µ—Ä—å –ø–æ–µ—Ö–∞–ª–∏ –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã.
        '''
        r = np.roll(frame[:, :, 2], shifts[0], axis=1)
        g = np.roll(frame[:, :, 1], shifts[1], axis=1)
        b = np.roll(frame[:, :, 0], shifts[2], axis=1)
        '''
–°–∫–ª–µ–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–¥–∏–Ω –∫–∞–¥—Ä (BGR –¥–ª—è OpenCV).
        '''
        frame = np.dstack((b, g, r))  # –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ BGR –¥–ª—è OpenCV

        # 3) –ü–æ–ª–æ—Å—ã (–Ω–µ —Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–∏–µ, —á—Ç–æ–±—ã —Ü–∏–∫–ª –±—ã–ª –∫–æ—Ä–æ—Ç–∫–∏–π)
        '''
–í—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å—ã. –ú–∏–Ω–∏–º—É–º 8 –ø–∏–∫—Å–µ–ª–µ–π, –º–∞–∫—Å–∏–º—É–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        '''
        stripe_h = max(8, h // 20)  # –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ –≤—ã—Å–æ—Ç–µ
        '''
–°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ—Å –±—É–¥–µ—Ç –ø–æ –≤—ã—Å–æ—Ç–µ.
        '''
        n_stripes = (h + stripe_h - 1) // stripe_h
        # –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–¥–≤–∏–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã, —á–∞—Å—Ç—å –ø–æ–ª–æ—Å –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –±–µ–∑ —Å–¥–≤–∏–≥–∞
        '''
–î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å–¥–≤–∏–≥.
        '''
        stripe_shifts = rng.integers(-max_shift, max_shift + 1, size=n_stripes)
        '''
–†–µ—à–∞–µ–º, –∫–∞–∫–∏–µ –ø–æ–ª–æ—Å—ã —Ä–µ–∞–ª—å–Ω–æ –±—É–¥—É—Ç —Å–¥–≤–∏–Ω—É—Ç—ã (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º —à–∞–Ω—Å –±–æ–ª—å—à–µ).
        '''
        apply_mask = rng.random(n_stripes) < (0.25 + 0.75 * progress)
        '''
‚Äî –ë–µ–∂–∏–º –ø–æ –ø–æ–ª–æ—Å–∞–º.
‚Äî –ï—Å–ª–∏ –ø–æ–ª–æ—Å—É –Ω–∞–¥–æ –¥–≤–∏–≥–∞—Ç—å, —Ç–æ –±–µ—Ä—ë–º –µ—ë –∫—É—Å–æ–∫ –ø–æ –≤—ã—Å–æ—Ç–µ –∏ —Å–¥–≤–∏–≥–∞–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ.
        '''
        for i, s in enumerate(stripe_shifts):
            if not apply_mask[i] or s == 0:
                continue
            y0 = i * stripe_h
            y1 = min((i + 1) * stripe_h, h)
            frame[y0:y1] = np.roll(frame[y0:y1], int(s), axis=1)

        # 4) –ù–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ—á–Ω—ã—Ö –≤—Å–ø–ª–µ—Å–∫–æ–≤ (–∏–Ω–æ–≥–¥–∞), —á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç —Å—Ç–∞–ª ¬´—Å—É–ø–µ—Ä¬ª
        '''
–ò–Ω–æ–≥–¥–∞ (—Å —à–∞–Ω—Å–æ–º –¥–æ 35%) –¥–æ–±–∞–≤–ª—è–µ–º "–≤—Å–ø–ª–µ—Å–∫–∏".
        '''
        if rng.random() < 0.35 * progress:
            '''
–ö–æ–ª-–≤–æ –±–ª–æ–∫–æ–≤, –æ—Ç 1 –¥–æ 3.
            '''
            n_blocks = int(rng.integers(1, 4))
            '''
‚Äî –¢—É—Ç —Ä–µ–∂–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏.
‚Äî –í—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ —Å–ª—É—á–∞–π–Ω–∞—è, —à–∏—Ä–∏–Ω–∞ —Ç–æ–∂–µ.
‚Äî –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ.
‚Äî –ë–µ—Ä—ë–º —ç—Ç–æ—Ç –±–ª–æ–∫ –∏ –¥–≤–∏–≥–∞–µ–º –µ–≥–æ –≤ —Å—Ç–æ—Ä–æ–Ω—É.
‚Äî –í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –∫—É—Å–∫–∞–º–∏ —Ä–∞–∑–æ—Ä–≤–∞–ª–æ.
            '''
            for _ in range(n_blocks):
                bh = int(rng.integers(stripe_h, stripe_h * 3))
                bw = int(rng.integers(max(4, w // 15), max(8, w // 3)))
                y = int(rng.integers(0, max(1, h - bh + 1)))
                x = int(rng.integers(0, max(1, w - bw + 1)))
                dx = int(rng.integers(-max_shift, max_shift + 1))
                frame[y:y + bh, x:x + bw] = np.roll(frame[y:y + bh, x:x + bw], dx, axis=1)

        return frame

    def starburst_explosion2(self, frame, t, duration):
        # –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1 —Å –ø–ª–∞–≤–Ω—ã–º easing
        progress = float(t) / max(1e-6, duration)
        progress = max(0.0, min(1.0, progress))
        # –ª—ë–≥–∫–∏–π ease (smooth)
        '''
–¢—É—Ç —Ö–∏—Ç—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞: –¥–µ–ª–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–π —Ä–∞–∑–≥–æ–Ω –∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ.
–¢–∏–ø–∞ –≤–º–µ—Å—Ç–æ —Ä–µ–∑–∫–æ–≥–æ ¬´–≤–∫–ª/–≤—ã–∫–ª¬ª, –∏–¥—ë—Ç –∫—Ä–∞—Å–∏–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥.
        '''
        def smoothstep(x): return x * x * (3 - 2 * x)
        '''
–ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ç–æ—Ç –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥, –∏ —Ç–µ–ø–µ—Ä—å —É –Ω–∞—Å p ‚Äì —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å.
        '''
        p = smoothstep(progress)

        h, w = frame.shape[:2]
        '''
–î–µ–ª–∞–µ–º –∫–æ–ø–∏—é –∫–∞–¥—Ä–∞, —Å –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å, –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ü–µ–ª—ã–º —á–∏—Å–ª–∞–º –¥–ª—è OpenCV.
        '''
        out = frame.copy().astype(np.uint8)

        # === 1) SOFT BLOOM (–Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–º —Å–ª–æ–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏) ===
        '''
–†–µ—à–∞–µ–º, –≤–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —É–º–µ–Ω—å—à–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è ¬´—Å–≤–µ—á–µ–Ω–∏—è¬ª.
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –æ–≥—Ä–æ–º–Ω–∞—è ‚Äì —Ä–µ–∂–µ–º —Å–∏–ª—å–Ω–µ–µ, —á—Ç–æ–± –Ω–µ –∂—Ä–∞–ª–æ –º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤.
        '''
        ds = 6 if max(h, w) > 1500 else 4  # downscale —Ñ–∞–∫—Ç–æ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        '''
–°—á–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–æ–ø–∏–∏.
        '''
        sw, sh = max(1, w // ds), max(1, h // ds)
        '''
–°–æ–∑–¥–∞—ë–º —á—ë—Ä–Ω–æ–µ –ø–æ–ª–æ—Ç–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è.
        '''
        glow = np.zeros((sh, sw, 3), dtype=np.uint8)


        '''
–û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –∏—Å–∫—Ä –±—É–¥–µ—Ç. –ß–µ–º –¥–∞–ª—å—à–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º –∏—Ö –±–æ–ª—å—à–µ.
–ú–∞–∫—Å–∏–º—É–º ‚Äî 250, —á—Ç–æ–± –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É.
        '''
        max_sparks = 90
        num_sparks = int(max_sparks * (p ** 0.9))
        num_sparks = min(num_sparks, 250)
        '''
–†–∞–∑–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫—Ä—ã —Å–ª—É—á–∞–π–Ω–æ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ (–Ω–æ –Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏).
        '''
        for _ in range(num_sparks):
            gx = random.randint(0, sw - 1)
            gy = random.randint(0, sh - 1)
            # —Ä–∞–¥–∏—É—Å –Ω–∞ –º–µ–ª–∫–æ–º —Å–ª–æ–µ
            '''
–†–∞–∑–º–µ—Ä –∏—Å–∫—Ä—ã: —á—É—Ç—å –±–æ–ª—å—à–µ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, –ø–ª—é—Å –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–Ω–¥–æ–º–∞.
            '''
            r = max(1, int(1 + 6 * p * (0.5 + random.random() * 0.9)))
            # —Ü–≤–µ—Ç ‚Äî —Ç—ë–ø–ª—ã–π —Å –ª—ë–≥–∫–∏–º —Å–¥–≤–∏–≥–æ–º –∫ –ø—É—Ä–ø—É—Ä–Ω–æ-—Ä–æ–∑–æ–≤–æ–º—É
            color = (int(160 + random.random() * 95),
                     int(130 + random.random() * 120),
                     int(190 + random.random() * 60))
            '''
–†–∏—Å—É–µ–º –∫—Ä—É–∂–æ–∫-–∏—Å–∫—Ä—É –≤ —Å–ª–æ–µ glow.
            '''
            cv2.circle(glow, (gx, gy), r, color, -1, lineType=cv2.LINE_AA)

        '''
–†–∞–∑–º—ã–≤–∞–µ–º –≤—Å—ë —Å–≤–µ—á–µ–Ω–∏–µ –ì–∞—É—Å—Å–æ–º, —á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –º—è–≥–∫–æ.
k ‚Äì —Ä–∞–∑–º–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞, —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
–î–µ–ª–∞–µ–º –µ–≥–æ –Ω–µ—á—ë—Ç–Ω—ã–º, –∏–Ω–∞—á–µ OpenCV —Ä—É–≥–Ω—ë—Ç—Å—è.
        '''
        k = max(1, int(3 + 14 * p))
        if k % 2 == 0: k += 1
        glow = cv2.GaussianBlur(glow, (k, k), 0)
        '''
–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–ª–æ–π —Å–≤–µ—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –¥–æ —Ä–∞–∑–º–µ—Ä–æ–≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.
        '''
        glow_up = cv2.resize(glow, (w, h), interpolation=cv2.INTER_LINEAR)
        # –ª—ë–≥–∫–∞—è —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è –Ω–∞ bloom ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤
        '''
–î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç ¬´—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è¬ª ‚Äî —Å–¥–≤–∏–≥–∞–µ–º —Ü–≤–µ—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã,
—á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–æ—Å—å –æ—â—É—â–µ–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –±–ª–∏–∫–∞.
        '''
        shift = max(1, int(1 + 6 * p))
        bloom = glow_up.copy()
        bloom[:,:,0] = np.roll(bloom[:,:,0], shift, axis=1)   # B
        bloom[:,:,2] = np.roll(bloom[:,:,2], -shift//2, axis=1)  # R
        '''
–°–º–µ—à–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–∞–¥—Ä –∏ —Å–≤–µ—á–µ–Ω–∏–µ.
        '''
        out = cv2.addWeighted(out, 1.0, bloom, 0.18 + 0.6 * p, 0)

        # === 2) SOFT LIGHT RAYS (—Ç–æ–Ω–∫–∏–µ, –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∏–ª–∏ –æ—Ç —è—Ä–∫–∏—Ö —Ç–æ—á–µ–∫) ===
        '''
–°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Å–ª–æ–π –¥–ª—è –ª—É—á–µ–π –∏ —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞.
        '''
        rays = np.zeros_like(out)
        cx, cy = w // 2, h // 2
        '''
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—É—á–µ–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
        '''
        num_rays = int(8 + 12 * p)
        '''
–†–∏—Å—É–µ–º –ª—É—á: —É–≥–æ–ª ‚Äî —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –∫—Ä—É–≥—É, –Ω–æ —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º —Å–¥–≤–∏–≥–æ–º.
–î–ª–∏–Ω–∞ –ª—É—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
        '''
        for i in range(num_rays):
            angle = random.uniform(-0.25, 0.25) + (2 * math.pi * i / max(1, num_rays))
            length = int(min(w, h) * (0.6 + 0.5 * p) * (0.8 + random.random() * 0.6))
            '''
–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –ª—É—á–∞ –ø–æ —É–≥–ª—É –∏ –¥–ª–∏–Ω–µ.
            '''
            x2 = int(cx + math.cos(angle) * length)
            y2 = int(cy + math.sin(angle) * length * 0.9)
            '''
–†–∏—Å—É–µ–º —Å–∞–º –ª—É—á: –±–µ–ª–æ-–≥–æ–ª—É–±–æ–π, —Å —Ç–æ–ª—â–∏–Ω–æ–π –∑–∞–≤–∏—Å—è—â–µ–π –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
            '''
            thickness = max(1, int(1 + 4 * p * (0.5 + random.random())))
            col = (220, 210, 255)
            cv2.line(rays, (cx, cy), (x2, y2), col, thickness, lineType=cv2.LINE_AA)
        '''
–†–∞–∑–º—ã–≤–∞–µ–º –ª—É—á–∏ –∏ –ø–æ–¥–º–µ—à–∏–≤–∞–µ–º –∏—Ö –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        rays = cv2.GaussianBlur(rays, (15, 15), 0)
        out = cv2.addWeighted(out, 1.0, rays, 0.18 * p, 0)

        # === 3) ELEGANT SHARDS (–ø–ª–∞–≤–Ω–æ –ø–∞—Ä—è—â–∏–µ –∫—É—Å–∫–∏ —Å –º—è–≥–∫–∏–º–∏ –∫—Ä–∞—è–º–∏ –∏ –ª—ë–≥–∫–æ–π –∫–∏–Ω–µ—Ç–∏–∫–æ–π) ===
        '''
–≠—Ñ—Ñ–µ–∫—Ç –æ—Å–∫–æ–ª–∫–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–µ —Å—Ä–∞–∑—É, –∞ —á—É—Ç—å –ø–æ–∑–∂–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Å 15%).
        '''
        if p > 0.15:
            # –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à–∞—Ä–¥–æ–≤: –º–µ–Ω—å—à–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö, –±–æ–ª—å—à–µ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤
            '''
–°—á–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—Å–∫–æ–ª–∫–æ–≤: –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫—É.
–ú–∏–Ω–∏–º—É–º 48 –ø–∏–∫—Å–µ–ª–µ–π, –º–∞–∫—Å–∏–º—É–º 160 ‚Äì —á—Ç–æ–±—ã –º–∞–ª–µ–Ω—å–∫–∏–µ –∏ –æ–≥—Ä–æ–º–Ω—ã–µ –∫–∞–¥—Ä—ã –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Å–º–æ—Ç—Ä–µ–ª–∏—Å—å.
            '''
            shard_base = int(min(h, w) / 12)
            shard_size = max(48, min(160, shard_base))
            '''
–ù–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –æ—Å–∫–æ–ª–∫–∏ –±—É–¥—É—Ç —Ä–∞–∑–ª–µ—Ç–∞—Ç—å—Å—è: —Ä–∞—Å—Ç—ë—Ç –ø–ª–∞–≤–Ω–æ –æ—Ç 0 –¥–æ 1 —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
            '''
            move_strength = (p - 0.15) / (1.0 - 0.15)
            move_strength = max(0.0, min(1.0, move_strength))
            '''
–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Å–∫–æ–ª–æ–∫ –¥–≤–∏–Ω–µ—Ç—Å—è –Ω–∞—Ä—É–∂—É
            '''
            move_prob = 0.32 + 0.58 * move_strength  # —á–∞—Å—Ç—å —à–∞—Ä–¥–æ–≤ –¥–≤–∏–∂–µ—Ç—Å—è
            # –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Ä–æ–≥–∏—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤
            '''
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ¬´–¥–æ—Ä–æ–≥–∏—Ö¬ª –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ (—á—Ç–æ–± –Ω–µ –≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø).
            '''
            max_rotates = 10
            rotates_done = 0
            '''
–î–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç—ã (—à–∞—Ä–¥—ã).
–° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é move_prob –≤—ã–±–∏—Ä–∞–µ–º, –∫–∞–∫–∏–µ –∫—É—Å–∫–∏ –±—É–¥—É—Ç –ª–µ—Ç–µ—Ç—å.
–ë–µ—Ä—ë–º –ø–æ–¥–∫–∞–¥—Ä —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.
            '''
            for i in range(0, h, shard_size):
                ph = min(shard_size, h - i)
                for j in range(0, w, shard_size):
                    if random.random() > move_prob:
                        continue
                    pw = min(shard_size, w - j)
                    src = frame[i:i+ph, j:j+pw].astype(np.uint8)

                    # –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Ä—É–∂—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–ª—ë—Ç–∞
                    '''
–°—á–∏—Ç–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Ä—É–∂—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–µ–∫—Ç–æ—Ä, —á—Ç–æ–± –æ—Å–∫–æ–ª–∫–∏ –ª–µ—Ç–µ–ª–∏ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.
                    '''
                    sx = (j + pw/2.0) - cx
                    sy = (i + ph/2.0) - cy
                    dist = math.hypot(sx, sy) + 1e-6
                    nx, ny = sx / dist, sy / dist

                    # –¥–∞–ª—å–Ω–æ—Å—Ç—å —Å–º–µ—â–µ–Ω–∏—è —Ä–∞—Å—Ç—ë—Ç –ø–ª–∞–≤–Ω–æ
                    '''
–î–∞–ª—å–Ω–æ—Å—Ç—å —Å–º–µ—â–µ–Ω–∏—è: —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∏ –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–Ω–¥–æ–º–Ω–∞—è, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ.
                    '''
                    max_shift = int(min(w, h) * 0.45 * (0.25 + 0.75 * move_strength))
                    dx = int(nx * max_shift * (0.5 + 0.5 * random.random()))
                    dy = int(ny * (max_shift*0.55) * (0.4 + 0.6 * random.random()))

                    # –Ω–µ–±–æ–ª—å—à–æ–π –ø–∞—Ä–∞–ª–ª–∞–∫—Å –ø–æ –≥–ª—É–±–∏–Ω–µ: –±–ª–∏–∂–Ω–∏–µ –∫—É—Å–∫–∏ —Å–º–µ—â–∞—é—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ
                    '''
–ü–∞—Ä–∞–ª–ª–∞–∫—Å: –æ—Å–∫–æ–ª–∫–∏ –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É –¥–≤–∏–≥–∞—é—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ, –¥–∞–ª—å–Ω–∏–µ ‚Äì —Å–ª–∞–±–µ–µ.
                    '''
                    depth_bias = 1.0 - (dist / (math.hypot(cx, cy) + 1e-6))
                    dx = int(dx * (0.6 + 0.8 * depth_bias))
                    dy = int(dy * (0.6 + 0.8 * depth_bias))

                    '''
–í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –æ—Å–∫–æ–ª–∫–∞ –∏ –æ–±—Ä–µ–∑–∞–µ–º, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –≤—ã–ª–µ–∑ –∑–∞ –∫—Ä–∞—è.
                    '''
                    new_j = j + int(dx * move_strength)
                    new_i = i + int(dy * move_strength)
                    new_j = max(0, min(w - pw, new_j))
                    new_i = max(0, min(h - ph, new_i))


                    '''
–†–µ–¥–∫–∏–π –ø–æ–≤–æ—Ä–æ—Ç –æ—Å–∫–æ–ª–∫–∞, —á—Ç–æ–±—ã –±—ã–ª–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ.
–ù–µ –±–æ–ª–µ–µ max_rotates –∑–∞ –∫–∞–¥—Ä, —É–≥–æ–ª –Ω–µ–±–æ–ª—å—à–æ–π, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
                    '''
                    dst_patch = src

                    # —Ä–µ–¥–∫–∏–µ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã –¥–ª—è –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ—Å—Ç–∏
                    if rotates_done < max_rotates and random.random() < 0.12:
                        angle = random.uniform(-6.0, 6.0) * move_strength
                        M = cv2.getRotationMatrix2D((pw / 2.0, ph / 2.0), angle, 1.0)
                        rotated = cv2.warpAffine(src, M, (pw, ph), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
                        dst_patch = rotated
                        rotates_done += 1

                    # –º—è–≥–∫–∞—è –º–∞—Å–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞, –¥–∞—ë–º –ø–ª–∞–≤–Ω—ã–µ –∫—Ä–∞—è
                    '''
–°–æ–∑–¥–∞—ë–º –∫—Ä—É–≥–æ–≤—É—é –º–∞—Å–∫—É –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –∫—Ä–∞—ë–≤ –æ—Å–∫–æ–ª–∫–∞.
                    '''
                    yy, xx = np.ogrid[:ph, :pw]
                    cxr, cyr = pw / 2.0, ph / 2.0
                    radius = math.hypot(cxr, cyr)
                    mask = (( (xx - cxr)**2 + (yy - cyr)**2 ) <= (radius*0.98)**2).astype(np.float32)
                    # —Ä–∞–∑–º—ã–≤–∞–µ–º –º–∞—Å–∫—É (–º–∞–ª–µ–Ω—å–∫–∏–π –≥–∞—É—Å—Å)
                    '''
–†–∞–∑–º—ã–≤–∞–µ–º –º–∞—Å–∫—É, –¥–µ–ª–∞–µ–º –º—è–≥–∫–∏–π –∫—Ä–∞–π, –ø–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è —Ç—Ä—ë—Ö –∫–∞–Ω–∞–ª–æ–≤.
                    '''
                    mk = max(3, int(3 + 5 * (1.0 - move_strength)))
                    if mk % 2 == 0: mk += 1
                    mask = cv2.GaussianBlur((mask*255).astype(np.uint8), (mk, mk), 0).astype(np.float32) / 255.0
                    mask3 = np.repeat(mask[:, :, None], 3, axis=2)

                    # –¥–æ–±–∞–≤–ª—è–µ–º –º—è–≥–∫–∏–π trailing (2 —à–∞–≥–∞) –¥–ª—è –æ—â—É—â–µ–Ω–∏—è motion blur ‚Äî –¥–µ—à—ë–≤—ã–π –ø—Ä–∏—ë–º
                    '''
–î–µ–ª–∞–µ–º –¥–µ—à—ë–≤—ã–π motion blur: –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ø–∏–π –æ—Å–∫–æ–ª–∫–∞ —Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º —Å–º–µ—â–µ–Ω–∏–µ–º.
–ß–µ–º –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É, —Ç–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ, —Å–æ–∑–¥–∞—ë—Ç –æ—â—É—â–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è.
                    '''
                    trail_steps = 2
                    total = np.zeros_like(dst_patch, dtype=np.float32)
                    alpha_acc = 0.0
                    for s in range(trail_steps + 1):
                        talpha = (1.0 - s / (trail_steps + 1)) * (0.6 + 0.4 * move_strength)
                        shift_x = int(- (dx * move_strength) * (s / (trail_steps + 1)) * 0.6)
                        shift_y = int(- (dy * move_strength) * (s / (trail_steps + 1)) * 0.6)
                        # –±–µ—Ä—ë–º src –∏ —Å–¥–≤–∏–≥–∞–µ–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞: —Å–¥–≤–∏–≥ —á–µ—Ä–µ–∑ roll, –∑–∞—Ç–µ–º –æ–±—Ä–µ–∑–∫–∞ –≤–∞–ª–∏–¥–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
                        rolled = np.roll(dst_patch, shift=(shift_y, shift_x), axis=(0,1))
                        total += rolled.astype(np.float32) * talpha
                        alpha_acc += talpha
                    if alpha_acc > 1e-6:
                        total = (total / alpha_acc).astype(np.uint8)
                    else:
                        total = dst_patch

                    # —Å–º–µ—à–∏–≤–∞–Ω–∏–µ —Å —Ñ—Ä–µ–π–º–æ–º —á–µ—Ä–µ–∑ –º–∞—Å–∫—É
                    '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Å–∫–æ–ª–æ–∫ —Å —Ñ—Ä–µ–π–º–æ–º –ø–æ –º–∞—Å–∫–µ: –º—è–≥–∫–æ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É.
                    '''
                    dst_roi = out[new_i:new_i+ph, new_j:new_j+pw].astype(np.float32)
                    src_f = total.astype(np.float32)
                    blended = (src_f * mask3 + dst_roi * (1.0 - mask3)).astype(np.uint8)
                    out[new_i:new_i+ph, new_j:new_j+pw] = blended

                    # —Ç–æ–Ω–∫–∏–π –ø–æ–¥—Å–≤–µ—Ç/–±–ª–∏–∫ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
                    '''
–õ—ë–≥–∫–∏–π –±–ª–∏–∫ —Å–≤–µ—Ä—Ö—É –æ—Å–∫–æ–ª–∫–∞ –¥–ª—è –æ–±—ä—ë–º–∞ –∏ —Å–≤–µ—á–µ–Ω–∏—è.
                    '''
                    if pw > 6 and ph > 6:
                        light_alpha = 0.18 * (0.4 + move_strength * 0.6)
                        top_line = (230, 225, 255)
                        cv2.line(out, (new_j, new_i), (new_j + pw - 1, new_i), top_line, max(1, int(1 + move_strength)), lineType=cv2.LINE_AA)

        # === 4) SOFT COLOR GRADE & VIGNETTE ===
        # –ª—ë–≥–∫–∏–π —Ç—ë–ø–ª—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç/–ø–æ–¥—Ç—è–∂–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
        '''
–¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è: –ª—ë–≥–∫–∞—è S-–∫—Ä–∏–≤–∞—è, –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ—Ç —Å–≤–µ—Ç–ª—ã–µ/—Ç—ë–º–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏.
        '''
        lut = np.arange(256, dtype=np.uint8)
        # –Ω–µ–±–æ–ª—å—à–æ–π S-curve: —É—Å–∏–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–∞—Å—Ç (–∫—Ä–∏–≤—É—é –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
        lut = np.clip(255.0 * ( (lut / 255.0) ** (0.95 - 0.12 * p) ), 0, 255).astype(np.uint8)
        for c in range(3):
            out[:,:,c] = cv2.LUT(out[:,:,c], lut)

        # –¥–æ–±–∞–≤–∏—Ç—å –ª—ë–≥–∫–∏–π —Ç—ë–ø–ª—ã–π —Ç–æ–Ω: –¥–æ–±–∞–≤–∏—Ç—å –≤ R –Ω–µ–±–æ–ª—å—à—É—é –ø—Ä–∏–±–∞–≤–∫—É, –≤ B ‚Äî –Ω–µ–±–æ–ª—å—à–æ–µ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ
        '''
–î–æ–±–∞–≤–ª—è–µ–º —Ç—ë–ø–ª—ã–π —Ç–æ–Ω: –∫—Ä–∞—Å–Ω—ã–π —á—É—Ç—å —è—Ä—á–µ, —Å–∏–Ω–∏–π —á—É—Ç—å —Ç—É—Å–∫–ª–µ–µ.
        '''
        warm = int(8 + 28 * p)
        out[:,:,2] = np.clip(out[:,:,2].astype(int) + warm, 0, 255).astype(np.uint8)  # R up
        out[:,:,0] = np.clip(out[:,:,0].astype(int) - int(warm * 0.3), 0, 255).astype(np.uint8)  # B down

        # –≤–∏–Ω—å–µ—Ç–∫–∞ (–º—è–≥–∫–∞—è)
        '''
–í–∏–Ω—å–µ—Ç–∫–∞: –∫—Ä–∞—è –∫–∞–¥—Ä–∞ —Å–ª–µ–≥–∫–∞ –∑–∞—Ç–µ–º–Ω–µ–Ω—ã, —Ü–µ–Ω—Ç—Ä —è—Ä—á–µ.
–°–∏–ª–∞ –≤–∏–Ω—å–µ—Ç–∫–∏ —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
        '''
        vx = cv2.getGaussianKernel(w, w * 0.9)
        vy = cv2.getGaussianKernel(h, h * 0.9)
        vign = vy @ vx.T
        vign = (vign - vign.min()) / (vign.max() - vign.min() + 1e-9)
        vign_strength = 0.28 * p
        for c in range(3):
            out[:,:,c] = (out[:,:,c].astype(np.float32) * (1.0 - vign_strength * (1.0 - vign))).astype(np.uint8)

        return out

    def mirror_shatter2(self, frame, t, duration):
        # –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1 —Å –ø–ª–∞–≤–Ω—ã–º easing (ease out)
        progress = float(t) / max(1e-6, duration)
        progress = max(0.0, min(1.0, progress))
        def ease_out(x): return 1 - (1 - x) ** 3
        p = ease_out(progress)

        h, w = frame.shape[:2]
        # –±–∞–∑–æ–≤—ã–π –±–ª–µ–Ω–¥ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ –∑–µ—Ä–∫–∞–ª–∞ ‚Äî –∑–µ—Ä–∫–∞–ª—å–Ω–∞—è –æ—Å—å –ø–æ —Ü–µ–Ω—Ç—Ä—É
        '''
–î–µ–ª–∞–µ–º –∑–µ—Ä–∫–∞–ª–∫—É –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (flip(frame, 1)) –∏ —Å–º–µ—à–∏–≤–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º.
0.6/0.4 ‚Äî —á—Ç–æ–±—ã –æ—Ä–∏–≥–∏–Ω–∞–ª –±—ã–ª —è—Ä—á–µ. –¢–∏–ø uint8 ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        '''
        mirrored = cv2.flip(frame, 1)
        base = cv2.addWeighted(frame, 0.6, mirrored, 0.4, 0).astype(np.uint8)

        out = base.copy()

        # —Ç–æ–Ω–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–¥–æ–ª—å –∑–µ—Ä–∫–∞–ª—å–Ω–æ–π –æ—Å–∏ (seam glow)
        '''
–ß—ë—Ç–∫–∞—è –ª–∏–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É –∑–µ—Ä–∫–∞–ª–∞, —Ç–∏–ø–∞ ¬´—à–æ–≤¬ª —Å –ª—ë–≥–∫–∏–º —Å–≤–µ—á–µ–Ω–∏–µ–º.  
`seam_width` —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∞–Ω–∏–º–∞—Ü–∏–∏,
`GaussianBlur` –¥–µ–ª–∞–µ—Ç –µ—ë –º—è–≥–∫–æ–π,
–∞ –ø–æ—Ç–æ–º —Å–º–µ—à–∏–≤–∞–µ–º —Å –∫–∞–¥—Ä–æ–º —á–µ—Ä–µ–∑ addWeighted.
        '''
        cx = w // 2
        seam = np.zeros_like(base, dtype=np.uint8)
        seam_width = max(2, int(2 + 8 * p))
        cv2.line(seam, (cx, 0), (cx, h - 1), (230, 220, 255), seam_width, lineType=cv2.LINE_AA)
        seam = cv2.GaussianBlur(seam, (1 + 2 * seam_width, 1 + 2 * seam_width), 0)
        out = cv2.addWeighted(out, 1.0, seam, 0.22 * p, 0)

        # –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–∞–∑–ª–µ—Ç —à–∞—Ä–¥–æ–≤
        '''
–≠—Ñ—Ñ–µ–∫—Ç ¬´—Ä–∞–∑–ª–µ—Ç–∞ shards¬ª —Å—Ç–∞—Ä—Ç—É–µ—Ç –ø–æ—Å–ª–µ 22% –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
sp ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —ç—Ç–∏—Ö –æ—Å–∫–æ–ª–∫–æ–≤.
        '''
        shatter_start = 0.22
        if p > shatter_start:
            sp = (p - shatter_start) / (1.0 - shatter_start)
            sp = max(0.0, min(1.0, sp))

            # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞—Ä–¥–æ–≤
            '''
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—Å–∫–æ–ª–∫–æ–≤ –∏ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
–° —Ä–æ—Å—Ç–æ–º sp –æ—Å–∫–æ–ª–∫–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ max_shards.
            '''
            shard_base = int(min(h, w) / 12)
            shard_size = max(40, min(160, shard_base))
            max_shards = 28
            num_shards = max(4, int(max_shards * (sp ** 0.95)))
            num_shards = min(num_shards, max_shards)

            # –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ heavy transforms
            '''
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ –æ—Å–∫–æ–ª–∫–æ–≤, —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø, –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –æ—Å—å.
            '''
            max_rotates = 6
            rotates_done = 0

            # –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä-–æ—Å—å (x=center seam)
            seam_x = float(cx)

            '''
–í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ç–æ—á–∫—É –æ—Å–∫–æ–ª–∫–∞ —Ä—è–¥–æ–º —Å –æ—Å—å—é.
j ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å, i ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å. –ì–∞—É—Å—Å —Å–º–µ—â–∞–µ—Ç –æ—Å–∫–æ–ª–æ–∫ –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É.
            '''
            for s in range(num_shards):
                # –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –±–ª–∏–∑–∫–æ –∫ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–π –æ—Å–∏,
                # —á—Ç–æ–±—ã —à–∞—Ä–¥ –≤—ã–≥–ª—è–¥–µ–ª –∫–∞–∫ –æ—Ç–æ—Ä–≤–∞–Ω–Ω—ã–π –æ—Ç –∑–µ—Ä–∫–∞–ª–∞
                # x –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö +/- –ø–æ–ª–æ–≤–∏–Ω—ã —à–∏—Ä–∏–Ω—ã —à–∞—Ä–¥–æ–≤ –æ—Ç –æ—Å–∏
                j = int(np.clip(random.gauss(seam_x, shard_size * 1.2), 0, w - 1))
                i = random.randint(0, max(0, h - 1))

                '''
–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ—Å–∫–æ–ª–æ–∫, –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –∫—Ä–∞—é, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ—Ç–µ—Ç—å –∑–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É.
                '''
                pw = min(shard_size, w - j)
                ph = min(shard_size, h - i)
                # –µ—Å–ª–∏ —Ö–æ–ª–æ—Å—Ç–æ–π (—Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –∫—Ä–∞—é), —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –≤–∑—è—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç
                if pw <= 4 or ph <= 4:
                    # –≤–æ–∑—å–º—ë–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –∫–∞–¥—Ä–∞
                    j = max(0, min(w - shard_size, j - shard_size // 2))
                    i = max(0, min(h - shard_size, i - shard_size // 2))
                    pw = min(shard_size, w - j)
                    ph = min(shard_size, h - i)

                '''
–í—ã—Ä–µ–∑–∞–µ–º –æ—Å–∫–æ–ª–æ–∫ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.
                '''
                src = frame[i:i + ph, j:j + pw].astype(np.uint8)

                # –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è: –Ω–∞—Ä—É–∂—É –æ—Ç seam (–µ—Å–ª–∏ —Å–ª–µ–≤–∞ ‚Äî –≤–ª–µ–≤–æ, –µ—Å–ª–∏ —Å–ø—Ä–∞–≤–∞ ‚Äî –≤–ø—Ä–∞–≤–æ)
                '''
–û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è:
–≤–ª–µ–≤–æ –∏–ª–∏ –≤–ø—Ä–∞–≤–æ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞, —Å –Ω–µ–±–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π —Å–ª—É—á–∞–π–Ω–æ–π —Å–æ—Å—Ç–∞–≤–ª—è—é—â–µ–π.
                '''
                center_x_fragment = j + pw / 2.0
                dir_x = 1.0 if center_x_fragment > seam_x else -1.0
                # –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –Ω–µ–±–æ–ª—å—à–∞—è, —Å —Ä–∞–Ω–¥–æ–º–æ–º
                dir_y = random.uniform(-0.25, 0.25)

                # –≥–ª—É–±–∏–Ω–∞/–ø–∞—Ä–∞–ª–ª–∞–∫—Å: —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É —Å–º–µ—â–∞—é—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ
                '''
–ß–µ–º –±–ª–∏–∂–µ –æ—Å–∫–æ–ª–æ–∫ –∫ —Ü–µ–Ω—Ç—Ä—É ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–º–µ—â–∞–µ–º. –ü–æ–ª—É—á–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç ¬´–≥–ª—É–±–∏–Ω—ã¬ª –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–∞–∫—Å–∞.
                '''
                dist_from_center = abs(center_x_fragment - seam_x)
                max_dist = w / 2.0
                depth_factor = 1.0 - (dist_from_center / (max_dist + 1e-6))
                depth_factor = 0.5 + 0.5 * depth_factor  # 0.5..1.0
                # –≤–µ–ª–∏—á–∏–Ω–∞ —Å–º–µ—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç sp, depth –∏ —Ä–∞–Ω–¥–æ–º–∞
                '''
–í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Å–∫–æ–ª–∫–∞. dx –∏ dy –∑–∞–≤–∏—Å—è—Ç –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ sp, —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –∏ –≥–ª—É–±–∏–Ω—ã.
                '''
                max_shift = int(min(w, h) * 0.45 * (0.25 + 0.75 * sp))
                dx = int(dir_x * max_shift * (0.4 + 0.6 * random.random()) * depth_factor)
                dy = int(dir_y * (max_shift * 0.35) * (0.6 + 0.8 * random.random()) * depth_factor)
                new_j = j + int(dx * sp)
                new_i = i + int(dy * sp)

                # –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                '''
–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ—Å–∫–æ–ª–æ–∫, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞–¥—Ä–∞.
                '''
                new_j = max(0, min(w - pw, new_j))
                new_i = max(0, min(h - ph, new_i))


                '''
–ò–Ω–æ–≥–¥–∞ –∫—Ä—É—Ç–∏–º –æ—Å–∫–æ–ª–æ–∫, –Ω–æ —Ä–µ–¥–∫–æ, —á—Ç–æ–±—ã –∫–æ–º–ø –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª. BORDER_REFLECT ‚Äî —á—Ç–æ–± –∫—Ä–∞—è –Ω–µ —É—Ä–æ–¥–∏–ª–∏—Å—å.
                '''
                dst_patch = src

                # —Ä–µ–¥–∫–æ –¥–µ–ª–∞–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç (–¥–æ—Ä–æ–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è) ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–±—â–µ–µ —á–∏—Å–ª–æ
                if rotates_done < max_rotates and random.random() < 0.18:
                    angle = random.uniform(-7.0, 7.0) * sp
                    M = cv2.getRotationMatrix2D((pw / 2.0, ph / 2.0), angle, 1.0)
                    # borderMode REFLECT ‚Äî –±–µ–∑ –∂–µ—Å—Ç–∫–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
                    rotated = cv2.warpAffine(src, M, (pw, ph), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
                    dst_patch = rotated
                    rotates_done += 1


                '''
–°–æ–∑–¥–∞—ë–º –º—è–≥–∫—É—é –º–∞—Å–∫—É, —á—Ç–æ–±—ã –∫—Ä–∞—è –æ—Å–∫–æ–ª–∫–∞ –±—ã–ª–∏ –ø–ª–∞–≤–Ω—ã–º–∏. –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —Ç–µ–º –º–µ–Ω—å—à–µ —Ä–∞–∑–º—ã—Ç–∏–µ.
                '''
                # —Å–æ–∑–¥–∞—ë–º –º—è–≥–∫—É—é –º–∞—Å–∫—É: –∑–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ / —ç–ª–ª–∏–ø—Å
                yy, xx = np.ogrid[:ph, :pw]
                cxr, cyr = pw / 2.0, ph / 2.0
                # —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Å–∫–∞
                mask = (((xx - cxr) ** 2) / (cxr ** 2 + 1e-6) + ((yy - cyr) ** 2) / (cyr ** 2 + 1e-6)) <= 1.0
                mask = mask.astype(np.float32)
                mk = max(3, int(3 + 5 * (1.0 - sp)))  # –º–µ–Ω—å—à–∏–π blur –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞
                if mk % 2 == 0: mk += 1
                mask = cv2.GaussianBlur((mask * 255).astype(np.uint8), (mk, mk), 0).astype(np.float32) / 255.0
                mask3 = np.repeat(mask[:, :, None], 3, axis=2)

                # –ª—ë–≥–∫–∏–π trailing: 1-2 —à–∞–≥–∞ –¥–µ—à—ë–≤–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è –æ—â—É—â–µ–Ω–∏—è motion
                '''
–î–µ–ª–∞–µ–º –ª—ë–≥–∫–∏–π ¬´trail¬ª, —á—Ç–æ–±—ã –æ—Å–∫–æ–ª–∫–∏ –æ—Å—Ç–∞–≤–ª—è–ª–∏ —Å–ª–µ–¥ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ ‚Äî —Ç–∏–ø–∞ motion blur –¥–µ—à–µ–≤—ã–π.
                '''
                trail_steps = 2
                total = np.zeros_like(dst_patch, dtype=np.float32)
                alpha_acc = 0.0
                for step in range(trail_steps + 1):
                    fac = 1.0 - (step / (trail_steps + 1))
                    talpha = fac * (0.55 + 0.45 * sp)
                    # —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –ø–∞—Ç—á–∞ (–Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ) ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∏–ª–ª—é–∑–∏—é —Ä–∞–∑–º—ã—Ç–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
                    sx = int(-dx * (step / (trail_steps + 1)) * 0.18)
                    sy = int(-dy * (step / (trail_steps + 1)) * 0.18)
                    rolled = np.roll(dst_patch, shift=(sy, sx), axis=(0, 1))
                    total += rolled.astype(np.float32) * talpha
                    alpha_acc += talpha
                if alpha_acc > 1e-6:
                    total = (total / alpha_acc).astype(np.uint8)
                else:
                    total = dst_patch

                # –∞–ª—å—Ñ–∞-–±–ª–µ–Ω–¥–∏–Ω–≥ –≤—Å—Ç–∞–≤–ª—è–µ–º–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –∫–∞–¥—Ä
                '''
–í—Å—Ç–∞–≤–ª—è–µ–º –æ—Å–∫–æ–ª–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞–¥—Ä —Å –ø–ª–∞–≤–Ω—ã–º–∏ –∫—Ä–∞—è–º–∏ —á–µ—Ä–µ–∑ –º–∞—Å–∫—É.
                '''
                dst_roi = out[new_i:new_i + ph, new_j:new_j + pw].astype(np.float32)
                src_f = total.astype(np.float32)
                blended = (src_f * mask3 + dst_roi * (1.0 - mask3)).astype(np.uint8)
                out[new_i:new_i + ph, new_j:new_j + pw] = blended

                # —Ç–æ–Ω–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤–µ—Ä—Ö—É —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –¥–ª—è –æ—â—É—â–µ–Ω–∏—è ¬´—Ä–∞–∑—Ä–µ–∑–∞¬ª
                '''
–î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–Ω–∫—É—é —Å–≤–µ—Ç—è—â—É—é—Å—è –ª–∏–Ω–∏—é —Å–≤–µ—Ä—Ö—É –æ—Å–∫–æ–ª–∫–∞, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ —Ä–µ–∑–∞–Ω–æ–µ —Å—Ç–µ–∫–ª–æ.
                '''
                if pw > 6 and ph > 6:
                    alpha_line = 0.12 + 0.4 * sp
                    line_col = (230, 225, 255)
                    cv2.line(out, (new_j, new_i), (new_j + pw - 1, new_i), line_col, max(1, int(1 + sp * 2)), lineType=cv2.LINE_AA)

        # —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ª—ë–≥–∫–∏–π bloom –∏ –≤–∏–Ω—å–µ—Ç–∫–∞ –¥–ª—è –≥–ª—É–±–∏–Ω—ã
        # bloom: –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ –∫–æ–ø–∏–∏ –∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ
        '''
–õ—ë–≥–∫–∏–π bloom: —Ä–∞–∑–º–∞–∑—ã–≤–∞–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –≤–µ—Ä—Å–∏—é –∫–∞–¥—Ä–∞,
–ø–æ—Ç–æ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –∏ —Å–º–µ—à–∏–≤–∞–µ–º ‚Äî –∫—Ä–∞—Å–∏–≤–æ –±–ª–µ—Å—Ç–∏—Ç.
        '''
        small = cv2.resize(out, (max(1, w // 4), max(1, h // 4)), interpolation=cv2.INTER_LINEAR)
        small = cv2.GaussianBlur(small, (5, 5), 0)
        bloom = cv2.resize(small, (w, h), interpolation=cv2.INTER_LINEAR)
        out = cv2.addWeighted(out, 1.0, bloom, 0.12 * p, 0)

        # —Ü–≤–µ—Ç–æ–∫–æ—Ä: —á—É—Ç—å —Ç–µ–ø–ª–µ–µ –∏ –ª—ë–≥–∫–∏–π S-curve
        '''
–¶–≤–µ—Ç–æ–∫–æ—Ä: —á—É—Ç—å —Ç–µ–ø–ª–µ–µ, –ª—ë–≥–∫–∏–π S-curve —á–µ—Ä–µ–∑ LUT, –∫—Ä–∞—Å–∏–º –∫—Ä–∞—Å–Ω—ã–π —á—É—Ç—å —è—Ä—á–µ, —Å–∏–Ω–∏–π ‚Äî —á—É—Ç—å —Ç—É—Å–∫–ª–µ–µ.
        '''
        lut = np.arange(256, dtype=np.uint8)
        gamma = 1.0 - 0.06 * p
        lut = np.clip(255.0 * ((lut / 255.0) ** gamma), 0, 255).astype(np.uint8)
        for c in range(3):
            out[:, :, c] = cv2.LUT(out[:, :, c], lut)
        warm = int(6 * p)
        out[:, :, 2] = np.clip(out[:, :, 2].astype(int) + warm, 0, 255).astype(np.uint8)
        out[:, :, 0] = np.clip(out[:, :, 0].astype(int) - int(warm * 0.25), 0, 255).astype(np.uint8)

        # –º—è–≥–∫–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞, —É—Å–∏–ª–∏–≤–∞–µ–º –µ—ë –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        '''
–î–µ–ª–∞–µ–º –≤–∏–Ω—å–µ—Ç–∫—É: –∫—Ä–∞—è —á—É—Ç—å —Ç–µ–º–Ω–µ–µ, —Ü–µ–Ω—Ç—Ä —è—Ä—á–µ, –∏ —ç—Ñ—Ñ–µ–∫—Ç —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
        '''
        vx = cv2.getGaussianKernel(w, w * 0.9)
        vy = cv2.getGaussianKernel(h, h * 0.9)
        vign = (vy @ vx.T)
        vign = (vign - vign.min()) / (vign.max() - vign.min() + 1e-9)
        vign_strength = 0.22 * p
        for c in range(3):
            out[:, :, c] = (out[:, :, c].astype(np.float32) * (1.0 - vign_strength * (1.0 - vign))).astype(np.uint8)

        return out

    def color_wave_glitch2(self, frame, t, duration):

        # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ self)
        '''
¬´–ó–¥–µ—Å—å –º—ã –∑–∞–¥–∞—ë–º –≤—Å—é —Ö–∏–º–∏—é: —Å–∫–æ–ª—å–∫–æ –∫—Ä—É—Ç–∏–º –æ—Ç—Ç–µ–Ω–∫–∏,
–∫–∞–∫ –≤–æ–ª–Ω–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è, —Ä–∞–∑–º–µ—Ä –ø–æ–ª–æ—Å, —Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ —Ä–≤—ë–º,
–Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–¥–≤–∏–≥–∞–µ–º —Ü–≤–µ—Ç–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —à—É–º—ã.
–ö–æ—Ä–æ—á–µ, –≤—Å—ë –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ñ–∏–≥–µ–Ω–Ω–æ –¥–µ—Ä–≥–∞–ª–∞—Å—å.¬ª
        '''
        hue_amp_max = 60
        hue_freq = 1.2
        wave_amp_max = 18
        wave_freq = 0.8
        wave_len = 120.0
        slice_w = 28
        slice_shift_max = 28
        n_blocks = 4
        block_shift_max = 40
        channel_shift_max = 14
        jitter_max = 12
        scanline_strength = 0.12
        noise_amount = 0.035
        noise_intensity = 48


        '''
¬´–ë–µ—Ä—ë–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏,
–ø–æ—Ç–æ–º –∑–∞–≤–æ–¥–∏–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –≤—Ä–µ–º–µ–Ω–∏,
—á—Ç–æ–±—ã –≥–ª–∏—Ç—á –±—ã–ª –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –Ω–æ –º–µ–Ω—è—Ç—å—Å—è —Å —Ç–µ—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏.¬ª
        '''
        progress = float(t) / max(float(duration), 1e-6)
        progress = max(0.0, min(1.0, progress))

        h, w = frame.shape[:2]
        rng = np.random.RandomState(int(t * 1000) ^ 0x9e3779b9)

        # Hue & saturation (—Ä–∞–±–æ—Ç–∞–µ–º –≤ int16/float —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è—Ç—å uint8)
        '''
¬´–ó–¥–µ—Å—å –º—ã –∫—Ä—É—Ç–Ω–µ–º —Ü–≤–µ—Ç–∞.
–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ HSV, —á—Ç–æ–±—ã –ª–µ–≥—á–µ –±—ã–ª–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—Ç—Ç–µ–Ω–∫–æ–º –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å—é.
–ü–æ—Ç–æ–º —Å—á–∏—Ç–∞–µ–º, –∫–∞–∫ —Å–∏–ª—å–Ω–æ —Å–º–µ—â–∞—Ç—å Hue –ø–æ —Å–∏–Ω—É—Å–æ–∏–¥–µ,
–¥–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä—å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏,
–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ BGR.
–í –∏—Ç–æ–≥–µ –±–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å —Ü–≤–µ—Ç–æ–≤—ã–º —Å–¥–≤–∏–≥–æ–º –≥–æ—Ç–æ–≤–∞.¬ª
        '''
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV).astype(np.int16)
        hue_shift = int(round(hue_amp_max * progress * math.sin(2 * math.pi * hue_freq * t)))
        hsv[..., 0] = (hsv[..., 0] + hue_shift) % 180
        sat_var = 1.0 + 0.35 * math.sin(t * 3.0 + progress * 6.0)
        hsv[..., 1] = np.clip(hsv[..., 1].astype(np.float32) * sat_var, 0, 255).astype(np.int16)
        hsv = np.clip(hsv, 0, 255).astype(np.uint8)
        base = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR)      # uint8

        # remap: —Å–æ–∑–¥–∞—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã –≤ float32
        '''
¬´–°–æ–∑–¥–∞—ë–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –≤–æ–ª–Ω—ã –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ –≥–æ–Ω—è—Ç—å.
–ê–º–ø–ª–∏—Ç—É–¥–∞ –≤–æ–ª–Ω—ã —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞ ‚Äî –ø–æ–ª–æ–≤–∏–Ω–∞ –æ–±—â–µ–π, –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã.¬ª
        '''
        xx, yy = np.meshgrid(np.arange(w, dtype=np.float32), np.arange(h, dtype=np.float32))
        wave_amp = wave_amp_max * (0.25 + 0.75 * progress)
        horiz_amp = 0.5 * wave_amp

        '''
¬´–°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∏–∫—Å–µ–ª–µ–π —Å —É—á—ë—Ç–æ–º –≤–æ–ª–Ω.
yy –∏–¥—ë—Ç –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑, xx ‚Äî —Å–ª–µ–≤–∞-–Ω–∞–ø—Ä–∞–≤–æ.
–°–∏–Ω—É—Å—ã –∏ –∫–æ—Å–∏–Ω—É—Å—ã –¥–µ–ª–∞—é—Ç —ç—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫—É –∫–∞–∫ –±—É–¥—Ç–æ –¥—ã—à–∞—â–µ–π.¬ª
        '''
        map_y = yy + wave_amp * np.sin(2 * math.pi * ((xx / max(1.0, wave_len)) - wave_freq * t))
        map_x = xx + horiz_amp * np.cos(2 * math.pi * ((yy / max(1.0, wave_len * 0.6)) + wave_freq * t * 0.7))

        # jitter (–º–∞–ª–µ–Ω—å–∫–∞—è –æ–¥–Ω–æ—Ç–∏–ø–Ω–∞—è –¥–æ–±–∞–≤–∫–∞) ‚Äî –¥–µ–ª–∞–µ–º –∫–∞–∫ float32
        '''
¬´–î–æ–±–∞–≤–ª—è–µ–º –º–µ–ª–∫–∏–π –¥–µ—Ä–≥–∞–Ω—á–∏–∫, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∏–¥–µ–∞–ª—å–Ω–æ —Ä–æ–≤–Ω–æ.
Jitter ‚Äî —Ç–∏–ø–∞ –ª–µ–≥–∫–∞—è –¥—Ä–æ–∂—å, –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –µ–≥–æ —Å–∏–ª—É.¬ª
        '''
        jitter_x = (rng.rand() - 0.5) * 2.0 * (jitter_max * (0.06 + 0.94 * progress))
        map_x = (map_x + float(jitter_x)).astype(np.float32, copy=False)
        map_y = map_y.astype(np.float32, copy=False)

        # remap —Ü–µ–ª–∏–∫–æ–º (–±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ "warped")
        '''
¬´–ü–µ—Ä–µ–º–∞–ø–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ —ç—Ç–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º ‚Äî –±–∞–∑–æ–≤—ã–π –≤–æ–ª–Ω–æ–≤–æ–π –≥–ª–∏—Ç—á –≥–æ—Ç–æ–≤.
–ö–æ–ø–∏—Ä—É–µ–º –≤ out, –¥–∞–ª—å—à–µ –±—É–¥–µ–º –¥–æ–ø–∏–ª–∏–≤–∞—Ç—å.¬ª
        '''
        warped = cv2.remap(base, map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        out = warped.copy()

        # slice-–≥–ª–∏—Ç—á (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã —Å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º —Å–¥–≤–∏–≥–æ–º)
        '''
¬´–î–µ–ª–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏, —Å–¥–≤–∏–≥–∞–µ–º –∏—Ö –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑.
–ü–æ–ª–æ—Å—ã –¥–µ—Ä–≥–∞—é—Ç—Å—è –ø–æ —Å–∏–Ω—É—Å–æ–∏–¥–µ, —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –≥–ª–∏—Ç—á —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ.¬ª
        '''
        for x in range(0, w, slice_w):
            xs = min(w, x + slice_w)
            phase = t * 3.0 + x * 0.04
            shift = int(round(slice_shift_max * (0.2 + 0.8 * progress) * math.sin(phase)))
            if shift != 0:
                out[:, x:xs] = np.roll(out[:, x:xs], shift, axis=0)

        # –±–ª–æ—á–Ω—ã–µ —Ä–∞–∑—Ä—ã–≤—ã
        '''
¬´–†–µ–∂–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–µ –±–ª–æ–∫–∏ –∏ –¥–µ—Ä–≥–∞–µ–º –∏—Ö –ø–æ x/y.
–ö–æ—Ä–æ—á–µ, —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑—Ä—ã–≤–∞, –∫–∞–∫ –±—É–¥—Ç–æ –∫—Ç–æ-—Ç–æ –ø–æ —ç–∫—Ä–∞–Ω—É —É–¥–∞—Ä–∏–ª,
—á–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–¥–≤–∏–≥–∏.¬ª
        '''
        blocks = max(1, int(n_blocks * (0.6 + 0.8 * progress)))
        for i in range(blocks):
            bw = int(rng.randint(w // 8, max(16, w // 3)))
            bh = int(rng.randint(h // 10, max(12, h // 4)))
            bx = int(rng.randint(0, max(1, w - bw)))
            by = int(rng.randint(0, max(1, h - bh)))
            dx = int(round((rng.randint(-block_shift_max, block_shift_max)) * (0.3 + 0.7 * progress)))
            dy = int(round((rng.randint(-block_shift_max, block_shift_max)) * (0.3 + 0.7 * progress)))
            patch = np.copy(out[by:by + bh, bx:bx + bw])
            if dx != 0 or dy != 0:
                patch = np.roll(patch, dy, axis=0)
                patch = np.roll(patch, dx, axis=1)
            out[by:by + bh, bx:bx + bw] = patch

        # –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—Å–ª–æ–µ–Ω–∏–µ ‚Äî —Å–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—ã –¥–ª—è B –∏ R –∏ —è–≤–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –ø—Ä–∏–≤–æ–¥–∏–º –∫ float32
        '''
¬´–•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—Å–ª–æ–µ–Ω–∏–µ: —Å–º–µ—â–∞–µ–º —Å–∏–Ω–∏–π –∏ –∫—Ä–∞—Å–Ω—ã–π –∫–∞–Ω–∞–ª—ã –ø–æ x/y,
–∑–µ–ª—ë–Ω—ã–π –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å. –≠—Ç–æ –¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç —Å—Ç–∞—Ä–æ–≥–æ VHS –∏ –∏—Å–∫–∞–∂–µ–Ω–∏–π —Ü–≤–µ—Ç–æ–≤.¬ª
        '''
        ch_dx = channel_shift_max * (0.2 + 0.8 * progress) * math.sin(t * 2.9)
        # —Å–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã (–≤ float32) ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
        map_x_f = map_x.astype(np.float32, copy=False)
        map_y_f = map_y.astype(np.float32, copy=False)
        map_x_b = (map_x_f + 0.5 * float(ch_dx) * np.sin(t * 2.1 + yy / max(1.0, h) * 6.0)).astype(np.float32, copy=False)
        map_x_r = (map_x_f - 0.5 * float(ch_dx) * np.sin(t * 2.4 + yy / max(1.0, h) * 5.0)).astype(np.float32, copy=False)
        map_y_b = (map_y_f + 0.4 * float(ch_dx) * np.cos(t * 1.7 + xx / max(1.0, w) * 7.0)).astype(np.float32, copy=False)
        map_y_r = (map_y_f - 0.4 * float(ch_dx) * np.cos(t * 1.3 + xx / max(1.0, w) * 6.0)).astype(np.float32, copy=False)

        # remap –∫–∞–Ω–∞–ª–æ–≤ (SOURCE –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å uint8 –∏–ª–∏ float32 ‚Äî —É –Ω–∞—Å uint8)
        '''
¬´–ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ç–∏ —Å–º–µ—â–µ–Ω–∏—è –∏ —Å–æ–±–∏—Ä–∞–µ–º –∫–∞–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É.
–ì–æ—Ç–æ–≤–æ, —Ü–≤–µ—Ç–∞ –¥–µ—Ä–≥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.¬ª
        '''
        b = cv2.remap(out[..., 0], map_x_b, map_y_b, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        g = cv2.remap(out[..., 1], map_x_f, map_y_f, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        r = cv2.remap(out[..., 2], map_x_r, map_y_r, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        out = cv2.merge([b, g, r])

        # —Å–∫–∞–Ω–ª–∞–π–Ω—ã
        '''
¬´–°–∫–∞–Ω–ª–∞–π–Ω—ã: –¥–µ–ª–∞–µ–º –ø–æ–ª–æ—Å–∫–∏ —Ç–µ–º–Ω–µ–µ —á–µ—Ä–µ–∑ –∫–∞–∂–¥—ã–π —Ä—è–¥ –ø–∏–∫—Å–µ–ª–µ–π, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—Ç–∞—Ä—ã–π —ç–∫—Ä–∞–Ω.¬ª
        '''
        if scanline_strength > 0:
            mask = np.ones((h, 1), dtype=np.float32)
            mask[::2, 0] = 1.0 - scanline_strength
            out = (out.astype(np.float32) * mask[:, :, None]).astype(np.uint8)

        # —à—É–º
        '''
¬´–î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —à—É–º: –∫–æ–µ-–≥–¥–µ –ø–∏–∫—Å–µ–ª–∏ –¥–µ—Ä–≥–∞—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
–ö—Ä–∞—Å–∏–≤–æ —Ä–µ–∂–µ—Ç –≥–ª–∞–∑, –∫–∞–∫ –Ω–∞ VHS.¬ª
        '''
        if noise_amount > 0:
            noise_mask = (rng.rand(h, w) < noise_amount)
            if noise_mask.any():
                noise_vals = rng.randint(-noise_intensity, noise_intensity + 1, size=(h, w, 1)).astype(np.int16)
                tmp = out.astype(np.int16)
                tmp += (noise_mask[:, :, None].astype(np.int16) * noise_vals)
                out = np.clip(tmp, 0, 255).astype(np.uint8)

        # –Ω–µ–±–æ–ª—å—à–æ–π temporal jitter
        '''
¬´–ù–µ–º–Ω–æ–≥–æ temporal jitter: –¥–µ—Ä–≥–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Ü–µ–ª–∏–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–º–∏ —à–∞–∂–∫–∞–º–∏. –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–∏–ª–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç.¬ª
        '''
        if rng.rand() < 0.18 * (0.3 + 0.7 * progress):
            tx = int(round((rng.randint(-6, 7)) * progress * 0.9))
            ty = int(round((rng.randint(-6, 7)) * progress * 0.9))
            if tx != 0 or ty != 0:
                out = np.roll(out, ty, axis=0)
                out = np.roll(out, tx, axis=1)

        return out

    def liquid_melt2(self, frame, t, duration):
        # –ª—ë–≥–∫–∏–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π RNG –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–∞–ø–µ–ª—å
        import numpy.random as npr

        h, w = frame.shape[:2]
        progress = float(np.clip(t / float(max(duration, 1e-6)), 0.0, 1.0))
        '''
–ï—Å–ª–∏ –µ—â—ë —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—Ç, —Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–∞–¥—Ä, –Ω–µ –¥–µ—Ä–≥–∞–µ–º –µ–≥–æ.
        '''
        if progress <= 1e-6:
            return frame

        # –∫–æ–ø–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º, –±—É–¥–µ–º –±–ª–µ–Ω–¥–∏—Ç—å –ø–æ–≤–µ—Ä—Ö)
        base = frame.astype(np.uint8)
        # overlay —Ü–≤–µ—Ç–æ–≤ –∏ –º–∞—Å–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ (float32 –¥–ª—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–≥–æ —Å–º–µ—à–∏–≤–∞–Ω–∏—è)
        '''
overlay ‚Äî —ç—Ç–æ —Å–∞–º–∏ –∫–∞–ø–ª–∏,
–∞ mask ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å,
—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–º–µ—à–∏–≤–∞—Ç—å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º.
        '''
        overlay = np.zeros_like(base, dtype=np.uint8)
        mask = np.zeros((h, w), dtype=np.float32)

        # –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–µ–ª—å (–æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞)
        seed = 424242
        rng = npr.RandomState(seed)

        # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–∞–ø–µ–ª—å (–Ω–µ –≤—Å–µ –ø–æ—è–≤—è—Ç—Å—è —Å—Ä–∞–∑—É)
        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –∫–∞–ø–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å. –°–Ω–∞—á–∞–ª–∞ –º–∞–ª–æ, –ø–æ—Ç–æ–º —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∏—Ö –±–æ–ª—å—à–µ, –º–∞–∫—Å–∏–º—É–º 12.
        '''
        max_drops = min(12, 2 + int(8 * progress))

        '''
–ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞–ø–ª–∏ –æ–¥–Ω—É –∑–∞ –¥—Ä—É–≥–æ–π.
        '''
        for i in range(max_drops):
            # –∑–∞—Ä–∞–Ω–µ–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–ø–ª–∏ (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ)
            '''
–í–æ—Ç —Ç—É—Ç –º—ã –≥–µ–Ω–µ—Ä–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–ø–ª–∏:

start ‚Äî –∫–æ–≥–¥–∞ –∫–∞–ø–ª—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è;

life_span ‚Äî —Å–∫–æ–ª—å–∫–æ –∂–∏–≤—ë—Ç;

x –∏ init_y ‚Äî —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è;

speed_px ‚Äî –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–∞–¥–∞–µ—Ç;

width ‚Äî —à–∏—Ä–∏–Ω–∞ –∫–∞–ø–ª–∏;

color_jitter ‚Äî —á—É—Ç—å-—á—É—Ç—å —à—É—Ç–∏–º —Å —Ü–≤–µ—Ç–æ–º, —á—Ç–æ–±—ã –∫–∞–ø–ª–∏ –Ω–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ.
            '''
            start = float(rng.uniform(-0.6 * duration, duration * 1.1))
            life_span = float(rng.uniform(0.6, 2.6))  # –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∂–∏–∑–Ω–∏ –∫–∞–ø–ª–∏ –≤ —Å–µ–∫
            x = int(rng.randint(int(0.05 * w), int(0.95 * w)))
            init_y = float(rng.uniform(0.0, max(1.0, 0.25 * h)))
            speed_px = float(rng.uniform(0.06 * h, 0.22 * h))
            width = int(1 + rng.randint(0, 2) + (1 if w > 1200 else 0))
            color_jitter = np.array([rng.uniform(0.85, 1.12), rng.uniform(0.85, 1.12), rng.uniform(0.85, 1.12)])

            '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –∫–∞–ø–ª—è –∂–∏–≤—ë—Ç. –ï—Å–ª–∏ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ –≤—Ä–µ–º—è, –∏–ª–∏ –æ–Ω–∞ —É–∂–µ —É–º–µ—Ä–ª–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.
            '''
            life = t - start
            if life <= 0.0 or life > life_span:
                continue  # –∫–∞–ø–ª—è –µ—â—ë –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å –∏–ª–∏ —É–∂–µ —É—à–ª–∞

            # –ø–æ–∑–∏—Ü–∏—è –∫–∞–ø–ª–∏ (–ø–∞–¥–∞–µ—Ç –≤–Ω–∏–∑)
            '''
–î–≤–∏–≥–∞–µ–º –∫–∞–ø–ª—é –≤–Ω–∏–∑ –ø–æ —ç–∫—Ä–∞–Ω—É. –ï—Å–ª–∏ –¥–æ—à–ª–∞ –¥–æ –¥–Ω–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –Ω–∞ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ.
            '''
            y_pos = init_y + speed_px * life
            if y_pos >= h - 1:
                y_pos = h - 1.0

            # —Ö–≤–æ—Å—Ç –∫–∞–ø–ª–∏ ‚Äî –¥–ª–∏–Ω–∞ —Ä–∞—Å—Ç—ë—Ç –ø–æ –∂–∏–∑–Ω–∏
            '''
–î–µ–ª–∞–µ–º —Ö–≤–æ—Å—Ç –∫–∞–ø–ª–∏, –æ–Ω —Ä–∞—Å—Ç—ë—Ç —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º. y0 ‚Äî –≤–µ—Ä—Ö–Ω—è—è —Ç–æ—á–∫–∞ —Ö–≤–æ—Å—Ç–∞, y1 ‚Äî –Ω–∏–∂–Ω—è—è.
            '''
            tail_len = int(max(2, min(h * 0.22, 2 + speed_px * 0.03 * (0.6 + 0.9 * (life / life_span)))))
            y0 = int(max(0, y_pos - tail_len))
            y1 = int(min(h - 1, y_pos))

            # –±–µ—Ä—ë–º —Ü–≤–µ—Ç –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ —Ö–≤–æ—Å—Ç–∞, —á—Ç–æ–±—ã –∫–∞–ø–ª—è "–æ—Ç—Ä—ã–≤–∞–ª–∞—Å—å" –æ—Ç –∫–∞–¥—Ä–∞
            '''
–ë–µ—Ä—ë–º —Ü–≤–µ—Ç –∫–∞–¥—Ä–∞ —Ç–∞–º, –≥–¥–µ –∫–∞–ø–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –æ—Ä–≥–∞–Ω–∏—á–Ω–æ.
–ü–æ–¥–º–µ—à–∏–≤–∞–µ–º —á—É—Ç—å —à—É–º —Å color_jitter.
            '''
            sample_y = int(max(0, min(h - 1, y0 + int(tail_len * 0.15))))
            sample_x = int(max(0, min(w - 1, x)))
            base_col = frame[sample_y, sample_x].astype(np.float32) / 255.0
            col = np.clip(base_col * color_jitter, 0.0, 1.0)
            color_bgr = (int(255 * col[0]), int(255 * col[1]), int(255 * col[2]))  # BGR tuple ints

            # –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫–∞–ø–ª–∏: –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –ø–∏–∫–∞, –∑–∞—Ç–µ–º —á—É—Ç—å –≥–∞—Å–Ω–µ—Ç
            '''
–°—á–∏—Ç–∞–µ–º –∞–ª—å—Ñ—É (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å) –∫–∞–ø–ª–∏ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –ø–æ—Ç–æ–º –≥–∞—Å–Ω–µ—Ç, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–µ–∑–∫–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è.
            '''
            life_norm = float(life / life_span)
            alpha_drop = float(np.clip(0.28 + 0.9 * (1.0 - abs(0.5 - life_norm) * 2.0), 0.10, 1.0) * progress)

            # —Ä–∏—Å—É–µ–º —Ö–≤–æ—Å—Ç: –æ—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è (—Ü–≤–µ—Ç), –∏ –º–∞—Å–∫—É —Å –ø–ª–∞–≤–Ω—ã–º alpha
            '''
–†–∏—Å—É–µ–º —Å–∞–º—É –∫–∞–ø–ª—é –≤ –≤–∏–¥–µ –ª–∏–Ω–∏–∏ –Ω–∞ overlay.
            '''
            cv2.line(overlay, (x, y0), (x, y1), color_bgr, thickness=width, lineType=cv2.LINE_AA)
            # —Ä–∏—Å—É–µ–º –±–ª–∏–∫ –Ω–∞ –∫–æ–Ω—Ü–µ
            tip_r = max(1, int(1 + 2 * progress))
            cv2.circle(overlay, (x, y1), tip_r, (255, 255, 255), -1, lineType=cv2.LINE_AA)

            # –Ω–∞ –º–∞—Å–∫—É —Ä–∏—Å—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ alpha (float32), –º–æ–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Äî —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è
            # –∏—Å–ø–æ–ª—å–∑—É–µ–º cv2.line –Ω–∞ –æ–¥–Ω–æ–∫–∞–Ω–∞–ª—å–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ float32
            '''
–†–∏—Å—É–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–∞ –º–∞—Å–∫–µ, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–º–µ—à–∏–≤–∞—Ç—å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º.
            '''
            alpha_val = float(alpha_drop)  # 0..1
            # —Ä–∏—Å—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å —Ö–≤–æ—Å—Ç–∞ —Å alpha
            cv2.line(mask, (x, y0), (x, y1), float(alpha_val), thickness=width + 1, lineType=cv2.LINE_AA)
            # –¥–æ–±–∞–≤–∏–º –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–π alpha –≤ –∫–æ–Ω—Ü–µ (–±–ª–∏–∫)
            cv2.circle(mask, (x, y1), int(tip_r * 1.2), float(alpha_val * 1.1), -1, lineType=cv2.LINE_AA)

            # –Ω–µ–±–æ–ª—å—à–æ–π –≤–µ—Ä—Ö–Ω–∏–π "–±–ª–∏–∫" —á—É—Ç—å –≤—ã—à–µ —Ö–≤–æ—Å—Ç–∞
            '''
–î–æ–±–∞–≤–ª—è–µ–º –µ—â—ë –æ–¥–∏–Ω –º–∏–Ω–∏-–±–ª–∏–∫ —á—É—Ç—å –≤—ã—à–µ —Ö–≤–æ—Å—Ç–∞ –¥–ª—è –±–ª–µ—Å–∫–∞, —á—Ç–æ–±—ã –∫–∞–ø–ª—è –≤—ã–≥–ª—è–¥–µ–ª–∞ –∂–∏–≤–æ–π.
            '''
            blink_y = int(max(0, y1 - max(1, int(tail_len * 0.18))))
            if 0 <= blink_y < h:
                cv2.circle(overlay, (x, blink_y), max(1, int(tip_r / 2)), color_bgr, -1, lineType=cv2.LINE_AA)
                cv2.circle(mask, (x, blink_y), max(1, int(tip_r / 2)), float(alpha_val * 0.6), -1, lineType=cv2.LINE_AA)

        # –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞—Å–∫—É (0..1)
        '''
–£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∞–ª—å—Ñ–∞ –Ω–µ –±–æ–ª—å—à–µ 1 –∏ –Ω–µ –º–µ–Ω—å—à–µ 0.
        '''
        np.clip(mask, 0.0, 1.0, out=mask)

        # —Å–º–µ—à–∏–≤–∞–Ω–∏–µ: out = base * (1 - mask) + overlay * mask
        # –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º mask –≤ —Ç—Ä—ë—Ö–∫–∞–Ω–∞–ª—å–Ω—ã–π
        '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª —Å –∫–∞–ø–ª—è–º–∏ –ø–æ –º–∞—Å–∫–µ. –í—Å—ë –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, —á—Ç–æ–±—ã —Ü–≤–µ—Ç–∞ –Ω–µ —Å–ª–µ—Ç–µ–ª–∏.
        '''
        mask3 = mask[:, :, None]
        out = (base.astype(np.float32) * (1.0 - mask3) + overlay.astype(np.float32) * mask3)
        out = np.clip(out, 0, 255).astype(np.uint8)

        return out


    def neon_glitch(self, frame, t, duration):
        h, w = frame.shape[:2]
        '''
–ó–¥–µ—Å—å –º—ã –º—É—Ç–∏–º —Å–∏–ª—É –≥–ª—é–∫–∞.
–ù–∞—á–∏–Ω–∞–µ–º —Å 20 –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º –µ—â—ë –æ—Ç 0 –¥–æ 40
–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (t / duration).
–¢–æ –µ—Å—Ç—å —á–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–¥—ë–º, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–Ω–æ—Å–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É.
        '''
        glitch_strength = int(20 + 40 * (t / duration))
        new_frame = frame.copy()
        '''
–¶–∏–∫–ª. –ë—É–¥–µ–º –∏–¥—Ç–∏ –ø–æ –≤—Å–µ–π –≤—ã—Å–æ—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏, –Ω–æ –Ω–µ –ø–æ –æ–¥–Ω–æ–º—É —Ä—è–¥—É, –∞ –ø—Ä—ã–∂–∫–∞–º–∏.
–®–∞–≥ –ø—Ä—ã–∂–∫–∞ ‚Äî —Ä–∞–∑–º–µ—Ä glitch_strength.
–ö–æ—Ä–æ—á–µ, –º—ã –±–µ—Ä—ë–º –ø–æ–ª–æ—Å—ã —á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ.
        '''
        for i in range(0, h, glitch_strength):
            '''
–î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å—ã —Ä–µ—à–∞–µ–º –Ω–∞ —Å–∫–æ–ª—å–∫–æ –µ—ë —Å–¥–≤–∏–Ω—É—Ç—å –≤–ª–µ–≤–æ –∏–ª–∏ –≤–ø—Ä–∞–≤–æ.
–ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç -20 –¥–æ +20 –ø–∏–∫—Å–µ–ª–µ–π.
            '''
            shift = random.randint(-20, 20)
            '''
–í–æ—Ç —Ç—É—Ç –≤—Å—è –º–∞–≥–∏—è:
–ë–µ—Ä—ë–º –º–∞–ª–µ–Ω—å–∫—É—é –ø–æ–ª–æ—Å–∫—É –≤—ã—Å–æ—Ç–æ–π 5 –ø–∏–∫—Å–µ–ª–µ–π (–æ—Ç i –¥–æ i+5)
–∏ —Å–¥–≤–∏–≥–∞–µ–º –µ—ë –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
np.roll ‚Äî —ç—Ç–æ –∫–∞–∫ –≤–∑—è—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É,
–æ—Ç—Ä–µ–∑–∞—Ç—å –∫—É—Å–æ–∫ –∏ –∑–∞–∫–∏–Ω—É—Ç—å –µ–≥–æ –≤ –∫–æ–Ω–µ—Ü, –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Å–¥–≤–∏–≥ –±–µ–∑ –¥—ã—Ä–æ–∫.
axis=1 ‚Äî –∑–Ω–∞—á–∏—Ç –¥–≤–∏–≥–∞–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ (–≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ).
            '''
            new_frame[i:i+5, :] = np.roll(new_frame[i:i+5, :], shift, axis=1)
            '''
–ö–æ–º–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ü–∞–Ω–æ–≤ ‚Äî –¥–∞–ª—å—à–µ –º—ã –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å —Ç–∞–∫,
—á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞—Å–∏—è–ª–∞ –∫–∞–∫ –Ω–µ–æ–Ω–æ–≤—ã–µ –≤—ã–≤–µ—Å–∫–∏ –≤ –ø–æ–¥–≤–∞–ª–µ —É –±–∞—Ä—ã–≥.
            '''
        # –¥–æ–±–∞–≤–∏–º –Ω–µ–æ–Ω –ø–æ–¥—Å–≤–µ—Ç–∫—É
        '''
–ë–µ—Ä—ë–º –ø–æ–ª—É—á–∏–≤—à–∏–π—Å—è –≥–ª—é—á–Ω—ã–π –∫–∞–¥—Ä –∏ –ø—Ä–æ–≥–æ–Ω—è–µ–º —á–µ—Ä–µ–∑ —Ü–≤–µ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É COLORMAP_HOT.
–≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É —è—Ä–∫–æ–π, –∫–∏—Å–ª–æ—Ç–Ω–æ–π, —Å –æ—Ä–∞–Ω–∂–µ–≤–æ-–∫—Ä–∞—Å–Ω—ã–º–∏ –Ω–µ–æ–Ω–æ–≤—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏.
–¢–∏–ø–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—Ç —É–ª—å—Ç—Ä–∞—Ñ–∏–æ–ª–µ—Ç–∞.
        '''
        glow = cv2.applyColorMap(new_frame, cv2.COLORMAP_HOT)
        '''
–§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–º–µ—Å:
–ë–µ—Ä—ë–º –¥–≤–∞ –∫–∞–¥—Ä–∞ ‚Äî –≥–ª—é—á–Ω—ã–π (new_frame) –∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–π (glow).
–°–º–µ—à–∏–≤–∞–µ–º –∏—Ö: 70% –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ + 30% –Ω–µ–æ–Ω–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏.
–ü–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–ª—å ‚Äî —ç—Ç–æ —Å–¥–≤–∏–≥ —è—Ä–∫–æ—Å—Ç–∏ (–Ω–∞–º —Ç—É—Ç –Ω–µ –Ω—É–∂–µ–Ω).
–í –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞–µ–º –≥–ª—é–∫ —Å —è—Ä–∫–æ–π –∫–∏—Å–ª–æ—Ç–Ω–æ–π –∞—É—Ä–æ–π.
        '''
        return cv2.addWeighted(new_frame, 0.7, glow, 0.3, 0)

    # 2. Hologram flicker
    def hologram_flicker44(self, frame, t, duration,
                       n_stripes=12,
                       swap_interval=0.6,
                       glitch_duration=0.12,
                       glitch_prob=0.35,
                       max_shift_px=18,
                       tint_strength=0.28,
                       seam_blend=2,
                       neon_color=(0.1, 0.9, 1.0),
                       neon_strength=0.22,
                       neon_power=2.0,
                       neon_intensity=1.2,
                       glow_radius_px=18,
                       glow_downscale=0.28,
                       chroma_shift_px=4,
                       chroma_speed=6.0,
                       scanline_strength=0.03,
                       grain_strength=0.04,
                       stutter_chance_per_sec=0.8,
                       stutter_duration=0.08,
                       stutter_blend=0.12,
                       posterize_levels=32
                           ):
        '''
n_stripes=12,
swap_interval=0.6,
glitch_duration=0.12,
glitch_prob=0.35,
max_shift_px=18,
tint_strength=0.28,
seam_blend=2,
–≠—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–ª–æ—Å–æ–∫ –∏ –≥–ª–∏—Ç—á–µ–π.
–¢–∏–ø–∞ —Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ—Å, –∫–∞–∫ —á–∞—Å—Ç–æ –æ–Ω–∏ –±—É–¥—É—Ç –º–µ–Ω—è—Ç—å—Å—è,
—Å –∫–∞–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –±–∞–≥–Ω—É—Ç—Å—è –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –±—É–¥—É—Ç —Å–º–µ—â–∞—Ç—å—Å—è.
neon_color=(0.1, 0.9, 1.0),
neon_strength=0.22,
neon_power=2.0,
neon_intensity=1.2,
glow_radius_px=18,
glow_downscale=0.28,
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–æ–Ω–æ–≤–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è: —Ü–≤–µ—Ç, –º–æ—â–Ω–æ—Å—Ç—å,
—Å–∏–ª–∞ —Å–≤–µ—á–µ–Ω–∏—è, —Ä–∞–¥–∏—É—Å —Ä–∞–∑–º—ã—Ç–∏—è –∏ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞.
–ö–æ—Ä–æ—á–µ, —á—Ç–æ–± –∫–∞–∫ –≤ –∫–∏–±–µ—Ä–ø–∞–Ω–∫–µ.
chroma_shift_px=4,
chroma_speed=6.0,
scanline_strength=0.03,
grain_strength=0.04,
stutter_chance_per_sec=0.8,
stutter_duration=0.08,
stutter_blend=0.12,
posterize_levels=32
–¢—É—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —Ü–≤–µ—Ç–æ–≤–æ–π —Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤,
—Å–∏–ª–∞ —Å–∫–∞–Ω–ª–∞–π–Ω–æ–≤ –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä–æ–º —Ç–µ–ª–∏–∫–µ, –ø–ª—ë–Ω–∫–∞ —Å –∑–µ—Ä–Ω–æ–º,
–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∞–Ω–∏—è –∫–∞–¥—Ä–∞ (stutter),
–µ–≥–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ, –ø–ª—é—Å –ø–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤).
        '''
        # ----- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è -----
        h, w = frame.shape[:2]
        '''
–ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ –µ—â—ë –Ω–µ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö,
—Ç–æ —Å–æ–∑–¥–∞—ë–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
–¢–∏–ø–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–∞–¥—Ä,
–º–æ–º–µ–Ω—Ç –¥–æ –∫–∞–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –º—ã "–∑–∞–≤–∏—Å–∞–µ–º", –∏ –∫–∞–¥—Ä,
–∫–æ—Ç–æ—Ä—ã–π –Ω–∞–¥–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –∑–∞–≤–∏—Å–æ–Ω–∞.
        '''
        if not hasattr(self, '_hf44_prev_frame'):
            self._hf44_prev_frame = frame.copy()
            self._hf44_stutter_until = 0.0
            self._hf44_last_stutter_check = 0.0
            self._hf44_stutter_frame = frame.copy()

        '''
–©–∞ –¥–µ–ª–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ª–∞–≥–æ–≤:
—Ç–∏–ø–∞ –∑–∞–≤–∏—Å –∫–∞–¥—Ä –Ω–∞ –ø–∞—Ä—É –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥, –∫–∞–∫ –±—É–¥—Ç–æ –≤–∏–¥–µ–æ —Ç–æ—Ä–º–æ–∑–∏—Ç.
        '''
        # –†–µ—à–∞–µ–º, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–π freeze/stutter (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–Ω—Å –ø—Ä–∏–º–µ—Ä–Ω–æ –∫–∞–∂–¥—ã–π 1/swap_interval –¥–ª—è —Ä–∞–∑—É–º–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã
        '''
–ë–µ—Ä—ë–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è.
        '''
        now = t
        # –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º stutter
        '''
–¢—É—Ç —á—É–≤–∞–∫ —Ö–æ—Ç–µ–ª —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º,
–Ω–æ –ø–æ —Ñ–∞–∫—Ç—É ‚Äî —ç—Ç–æ —Ñ–∏–∫—Ç–∏–≤–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞. –ü—Ä–æ—Å—Ç–æ —á—Ç–æ–± –∫–æ–¥ –Ω–µ —É–ø–∞–ª.
        '''
        check_dt = max(0.01, 1.0 / max(1.0, 1.0))
        # –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ç–∞—Ä—Ç–∞ stutter
        '''
–ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ —á–µ–º 0.05 —Å–µ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
‚Äî –ø–æ—Ä–∞ —Å–Ω–æ–≤–∞ –∫–∏–¥–∞—Ç—å –∫—É–±–∏–∫, –±—É–¥–µ—Ç –ª–∏ –∑–∞–≤–∏—Å–æ–Ω.
        '''
        if now - self._hf44_last_stutter_check > 0.05:
            '''
–°—á–∏—Ç–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–æ–Ω–∞ –∑–∞ —ç—Ç–æ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫.
–ß–µ–º –¥–æ–ª—å—à–µ –ø—Ä–æ—à–ª–æ ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ —à–∞–Ω—Å.
            '''
            prob = 1.0 - math.exp(-stutter_chance_per_sec * (now - self._hf44_last_stutter_check))
            # –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∫–∞–∫ seed (–±–µ–∑ –ø–æ–±–æ—á–Ω—ã—Ö —Ç–∏–ø–æ–≤)
            '''
–ë–µ—Ä—ë–º –∏–Ω–¥–µ–∫—Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ —Å–∏–¥ –¥–ª—è —Ä–∞–Ω–¥–æ–º–∞.
–¢–∏–ø–∞, —á—Ç–æ–± –≥–ª—é–∫–∏ –±—ã–ª–∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –∞ –Ω–µ –∫–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ —Ä–∞–∑–Ω—ã–µ.
            '''
            interval_idx = int(math.floor(now / swap_interval)) if swap_interval > 1e-9 else 0
            seed = interval_idx & 0xffffffff
            rng_check = np.random.RandomState(seed=seed)
            '''
–ï—Å–ª–∏ –ø–æ–≤–µ–∑–ª–æ (—Ä–∞–Ω–¥–æ–º < –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å),
—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≤–∏—Å–æ–Ω: –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –∫–∞–¥—Ä –¥–æ now + stutter_duration.
            '''
            if rng_check.rand() < prob:
                self._hf44_stutter_until = now + stutter_duration
                self._hf44_stutter_frame = self._hf44_prev_frame.copy()
                '''
–û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.
                '''
            self._hf44_last_stutter_check = now

        '''
–ï—Å–ª–∏ –º—ã –µ—â—ë –≤ –∑–æ–Ω–µ –∑–∞–≤–∏—Å–æ–Ω–∞ ‚Äî —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ 1. –ò–Ω–∞—á–µ 0.
        '''
        if now < self._hf44_stutter_until:
            stutter_t = 1.0
        else:
            stutter_t = 0.0
            '''
–¢—É—Ç –¥–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω—ã–π –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥ –∏–∑ –∑–∞–≤–∏—Å–æ–Ω–∞. –¢–∏–ø–∞ –Ω–µ —Ä–µ–∑–∫–∏–π –æ–±—Ä—É–±, –∞ –º—è–≥–∫–æ.
            '''
        if stutter_blend > 1e-6:
            start = self._hf44_stutter_until - stutter_duration
            if start < now < start + stutter_blend:
                stutter_t = (start + stutter_blend - now) / stutter_blend
                stutter_t = np.clip(stutter_t, 0.0, 1.0)

        '''
–ï—Å–ª–∏ –∑–∞–≤–∏—Å–æ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π ‚Äî –±–µ—Ä—ë–º —Å—Ç–∞—Ä—ã–π –∫–∞–¥—Ä. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∫–∞–¥—Ä.
        '''
        if stutter_t > 0.5:
            base = self._hf44_stutter_frame.copy()
        else:
            base = frame.copy()
        '''
–û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–∞–¥—Ä, —á—Ç–æ–± –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –±—ã–ª–æ —á—Ç–æ –∑–∞–ª–∏–ø–∞—Ç—å.
        '''
        self._hf44_prev_frame = frame.copy()

        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ float –æ—Ç 0 –¥–æ 1, —á—Ç–æ–± –ª–µ–≥—á–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –º—É—Ç–∏—Ç—å.
        '''
        base_f = base.astype(np.float32) / 255.0

        '''
–¥–∞–ª—å—à–µ –∏–¥—ë—Ç "—Ü–≤–µ—Ç–æ–≤–æ–π –∞–±–µ—Ä—Ä–∞—Ü–∏–∏" —ç—Ñ—Ñ–µ–∫—Ç ‚Äî —Ç–∏–ø–∞ —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ –æ—Ä–µ–æ–ª—ã –ø–æ –∫—Ä–∞—è–º.
–°—á–∏—Ç–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤.
–ë–µ—Ä—ë–º —Å–∏–Ω—É—Å –æ—Ç –≤—Ä–µ–º–µ–Ω–∏,
—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å (chroma_speed)
–∏ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (chroma_shift_px).
        '''
        csx = int(round(math.sin(t * chroma_speed) * chroma_shift_px))
        '''
–ê —ç—Ç–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥, –Ω–æ –º–µ–Ω—å—à–µ.
–ö–æ—Å–∏–Ω—É—Å –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –Ω–µ –≤—Å—ë –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø—Ä—ã–≥–∞–ª–æ.
        '''
        csy = int(round(math.cos(t * (chroma_speed * 0.7)) * (chroma_shift_px // 2)))
        '''
—Å–¥–≤–∏–≥–∞—Ç—å –ø–∏–∫—Å–µ–ª–∏ —Å –ø–æ–º–æ—â—å—é np.roll ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä–∞—è —Ç–µ–º–∞.
–î–≤–∏–≥–∞–µ–º —Å–∏–Ω–∏–π –∫–∞–Ω–∞–ª ([...,0]) –≤–ø—Ä–∞–≤–æ/–≤–ª–µ–≤–æ –Ω–∞ csx.
        '''
        bch = np.roll(base_f[..., 0], csx, axis=1)
        '''
–ó–µ–ª—ë–Ω—ã–π –¥–≤–∏–≥–∞–µ–º —á—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–µ—Ö–∞–ª–∞.
        '''
        gch = np.roll(base_f[..., 1], -csx//2, axis=1)
        '''
–ö—Ä–∞—Å–Ω—ã–π –¥–≤–∏–≥–∞–µ–º –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–∫—É —Å–∏–Ω–µ–º—É, —á—Ç–æ–± –¥–∏–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è –±—ã–ª–∞.
        '''
        rch = np.roll(base_f[..., 2], -csx, axis=1)
        '''
–°–∫–ª–∞–¥—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
        '''
        base_f = np.stack([bch, gch, rch], axis=2)

        '''
–¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–∏–º –º–µ–ª–∫–∏–π —Ä–∞–Ω–¥–æ–º –ø–æ —Å—Ç—Ä–æ–∫–∞–º, —á—Ç–æ–± –±—ã–ª–æ –±–æ–ª—å—à–µ "–¥—Ä–æ–∂–∏".
–û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞,
—á—Ç–æ–± —Å–∏–¥ –¥–ª—è —Ä–∞–Ω–¥–æ–º–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª –æ–¥–∏–Ω–∞–∫–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞.
        '''
        interval_idx = int(math.floor(t / swap_interval)) if swap_interval > 1e-9 else 0
        '''
–°–æ–∑–¥–∞—ë–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ —ç—Ç–æ–º—É —Å–∏–¥y.
        '''
        rng = np.random.RandomState(seed=(interval_idx & 0xffffffff))
        '''
–î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –±–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω—ã–π —Å–¥–≤–∏–≥ –æ—Ç -2 –¥–æ 2 –ø–∏–∫—Å–µ–ª–µ–π.
        '''
        per_row_offsets = (rng.randint(-2, 3, size=(h,))).astype(np.int32)
        '''
–¶–∏–∫–ª: –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –∑–µ–ª—ë–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
–¥–≤–∏–≥–∞–µ–º –µ—ë –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –Ω–∞ off. –ï—Å–ª–∏ off=0, –æ—Å—Ç–∞–≤–ª—è–µ–º.
        '''
        for row in range(h):
            off = per_row_offsets[row]
            if off != 0:
                gch[row] = np.roll(gch[row], off, axis=0)
                '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π –∫–∞–Ω–∞–ª –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É.
                '''
        base_f[...,1] = gch

        '''
–¢–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º "—Å–∫–∞–Ω–ª–∞–π–Ω—ã" –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–µ–ª–µ–∫–∞—Ö –∏ –¥–æ–±–∞–≤–ª—è–µ–º –º–∏–≥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞.
–°—Ç—Ä–æ–∏–º –º–∞—Å—Å–∏–≤ –æ—Ç 0 –¥–æ 1 –ø–æ –≤—ã—Å–æ—Ç–µ –∫–∞–¥—Ä–∞, –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–ª–æ—Å.
        '''
        rows = np.arange(h, dtype=np.float32)[:, None] / max(1.0, h)
        '''
–§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω —Ç—ë–º–Ω—ã—Ö –ø–æ–ª–æ—Å: —Å–∏–Ω—É—Å —Å –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç–æ–π,
—á—Ç–æ–±—ã –∫–∞–∫ –Ω–∞ –≠–õ–¢-—ç–∫—Ä–∞–Ω–µ.
        '''
        scan = 1.0 - scanline_strength * (0.5 + 0.5 * np.sin(rows * 2.0 * math.pi * 240.0 + t * 60.0))
        '''
–£–º–Ω–æ–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Å–∫–∞–Ω–ª–∞–π–Ω—ã. –¢–æ –µ—Å—Ç—å –¥–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã.
        '''
        base_f = np.clip(base_f * scan[..., None], 0.0, 1.0)

        '''
–î–µ–ª–∞–µ–º –ª—ë–≥–∫–æ–µ –º–∏–≥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ ‚Äî —Å–∏–Ω—É—Å –Ω–∞ 16 –ì—Ü.
        '''
        flick = 0.97 + 0.06 * math.sin(t * 16.0)
        '''
–ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤–æ–∫—Ä—É–≥ 0.5,
—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∏–≥–∞–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ.
        '''
        base_f = np.clip((base_f - 0.5) * (1.0 + 0.15*(flick-1.0)) + 0.5, 0.0, 1.0)

        '''
–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π –ø–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –±–æ–ª—å—à–µ 2 ‚Äî –≤–∫–ª—é—á–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç.
        '''
        if posterize_levels is not None and posterize_levels > 2:
            '''
–ë–µ—Ä—ë–º —á–∏—Å–ª–æ —É—Ä–æ–≤–Ω–µ–π –∫–∞–∫ float.
            '''
            levels = float(posterize_levels)
            '''
–û–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π (–∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ).
            '''
            base_f = np.floor(base_f * levels) / (levels - 1.0)
            '''
–ü–æ–¥—Ä–µ–∑–∞–µ–º, —á—Ç–æ–± –∑–Ω–∞—á–µ–Ω–∏—è –æ—Å—Ç–∞–ª–∏—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö [0..1].
            '''
            base_f = np.clip(base_f, 0.0, 1.0)

        '''
–ï—Å–ª–∏ —Å–∏–ª–∞ —à—É–º–∞ –±–æ–ª—å—à–µ –Ω—É–ª—è ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø–ª—ë–Ω–æ—á–Ω–æ–µ –∑–µ—Ä–Ω–æ.
        '''
        if grain_strength > 1e-6:
            '''
–°–æ–∑–¥–∞—ë–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª,
—Å–∏–¥–∏–º –µ–≥–æ –≤—Ä–µ–º–µ–Ω–µ–º (–∫–∞–∂–¥—É—é –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—É —Ä–∞–∑–Ω—ã–π).
            '''
            noise_rng = np.random.RandomState(seed=int((t*1000) % 2**31))
            '''
–î–µ–ª–∞–µ–º —à—É–º —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º
–¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –∫–∞–¥—Ä–∞, —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ —Å–∏–ª—É —à—É–º–∞.
            '''
            noise = noise_rng.randn(h, w).astype(np.float32) * grain_strength
            '''
–°—á–∏—Ç–∞–µ–º —è—Ä–∫–æ—Å—Ç—å –ø–∏–∫—Å–µ–ª—è –∫–∞–∫ –≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å—É–º–º—É –∫–∞–Ω–∞–ª–æ–≤ (BT.601).
            '''
            lum = base_f[...,0]*0.114 + base_f[...,1]*0.587 + base_f[...,2]*0.299  # (h,w)

            # –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ noise –∫ (h,w,1), –∑–∞—Ç–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏–µ
            '''
–î–æ–±–∞–≤–ª—è–µ–º —à—É–º, –∑–∞–≤–∏—Å—è—â–∏–π –æ—Ç —è—Ä–∫–æ—Å—Ç–∏: –Ω–∞ —Å–≤–µ—Ç–ª—ã—Ö –º–µ—Å—Ç–∞—Ö —à—É–º —Å–∏–ª—å–Ω–µ–µ.
            '''
            base_f += noise[..., None] * (0.5 + lum[..., None])
            '''
–û–ø—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Å—ë –≤ [0..1].
            '''
            base_f = np.clip(base_f, 0.0, 1.0)

        '''
–¢–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º –º—è—Å–æ: –¥–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –ø–æ–ª–æ—Å–∫–∏ –∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏—Ö.
–°—á–∏—Ç–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å–∫–∏.
        '''
        stripe_h = max(1, h // n_stripes)
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ uint8, —á—Ç–æ–± —Å –Ω–µ–π –º—É—Ç–∏—Ç—å.
        '''
        out = (base_f * 255.0).astype(np.uint8)

        '''
–§–∞–∑–∞ –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞: –≥–¥–µ –º—ã —Å–µ–π—á–∞—Å –º–µ–∂–¥—É –∑–∞–º–µ–Ω–∞–º–∏ –ø–æ–ª–æ—Å.
        '''
        phase_in = (t % swap_interval) / swap_interval if swap_interval > 1e-9 else 0.0
        '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º: –≥–ª—é–∫ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ –Ω–µ—Ç (–ø–æ –≤—Ä–µ–º–µ–Ω–∏).
        '''
        is_glitch_active = (phase_in * swap_interval) < glitch_duration

        '''
–°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ–ª–æ—Å (0,1,2,‚Ä¶).
        '''
        src_indices = np.arange(n_stripes, dtype=int)
        '''
–°–æ–∑–¥–∞—ë–º –µ—â—ë –æ–¥–∏–Ω —Ä–∞–Ω–¥–æ–º, —Ç–æ–∂–µ —Å–∏–¥–∏–º –µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º.
        '''
        rng2 = np.random.RandomState(seed=interval_idx & 0xffffffff)

        '''
–ë—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å —Ç—É—Ç –ø–æ–ª–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–º–µ–Ω—è–ª–∏—Å—å –º–µ—Å—Ç–∞–º–∏.
        '''
        swapped_set = set()
        '''
–ï—Å–ª–∏ –≥–ª—é–∫ –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ª–æ—Å—ã,
–∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–≤–∞–ø–µ.
        '''
        if is_glitch_active:
            candidates = [i for i in range(n_stripes) if rng2.rand() < glitch_prob]
            '''
–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏ –¥–µ–ª–∞–µ–º,
—á—Ç–æ–± –∏—Ö –±—ã–ª–æ —á—ë—Ç–Ω–æ–µ —á–∏—Å–ª–æ (–∏–Ω–∞—á–µ –æ–¥–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ª–∏—à–Ω–µ–π).
            '''
            if len(candidates) >= 2:
                rng2.shuffle(candidates)
                if len(candidates) % 2 == 1:
                    candidates = candidates[:-1]
                    '''
–°–≤–∞–ø–∞–µ–º –ø–æ–ª–æ—Å—ã –ø–æ–ø–∞—Ä–Ω–æ.
                    '''
                for k in range(0, len(candidates), 2):
                    a = candidates[k]; b = candidates[k+1]
                    src_indices[a], src_indices[b] = src_indices[b], src_indices[a]
                    '''
–ó–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫–∞–∫–∏–µ –ø–æ–ª–æ—Å—ã –±—ã–ª–∏ –∑–∞–º–µ—à–∞–Ω—ã.
                    '''
                swapped_set = set(candidates)

        '''
–ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –∫–∞–∂–¥–æ–π –ø–æ–ª–æ—Å–µ: —Å—á–∏—Ç–∞–µ–º –µ—ë –≤–µ—Ä—Ö –∏ –Ω–∏–∑.
        '''
        for i in range(n_stripes):
            y0 = i * stripe_h
            y1 = (i + 1) * stripe_h if i < n_stripes - 1 else h

            '''
–ë–µ—Ä—ë–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è —ç—Ç–æ–π –ø–æ–ª–æ—Å—ã (–≤–¥—Ä—É–≥ –æ–Ω–∞ –±—ã–ª–∞ —Å–≤–∞–ø–Ω—É—Ç–∞).
            '''
            src_i = src_indices[i]
            sy0 = src_i * stripe_h
            sy1 = (src_i + 1) * stripe_h if src_i < n_stripes - 1 else h

            '''
–í—ã—Ä–µ–∑–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–ª–æ—Å–∫—É.
            '''
            stripe = out[sy0:sy1].copy()


            '''
–ï—Å–ª–∏ –ø–æ–ª–æ—Å–∞ –±—ã–ª–∞ —Å–≤–∞–ø–Ω—É—Ç–∞, –Ω–∞—á–∏–Ω–∞–µ–º –µ—ë –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å.
            '''
            if i in swapped_set:
                s = stripe.astype(np.float32) / 255.0
                '''
–î–≤–∏–≥–∞–µ–º –ø–æ–ª–æ—Å–∫—É –≤–±–æ–∫ —Å–ª—É—á–∞–π–Ω–æ.
                '''
                shift = int(rng2.randint(-max_shift_px, max_shift_px + 1))
                if shift != 0:
                    s = np.roll(s, shift, axis=1)
                '''
–ö—Ä–∞—Å–∏–º –ø–æ–ª–æ—Å–∫—É –≤ –¥—Ä—É–≥–æ–π –æ—Ç—Ç–µ–Ω–æ–∫ (–±–æ–ª—å—à–µ —Å–∏–Ω–µ–≤—ã).
                '''
                tint = np.array([1.0 - tint_strength * 0.4,
                                 1.0 - tint_strength * 0.1,
                                 1.0 + tint_strength], dtype=np.float32)
                s *= tint
                '''
–ï—â—ë –ø–æ –∫–∞–Ω–∞–ª–∞–º —Ä–∞–∑–¥–≤–∏–≥–∞–µ–º –ø–∏–∫—Å–µ–ª–∏, —á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ —Ä–≤–∞–Ω–æ.
                '''
                b = np.roll(s[..., 0],  int(rng2.randint(-3, 4)), axis=1)
                g = np.roll(s[..., 1],  int(rng2.randint(-2, 3)), axis=1)
                r = np.roll(s[..., 2],  int(rng2.randint(-4, 5)), axis=1)
                '''
–°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–æ—Å–∫—É –æ–±—Ä–∞—Ç–Ω–æ –∏ –æ–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è.
                '''
                s2 = np.stack([b, g, r], axis=2)
                stripe_out = (np.clip(s2, 0.0, 1.0) * 255.0).astype(np.uint8)
                '''
–ï—Å–ª–∏ –ø–æ–ª–æ—Å–∞ –æ–±—ã—á–Ω–∞—è ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å.
                '''
            else:
                stripe_out = stripe
                '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–æ—Å–∫—É –Ω–∞ –µ—ë –º–µ—Å—Ç–æ.
                '''
            out[y0:y1] = stripe_out

        '''
–¢–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –º–µ–∂–¥—É –ø–æ–ª–æ—Å–∞–º–∏.
–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ ‚Äî –±–µ—Ä—ë–º —à–∏—Ä–∏–Ω—É —Ä–∞–∑–º—ã—Ç–∏—è.
        '''
        if seam_blend and seam_blend >= 1:
            bw = int(seam_blend)
            '''
–î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É –ø–æ–ª–æ—Å–∞–º–∏ –±–µ—Ä—ë–º –∫—É—Å–æ–∫ –≤–æ–∫—Ä—É–≥ –Ω–µ—ë.
            '''
            for i in range(1, n_stripes):
                y = i * stripe_h
                y0 = max(0, y - bw)
                y1 = min(h, y + bw)
                if y1 <= y0:
                    continue
                '''
–†–∞–∑–º—ã–≤–∞–µ–º —ç—Ç–æ—Ç –∫—É—Å–æ–∫ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏.
                '''
                region = out[y0:y1].astype(np.float32)
                kernel_h = max(3, (y1 - y0) | 1)
                blurred = cv2.GaussianBlur(region, (1, kernel_h), 0)
                '''
–°–æ–∑–¥–∞—ë–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç 0 –¥–æ 1 –ø–æ –≤—ã—Å–æ—Ç–µ.
                '''
                region_h = y1 - y0
                alpha = np.linspace(0.0, 1.0, region_h, dtype=np.float32)[:, None, None]
                '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ —Ä–∞–∑–º—ã—Ç–∏–µ, –ø–æ–ª—É—á–∞–µ–º –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥.
                '''
                blended = region * (1.0 - alpha) + blurred * alpha
                '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–π –∫—É—Å–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ.
                '''
                out[y0:y1] = np.clip(blended, 0, 255).astype(np.uint8)

        '''
–í–∫–ª—é—á–∞–µ–º –Ω–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ.
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å–Ω–æ–≤–∞ –≤ float.
        '''
        if neon_strength > 1e-4:
            out_f = out.astype(np.float32) / 255.0
            '''
–°—á–∏—Ç–∞–µ–º —è—Ä–∫–æ—Å—Ç—å –ø–∏–∫—Å–µ–ª–µ–π.
            '''
            lum = out_f[..., 0] * 0.114 + out_f[..., 1] * 0.587 + out_f[..., 2] * 0.299
            '''
–°–æ–∑–¥–∞—ë–º –º–∞—Å–∫—É —Å–≤–µ—á–µ–Ω–∏—è: —è—Ä–∫–∏–µ –º–µ—Å—Ç–∞ –±—É–¥—É—Ç —Å–≤–µ—Ç–∏—Ç—å—Å—è —Å–∏–ª—å–Ω–µ–µ.
            '''
            mask = np.clip((lum ** neon_power) * neon_intensity, 0.0, 1.0)
            '''
–ö—Ä–∞—Å–∏–º –º–∞—Å–∫—É –≤ –Ω–µ–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç.
            '''
            neon_col = np.array(neon_color, dtype=np.float32).reshape((1,1,3))
            base_overlay = (mask[..., None] * neon_col)

            '''
–°—á–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–æ–ø–∏–∏ –∫–∞–¥—Ä–∞, —á—Ç–æ–± –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–º—ã–≤–∞—Ç—å.
            '''
            ds = float(max(0.08, min(0.6, glow_downscale)))
            small_w = max(2, int(w * ds))
            small_h = max(2, int(h * ds))
            '''
–£–º–µ–Ω—å—à–∞–µ–º, —Ä–∞–∑–º—ã–≤–∞–µ–º –∏ –≥–æ—Ç–æ–≤–∏–º –æ—Å–Ω–æ–≤—É –¥–ª—è —Å–≤–µ—á–µ–Ω–∏—è.
            '''
            small = cv2.resize(base_overlay, (small_w, small_h), interpolation=cv2.INTER_LINEAR)
            sigma = max(0.6, glow_radius_px * ds)
            small_blurred = cv2.GaussianBlur(small, (0,0), sigmaX=sigma, sigmaY=sigma)
            '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º—ã—Ç—ã–π —Å–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä.
            '''
            glow = cv2.resize(small_blurred, (w, h), interpolation=cv2.INTER_LINEAR)

            '''
–ü—Ä–∏–±–∞–≤–ª—è–µ–º —Å–≤–µ—á–µ–Ω–∏–µ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ.
            '''
            out_f = np.clip(out.astype(np.float32)/255.0 + glow * neon_strength, 0.0, 1.0)
            '''
–õ—ë–≥–∫–∏–π –æ–±—â–∏–π –æ—Ç—Ç–µ–Ω–æ–∫ –Ω–µ–æ–Ω–æ–≤–æ–≥–æ —Ü–≤–µ—Ç–∞ –ø–æ–≤–µ—Ä—Ö.
            '''
            tint_overlay = neon_col * 0.03
            out_f = np.clip(out_f * (1.0 - 0.03) + tint_overlay * 0.03, 0.0, 1.0)
            '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ uint8.
            '''
            out = (out_f * 255.0).astype(np.uint8)
            '''
–û—Ç–¥–∞—ë–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –≥–ª—é–∫–∞–º–∏, —à—É–º–æ–º, –ø–æ–ª–æ—Å–∞–º–∏ –∏ –Ω–µ–æ–Ω–æ–º.
            '''
        return out


    '''
üí¨ –¢—É—Ç –º—ã –º—É—Ç–∏–º –º–µ—Ç–æ–¥ –ø–æ–¥ —ç—Ñ—Ñ–µ–∫—Ç ¬´–ú–∞—Ç—Ä–∏—Ü—ã¬ª. –ù–∞ –≤—Ö–æ–¥:

frame ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ (—Ç–∏–ø–∞ –∫–∞–¥—Ä –≤–∏–¥–æ—Å–∞),

t ‚Äî –≤—Ä–µ–º—è, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ,

duration ‚Äî —Å–∫–æ–ª—å–∫–æ –≤—Å—è –¥–≤–∏–∂—É—Ö–∞ –¥–ª–∏—Ç—Å—è,

spacing ‚Äî —á–µ—Ä–µ–∑ –∫–∞–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –±—É–∫–≤ –ø–∞–¥–∞—é—Ç,

font_scale, base_thickness ‚Äî —á—ë –∑–∞ —Ä–∞–∑–º–µ—Ä –∏ —Ç–æ–ª—â–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞,

charset ‚Äî –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–ª–∏ ‚Äî —Å–∞–º–∏ —Å–¥–µ–ª–∞–µ–º.
    '''
    def matrix_digital_rain(self, frame, t, duration,
                        spacing=20, font_scale=0.5, base_thickness=1, charset=None):
        """
        –ú–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞. –•—Ä–∞–Ω–∏—Ç —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ self._matrix_state.
        frame: BGR numpy array
        t: –≤—Ä–µ–º—è (—Å–µ–∫)
        duration: –æ–±—â–µ–µ –≤—Ä–µ–º—è (—Å–µ–∫)
        """
        '''
–ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –º–æ–¥—É–ª—å string, —Ç–∞–º –≤—Å—è–∫–∏–µ –±—É–∫–æ–≤–∫–∏ –∏ —Ü–∏—Ñ—Ä—ã –Ω–∞ —Ö–∞–ª—è–≤—É.
        '''
        import string

        h, w = frame.shape[:2]

        # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ self
        '''
–¢—É—Ç —Ö–∏—Ç—Ä–æ ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–º–Ω–∏—Ç—å,
–∫–∞–∫–∏–µ —É –Ω–µ–≥–æ –∫–æ–ª–æ–Ω–∫–∏ —É–∂–µ –µ—Å—Ç—å.
–ü–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ –µ—â—ë –Ω–µ –±—ã–ª–æ self._matrix_state,
–º—ã –∑–∞–≤–æ–¥–∏–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å. –ê –ø–æ—Ç–æ–º —é–∑–∞–µ–º –µ–≥–æ –∫–∞–∫ state.
        '''
        if not hasattr(self, '_matrix_state'):
            self._matrix_state = {}
        state = self._matrix_state


        
        '''
–ï—Å–ª–∏ —á—É–≤–∞–∫ –Ω–µ –¥–∞–ª —Å–≤–æ–π –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤,
–º—ã –±–µ—Ä—ë–º —Ü–∏—Ñ—Ä—ã, –±—É–∫–æ–≤–∫–∏ –∏ –ø–∞—Ä—É —Å–ø–µ—Ü–∑–Ω–∞–∫–æ–≤, —á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –ø–∞–¥–∞–ª–∏, –∫–∞–∫ –≤ —Ñ–∏–ª—å–º–µ.
        '''
        if charset is None:
            charset = list("01" + string.ascii_letters + string.digits + "@#$%&*")

        # (–ø–µ—Ä–µ)–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–æ–Ω–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –∏–ª–∏ spacing
        '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–æ–∫ –µ—â—ë –Ω–µ –±—ã–ª–æ, –∏–ª–∏ —Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞ –ø–æ–º–µ–Ω—è–ª—Å—è,
–∏–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ –¥—Ä—É–≥–æ–µ ‚Äî –∑–Ω–∞—á–∏—Ç, –Ω–∞–¥–æ –≤—Å—ë –∑–∞–Ω–æ–≤–æ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å.
        '''
        if ('cols' not in state) or state.get('size') != (w, h) or state.get('spacing') != spacing:
            '''
–¢—É—Ç –º—É—Ç–∏–º —Å–∞–º–∏ –∫–æ–ª–æ–Ω–∫–∏:

x ‚Äî –≥–¥–µ –∫–æ–ª–æ–Ω–∫–∞ –±—É–¥–µ—Ç –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏,

y ‚Äî –æ—Ç–∫—É–¥–∞ —Å–≤–µ—Ä—Ö—É –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–∞–¥–∞—Ç—å (–º–æ–∂–µ—Ç –¥–∞–∂–µ –∏–∑-–∑–∞ —ç–∫—Ä–∞–Ω–∞),

speed ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è,

trail ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ö–≤–æ—Å—Ç–µ,

chars ‚Äî –º–∞—Å—Å–∏–≤ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤,

offset ‚Äî —Å–¥–≤–∏–≥, —á—Ç–æ–± –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –±—ã–ª–∞.
–ò –≤—Å—ë —ç—Ç–æ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ —Å–ø–∏—Å–æ–∫ cols.
            '''
            cols = []
            for x in range(0, w, spacing):
                speed = random.uniform(0.6, 2.0)
                trail = random.randint(6, 20)
                y = random.randint(-h, 0)
                chars = [random.choice(charset) for _ in range(max(30, trail + 10))]
                cols.append({'x': int(x), 'y': float(y), 'speed': speed, 'trail': trail,
                             'chars': chars, 'offset': random.uniform(0, len(chars))})
                '''
–ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ state, —á—Ç–æ–± –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑.
                '''
            state['cols'] = cols
            state['size'] = (w, h)
            state['spacing'] = spacing

            '''
–î–æ—Å—Ç–∞—ë–º –≥–æ—Ç–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏.
            '''
        cols = state['cols']

        # –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —É—Å–∏–ª–µ–Ω–∏—è
        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ (progress –æ—Ç 0 –¥–æ 1).
–ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏ —è—Ä—á–µ –≤—Å—ë –ø–∞–¥–∞–µ—Ç:

speed_boost ‚Äî —É—Å–∫–æ—Ä—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è,

trail_boost ‚Äî —Ö–≤–æ—Å—Ç—ã –¥–µ–ª–∞–µ–º –¥–ª–∏–Ω–Ω–µ–µ,

bright_boost ‚Äî —Å–≤–µ—Ç–∏–º —è—Ä—á–µ.
        '''
        progress = float(np.clip(t / max(1e-6, duration), 0.0, 1.0))
        speed_boost = 1.0 + 3.0 * progress
        trail_boost = 1.0 + 2.0 * progress
        bright_boost = 0.5 + 1.5 * progress

        '''
–°–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —á—ë—Ä–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É, –Ω–∞ –Ω–µ–π –±—É–¥–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å –±—É–∫–≤—ã.
        '''
        overlay = np.zeros_like(frame)

        '''
–û–ø—Ä–µ–¥–µ–ª—è–µ–º —à—Ä–∏—Ñ—Ç –∏ —Ä–∞–∑–º–µ—Ä —Å–∏–º–≤–æ–ª–∞.
vstep ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —à–∞–≥, —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–µ–π –≤–Ω–∏–∑ —Ä–∏—Å–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –±—É–∫–≤—É.
        '''
        font = cv2.FONT_HERSHEY_SIMPLEX
        (tw, th), _ = cv2.getTextSize("0", font, font_scale, base_thickness)
        vstep = max(12, th + 2)

        '''
–ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º –∏ –¥–≤–∏–≥–∞–µ–º –∏—Ö –≤–Ω–∏–∑ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é
        '''
        for col in cols:
            col['y'] += col['speed'] * speed_boost

            '''
–ò–Ω–æ–≥–¥–∞ —Å–ª—É—á–∞–π–Ω–æ –º–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å, —á—Ç–æ–± –≤—Å—ë –Ω–µ –±—ã–ª–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ.
            '''
            if random.random() < 0.01:
                col['speed'] = max(0.3, col['speed'] + random.uniform(-0.3, 0.5))

                '''
–ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—à–ª–∞ –∑–∞ —ç–∫—Ä–∞–Ω –≤–Ω–∏–∑ ‚Äî –≤–æ–∑—Ä–æ–∂–¥–∞–µ–º –µ—ë —Å–≤–µ—Ä—Ö—É —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
                '''
            if col['y'] - col['trail'] * vstep > h:
                col['y'] = random.randint(-h // 2, 0)
                col['speed'] = random.uniform(0.6, 2.0)
                col['trail'] = random.randint(6, 20)
                col['chars'] = [random.choice(charset) for _ in range(max(30, col['trail'] + 10))]
                col['offset'] = random.uniform(0, len(col['chars']))

                '''
–ì–æ–ª–æ–≤–∞ –∫–æ–ª–æ–Ω–∫–∏ (head_y) –∏ —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ —É –Ω–µ—ë –≤ —Ö–≤–æ—Å—Ç–µ —Å —É—á—ë—Ç–æ–º –±—É—Å—Ç–∞.
                '''
            head_y = int(col['y'])
            trail_len = max(1, int(col['trail'] * trail_boost))

            '''
–ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã –≤ —Ö–≤–æ—Å—Ç–µ. –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª —É—à—ë–ª –∑–∞ —ç–∫—Ä–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.
            '''
            for i in range(trail_len):
                y = head_y - i * vstep
                if y < -vstep or y > h + vstep:
                    continue

                '''
–í—ã–±–∏—Ä–∞–µ–º, –∫–∞–∫–æ–π —Å–∏–º–≤–æ–ª —Ä–∏—Å–æ–≤–∞—Ç—å –≤ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ x —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –≤—Å–µ–π –∫–æ–ª–æ–Ω–∫–∏.
                '''
                ch_idx = int((i + int(col['offset'])) % len(col['chars']))
                ch = col['chars'][ch_idx]
                x = int(col['x'])

                '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ —è—Ä–∫–æ—Å—Ç—å: —á–µ–º –¥–∞–ª—å—à–µ –æ—Ç –≥–æ–ª–æ–≤—ã, —Ç–µ–º –±–ª–µ–¥–Ω–µ–µ –±—É–∫–≤–∞.
                '''
                rel = i / max(1, trail_len - 1)
                alpha = (1.0 - rel) ** 1.5
                alpha *= bright_boost
                alpha = float(np.clip(alpha, 0.05, 1.0))

                '''
–¶–≤–µ—Ç —Å–∏–º–≤–æ–ª–∞ ‚Äî –∑–µ–ª—ë–Ω—ã–π, —è—Ä–∫–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç alpha.
                '''
                g_val = int(np.clip(60 + 195 * alpha, 0, 255))
                color = (0, g_val, 0)

                '''
–ï—Å–ª–∏ —ç—Ç–æ –≥–æ–ª–æ–≤–∞ –∫–æ–ª–æ–Ω–∫–∏ (i == 0), —Ç–æ —Ä–∏—Å—É–µ–º –µ—ë –∂–∏—Ä–Ω–æ: —á—ë—Ä–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ –∏ —è—Ä–∫–∏–π –∑–µ–ª—ë–Ω–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç.
–ï—Å–ª–∏ —Ö–≤–æ—Å—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ —á—ë—Ä–Ω–∞—è —Ç–µ–Ω—å + –∑–µ–ª—ë–Ω–∞—è –±—É–∫–≤–∞.
                '''
                if i == 0:
                    cv2.putText(overlay, ch, (x, y), font, font_scale, (0, 0, 0), 3, cv2.LINE_AA)
                    head_green = int(np.clip(200 + 55 * progress, 0, 255))
                    cv2.putText(overlay, ch, (x, y), font, font_scale, (0, head_green, 200), 1, cv2.LINE_AA)
                else:
                    cv2.putText(overlay, ch, (x, y), font, font_scale, (0, 0, 0), 2, cv2.LINE_AA)
                    cv2.putText(overlay, ch, (x, y), font, font_scale, color, 1, cv2.LINE_AA)

                    '''
–î–≤–∏–≥–∞–µ–º –æ—Ñ—Ñ—Å–µ—Ç, —á—Ç–æ–± —Å–∏–º–≤–æ–ª—ã –≤ –∫–æ–ª–æ–Ω–∫–µ –º–µ–Ω—è–ª–∏—Å—å —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.
                    '''
            col['offset'] += 0.25 + 0.75 * progress
            if col['offset'] > len(col['chars']):
                col['offset'] -= len(col['chars'])

        out = cv2.addWeighted(frame, 0.65, overlay, 0.95, 0)
        return out


    # 4. CRT wave distortion
    def crt_wave_distortion(self, frame, t, duration):
        h, w = frame.shape[:2]

        # –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–∫ 2D —á–µ—Ä–µ–∑ broadcasting (—á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–≤–∞ –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã—Ö –º–∞—Å—Å–∏–≤–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
        '''
–≠—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–∏–∫—Å–µ–ª–µ–π.
y ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å (–æ—Ç 0 –¥–æ h-1), —Å—Ç–æ–ª–±–∏–∫.
x ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å (–æ—Ç 0 –¥–æ w-1), —Å—Ç—Ä–æ–∫–∞.
–° [:, None] –∏ [None, :] –¥–µ–ª–∞–µ–º –∏—Ö –¥–≤—É–º–µ—Ä–Ω—ã–º–∏ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ ¬´–±—Ä–æ–∞–¥–∫–∞—Å—Ç–∞¬ª, —á—Ç–æ–± –ø–æ—Ç–æ–º –∫—Ä–∞—Å–∏–≤–æ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å.
        '''
        y = np.arange(h, dtype=np.float32)[:, None]   # (h,1)
        x = np.arange(w, dtype=np.float32)[None, :]   # (1,w)

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (—Ä–µ–≥—É–ª–∏—Ä—É–π –¥–ª—è –±–æ–ª–µ–µ/–º–µ–Ω–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ –≥–ª–∏—Ç—á–∞)
        '''
–≠—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ¬´–≤–æ–ª–Ω—ã¬ª:

amp_main ‚Äî —Å–∏–ª–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏—Å–∫–∞–∂–µ–Ω–∏—è,

amp_secondary ‚Äî —Å–ª–∞–±–µ–µ –¥–æ–ø. –∫–æ–ª–µ–±–∞–Ω–∏—è,

freq1, freq2 ‚Äî —á–∞—Å—Ç–æ—Ç—ã (–∫–∞–∫ —á–∞—Å—Ç–æ –≤–æ–ª–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –ø–æ –≤—ã—Å–æ—Ç–µ),

time_speed1, time_speed2 ‚Äî –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –∫–æ–ª–±–∞—Å–∏—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏.
        '''
        amp_main = 16.0                   # –æ—Å–Ω–æ–≤–Ω–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–¥–≤–∏–≥–∞
        amp_secondary = 8.0               # –≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç–æ—Ç–∞
        freq1 = 0.018                     # —á–∞—Å—Ç–æ—Ç–∞ 1 (–ø–æ Y)
        freq2 = 0.055                     # —á–∞—Å—Ç–æ—Ç–∞ 2 (–ø–æ Y)
        time_speed1 = 3.0
        time_speed2 = 6.0

        # –õ—ë–≥–∫–∏–π –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —à—É–º (–∫–æ—ç—Ä—Å-—É—Ä–æ–≤–µ–Ω—å –ø–æ –≤—ã—Å–æ—Ç–µ, –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ—Ç—Å—è) ‚Äî –¥–µ—à—ë–≤–∞—è –∏–º–∏—Ç–∞—Ü–∏—è ¬´—à—É–º–æ–≤—ã—Ö –ø–æ–ª–æ—Å¬ª
        rng = np.random.RandomState(int(t * 1000) & 0xFFFF)
        '''
–û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ ¬´—à—É–º–æ–≤—ã—Ö –ø–æ–ª–æ—Å¬ª –±—É–¥–µ—Ç —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑.
–ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º: –ª–∏–±–æ 4, –ª–∏–±–æ h/20.
        '''
        coarse_n = max(4, h // 20)
        '''
–ì–µ–Ω–µ—Ä–∏–º —Å–ª—É—á–∞–π–Ω—ã–µ —á–∏—Å–ª–∞ –æ—Ç -1 –¥–æ 1, —Å—Ç–æ–ª—å–∫–æ —Å–∫–æ–ª—å–∫–æ coarse_n.
–≠—Ç–æ –∫–∞–∫ ¬´–±–∞–∑–æ–≤—ã–µ —à—É–º–æ–≤—ã–µ —Ç–æ—á–∫–∏¬ª.
        '''
        coarse = rng.uniform(-1.0, 1.0, size=(coarse_n,))
        '''
–°–æ–∑–¥–∞—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã X –¥–ª—è —ç—Ç–∏—Ö —à—É–º–æ–≤: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –æ—Ç 0 –¥–æ –≤—ã—Å–æ—Ç—ã.
        '''
        xp = np.linspace(0, h - 1, coarse_n)
        '''
–ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º —à—É–º: —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Ç–æ—á–∫–∏ –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫–∏.
–ü–æ–ª—É—á–∞–µ–º –ø–ª–∞–≤–Ω—ã–π —à—É–º –ø–æ Y.
        '''
        noise_y = np.interp(np.arange(h), xp, coarse).astype(np.float32)[:, None]  # (h,1)
        '''
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ —ç—Ç–æ—Ç —à—É–º –±—É–¥–µ—Ç –≤–ª–∏—è—Ç—å.
        '''
        noise_amp = 3.0

        # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ (X) —Å–º–µ—â–µ–Ω–∏—è: —Å—É–º–º–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∏–Ω—É—Å–æ–≤ + —à—É–º –ø–æ Y, –Ω–µ–±–æ–ª—å—à–æ–π —Ñ–∞–∑–æ–≤—ã–π —Å–¥–≤–∏–≥ –ø–æ X –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
        '''
–í–æ—Ç —Ç—É—Ç –Ω–∞—á–∏–Ω–∞–µ–º –∫–æ–ª–±–∞—Å–∏—Ç—å X-—Å–º–µ—â–µ–Ω–∏—è:

–ø–µ—Ä–≤–∞—è —Å–∏–Ω—É—Å–æ–∏–¥–∞ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –≤–æ–ª–Ω–∞ –ø–æ Y,

–≤—Ç–æ—Ä–∞—è ‚Äî –±–æ–ª–µ–µ –º–µ–ª–∫–∞—è –≤–æ–ª–Ω–∞, –∑–∞–≤–∏—Å—è—â–∞—è –∏ –æ—Ç Y, –∏ –æ—Ç X (—á—Ç–æ–± —Ç–µ–∫—Å—Ç—É—Ä–∞ –∂–∏–≤–∞—è –±—ã–ª–∞),

–¥–æ–º–Ω–æ–∂–∞–µ–º –∫–æ–µ-–≥–¥–µ –Ω–∞ –¥–æ–ø. —Å–∏–Ω—É—Å, —á—Ç–æ–± –≤–æ–ª–Ω–∞ –µ—â—ë –∏ ¬´–ø—É–ª—å—Å–∏—Ä–æ–≤–∞–ª–∞¬ª.
        '''
        dx = (amp_main * np.sin(2.0 * np.pi * freq1 * y + t * time_speed1) +
              amp_secondary * np.sin(2.0 * np.pi * freq2 * y * 0.6 + t * time_speed2 + x * 0.01) * (1.0 + 0.4 * np.sin(y * 0.12 + t * 1.5)))
        '''
–î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—Ä—Ö—É –Ω–∞—à —à—É–º, —á—Ç–æ–± –≤–æ–ª–Ω–∞ –±—ã–ª–∞ –≥—Ä—è–∑–Ω–æ–π, –∞ –Ω–µ —Ä–æ–≤–Ω–æ–π.
        '''
        dx += noise_amp * noise_y  # —Ä–∞—Å—Ç—è–Ω—É—Ç—å —à—É–º –ø–æ —à–∏—Ä–∏–Ω–µ –∑–∞ —Å—á—ë—Ç broadcast

        # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ (Y) –Ω–µ–±–æ–ª—å—à–∏–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è –¥–ª—è ¬´tear¬ª —ç—Ñ—Ñ–µ–∫—Ç–∞
        '''
–¢—É—Ç –¥–µ–ª–∞–µ–º Y-—Å–º–µ—â–µ–Ω–∏—è (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ).
–¢–∏–ø–∞ ¬´—Ä–∞–∑—Ä—ã–≤—ã¬ª –Ω–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–µ–ª–µ–∫–∞—Ö.
vert_amp —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —Å–∏–ª—É, —Å–∏–Ω—É—Å –¥–µ–ª–∞–µ—Ç –≤–æ–ª–Ω—ã –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏, –ø–ª—é—Å –¥–æ–±–∞–≤–ª—è–µ–º —à—É–º.
        '''
        vert_amp = 2.2
        dy = vert_amp * np.sin(x * 0.02 + t * 2.2) + 0.4 * noise_y

        # –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—ã remap (OpenCV –æ–∂–∏–¥–∞–µ—Ç float32)
        '''
–ì–æ—Ç–æ–≤–∏–º –∫–∞—Ä—Ç—ã –¥–ª—è cv2.remap.
–û–Ω–∏ –≥–æ–≤–æ—Ä—è—Ç OpenCV, –∫—É–¥–∞ –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å —Å–¥–≤–∏–≥–∞—Ç—å.
        '''
        map_x = (x + dx).astype(np.float32)
        map_y = (y + dy).astype(np.float32)

        # –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è: —Å–º–µ—â–∞–µ–º —Ü–≤–µ—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã –ø–æ X/Y —á—É—Ç—å –ø–æ-—Ä–∞–∑–Ω–æ–º—É
        # –ù–µ–±–æ–ª—å—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî ¬´—Å—Ç–∏–ª—å–Ω–æ¬ª, –Ω–µ —Ä–∞–∑—Ä—É—à–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∏–ª—å–Ω–æ
        '''
–≠—Ç–æ –¥–ª—è —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–±–µ—Ä—Ä–∞—Ü–∏–∏ (—Ä–∞–∑—ä–µ–∑–∂–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤).
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (—Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∫—Ä–∞—Å–Ω—ã–π) —Å–º–µ—â–µ–Ω–∏—è –ø–æ X –∏ Y —Ä–∞–∑–Ω—ã–µ.
        '''
        ch_offsets = [
            (0.0, 0.0),    # B
            (1.2, -0.6),   # G
            (-1.6, 0.8)    # R
        ]

        # –†–∞–∑–¥–µ–ª–∏–º –∫–∞–Ω–∞–ª—ã, –ø—Ä–∏–º–µ–Ω–∏–º remap –∫ –∫–∞–∂–¥–æ–º—É –∏ —Å–æ–π–¥–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        '''
–ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ü–≤–µ—Ç–Ω–∞—è (3 –∫–∞–Ω–∞–ª–∞), –¥–µ–ª–∞–µ–º –∞–±–µ—Ä—Ä–∞—Ü–∏—é.
        '''
        if frame.ndim == 3 and frame.shape[2] == 3:
            '''
–†–∞–∑–±–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞: b, g, r.
–°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤.
            '''
            b, g, r = cv2.split(frame)
            remapped = []
            '''
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞:

—Å–¥–≤–∏–≥–∞–µ–º –∫–∞—Ä—Ç—É X –∏ Y –Ω–∞ —Å–≤–æ—ë —Å–º–µ—â–µ–Ω–∏–µ,

cv2.remap —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ—Ç –ø–∏–∫—Å–µ–ª–∏ –ø–æ —ç—Ç–∏–º –∫–∞—Ä—Ç–∞–º,

–¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–ø–∏—Å–æ–∫.
            '''
            for (ox, oy), ch in zip(ch_offsets, (b, g, r)):
                mx = (map_x + ox).astype(np.float32)
                my = (map_y + oy).astype(np.float32)
                rem = cv2.remap(ch, mx, my, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
                remapped.append(rem)
                '''
–°–∫–ª–µ–∏–≤–∞–µ–º —Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ü–≤–µ—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
                '''
            out = cv2.merge(remapped)
            '''
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —á—ë—Ä–Ω–æ-–±–µ–ª–∞—è, —Ç–æ –¥–µ–ª–∞–µ–º —Ä–µ–º–∞–ø –æ–¥–∏–Ω —Ä–∞–∑, –±–µ–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤.
            '''
        else:
            # –¥–ª—è —Å–µ—Ä—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Äî –æ–¥–∏–Ω remap
            out = cv2.remap(frame, map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        # –õ—ë–≥–∫–∏–µ —Å–∫–∞–Ω–ª–∞–π–Ω—ã/CRT-—à—É–º—ã –ø–æ —Å—Ç—Ä–æ–∫–∞–º
        '''
–î–µ–ª–∞–µ–º ¬´—Å–∫–∞–Ω–ª–∞–π–Ω—ã¬ª ‚Äî –ø–æ–ª–æ—Å–∫–∏, –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä–æ–º —Ç–µ–ª–∏–∫–µ.
–≠—Ç–æ —Å–∏–Ω—É—Å–æ–∏–¥–∞ –ø–æ –≤—ã—Å–æ—Ç–µ, –∫–æ—Ç–æ—Ä–∞—è –∫–æ–ª–µ–±–ª–µ—Ç —è—Ä–∫–æ—Å—Ç—å —Å—Ç—Ä–æ–∫.
        '''
        scan_amp = 0.08
        scan = (1.0 - scan_amp * (0.5 + 0.5 * np.sin((np.arange(h, dtype=np.float32)[:, None] / 2.0) + t * 12.0)))
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –∫–∞–∂–¥–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ (broadcast –ø–æ —à–∏—Ä–∏–Ω–µ –∏ –∫–∞–Ω–∞–ª–∞–º)
        '''
–ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∞–Ω–ª–∞–π–Ω—ã –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ.

—É–º–Ω–æ–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã,

–æ–±—Ä–µ–∑–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0‚Äì255,

–¥–µ–ª–∞–µ–º uint8 (–æ–±—ã—á–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏).
        '''
        out = (out.astype(np.float32) * scan).clip(0, 255).astype(np.uint8)

        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º ¬´—Å—Ç–∞—Ä—ã–π —Ç–µ–ª–∏–∫ –≥–ª—é—á–∏—Ç¬ª.
        '''
        return out

    # 5. Neon edge glow
    def neon_edge_glow(self, frame, t=0.0, duration=1.0):
        '''
–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–∞–¥—Ä —É –Ω–∞—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenCV ‚Äî —Ç—Ä—ë—Ö–∫–∞–Ω–∞–ª—å–Ω—ã–π (BGR), –∏ –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª 8-–±–∏—Ç–Ω—ã–π.
        '''
        # frame: BGR uint8
        h, w = frame.shape[:2]

        # 1) –ö–æ–Ω—Ç—É—Ä—ã: Canny + —É—Ç–æ–ª—â–µ–Ω–∏–µ
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ —á/–±, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–ª—è –∫–æ–Ω—Ç—É—Ä–æ–≤ —Ü–≤–µ—Ç –Ω–∞—Ö—Ä–µ–Ω –Ω–µ –Ω—É–∂–µ–Ω.
        '''
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        '''
–ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä –∫–æ–Ω—Ç—É—Ä–æ–≤ –ö–∞–Ω–Ω–∏:
–∏—â–µ–º –≥—Ä–∞–Ω–∏—Ü—ã, –≥–¥–µ —Ä–µ–∑–∫–∏–π –ø–µ—Ä–µ–ø–∞–¥ —è—Ä–∫–æ—Å—Ç–∏.
–ü–æ—Ä–æ–≥–∏ ‚Äî 80 –∏ 180. –ß–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞.
        '''
        edges = cv2.Canny(gray, 80, 180)  # –º–æ–∂–Ω–æ —Ç–æ–Ω–∫–æ –ø–æ–¥–±–∏—Ä–∞—Ç—å –ø–æ—Ä–æ–≥–∏
        '''
–°–æ–∑–¥–∞—ë–º —è–¥—Ä–æ-—Ñ–æ—Ä–º—É 3—Ö3 –≤ –≤–∏–¥–µ —ç–ª–ª–∏–ø—Å–∞ ‚Äî –±—É–¥–µ–º –∏–º ¬´–º–∞–∑–∞—Ç—å¬ª –∫–æ–Ω—Ç—É—Ä—ã.
        '''
        kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
        '''
–ë–µ—Ä—ë–º –∫–æ–Ω—Ç—É—Ä –∏ –¥–≤–∞ —Ä–∞–∑–∞ –µ–≥–æ ¬´—Ä–∞–∑–¥—É–≤–∞–µ–º¬ª. –õ–∏–Ω–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∂–∏—Ä–Ω–µ–µ.
        '''
        edges = cv2.dilate(edges, kernel, iterations=2)  # —É—Ç–æ–ª—â–∞–µ–º –∫–æ–Ω—Ç—É—Ä
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –∫–æ–Ω—Ç—É—Ä–∞–º–∏ –≤ –º–∞—Å–∫—É True/False. –ì–¥–µ –∫–æ–Ω—Ç—É—Ä ‚Äî —Ç–∞–º True.
        '''
        edge_mask = edges.astype(bool)

        # 2) –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ/—É–ø—Ä–æ—â–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ (speed-friendly cartoon look)
        # –ü–æ–Ω–∏–∂–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º –±—ã—Å—Ç—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä, –∞–ø—Å–∫–µ–π–ª–∏–º
        '''
–£–º–µ–Ω—å—à–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –¥–≤–∞ —Ä–∞–∑–∞, —á—Ç–æ–± –±—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å.
        '''
        small = cv2.resize(frame, (w // 2, h // 2), interpolation=cv2.INTER_LINEAR)
        # –ë–∏–ª–∞—Ç–µ—Ä–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–∞—ë—Ç ¬´–ø–ª–∞—Å—Ç–∏–∫–æ–≤—É—é¬ª –∑–∞–ª–∏–≤–∫—É, –Ω–æ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ ‚Äî –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ
        '''
–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ –±–∏–ª–∞—Ç–µ—Ä–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä: –æ–Ω —Ä–∞–∑–º—ã–≤–∞–µ—Ç, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫—Ä–∞—è.
–í –∏—Ç–æ–≥–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ¬´–ø–ª–∞—Å—Ç–∏–∫–æ–≤–∞—è¬ª –∫–∞–∫ –≤ –º—É–ª—å—Ç—è—à–∫–∞—Ö.
        '''
        small = cv2.bilateralFilter(small, d=7, sigmaColor=60, sigmaSpace=60)
        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä. –ò –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ float32 —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π (0‚Äì1).
        '''
        base = cv2.resize(small, (w, h), interpolation=cv2.INTER_LINEAR).astype(np.float32) / 255.0

        # 3) Posterize (–Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π —Ü–≤–µ—Ç–∞) ‚Äî –ø—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π
        '''
–ì–æ–≤–æ—Ä–∏–º: —É –Ω–∞—Å –±—É–¥–µ—Ç –≤—Å–µ–≥–æ 5 —É—Ä–æ–≤–Ω–µ–π —Ü–≤–µ—Ç–∞.
        '''
        levels = 5
        '''
–û–≥—Ä—É–±–ª—è–µ–º —Ü–≤–µ—Ç–∞ ‚Äî —Ç–∏–ø–∞ –ø–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è. –ë–æ–ª—å—à–µ –Ω–µ—Ç –ø–ª–∞–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤, —Ç–æ–ª—å–∫–æ —Å—Ç—É–ø–µ–Ω—å–∫–∏.
        '''
        base = np.floor(base * levels) / levels

        # 4) –ü—Ä–∏–¥—É—à–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ (–º—Ä–∞—á–Ω—ã–π –≤–∏–¥)
        # –Ω–µ–º–Ω–æ–≥–æ —Å–º–µ—à–∞–µ–º —Å —Å–µ—Ä—ã–º
        '''
–°–Ω–æ–≤–∞ –¥–µ–ª–∞–µ–º —á/–± –≤–µ—Ä—Å–∏—é –∏–∑ –Ω–∞—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏. –í float –æ—Ç 0 –¥–æ 1.
        '''
        gray_full = cv2.cvtColor((base * 255).astype(np.uint8), cv2.COLOR_BGR2GRAY).astype(np.float32) / 255.0
        '''
–°–º–µ—à–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Å —Å–µ—Ä—ã–º, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ —Ç—É—Å–∫–ª–∞—è, –º—Ä–∞—á–Ω–∞—è.
        '''
        base = base * 0.65 + gray_full[..., None] * 0.35

        # –ö–æ–Ω—Ç—Ä–∞—Å—Ç/—è—Ä–∫–æ—Å—Ç—å (—Ç–æ–Ω–∫–æ)
        '''
–ß—É—Ç—å –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç –∏ —É–º–µ–Ω—å—à–∞–µ–º —è—Ä–∫–æ—Å—Ç—å.
        '''
        contrast = 1.05
        brightness = 0.9
        '''
–í—ã—á–∏—Å–ª—è–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç+—è—Ä–∫–æ—Å—Ç—å. clip —Ä–µ–∂–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ–∑–ª–∏ –∑–∞ 0‚Äì1.
        '''
        base = np.clip((base - 0.5) * contrast + 0.5, 0.0, 1.0) * brightness

        # 5) –£—Å–∏–ª–µ–Ω–∏–µ —Ç–µ–Ω–µ–π (–¥–µ–ª–∞–µ–º –º—Ä–∞—á–Ω–µ–µ –Ω–∏–∑–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è)
        '''
–ë–µ—Ä—ë–º –≥–æ—Ç–æ–≤—É—é —è—Ä–∫–æ—Å—Ç—å –∏–∑ —Å–µ—Ä–æ–π –≤–µ—Ä—Å–∏–∏.
        '''
        luma = gray_full  # —É–∂–µ –µ—Å—Ç—å
        '''
–§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å–∫—É: —á–µ–º —Ç–µ–º–Ω–µ–µ –ø–∏–∫—Å–µ–ª—å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –æ–Ω –ø–æ–ø–∞–¥–∞–µ—Ç –≤ ¬´—Ç–µ–Ω—å¬ª.
        '''
        shadow_mask = np.clip(1.0 - luma * 1.2, 0.0, 1.0)
        '''
–£–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, —Ç–µ–º —Å–∞–º—ã–º –¥–µ–ª–∞–µ–º —Ç—ë–º–Ω—ã–µ –∑–æ–Ω—ã –µ—â—ë –º—Ä–∞—á–Ω–µ–µ.
        '''
        base = base * (1.0 - 0.28 * shadow_mask[..., None])

        # 6) –í–∏–Ω—å–µ—Ç–∫–∞ (–ø—Ä–æ—Å—Ç–∞—è, –¥–µ—à—ë–≤–∞—è)
        '''
–°–æ–∑–¥–∞—ë–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: –æ—Ç -1 –¥–æ 1 –ø–æ X –∏ Y. –¢–∏–ø–∞ —Ä–∞–¥–∏–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.
        '''
        yy = np.linspace(-1.0, 1.0, h)[:, None]
        xx = np.linspace(-1.0, 1.0, w)[None, :]
        '''
–°—á–∏—Ç–∞–µ–º –∫—Ä—É–≥–ª—É—é –º–∞—Å–∫—É. –¶–µ–Ω—Ç—Ä —è—Ä–∫–∏–π, –∫—Ä–∞—è —Ç–µ–º–Ω–µ–µ.
        '''
        vign = 1.0 - np.clip((xx**2 + yy**2), 0.0, 1.0)
        '''
–ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–∏–Ω—å–µ—Ç–∫—É ‚Äî –ø–æ –∫—Ä–∞—è–º —Ç–µ–º–Ω–µ–µ—Ç –ø–æ—á—Ç–∏ –Ω–∞ 55%.
        '''
        vign_strength = 0.55
        base = base * (1.0 - (1.0 - vign) * vign_strength)[..., None]

        # 7) –ù–∞–ª–æ–∂–µ–Ω–∏–µ —á—ë—Ä–Ω—ã—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤ (—Ç–æ–ª—Å—Ç—ã–µ –ª–∏–Ω–∏–∏ –º—É–ª—å—Ç—è—à–Ω–æ–≥–æ —Å—Ç–∏–ª—è)
        '''
–ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤—É, —á—Ç–æ–±—ã —Ç—É–¥–∞ —É–∂–µ —Ä–∏—Å–æ–≤–∞—Ç—å.
        '''
        out = base.copy()
        # –¥–µ–ª–∞–µ–º –∫–æ–Ω—Ç—É—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —á—ë—Ä–Ω—ã–º (–∏–ª–∏ –ø–æ—á—Ç–∏ —á—ë—Ä–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ —Å–∂–µ—á—å –¥–µ—Ç–∞–ª–∏)
        '''
–í –º–µ—Å—Ç–∞—Ö, –≥–¥–µ —É –Ω–∞—Å –∫–æ–Ω—Ç—É—Ä—ã, –∑–∞–ª–∏–≤–∞–µ–º –∏—Ö –ø–æ—á—Ç–∏ —á—ë—Ä–Ω—ã–º —Ü–≤–µ—Ç–æ–º (—á—É—Ç—å —Å–µ—Ä—ã–º, —á—Ç–æ–± –Ω–µ —É–±–∏—Ç—å –º–µ–ª–æ—á–∏).
        '''
        out[edge_mask] = np.array([0.02, 0.02, 0.02], dtype=np.float32)

        # 8) –õ—ë–≥–∫–∏–π —à—É–º/–∑–µ—Ä–Ω–æ –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã
        '''
–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏–ª—É —à—É–º–∞. –ú–∞–ª–µ–Ω—å–∫–∞—è, —á—Ç–æ–± –ø—Ä–æ—Å—Ç–æ –ª—ë–≥–∫–∞—è –∑–µ—Ä–Ω–∏—Å—Ç–æ—Å—Ç—å.
        '''
        grain_strength = 0.02
        '''
–ì–µ–Ω–µ—Ä–∏–º —à—É–º (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ) –Ω–∞ –≤—Å—é –∫–∞—Ä—Ç–∏–Ω–∫—É
        '''
        noise = np.random.randn(h, w, 1).astype(np.float32) * grain_strength
        '''
–î–æ–±–∞–≤–ª—è–µ–º —à—É–º –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ, –Ω–æ —Ä–µ–∂–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ–∑–ª–∏ –∑–∞ 0‚Äì1. –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ.
        '''
        out = np.clip(out + noise, 0.0, 1.0)

        # 9) –í–µ—Ä–Ω—É—Ç—å BGR uint8
        return (out * 255).astype(np.uint8)

    # 6. Smoke screen dissolve
    def smoke_screen_dissolve(self, frame, t, duration):
        
        # –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –≤—Ö–æ–¥–∞
        '''
–ë–µ—Ä—ë–º frame –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ –º–∞—Å—Å–∏–≤ NumPy,
–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª —á–µ–º-—Ç–æ –¥—Ä—É–≥–∏–º.
–¢–∏–ø–∞: "–¥–∞–≤–∞–π –±–µ–∑ —Ñ–æ–∫—É—Å–æ–≤, –≤—Å—ë –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤".
        '''
        frame = np.asarray(frame)
        '''
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –≤ —Ç–∏–ø–µ uint8 (–∞ —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –ø–∏–∫—Å–µ–ª–µ–π: 0‚Äì255),
—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º. –ë–µ–∑ –∫–æ–ø–∏–π, —á—Ç–æ–± –ø–∞–º—è—Ç—å –Ω–µ —Ö–∞–≤–∞–ª–æ.
        '''
        if frame.dtype != np.uint8:
            frame = frame.astype(np.uint8, copy=False)

        # –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–∫–∞–ª—è—Ä–Ω—ã–µ t –∏ duration (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ length-1 arrays)
        '''
–ö–æ—Ä–æ—á–µ, –±–µ—Ä—ë–º t –∏ duration, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤—ã —Å –æ–¥–Ω–∏–º —á–∏—Å–ª–æ–º ‚Äî –≤—ã–∫–æ–≤—ã—Ä–∏–≤–∞–µ–º —Å–∫–∞–ª—è—Ä.
progress ‚Äî —ç—Ç–æ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø—Ä–æ—à–ª–æ: 0 ‚Äî –Ω–∞—á–∞–ª–æ, 1 ‚Äî –∫–æ–Ω–µ—Ü.
max(1e-8, d_val) –Ω—É–∂–µ–Ω, —á—Ç–æ–± –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å –Ω–µ —Å–ª—É—á–∏–ª–æ—Å—å (—á–∏—Å—Ç–æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞).
np.clip –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ä–∞–º–∫–∞—Ö 0.0‚Äì1.0, —Ç–∏–ø–∞ –Ω–µ –≤—ã–π–¥–µ—à—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã.
        '''
        t_val = float(np.ravel(t)[0])
        d_val = float(np.ravel(duration)[0])
        progress = np.clip(t_val / max(1e-8, d_val), 0.0, 1.0)

        '''
–í—ã—Å–æ—Ç–∞ –∏ —à–∏—Ä–∏–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ü–æ—Ç–æ–º —Å–æ–∑–¥–∞—ë–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª rng,
–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –µ–≥–æ —Ö–∏—Ç—Ä—ã–º —Å–∏–¥–æ–º: –ø—Ä–æ–≥—Ä–µ—Å—Å * –º–∏–ª–ª–∏–æ–Ω, —Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞.
–¢–∞–∫ —Ä–∞–Ω–¥–æ–º –±—É–¥–µ—Ç ¬´–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π¬ª ‚Äî –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.
        '''
        h, w = frame.shape[:2]
        rng = np.random.default_rng(int(progress * 1e6) ^ (h<<16) ^ w)

        # —Å–ª—É—á–∞–π–Ω–∞—è –º–∞—Å–∫–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞
        '''
–î–µ–ª–∞–µ–º —à—É–º –æ—Ç 0 –¥–æ 1 —Ä–∞–∑–º–µ—Ä–æ–º –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞.
–ü–æ—Ç–æ–º —Å–º–æ—Ç—Ä–∏–º: –µ—Å–ª–∏ —à—É–º –º–µ–Ω—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ‚Äî –ø–∏–∫—Å–µ–ª—å –≤ —ç—Ñ—Ñ–µ–∫—Ç–µ.
–ß–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –±–æ–ª—å—à–µ ¬´–¥—ã–º–∞¬ª –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è.
        '''
        noise = rng.random((h, w))
        appear_mask = noise < progress   # shape (H, W)

        # —Ä–∞–±–æ—á–∞—è –∫–æ–ø–∏—è –≤ float32
        '''
–ë–µ—Ä—ë–º –∫–æ–ø–∏—é –∫–∞—Ä—Ç–∏–Ω–∫–∏, –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ float32,
—á—Ç–æ–± —É–¥–æ–±–Ω–µ–µ —Å—á–∏—Ç–∞—Ç—å –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å (–∏–Ω–∞—á–µ –≤—Å—ë –±—É–¥–µ—Ç –æ–±—Ä–µ–∑–∞—Ç—å—Å—è).
        '''
        src = frame.astype(np.float32, copy=True)

        # posterize (cartoon) ‚Äî —á–µ–º –≤—ã—à–µ progress, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤
        '''
–î–µ–ª–∞–µ–º ¬´–ø–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é¬ª, —Ç–∏–ø–∞ –º—É–ª—å—Ç—è—à–Ω—ã–π —Å—Ç–∏–ª—å.
–ß–µ–º –¥–∞–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç, —Ç–µ–º –º–µ–Ω—å—à–µ —Ü–≤–µ—Ç–æ–≤ –æ—Å—Ç–∞—ë—Ç—Å—è (—É—Ä–æ–≤–Ω–∏ –æ—Ç 4 –¥–æ 16).
step ‚Äî —Ä–∞–∑–º–µ—Ä —à–∞–≥–∞ –º–µ–∂–¥—É —Ü–≤–µ—Ç–∞–º–∏.
np.floor(...)*step ‚Äî –æ–∫—Ä—É–≥–ª—è–µ–º –ø–∏–∫—Å–µ–ª–∏ –≤–Ω–∏–∑ –∫ –±–ª–∏–∂–∞–π—à–µ–º—É ¬´–∫–æ—Ä–∑–∏–Ω–Ω–æ–º—É¬ª —Ü–≤–µ—Ç—É.
        '''
        levels = max(3, int(4 + progress * 12))   # 4..16 —É—Ä–æ–≤–Ω–µ–π
        step = 256.0 / levels
        poster = np.floor(src / step) * step

        # edge detection –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º (uint8 contiguous)
        '''
–î–µ–ª–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –ø–∞–º—è—Ç–∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π, —á—Ç–æ–± OpenCV –Ω–µ —Ä—É–≥–∞–ª—Å—è.
        '''
        src_cv = np.ascontiguousarray(frame)
        '''
–ì–æ—Ç–æ–≤–∏–º —á—ë—Ä–Ω–æ-–±–µ–ª—É—é –≤–µ—Ä—Å–∏—é –∫–∞–¥—Ä–∞: –µ—Å–ª–∏ RGB ‚Äî –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–µ—Ä—ã–π, –µ—Å–ª–∏ —É–∂–µ —Å–µ—Ä—ã–π ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º.
        '''
        if src_cv.ndim == 3 and src_cv.shape[2] == 3:
            gray = cv2.cvtColor(src_cv, cv2.COLOR_BGR2GRAY)
        else:
            gray = src_cv if src_cv.ndim == 2 else cv2.cvtColor(src_cv, cv2.COLOR_BGR2GRAY)

        # —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ Canny, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏ progress
        '''
–ü–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç–∏–Ω–∫—É –±–ª—é—Ä–∏–º, —á—Ç–æ–±—ã —à—É–º –Ω–µ –º–µ—à–∞–ª.
–ß–µ–º –º–µ–Ω—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –±–ª—é—Ä–∏–º (—á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞—á–∏–Ω–∞–ª—Å—è –ø–ª–∞–≤–Ω–æ).
–ö–µ—Ä–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ—á—ë—Ç–Ω—ã–π, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º –µ–¥–∏–Ω–∏—á–∫—É.
        '''
        blur_k = max(3, int(1 + (1 - progress) * 5))  # –ø—Ä–∏ –º–∞–ª–µ–Ω—å–∫–æ–º progress —á—É—Ç—å —Å–∏–ª—å–Ω–µ–µ –±–ª—é—Ä–∏–º
        if blur_k % 2 == 0:
            blur_k += 1
        gray_blur = cv2.medianBlur(gray, blur_k)

        # Canny –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–∏–π
        '''
–ù–∞—Ö–æ–¥–∏–º –∫—Ä–∞—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º Canny. –ü–æ—Ä–æ–≥ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: –¥–∞–ª—å—à–µ ‚Äî –∂—ë—Å—Ç—á–µ.
        '''
        low = int(30 + progress * 60)
        high = int(90 + progress * 120)
        edges = cv2.Canny(gray_blur, low, high)
        # —à–∏—Ä–∏–Ω–∞ –ª–∏–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        '''
–î–µ–ª–∞–µ–º –ª–∏–Ω–∏–∏ –ø–æ—Ç–æ–ª—â–µ (–¥–∏–ª–∞—Ç–∞—Ü–∏—è). –ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º –∂–∏—Ä–Ω–µ–µ –ª–∏–Ω–∏–∏.
        '''
        dilate_iter = 1 + int(progress * 6)
        kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
        edges_dil = cv2.dilate(edges, kernel, iterations=dilate_iter)

        # —Ü–≤–µ—Ç –Ω–µ–æ–Ω–∞ (BGR) ‚Äî –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å
        '''
–ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç —Å–≤–µ—á–µ–Ω–∏—è: –≤ —Ñ–æ—Ä–º–∞—Ç–µ BGR, —Ç—É—Ç –æ–Ω —Ç–∞–∫–æ–π —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—Å–∏–Ω–∏–π.
        '''
        base_tint = np.array([40, 10, 240], dtype=np.float32)  # —è—Ä–∫–∏–π —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—Å–∏–Ω–∏–π
        # —É—Å–∏–ª–∏–≤–∞–µ–º/–º–µ–Ω—è–µ–º –æ—Ç—Ç–µ–Ω–æ–∫ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É (–ø—É–ª—å—Å–∞—Ü–∏—è)
        '''
–î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é —Ü–≤–µ—Ç–∞, —Ç–∏–ø–∞ –æ–Ω–æ –¥—ã—à–∏—Ç. –ß–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —è—Ä—á–µ –∏ —Å–æ—á–Ω–µ–µ.
        '''
        pulse = 0.6 + 0.4 * np.sin(progress * np.pi * 2)
        tint = base_tint * (0.7 + 0.6 * progress) * (0.9 + 0.1 * pulse)

        # —Å–æ–∑–¥–∞—ë–º —Ü–≤–µ—Ç–Ω–æ–π –Ω–∞–ª—ë—Ç –∫—Ä–∞—ë–≤
        '''
–°–æ–∑–¥–∞—ë–º —Å–ª–æ–π ¬´—Å–≤–µ—á–µ–Ω–∏—è¬ª –Ω–∞ –∫—Ä–∞—è—Ö.
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ü–≤–µ—Ç–Ω–∞—è ‚Äî –∫—Ä–∞—Å–∏–º –∫—Ä–∞—è —Ü–≤–µ—Ç–æ–º tint, –µ—Å–ª–∏ —á/–± ‚Äî —Å—Ä–µ–¥–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
        '''
        edges_mask = edges_dil.astype(bool)
        glow = np.zeros_like(src, dtype=np.float32)
        if src.ndim == 2:
            glow[edges_mask] = float(np.mean(tint))
        else:
            # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            glow[edges_mask] = tint

        # –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ ‚Äî —Å–∏–ª—å–Ω—ã–π GaussianBlur; —Ä–∞–¥–∏—É—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏ progress
        '''
–†–∞–∑–º–∞–∑—ã–≤–∞–µ–º ¬´—Å–≤–µ—á–µ–Ω–∏–µ¬ª —Å–∏–ª—å–Ω—ã–º –±–ª—é—Ä–æ–º,
—Ä–∞–¥–∏—É—Å —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º, —á—Ç–æ–±—ã –∫–æ–º–ø –Ω–µ –∑–∞–¥–æ—Ö–Ω—É–ª—Å—è.
        '''
        max_kernel = int(min(max(h, w) * 0.03, 65))  # –æ–≥—Ä–∞–Ω–∏—á–∏–º —è–¥—Ä–æ
        gk = 3 + int(progress * max_kernel)
        if gk % 2 == 0:
            gk += 1
        glow_blur = cv2.GaussianBlur(glow.astype(np.float32), (gk, gk), 0)

        # Core lines (—è—Ä–∫–∏–µ —Ç–æ–Ω–∫–∏–µ –ª–∏–Ω–∏–∏ –ø–æ–≤–µ—Ä—Ö)
        '''
–î–µ–ª–∞–µ–º ¬´–∂–∏—Ä–Ω—ã–µ –Ω–µ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ–∂–∏–ª–∫–∏¬ª ‚Äî —ç—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ —è—Ä–∫–∏–µ –ª–∏–Ω–∏–∏.
–ë–µ—Ä—ë–º –∫—Ä–∞—è, —á—É—Ç—å —Å—É–∂–∞–µ–º (—ç—Ä–æ–∑–∏—è) –∏ –∫—Ä–∞—Å–∏–º –±–æ–ª–µ–µ —è—Ä–∫–∏–º —Ü–≤–µ—Ç–æ–º.
        '''
        core = np.zeros_like(src, dtype=np.float32)
        core_mask_small = cv2.erode(edges_dil, kernel, iterations=max(1, dilate_iter-1)).astype(bool)
        if src.ndim == 2:
            core[core_mask_small] = float(np.mean(tint) * 1.1)
        else:
            core[core_mask_small] = tint * 1.3

        # –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º: poster (–±–∞–∑–∞) + glow + core
        '''
–ù–∞—á–∏–Ω–∞–µ–º —Å–æ–±–∏—Ä–∞—Ç—å –∏—Ç–æ–≥: –±–µ—Ä—ë–º –º—É–ª—å—Ç—è—à–Ω—É—é –±–∞–∑—É
        '''
        processed = poster.copy()
        # –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—á–µ–Ω–∏–µ (–∞–¥–¥–∏—Ç–∏–≤–Ω–æ), —á—É—Ç—å —Å–∏–ª—å–Ω–µ–µ –≥–¥–µ –ø–æ—è–≤–∏–ª—Å—è —ç—Ñ—Ñ–µ–∫—Ç
        '''
–ö –±–∞–∑–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ –ø—Ä–∏–±–∞–≤–ª—è–µ–º —Å–≤–µ—á–µ–Ω–∏–µ, –µ–≥–æ –º–æ—â—å —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
        '''
        glow_strength = 0.9 + 1.2 * progress
        processed += glow_blur * glow_strength

        # –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —è—Ä–∫–∏–µ –ª–∏–Ω–∏–∏
        '''
–ù–∞ –º–µ—Å—Ç–∞, –≥–¥–µ ¬´—è–¥—Ä–æ –ª–∏–Ω–∏–π¬ª, –º—ã –∫–ª–∞–¥—ë–º —Å–º–µ—Å—å –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∏ —Å—É–ø–µ—Ä—è—Ä–∫–æ–≥–æ –Ω–µ–æ–Ω–∞ (–ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–æ–Ω).
        '''
        processed[core_mask_small] = processed[core_mask_small] * 0.15 + core[core_mask_small] * 0.85

        # –º—è–≥–∫–∏–π bloom (—Ä–∞–∑–º—ã—Ç–∏–µ –≤—Å–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ) –¥–ª—è –º—É–ª—å—Ç—è—à–Ω–æ—Å—Ç–∏
        '''
–î–µ–ª–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç bloom: –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–µ–≥–∫–∞ —Ä–∞—Å–ø–ª—ã–≤–∞–µ—Ç—Å—è,
–∫–∞–∫ –±—É–¥—Ç–æ —Å–≤–µ—Ç —Ä–∞—Å—Å–µ–∏–≤–∞–µ—Ç—Å—è. –ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ.
        '''
        blur_all_k = 1 + int(progress * 9)
        if blur_all_k % 2 == 0:
            blur_all_k += 1
        bigblur = cv2.GaussianBlur(processed.astype(np.float32), (blur_all_k, blur_all_k), 0)
        processed = cv2.addWeighted(processed.astype(np.float32), 0.85, bigblur.astype(np.float32), 0.45 * progress, 0)

        # —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —á—É—Ç—å –∑–∞—Ç–µ–º–Ω—è–µ–º –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –∏ —Å–º–µ—à–∏–≤–∞–µ–º
        '''
–ë–µ—Ä—ë–º –∫–æ–ø–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –º–∏–∫—Å–∞.
        '''
        out = frame.astype(np.float32).copy()
        # where mask true -> –±–µ—Ä–µ–º processed, else -> mix original and processed by small factor
        '''
–¢–∞–º, –≥–¥–µ —ç—Ñ—Ñ–µ–∫—Ç ¬´–ø—Ä–æ—è–≤–∏–ª—Å—è¬ª –ø–æ –º–∞—Å–∫–µ ‚Äî –±–µ—Ä—ë–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é.
        '''
        out[appear_mask] = processed[appear_mask]
        # –≤–Ω–µ –º–∞—Å–∫–∏ ‚Äî –Ω–µ–±–æ–ª—å—à–æ–µ –≤–ª–∏—è–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ (–¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏)
        '''
–¢–∞–º, –≥–¥–µ –º–∞—Å–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ ‚Äî –º—ã –≤—Å—ë —Ä–∞–≤–Ω–æ —á—É—Ç—å –ø—Ä–∏–º–µ—à–∏–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–æ–¥ –±—ã–ª –ø–ª–∞–≤–Ω—ã–º.
        '''
        outside = ~appear_mask
        if np.any(outside):
            out[outside] = out[outside] * (1.0 - 0.4 * progress) + processed[outside] * (0.4 * progress)

        # posterize —Å–Ω–æ–≤–∞ —á—É—Ç—å-—á—É—Ç—å –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏–∏
        '''
–ï—â—ë —Ä–∞–∑–æ–∫ –ø–æ—Å—Ç–µ—Ä–∏–∑—É–µ–º, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ —Ä–∞–∑–≤–∞–ª–∏–ª–∞—Å—å –∏ –±—ã–ª–∞ –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ.
        '''
        out = np.floor(out / step) * step

        '''
–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç 0 –¥–æ 255,
–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –∫–∞–¥—Ä –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ uint8.
–í—Å—ë, –¥—ã–º–∫–∞ —Å –Ω–µ–æ–Ω–æ–º –≥–æ—Ç–æ–≤–∞.
        '''
        np.clip(out, 0, 255, out=out)
        return out.astype(np.uint8)
    

    # 7. Raid flashbang
    def raid_flashbang(self, frame, t, duration):
        '''
–ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –º–æ–¥—É–ª—å time, —á—Ç–æ–±—ã –ø–æ —á–∞—Å–∏–∫–∞–º —Å–ª–µ–¥–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ.
        '''
        import time

        h, w = frame.shape[:2]

        # –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
        '''
–°–º–æ—Ç—Ä–∏, —Ç—É—Ç –¥–µ–ª–∞–µ—Ç—Å—è —Ç–∞–∫:
–ë–µ—Ä—ë–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è t, –¥–µ–ª–∏–º –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å duration, –∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å (–æ—Ç 0 –¥–æ 1).
max(1e-9, duration) ‚Äì —ç—Ç–æ —á—Ç–æ–±—ã –Ω–∞ –Ω–æ–ª—å –Ω–µ –¥–µ–ª–∏–ª–æ—Å—å, —Ö–∏—Ç—Ä—ã–π —Ç—Ä—é–∫.
np.clip ‚Äì –ø–æ–¥—Ä–µ–∑–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –≤—ã—à–ª–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã.
–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞ (–Ω—É –º–∞–ª–æ –ª–∏, —Ñ–∏–≥–Ω—è –∫–∞–∫–∞—è –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö), —Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç—É–ø–æ –æ–±–Ω—É–ª—è–µ–º.
        '''
        try:
            prog_passed = float(t) / max(1e-9, float(duration))
            prog_passed = np.clip(prog_passed, 0.0, 1.0)
        except Exception:
            prog_passed = 0.0

            '''
–¢—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ (self) —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Ç–∏–ø–∞ –ø–∞–º—è—Ç—å –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏.
            '''
        state = getattr(self, '_hack_state', None)
        # (re)–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        '''
–ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ—Ç –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞ —Ä–∞–∑–º–µ—Ä, —Ç–æ –Ω–∞–¥–æ –≤—Å—ë –ø–æ-–Ω–æ–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
        '''
        if (state is None) or (state.get('size') != (w, h)):
            # —Å–µ—Ç–∫–∞ –±–ª–æ–∫–æ–≤
            '''
–¢—É—Ç –º—ã –¥–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –±–ª–æ–∫–∏.
target_block_pixels = 64 ‚Äì –∫–∞–∂–¥—ã–π –∫—É—Å–æ–∫ –ø—Ä–∏–º–µ—Ä–Ω–æ 64 –ø–∏–∫—Å–µ–ª—è –≤ —à–∏—Ä–∏–Ω—É/–≤—ã—Å–æ—Ç—É.
cols –∏ rows ‚Äì —Å–∫–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–æ–∫ –∏ —Å—Ç—Ä–æ–∫ –ø–æ–ª—É—á–∏—Ç—Å—è. –ú–∏–Ω–∏–º—É–º 4, –º–∞–∫—Å–∏–º—É–º 36.
            '''
            target_block_pixels = 64
            cols = max(4, min(36, w // target_block_pixels))
            rows = max(4, min(36, h // target_block_pixels))

            # —Ä–∞–∑–º–µ—Ä—ã –∫–æ–ª–æ–Ω–æ–∫/—Å—Ç—Ä–æ–∫
            '''
–ö–æ—Ä–æ—á–µ, –¥–µ–ª–∏–º —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É —Ä–æ–≤–Ω–æ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏.
–ï—Å–ª–∏ –Ω–µ –¥–µ–ª–∏—Ç—Å—è –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞, —Ç–æ –ª–∏—à–Ω–∏–µ –ø–∏–∫—Å–µ–ª–∏ —Ä–∞—Å–∫–∏–¥—ã–≤–∞–µ–º –ø–æ –ø–µ—Ä–≤—ã–º –∫—É—Å–∫–∞–º.
            '''
            col_widths = [w // cols] * cols
            for i in range(w % cols):
                col_widths[i] += 1
            row_heights = [h // rows] * rows
            for i in range(h % rows):
                row_heights[i] += 1

            # —Ü–µ–ª–µ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            '''
–°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ (–≥–¥–µ –∫–∞–∂–¥—ã–π –±–ª–æ–∫ –¥–æ–ª–∂–µ–Ω –æ–∫–∞–∑–∞—Ç—å—Å—è).
–í target_positions —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª (x,y) –∏ —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞.
            '''
            target_positions = []
            y = 0
            for r in range(rows):
                x = 0
                for c in range(cols):
                    target_positions.append((x, y, col_widths[c], row_heights[r]))
                    x += col_widths[c]
                y += row_heights[r]

                '''
–î–µ–ª–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫—É –±–ª–æ–∫–æ–≤. –¢–∏–ø–∞ –≤—Å–µ –∫—É—Å–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç –Ω–µ –Ω–∞ —Å–≤–æ–∏—Ö –º–µ—Å—Ç–∞—Ö, –∞ –≥–¥–µ –ø–æ–ø–∞–ª–æ.
                '''
            N = len(target_positions)
            perm = np.arange(N)
            np.random.shuffle(perm)
            # —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –ø–µ—Ä–µ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏
            start_positions = [target_positions[int(perm[i])] for i in range(N)]

            # –≤—ã—Ä–µ–∑–∞–µ–º –±–ª–æ–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ (–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞)
            '''
–í—ã—Ä–µ–∑–∞–µ–º —Å–∞–º–∏ –∫—É—Å–∫–∏ –∏–∑ –∫–∞–¥—Ä–∞, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –∏—Ö –¥–≤–∏–≥–∞—Ç—å.
            '''
            blocks = []
            for (tx, ty, tw, th) in target_positions:
                blocks.append(frame[ty:ty+th, tx:tx+tw].copy())

            # —Å–ª—É—á–∞–π–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã –¥–≤–∏–∂–µ–Ω–∏—è –±—ã–ª–∏ –≤–∏–¥–∏–º—ã
            '''
–ö–∞–∂–¥–æ–º—É –±–ª–æ–∫—É –¥–∞—ë–º –∑–∞–¥–µ—Ä–∂–∫—É —Å—Ç–∞—Ä—Ç–∞ (—Ä–∞–Ω–¥–æ–º –æ—Ç 0 –¥–æ 0.36 —Å–µ–∫—É–Ω–¥—ã).
            '''
            delays = np.random.uniform(0.0, 0.36, size=N)

            '''
–°–æ–±–∏—Ä–∞–µ–º –≤—Å—ë —ç—Ç–æ –¥–æ–±—Ä–æ –≤ —Å–ª–æ–≤–∞—Ä—å (—Å–æ—Å—Ç–æ—è–Ω–∏–µ):
—Ä–∞–∑–º–µ—Ä—ã, —Å—Ç–∞—Ä—Ç/—Ñ–∏–Ω–∏—à –ø–æ–∑–∏—Ü–∏–π, –±–ª–æ–∫–∏, –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞.
–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ self._hack_state, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑.
            '''
            state = {
                'size': (w, h),
                'target_positions': target_positions,
                'start_positions': start_positions,
                'blocks': blocks,
                'delays': delays,
                'init_time': time.time(),
                'last_passed': prog_passed,
                'start_t': t,
            }
            self._hack_state = state

            '''
–î–æ—Å—Ç–∞—ë–º –≤—Å—ë –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å.
            '''
        blocks = state['blocks']
        target_positions = state['target_positions']
        start_positions = state['start_positions']
        delays = state['delays']
        N = len(blocks)

        # –≤—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π, –Ω–æ –µ—Å–ª–∏ –æ–Ω "–Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è",
        # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (fallback)
        '''
–¢—É—Ç —Ö–∏—Ç—Ä–∞—è —Å—Ö–µ–º–∞:
‚Äì –ï—Å–ª–∏ –≤—Ö–æ–¥–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ–∞–ª—å–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.
‚Äì –ï—Å–ª–∏ –Ω–µ—Ç (–∑–∞—Å—Ç—Ä—è–ª), —Ç–æ —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–∞–º–∏ –ø–æ —á–∞—Å–∞–º (elapsed / dur).
–¢–∞–∫ –º—ã –Ω–µ –∑–∞–≤–∏—Å–∏–º –æ—Ç –≥–ª—é—á–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.
        '''
        last_passed = state.get('last_passed', -1.0)
        if abs(prog_passed - last_passed) > 1e-6:
            progress = prog_passed
        else:
            # fallback –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            elapsed = time.time() - state.get('init_time', time.time())
            # –µ—Å–ª–∏ duration —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π –∏–ª–∏ –Ω—É–ª–µ–≤–æ–π, —Å—Ç–∞–≤–∏–º 1.5 —Å–µ–∫—É–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            dur = max(0.001, float(duration)) if float(duration) > 0.0 else 1.5
            progress = np.clip(elapsed / dur, 0.0, 1.0)

            '''
–û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å.
            '''
        state['last_passed'] = prog_passed

        # –∑–∞–≤–µ—Ä—à–µ–Ω–æ
        '''
–ï—Å–ª–∏ –≤—Å—ë —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å (–ø—Ä–æ–≥—Ä–µ—Å—Å = 1), —É–±–∏—Ä–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–¥—Ä –∫–∞–∫ –µ—Å—Ç—å.
        '''
        if progress >= 1.0:
            if hasattr(self, '_hack_state'):
                delattr(self, '_hack_state')
            return frame

        # –ø–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è
        '''
–§—É–Ω–∫—Ü–∏—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è (–∫—Ä–∏–≤–∞—è S-–æ–±—Ä–∞–∑–Ω–∞—è, —á—Ç–æ–±—ã –±–ª–æ–∫–∏ –∫—Ä–∞—Å–∏–≤–æ –¥–≤–∏–≥–∞¬≠–ª–∏—Å—å, –Ω–µ –¥—ë—Ä–≥–∞–ª–∏—Å—å).
        '''
        def smootherstep(x):
            x = np.clip(x, 0.0, 1.0)
            return x * x * x * (x * (x * 6 - 15) + 10)

        '''
–°–æ–∑–¥–∞—ë–º —á—ë—Ä–Ω—ã–π (–ø–æ—á—Ç–∏) —Ñ–æ–Ω, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å.
        '''
        out = np.full_like(frame, 6)  # —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω

        # –ª—ë–≥–∫–∏–π —à—É–º –≤ –Ω–∞—á–∞–ª–µ
        '''
–ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –µ—â—ë –Ω–µ –¥–æ—à—ë–ª –¥–æ —Å–µ—Ä–µ–¥–∏–Ω—ã,
–¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ —à—É–º–∞ (—Ä–∞–Ω–¥–æ–º–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏), —á—Ç–æ–±—ã —ç–∫—Ä–∞–Ω –º–µ—Ä—Ü–∞–ª.
–ê–ª—å—Ñ–∞ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É—Ö–æ–¥–∏—Ç –∫ –Ω—É–ª—é –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
        '''
        if progress < 0.6:
            noise_alpha = (0.6 - progress) / 0.6 * 0.22
            noise = np.random.randint(0, 256, (h, w, 1), dtype=np.uint8)
            noise = np.repeat(noise, 3, axis=2)
            out = cv2.addWeighted(out, 1.0 - noise_alpha, noise, noise_alpha, 0)

        # —Ä–∏—Å—É–µ–º –±–ª–æ–∫–∏ ‚Äî –∫–∞–∂–¥—ã–π —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–µ–π
        '''
–ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –±–ª–æ–∫–∏: –±–µ—Ä—ë–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –∏ —Ü–µ–ª–µ–≤—É—é –ø–æ–∑–∏—Ü–∏—é.
        '''
        for i in range(N):
            block = blocks[i]
            sx, sy, sw, sh = start_positions[i]
            tx, ty, tw, th = target_positions[i]

            '''
–°—á–∏—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –±–ª–æ–∫–∞ (—É—á–∏—Ç—ã–≤–∞—è –µ–≥–æ –∑–∞–¥–µ—Ä–∂–∫—É d).
–ï—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –µ—â—ë –º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∏ ‚Üí –±–ª–æ–∫ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è.
–ï—Å–ª–∏ –ø—Ä–æ—à—ë–ª ‚Üí –¥–≤–∏–≥–∞–µ–º –µ–≥–æ –ø–æ –∫—Ä–∞—Å–∏–≤–æ–π –∫—Ä–∏–≤–æ–π smootherstep.
            '''
            d = float(delays[i])
            if progress <= d:
                bp = 0.0
            else:
                denom = 1.0 - d
                bp = (progress - d) / denom if denom > 1e-6 else 1.0
                bp = np.clip(bp, 0.0, 1.0)
            e = smootherstep(bp)

            # –ø–æ–∑–∏—Ü–∏—è –∏ –∞–ª—å—Ñ–∞
            '''
–°—á–∏—Ç–∞–µ–º, –≥–¥–µ —Å–µ–π—á–∞—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–ª–æ–∫ (cx, cy). –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–æ–∂–µ —Ä–∞—Å—Ç—ë—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
            '''
            cx = int(round(sx + (tx - sx) * e))
            cy = int(round(sy + (ty - sy) * e))
            alpha = 0.3 + 0.7 * e

            # –≤—Å—Ç–∞–≤–∫–∞ —Å —É—á—ë—Ç–æ–º –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
            '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –±–ª–æ–∫ –Ω–µ –≤—ã–ª–µ–∑ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞–¥—Ä–∞.
–ï—Å–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç ‚Äì –ø–æ–¥—Ä–µ–∑–∞–µ–º –ø–æ –∫—Ä–∞—è–º.
–ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ä–µ–∑–∫–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å (ww <= 0 –∏–ª–∏ hh <= 0) ‚Äì —Å–∫–∏–ø–∞–µ–º —ç—Ç–æ—Ç –±–ª–æ–∫.
            '''
            x1, y1 = cx, cy
            x2, y2 = cx + sw, cy + sh
            bx1 = 0
            by1 = 0
            if x1 < 0:
                bx1 = -x1
                x1 = 0
            if y1 < 0:
                by1 = -y1
                y1 = 0
            if x2 > w:
                x2 = w
            if y2 > h:
                y2 = h
            ww = x2 - x1
            hh = y2 - y1
            if ww <= 0 or hh <= 0:
                continue


            '''
–í—Å—Ç–∞–≤–ª—è–µ–º –∫—É—Å–æ–∫ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É out, —Å–º–µ—à–∏–≤–∞—è —Å —Ñ–æ–Ω–æ–º –ø–æ –∞–ª—å—Ñ–µ.
            '''
            src = block[by1:by1+hh, bx1:bx1+ww]
            dst = out[y1:y1+hh, x1:x1+ww]
            cv2.addWeighted(src, float(alpha), dst, 1.0 - float(alpha), 0, dst)
            out[y1:y1+hh, x1:x1+ww] = dst

        # —Ç–æ–Ω–∫–∏–µ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–ª–æ—Å—ã –ø–æ–≤–µ—Ä—Ö, –∑–∞—Ç—É—Ö–∞—é—Ç –∫ –∫–æ–Ω—Ü—É
        '''
–î–æ–±–∞–≤–ª—è–µ–º –±–µ–ª—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã, —á—Ç–æ–±—ã –Ω–∞–ø–æ–º–∏–Ω–∞–ª–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π –≥–ª–∏—Ç—á.
–ß–µ–º –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É —ç—Ñ—Ñ–µ–∫—Ç–∞ ‚Üí —Ç–µ–º —Å–ª–∞–±–µ–µ –ø–æ–ª–æ—Å—ã.
        '''
        if progress < 0.95:
            lines_alpha = (1.0 - progress) * 0.22
            step = max(3, h // 150)
            for yy in range(0, h, step * 5):
                y2 = min(h, yy + step)
                out[yy:y2, :] = cv2.addWeighted(out[yy:y2, :], 1.0 - lines_alpha,
                                                np.full_like(out[yy:y2, :], 255), lines_alpha, 0)

        return out

    # 8. Contraband scan lines
    '''
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ—Ç–æ–¥ contraband_scan_lines.
–ë–µ—Ä—ë—Ç –∫–∞–¥—Ä (frame), –≤—Ä–µ–º—è (t), –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (duration)
–∏ –ø–∞—Ä—É –ø—Ä–∏–∫–æ–ª–æ–≤ ‚Äî strength (—Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞) –∏ quality (–∫–∞—á–µ—Å—Ç–≤–æ, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è).
    '''
    def contraband_scan_lines(self, frame, t, duration, strength=0.95, quality=0.6):
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        '''
‚Äì s: —Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞, –ø–æ–¥—Ä–µ–∑–∞–ª–∏ —á—Ç–æ–± –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∞ –∑–∞ 0..1, –∫–∞–∫ –±—É–¥—Ç–æ –Ω–∞—Ä–∫–æ—Ç—É –Ω–∞ –ø–æ—Å—Ç—É —Ä–µ–∂—É—Ç.
‚Äì q: —Ç–æ –∂–µ —Å–∞–º–æ–µ, —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞.
‚Äì tt: –≤—Ä–µ–º—è. –ï—Å–ª–∏ t –Ω–µ—Ç, —Å—Ç–∞–≤–∏–º –Ω–æ–ª—å, —á—Ç–æ–± –Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å.
        '''
        s = float(np.clip(strength, 0.0, 1.0))   # –æ–±—â–∞—è —Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞
        q = float(np.clip(quality, 0.0, 1.0))    # –∫–∞—á–µ—Å—Ç–≤–æ/–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è (–≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π)
        tt = float(t if t is not None else 0.0)

        '''
‚Äì –í–∑—è–ª–∏ –≤—ã—Å–æ—Ç—É –∏ —à–∏—Ä–∏–Ω—É –∫–∞–¥—Ä–∞.
‚Äì –ü—Ä–∏–≤–µ–ª–∏ –∫–∞–¥—Ä –≤ float32 –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª–∏ –æ—Ç 0 –¥–æ 1.
–¢–µ–ø–µ—Ä—å –≤—Å—ë —É–¥–æ–±–Ω–æ –º–µ—à–∞—Ç—å, –∫–∞–∫ –ø–æ—Ä–æ—à–æ–∫ –≤ –ø–∞–∫–µ—Ç–∏–∫–µ.
        '''
        h, w = frame.shape[:2]
        img = frame.astype(np.float32) / 255.0

        # 0) –ª—ë–≥–∫–∞—è –≥–ª–æ–±–∞–ª—å–Ω–∞—è –¥—Ä–æ–∂—å (cheap warp)
        '''
‚Äì wobble_x –∏ wobble_y: —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–µ–±–∞–Ω–∏—è –ø–æ —Å–∏–Ω—É—Å–∞–º ‚Äî –∫–∞–¥—Ä –±—É–¥–µ—Ç —Å–ª–µ–≥–∫–∞ –¥—Ä–æ–∂–∞—Ç—å,
–±—É–¥—Ç–æ VHS-–∫–∞—Å—Å–µ—Ç—É –ø–µ—Ä–µ–º–æ—Ç–∞–ª–∏.
‚Äì M: –º–∞—Ç—Ä–∏—Ü–∞ —Å–º–µ—â–µ–Ω–∏—è.
‚Äì warpAffine: –¥–≤–∏–≥–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É, –¥–æ–±–∞–≤–ª—è–µ–º –¥—Ä–æ–∂—å. –ì—Ä–∞–Ω–∏—Ü—ã –æ—Ç—Ä–∞–∂–∞–µ–º, —á—Ç–æ–± –¥—ã—Ä–∫–∏ –Ω–µ –±—ã–ª–æ.
        '''
        wobble_x = (0.6 + 3.0 * s * q) * np.sin(2.0 * np.pi * 0.07 * tt)
        wobble_y = (0.25 + 1.0 * s * q) * np.cos(2.0 * np.pi * 0.03 * tt)
        M = np.float32([[1, 0, wobble_x], [0, 1, wobble_y]])
        img = cv2.warpAffine((img * 255).astype(np.uint8), M, (w, h),
                             flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT).astype(np.float32) / 255.0

        # 1) cheap chroma shift (warp per-channel small offsets) ‚Äî –∑–∞–º–µ—Ç–Ω–æ, –Ω–æ –¥–µ—à–µ–≤–æ
        '''
‚Äì –†–∞–∑–±–∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∫–∞–Ω–∞–ª—ã: —Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∫—Ä–∞—Å–Ω—ã–π.
‚Äì dx_r –∏ dx_b: —Å–¥–≤–∏–≥–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π –∏ —Å–∏–Ω–∏–π –∫–∞–Ω–∞–ª—ã –Ω–∞ –ø–∞—Ä—É –ø–∏–∫—Å–µ–ª–µ–π.
‚Äì Mr, Mb: –º–∞—Ç—Ä–∏—Ü—ã —Å–¥–≤–∏–≥–∞.
‚Äì warpAffine: —Å–¥–≤–∏–≥–∞–µ–º –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª –æ—Ç–¥–µ–ª—å–Ω–æ.
‚Äì merge: —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ.
–≠—Ñ—Ñ–µ–∫—Ç ‚Äî –¥–µ—à—ë–≤—ã–π —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–±–µ—Ä, –±—É–¥—Ç–æ —Ç–µ–ª–∏–∫ –±–µ–∑ –∞–Ω—Ç–µ–Ω–Ω—ã –ª–æ–≤–∏—Ç.
        '''
        bch, gch, rch = cv2.split((img * 255).astype(np.uint8))
        dx_r = int(round(1 + 2.5 * s * q * np.sin(tt * 1.9)))
        dx_b = -int(round(1 + 1.8 * s * q * np.cos(tt * 1.3)))
        Mr = np.float32([[1, 0, dx_r], [0, 1, 0.15 * dx_r]])
        Mb = np.float32([[1, 0, dx_b], [0, 1, -0.12 * dx_b]])
        r_w = cv2.warpAffine(rch, Mr, (w, h), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        b_w = cv2.warpAffine(bch, Mb, (w, h), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        img = cv2.merge([b_w, gch, r_w]).astype(np.float32) / 255.0

        # 2) posterize / comic palette (—á—ë—Ç–∫–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è ¬´–ø–ª–∏—Ç–∫–∞¬ª)
        '''
‚Äì levels: —Å–∫–æ–ª—å–∫–æ –≥—Ä–∞–¥–∞—Ü–∏–π —Ü–≤–µ—Ç–∞ –æ—Å—Ç–∞–≤–∏—Ç—å (–æ—Ç 4 –¥–æ 16).
‚Äì –û–≥—Ä—É–±–ª—è–µ–º —Ü–≤–µ—Ç–∞: –ø–æ—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è, –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞–∫ –∏–∑ –∫–æ–º–∏–∫—Å–æ–≤.
        '''
        levels = int(4 + 12 * q * s)  # 4..16
        if levels < 2:
            levels = 2
        img = np.floor(img * levels) / max(1.0, levels - 1)

        # 3) —è—Ä–∫–∏–µ —á–µ—Ä–Ω–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã (Sobel + threshold) ‚Äî –∫–æ–º–∏–∫—Å‚Äë—Å—Ç–∏–ª—å
        '''
‚Äì –ü–µ—Ä–µ–≤–µ–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ —á/–±.
‚Äì –†–∞–∑–º—ã–ª–∏ —Å–ª–µ–≥–∫–∞, —á—Ç–æ–± —à—É–º —É–±—Ä–∞—Ç—å.
‚Äì Sobel: –∏—â–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –ø–æ x –∏ y.
‚Äì grad: –¥–ª–∏–Ω–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ = —Å–∏–ª–∞ –∫—Ä–∞—è.
‚Äì edge: –≤—ã–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–∏–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã.
‚Äì –£–º–Ω–æ–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ (1 ‚Äì –∫–æ–µ—Ñ. –∫—Ä–∞—è): –ø–æ–ª—É—á–∞—é—Ç—Å—è –∂–∏—Ä–Ω—ã–µ —á—ë—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏, –±—É–¥—Ç–æ –æ–±–≤–µ–¥–µ–Ω–æ –º–∞—Ä–∫–µ—Ä–æ–º.
        '''
        gray = cv2.cvtColor((img * 255).astype(np.uint8), cv2.COLOR_BGR2GRAY).astype(np.float32) / 255.0
        # –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–∑–º—ã—Ç–∏–µ –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫—Ä–∞–µ–≤
        blur_g = cv2.GaussianBlur((gray * 255).astype(np.uint8), (3, 3), 0).astype(np.float32) / 255.0
        gx = cv2.Sobel(blur_g, cv2.CV_32F, 1, 0, ksize=3)
        gy = cv2.Sobel(blur_g, cv2.CV_32F, 0, 1, ksize=3)
        grad = np.sqrt(gx * gx + gy * gy)
        # –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥: —Å–∏–ª—å–Ω–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–µ–º s
        edge = np.clip((grad - 0.08 * (1 - q)) * (6.0 * s), 0.0, 1.0)
        # –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —á—ë—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏: final_line = edge**gamma
        edge_alpha = np.expand_dims(edge, 2)
        # apply as multiply darkening for –∫–æ–º–∏–∫—Å-lines
        img = img * (1.0 - 0.9 * edge_alpha)

        # 4) –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–µ —Å–∫–∞–Ω–ª–∞–π–Ω—ã (—Å–∏–Ω—É—Å –ø–æ —Å—Ç—Ä–æ–∫–∞–º + colour bias)
        '''
‚Äì rows: –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫.
‚Äì scan: —Å–∏–Ω—É—Å –ø–æ —Å—Ç—Ä–æ–∫–∞–º ‚Äî –ø–æ–ª—É—á–∞–µ–º —Ç—ë–º–Ω—ã–µ –ø–æ–ª–æ—Å—ã (scanlines), –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä–æ–º –º–æ–Ω–∏—Ç–æ—Ä–µ.
‚Äì color_bias: –ª—ë–≥–∫–∏–π —Å–¥–≤–∏–≥ —Ü–≤–µ—Ç–∞ –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ–æ–Ω-–∫–æ–º–∏–∫—Å–∞.
‚Äì –£–º–Ω–æ–∂–∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –≤—Å—ë —ç—Ç–æ.
        '''
        rows = np.arange(h, dtype=np.float32)[:, None]
        period = max(2.0, 3.0 - 1.2 * q)   # —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –¥–µ–ª–∞–µ—Ç –ª–∏–Ω–∏–∏ –ø–ª–æ—Ç–Ω–µ–µ
        phase = 2.0 * np.sin(2.0 * np.pi * 0.6 * tt)
        scan_strength = 0.55 * s
        scan = 1.0 - scan_strength * (0.5 + 0.5 * np.sin(2.0 * np.pi * (rows / period + phase)))
        scan = np.clip(scan, 0.18, 1.05)[:, :, None]
        # –ª—ë–≥–∫–∏–π —Ü–≤–µ—Ç–æ–≤–æ–π bias –Ω–∞ —Å—Ç—Ä–æ–∫–∞—Ö ‚Äî –∫–æ–º–∏–∫—Å‚Äë–Ω–µ–æ–Ω
        r_bias = 1.02 + 0.06 * s * np.sin(rows * 0.07 + tt * 1.8)
        g_bias = 0.98 + 0.04 * s * np.cos(rows * 0.05 + tt * 1.6)
        b_bias = 0.94 + 0.05 * s * np.sin(rows * 0.08 - tt * 1.2)
        color_bias = np.concatenate([b_bias[:, :, None], g_bias[:, :, None], r_bias[:, :, None]], axis=2)
        img = img * scan * color_bias

        # 5) halftone / dots (cheap sinusoidal dot mask per channel) ‚Äî –¥–∞—ë—Ç –∫–æ–º–∏–∫—Å–æ–≤—ã–µ –±–ª–∏–∫–∏
        # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã dot
        '''
‚Äì –ì–µ–Ω–µ—Ä–∏–º —Å–µ—Ç–∫—É –∫–æ—Å–∏–Ω—É—Å–æ–≤, –∫–∞–∫ —Ç–æ—á–∫–∏ –≤ –≥–∞–∑–µ—Ç–Ω–æ–π –ø–µ—á–∞—Ç–∏ (halftone).
‚Äì –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å–≤–æ—è —Ñ–∞–∑–∞ ‚Üí –æ—â—É—â–µ–Ω–∏–µ CMY –ø–µ—á–∞—Ç–∏.
‚Äì mask: –≥–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ—á–∫–∏ (–ø–æ —è—Ä–∫–æ—Å—Ç–∏).
‚Äì –£–º–Ω–æ–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã ‚Üí –ø–æ–ª—É—á–∞—é—Ç—Å—è –∫–æ–º–∏–∫—Å–æ–≤—ã–µ –±–ª–∏–∫–∏ —Ç–æ—á–∫–∞–º–∏.
        '''
        freq = 2.0 + 6.0 * (1.0 - q)  # –±–æ–ª—å—à–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ ‚Äî –∫—Ä—É–ø–Ω–µ–µ
        xv = (np.linspace(0, 2 * np.pi * freq, w))[None, :].astype(np.float32)
        yv = (np.linspace(0, 2 * np.pi * freq, h))[:, None].astype(np.float32)
        # –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–∑ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ ‚Äî –æ—â—É—â–µ–Ω–∏–µ CMY halftone
        dot_r = 0.5 + 0.5 * np.cos(xv * 1.0 + yv * 0.7 + tt * 4.1)
        dot_g = 0.5 + 0.5 * np.cos(xv * 0.9 + yv * 0.8 + tt * 3.3 + 1.2)
        dot_b = 0.5 + 0.5 * np.cos(xv * 1.1 + yv * 0.6 + tt * 2.7 + 2.3)
        dot_strength = 0.18 * s * (0.6 + 0.4 * q)
        # Blend halftone: darken bright areas more (gives comic dot shading)
        lum = 0.299 * img[:, :, 2] + 0.587 * img[:, :, 1] + 0.114 * img[:, :, 0]
        mask = np.clip((lum - 0.25) / 0.6, 0.0, 1.0)  # where halftone visible
        halfr = (1.0 - dot_strength * dot_r * mask)[:, :, None]
        halfg = (1.0 - dot_strength * dot_g * mask)[:, :, None]
        halfb = (1.0 - dot_strength * dot_b * mask)[:, :, None]
        img[:, :, 2] *= halfr[:, :, 0]
        img[:, :, 1] *= halfg[:, :, 0]
        img[:, :, 0] *= halfb[:, :, 0]

        # 6) Ghost / color streak ‚Äî –æ–¥–∏–Ω —Ä–µ–∑–∫–∏–π —Å–¥–≤–∏–≥ + blur (–±—ã—Å—Ç—Ä–æ: downscale blur)
        '''
‚Äì –ï—Å–ª–∏ —Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–æ—Ä–º, –¥–µ–ª–∞–µ–º ¬´–ø—Ä–∏–∑—Ä–∞–∫¬ª: —Ä–∞–∑–º—ã–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É, —Å–¥–≤–∏–Ω—É–ª–∏, –ø–æ–∫—Ä–∞—Å–∏–ª–∏ –≤ –æ—Ç—Ç–µ–Ω–æ–∫.
‚Äì –î–æ–±–∞–≤–ª—è–µ–º –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è –¥–≤–æ–π–Ω–∏–∫ —Å —Ü–≤–µ—Ç–Ω—ã–º —à–ª–µ–π—Ñ–æ–º.
        '''
        ghost_amount = 0.15 * s * q
        if ghost_amount > 0.01:
            small = cv2.resize((img * 255).astype(np.uint8), (max(32, w // 8), max(32, h // 8)), interpolation=cv2.INTER_LINEAR)
            # –ª—ë–≥–∫–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ
            small = cv2.GaussianBlur(small, (3, 3), sigmaX=1.5)
            up = cv2.resize(small, (w, h), interpolation=cv2.INTER_LINEAR).astype(np.float32) / 255.0
            dx = int(round((3 + 6 * s) * np.sin(tt * 1.7)))
            dy = int(round((1 + 3 * s) * np.cos(tt * 1.1)))
            Mg = np.float32([[1, 0, dx], [0, 1, dy]])
            shifted = cv2.warpAffine((up * 255).astype(np.uint8), Mg, (w, h),
                                     flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT).astype(np.float32) / 255.0
            tint = np.array([0.95 + 0.08 * np.sin(tt * 1.3), 1.0, 1.02 - 0.06 * np.cos(tt * 0.9)])
            img += shifted * tint[None, None, :] * ghost_amount

        # 7) –Ω–µ–±–æ–ª—å—à–æ–π bloom –¥–ª—è —è—Ä–∫–∏—Ö –∑–æ–Ω (cheap downscale blur)
        '''
‚Äì –ò—â–µ–º —è—Ä–∫–∏–µ –∑–æ–Ω—ã.
‚Äì –ï—Å–ª–∏ –µ—Å—Ç—å, –¥–µ–ª–∞–µ–º downscale, —Ä–∞–∑–º—ã–≤–∞–µ–º –∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ.
‚Äì –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ glow.
–¢–∏–ø–∞ –æ—Ä–µ–æ–ª —É —è—Ä–∫–∏—Ö –º–µ—Å—Ç.
        '''
        lum = 0.299 * img[:, :, 2] + 0.587 * img[:, :, 1] + 0.114 * img[:, :, 0]
        bright_mask = np.clip((lum - 0.65) / 0.35, 0.0, 1.0)
        if bright_mask.mean() > 0.005 and s > 0.05:
            small = cv2.resize((img * 255).astype(np.uint8), (max(16, w // 12), max(16, h // 12)),
                               interpolation=cv2.INTER_LINEAR)
            small = cv2.GaussianBlur(small, (5, 5), sigmaX=2.0)
            up = cv2.resize(small, (w, h), interpolation=cv2.INTER_LINEAR).astype(np.float32) / 255.0
            img += up * (0.35 * s * q) * bright_mask[:, :, None]

        # 8) tape noise / banding: low-res noise upsample + occasional scratches
        '''
‚Äì –ì–µ–Ω–µ—Ä–∏–º —à—É–º –Ω–∏–∑–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º ‚Üí –ø–æ–ª—É—á–∞–µ–º VHS —à—É–º.
‚Äì –° —à–∞–Ω—Å–æ–º scratch_prob –∫–∏–¥–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Ü–∞—Ä–∞–ø–∏–Ω—ã.
‚Äì –†–∞–∑–º–∞–∑—ã–≤–∞–µ–º –∏—Ö –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º.
        '''
        rng = np.random.RandomState(int((tt * 1000) % (2 ** 31)))
        noise_small = rng.normal(loc=0.0, scale=0.05 * (1.0 - q) + 0.015 * q, size=(max(8, h // 12), max(8, w // 12))).astype(np.float32)
        noise = cv2.resize(noise_small, (w, h), interpolation=cv2.INTER_LINEAR)
        img += noise[:, :, None] * (0.12 * s)
        # —Ä–µ–¥–∫–∏–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Ü–∞—Ä–∞–ø–∏–Ω—ã
        scratch_prob = 0.0009 + 0.0018 * s
        mask = (rng.rand(h, w) < scratch_prob).astype(np.float32)
        if mask.sum() > 0:
            scratch = cv2.blur(mask, (1, max(1, int(30 * s))))
            img += scratch[:, :, None] * (0.6 * s)

        # 9) final color punch + vignette + clamp
        # –ª—ë–≥–∫–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ (s-curve approx)
        '''
‚Äì –ü–æ–¥—Ä–µ–∑–∞–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∫ 0..1.
‚Äì –ö–∏–Ω—É–ª S-–æ–±—Ä–∞–∑–Ω—É—é –∫—Ä–∏–≤—É—é –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞.
‚Äì –î–æ–±–∞–≤–∏–ª–∏ –æ—Ç—Ç–µ–Ω–æ–∫: –∫—Ä–∞—Å–Ω—ã–π —á—É—Ç—å —É—Å–∏–ª–∏–ª–∏, —Å–∏–Ω–∏–π —á—É—Ç—å —É–±–∞–≤–∏–ª–∏ ‚Üí VHS –≤–∞–π–±.
‚Äì –í–∏–Ω—å–µ—Ç–∫–∞: –∑–∞—Ç–µ–º–Ω—è–µ–º –∫—Ä–∞—è, —Ü–µ–Ω—Ç—Ä —è—Ä—á–µ.
        '''
        img = np.clip(img, 0.0, 1.0)
        img = 0.5 * (np.tanh((img - 0.5) * (1.0 + 1.8 * s * q)) + 1.0)
        # magenta / cyan tint for VHS comic flavor
        img[:, :, 2] = np.clip(img[:, :, 2] * (1.02 + 0.06 * s), 0.0, 1.0)  # R up
        img[:, :, 0] = np.clip(img[:, :, 0] * (0.98 - 0.04 * s), 0.0, 1.0)  # B down
        # vignette
        xv = (np.linspace(-1.0, 1.0, w))[None, :].repeat(h, axis=0)
        yv = (np.linspace(-1.0, 1.0, h))[:, None].repeat(w, axis=1)
        radius = np.sqrt(xv * xv + yv * yv)
        vign = 1.0 - 0.6 * (radius ** (1.2 + 0.8 * (1.0 - q)))  # softer if lower quality
        img *= vign[:, :, None]

        out = (np.clip(img, 0.0, 1.0) * 255.0).astype(np.uint8)
        return out

    # 9. Territory split pan
    '''
–¢–∏–ø–∞ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
‚Äî –±—É–¥—Ç–æ –ø–∞–Ω–æ—Ä–∞–º–∞ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –¥–≤–µ –ø–æ–ª–æ–≤–∏–Ω—ã –∏ –æ–Ω–∏ —É–µ–∑–∂–∞—é—Ç –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã.
    '''
    def territory_split_pan(self, frame, t, duration):
        h, w = frame.shape[:2]
        """
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ñ—Ñ–µ–∫—Ç–∞: –∫–∞–∫–æ–µ —Å–µ–π—á–∞—Å –≤—Ä–µ–º—è (t) –¥–µ–ª–∏–º –Ω–∞ –æ–±—â–µ–µ (duration).
–ö–æ—Ä–æ—á–µ, –ø–æ–ª—É—á–∞–µ–º —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 1, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ñ—Ñ–µ–∫—Ç —É–∂–µ –ø—Ä–æ–¥–≤–∏–Ω—É–ª—Å—è.
        """
        progress = t/duration
        """
–ë–µ—Ä—ë–º —Å–µ—Ä–µ–¥–∏–Ω—É —à–∏—Ä–∏–Ω—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏.
// ‚Äî —ç—Ç–æ —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—Ä–æ–±–µ–π.
–¢–∏–ø–∞ –¥–µ–ª–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –ª–µ–≤—É—é –∏ –ø—Ä–∞–≤—É—é –ø–æ–ª–æ–≤–∏–Ω—É.
        """
        mid = w//2
        """
–û—Ç—Ä–µ–∑–∞–µ–º –ª–µ–≤—É—é –ø–æ–ª–æ–≤–∏–Ω—É –∫–∞–¥—Ä–∞.
: –ø–æ –≤—ã—Å–æ—Ç–µ –∑–Ω–∞—á–∏—Ç –±–µ—Ä—ë–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –∞ :mid –ø–æ —à–∏—Ä–∏–Ω–µ ‚Äî —Ç–æ–ª—å–∫–æ –¥–æ —Å–µ—Ä–µ–¥–∏–Ω—ã.
        """
        left = frame[:, :mid]
        """
–ê —ç—Ç–æ –ø—Ä–∞–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –∫–∞–¥—Ä–∞.
–ë–µ—Ä—ë–º –≤—Å—ë –ø–æ—Å–ª–µ —Å–µ—Ä–µ–¥–∏–Ω—ã –∏ –¥–æ –∫–æ–Ω—Ü–∞ —à–∏—Ä–∏–Ω—ã.
        """
        right = frame[:, mid:]
        """
–°—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ —Å–¥–≤–∏–Ω—É—Ç—å –ø–æ–ª–æ–≤–∏–Ω–∫–∏.
–ß–µ–º –¥–∞–ª—å—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å (0 ‚Üí 1), —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–¥–≤–∏–≥–∞–µ–º.
w//2 ‚Äî —ç—Ç–æ –ø–æ–ª–æ–≤–∏–Ω–∞ —à–∏—Ä–∏–Ω—ã, –∑–Ω–∞—á–∏—Ç –º–∞–∫—Å–∏–º—É–º –ø–æ–ª–æ–≤–∏–Ω–∫–∏ —É–µ–¥—É—Ç –Ω–∞ –ø–æ–ª—à–∏—Ä–∏–Ω—ã –∫–∞–¥—Ä–∞.
        """
        shift = int(progress * w//2)
        """
–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π –∫–∞–¥—Ä (new_frame), –∑–∞–±–∏—Ç—ã–π –Ω—É–ª—è–º–∏ (—á—ë—Ä–Ω—ã–π —Ñ–æ–Ω).
–û–Ω —Ç–∞–∫–æ–π –∂–µ —Ñ–æ—Ä–º—ã, –∫–∞–∫ frame.
        """
        new_frame = np.zeros_like(frame)
        """
–ë–µ—Ä—ë–º –ª–µ–≤—É—é –ø–æ–ª–æ–≤–∏–Ω—É –∏ –¥–≤–∏–≥–∞–µ–º –µ—ë –≤–ª–µ–≤–æ –Ω–∞ shift –ø–∏–∫—Å–µ–ª–µ–π (-shift).
axis=1 –∑–Ω–∞—á–∏—Ç –¥–≤–∏–≥–∞–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (–ø–æ —à–∏—Ä–∏–Ω–µ).
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–∏—Ö–∞–µ–º —ç—Ç—É —Å–¥–≤–∏–Ω—É—Ç—É—é –ª–µ–≤—É—é —á–∞—Å—Ç—å –≤ –Ω–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É, –≤ –ª–µ–≤—É—é –æ–±–ª–∞—Å—Ç—å.
        """
        new_frame[:, :mid] = np.roll(left, -shift, axis=1)
        """
–ê —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞: –¥–≤–∏–≥–∞–µ–º –µ—ë –≤–ø—Ä–∞–≤–æ (+shift).
–¢–æ–∂–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (axis=1).
–ò –≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –º–µ—Å—Ç–æ –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏.
        """
        new_frame[:, mid:] = np.roll(right, shift, axis=1)
        """
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä, –≥–¥–µ –ª–µ–≤–∞—è —á–∞—Å—Ç—å —É–µ—Ö–∞–ª–∞ –≤–ª–µ–≤–æ, –ø—Ä–∞–≤–∞—è –≤–ø—Ä–∞–≤–æ.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∫–∏–±–µ—Ä–ø–∞–Ω–∫–æ–≤—ã–π "—Ä–∞–∑—Ä—ã–≤ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏", –±—É–¥—Ç–æ —ç–∫—Ä–∞–Ω —Ä–∞–∑—ä–µ–∑–∂–∞–µ—Ç—Å—è –ø–æ –±–æ–∫–∞–º.
        """
        return new_frame

    # 10. Amnesty color shift
    def amnesty_color_shift(self, frame, t, duration):
        progress = t/duration
        '''
–ê –≤–æ—Ç —Ç—É—Ç –±—Ä–∞—Ç–∞–Ω –¥–µ–ª–∞–µ—Ç —Ö–∏—Ç—Ä—É—é —Ö–∏–º–∏—é:
–ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ –æ–±—ã—á–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ (BGR) –≤ HSV.
HSV ‚Äî —ç—Ç–æ –≥–¥–µ —Ü–≤–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ, —è—Ä–∫–æ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.
–ê –ø–æ—Ç–æ–º –∫–∏–¥–∞–µ—Ç –≤—Å—ë —ç—Ç–æ –≤ float32,
—á—Ç–æ–± –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ –∫—Ä–∞—Å–æ—Ç–µ –∫—Ä—É—Ç–∏—Ç—å —á–∏—Å–ª–∞, –Ω–µ —Ç–µ—Ä—è—è —Ç–æ—á–Ω–æ—Å—Ç–∏.
        '''
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV).astype(np.float32)
        '''
–í–æ—Ç —Ç—É—Ç –≤–æ–æ–±—â–µ –º—è—Å–æ:

hsv[:,:,0] ‚Äî —ç—Ç–æ "–æ—Ç—Ç–µ–Ω–æ–∫", –∫–æ—Ä–æ—á–µ —Å–∞–º–∞ –∫—Ä–∞—Å–∫–∞.

–ú—ã –∫ –Ω–µ–º—É –ø—Ä–∏–±–∞–≤–ª—è–µ–º progress*90 ‚Äî –∑–Ω–∞—á–∏—Ç,
—á–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–¥–≤–∏–≥–∞–µ–º —Ü–≤–µ—Ç–æ–≤—É—é –≥–∞–º–º—É.

% 180 ‚Äî —ç—Ç–æ —á—Ç–æ–±—ã –≤—Å—ë –Ω–µ —É–ª–µ—Ç–µ–ª–æ –≤ –∑–∞–∫–∞—Ç, –∞ –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ —Ü–≤–µ—Ç–æ–≤ (0‚Äì179).

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, –±—Ä–∞—Ç,
–∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –∫—Ä–∞—Å–∏—à—å —Å—Ç–µ–Ω—ã –≤ —Ö–∞—Ç–µ
–∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ —á—É—Ç—å –º–µ–Ω—è–µ—à—å –±–∞–Ω–∫—É –∫—Ä–∞—Å–∫–∏.
–í –Ω–∞—á–∞–ª–µ –±–µ–ª–æ–µ, –ø–æ—Ç–æ–º –∑–µ–ª—ë–Ω–æ–µ, –ø–æ—Ç–æ–º —Å–∏–Ω–µ–µ,
–∏ —Ç–∞–∫ –¥–æ –∫–æ–Ω—Ü–∞ –∑–∞–º–µ—Å–∞. –í–æ—Ç –æ–Ω–æ –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç—É—Ç.

        '''
        hsv[:,:,0] = (hsv[:,:,0] + progress*90) % 180
        '''
–¢–µ–ø–µ—Ä—å –æ–±—Ä–∞—Ç–Ω–æ: –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤—Å—ë –∏–∑ HSV –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç–∞ (BGR), —á—Ç–æ–± –≥–ª–∞–∑ –≤–∏–¥–µ–ª.
–ü–µ—Ä–µ–¥ —ç—Ç–∏–º —á–∏—Å–ª–∞ —É–∂–∏–º–∞–µ–º –¥–æ uint8, –∏–Ω–∞—á–µ OpenCV –Ω–∞—á–Ω—ë—Ç –±—É–∑–∏—Ç—å.
        '''
        shifted = cv2.cvtColor(hsv.astype(np.uint8), cv2.COLOR_HSV2BGR)
        '''
–ù—É –∏ –Ω–∞ –≤—ã—Ö–æ–¥–µ –æ—Ç–¥–∞—ë–º –∫–∞—Ä—Ç–∏–Ω–∫—É —É–∂–µ —Å –ø–æ–¥–∫—Ä—É—á–µ–Ω–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏.
–¢–∏–ø–∞ —Ñ–∏–ª—å—Ç—Ä "–±–ª–∞—Ç–Ω–æ–π —Ä–∞–¥—É–≥–∏", –ø–æ–Ω—è–ª, –¥–∞?
        '''
        return shifted

    # 11. Blur pulse
    def blur_pulse(self, frame=None, t: float = 0.0,
                               freq: float = 3.5, max_blur: int = 15,
                               max_sat_mult: float = 3.5,
                               chroma_shift_px: float = 6.0,
                               warp_amp_px: float = 6.0,
                               downscale_base: int = 2,
                               min_effect_thresh: float = 0.02) -> np.ndarray:
        """
        –ü—É–ª—å—Å–∞—Ü–∏—è —Å —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ–º –∏–Ω–≤–µ—Ä—Å–∏–∏ <-> –≥–∏–ø–µ—Ä-–Ω–∞—Å—ã—â–µ–Ω–∏—è + —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è –∏ –≤–æ–ª–Ω–æ–≤–∞—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è.
        –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
        - —Ç—è–∂—ë–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–æ–ø–∏–∏ –∫–∞–¥—Ä–∞ –∏ –∑–∞—Ç–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ;
        - –∏—Å–ø–æ–ª—å–∑—É—é –±—ã—Å—Ç—Ä—ã–µ LUT/bitwise –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ numpy –æ–ø–µ—Ä–∞—Ü–∏–∏.
        """
        if frame is None:
            return frame
        # –¥–∞–ª–µ–µ –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä:
        h, w = frame.shape[:2]
        if frame.dtype != np.uint8:
            frame = np.clip(frame, 0, 255).astype(np.uint8)

        # –±–∞–∑–æ–≤–∞—è —Ñ–∞–∑–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1, –∏—Å–ø–æ–ª—å–∑—É–µ–º abs(sin) –¥–ª—è ¬´–ø—É–ª—å—Å–∞—Ü–∏–∏¬ª
        phase = t * freq
        progress = abs(math.sin(phase))  # 0..1

        # –±—ã—Å—Ç—Ä–æ–µ —Ä–∞–Ω–Ω–µ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –º–∏–Ω–∏–º–∞–ª–µ–Ω
        if progress <= min_effect_thresh:
            return frame

        # –≤—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—á—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã)
        # —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º downscale –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º —ç—Ñ—Ñ–µ–∫—Ç–µ, —á—Ç–æ–±—ã blur/bloom –±—ã–ª–∏ –¥–µ—à—ë–≤—ã–º–∏
        scale = int(downscale_base + progress * 2)  # 2..4 –æ–±—ã—á–Ω–æ
        sx = max(1, w // scale)
        sy = max(1, h // scale)

        # —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –∫–æ–ø–∏—è –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        small = cv2.resize(frame, (sx, sy), interpolation=cv2.INTER_LINEAR)

        # —Ä–∞–∑–º—ã—Ç–∏–µ (Gaussian –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ)
        add = int(progress * max_blur)
        ksize = 1 + add
        if ksize % 2 == 0:
            ksize += 1
        if ksize <= 1:
            blurred_small = small
        else:
            # –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ª—ë–≥–∫–∏–π blur –ø—Ä–∏ –±–æ–ª—å—à–æ–º scale (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—É—Å–ª–æ–∂–Ω—è—Ç—å)
            blurred_small = cv2.GaussianBlur(small, (ksize, ksize), 0)

        # bloom: –±–µ—Ä–µ–º —è—Ä–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏, —Ä–∞–∑–º—ã–≤–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ (–Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–π –∫–æ–ø–∏–∏)
        hsv_small = cv2.cvtColor(blurred_small, cv2.COLOR_BGR2HSV).astype(np.float32)
        h_s, s_s, v_s = cv2.split(hsv_small)
        # –º–∞—Å–∫–∞ —è—Ä–∫–∏—Ö –ø–∏–∫—Å–µ–ª–µ–π (–Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–π)
        bright_mask = (v_s > 180).astype(np.float32)
        # –±—ã—Å—Ç—Ä—ã–π bloom: —Ä–∞–∑–º—ã—Ç–∏–µ –º–∞—Å–∫–∏ –∏ —É–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ —è—Ä–∫–æ—Å—Ç—å
        mask_blur = cv2.GaussianBlur((bright_mask * v_s).astype(np.uint8), (ksize|1, ksize|1), 0).astype(np.float32)
        bloom_small = np.clip(blurred_small.astype(np.float32) + (mask_blur[..., None] * 0.25), 0, 255).astype(np.uint8)

        # —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–æ –ø—É–ª—å—Å—É
        pulse_idx = int(math.floor(phase / math.pi))
        even = (pulse_idx % 2) == 0

        if even:
            # –ò–Ω–≤–µ—Ä—Å–∏—è + –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è + –º—è–≥–∫–∏–π bloom
            inv_small = cv2.bitwise_not(bloom_small)

            alpha = float(progress)  # —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
            mixed_small = cv2.addWeighted(bloom_small, 1.0 - alpha, inv_small, alpha, 0)

            # –≤–æ–ª–Ω–æ–≤–∞—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è: —Å–æ–∑–¥–∞—ë–º —Å–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
            yy, xx = np.mgrid[0:sy, 0:sx].astype(np.float32)
            # —Ñ–∞–∑–æ–≤—ã–π —Å–¥–≤–∏–≥ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º, –∞–º–ø–ª–∏—Ç—É–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç progress
            amp = warp_amp_px * (progress)
            # —á–∞—Å—Ç–æ—Ç–∞ –º–æ–∂–Ω–æ –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å; –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é —Å–∏–Ω—É—Å–æ–≤
            dx = (np.sin((yy / sy) * 2.0 * math.pi * (1.0 + progress*2.0) + phase) +
                  0.5 * np.sin((xx / sx) * 2.0 * math.pi * (1.0 + progress))) * amp / scale
            dy = (np.cos((xx / sx) * 2.0 * math.pi * (1.0 + progress*1.5) - phase) *
                  0.6) * amp / scale
            map_x = (xx + dx).astype(np.float32)
            map_y = (yy + dy).astype(np.float32)
            warped_small = cv2.remap(mixed_small, map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

            result_small = warped_small

        else:
            # –ì–∏–ø–µ—Ä-–Ω–∞—Å—ã—â–µ–Ω–∏–µ + —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è (—Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤) + –ª—ë–≥–∫–∏–π bloom
            # —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ small -> hsv -> scale S -> back
            hsv = cv2.cvtColor(bloom_small, cv2.COLOR_BGR2HSV).astype(np.float32)
            hh, ss, vv = cv2.split(hsv)
            factor = 1.0 + progress * (max_sat_mult - 1.0)
            ss *= factor
            np.clip(ss, 0, 255, out=ss)
            hsv = cv2.merge((hh, ss, vv)).astype(np.uint8)
            sat_small = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR)

            # —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è: —Å–¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
            shift = (chroma_shift_px * progress) / scale  # —É–º–µ–Ω—å—à–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ –º–∞–ª–æ–π –≤–µ—Ä—Å–∏–∏
            # —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è B,G,R
            M_b = np.float32([[1, 0, -shift], [0, 1, 0]])
            M_r = np.float32([[1, 0, shift], [0, 1, 0]])
            b, g, r = cv2.split(sat_small)
            b_s = cv2.warpAffine(b, M_b, (sx, sy), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
            r_s = cv2.warpAffine(r, M_r, (sx, sy), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
            merged = cv2.merge((b_s, g, r_s))

            # –º—è–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ bloom (—á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ —Å–æ—á–Ω–æ)
            result_small = cv2.addWeighted(merged, 1.0, blurred_small, 0.25 * progress, 0)

        # –∞–ø—Å–∫–µ–π–ª–∏–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        result = cv2.resize(result_small, (w, h), interpolation=cv2.INTER_LINEAR)

        # —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –º–∏–∫—Å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º ‚Äî –¥–∞—ë–º –Ω–µ–º–Ω–æ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
        final_alpha = 0.85 * progress  # 0..0.85
        out = cv2.addWeighted(frame, 1.0 - final_alpha, result, final_alpha, 0)

        return out

    # 12. Pixelation
    '''
–û–±—ä—è–≤–ª—è–µ–º —Ç–∞–∫—É—é –º—É—Ç–∫—É –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º pixelation.
–≠—Ç–æ —Ç–∏–ø–∞ —ç—Ñ—Ñ–µ–∫—Ç ‚Äî –¥–µ–ª–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–∏–∫—Å–µ–ª—å–Ω–æ–π,
–∫–∞–∫ –±—É–¥—Ç–æ —Å–º–æ—Ç—Ä–∏—à—å —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—É—é "–î–µ–Ω–¥–∏".
    '''
    def pixelation(self, frame, t, duration):
        '''
–ö–æ—Ä–æ—á–µ, —É–∑–Ω–∞—ë–º –≥–∞–±–∞—Ä–∏—Ç—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∫–∞–∫ —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É –ø–ª–∞–∑–º—ã —É –±–∞—Ä—ã–≥–∏.
        '''
        h,w = frame.shape[:2]
        """
        –¢—É—Ç —Å—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –±—É–¥–µ—Ç "–∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π".
–°–Ω–∞—á–∞–ª–∞ –≤—Å–µ–≥–¥–∞ –º–∏–Ω–∏–º—É–º 10,
–∞ –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –µ—â—ë –¥–æ 20,
–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ (t/duration).
–ö–æ—Ä–æ—á–µ, —á–µ–º –¥–∞–ª—å—à–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –ø–∏–∫—Å–µ–ª—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∂–∏—Ä–Ω—ã–º–∏, –∫–∞–∫ –ø–æ—Å–ª–µ –∫–∞—á–∞–ª–∫–∏.
        """
        scale = int(10 + 20*(t/duration))
        """
        –£–º–µ–Ω—å—à–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–æ –º–µ–ª–∫–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤, –¥–µ–ª–∏–º —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É –Ω–∞ —ç—Ç–æ—Ç scale.
–¢–∏–ø–∞ –±–µ—Ä—ë–º –∫–∞—Ä—Ç–∏–Ω–∫—É, —Å–∂–∏–º–∞–µ–º –µ—ë –∫–∞–∫ "—Å–∫—Ä–∏–Ω—à–æ—Ç –Ω–∞ –ù–æ–∫–∏–∏ 3310",
–∏ –æ–Ω–∞ —Ç–∞–∫–∞—è –º—É—Ç–Ω–∞—è –∏ –º–µ–ª–∫–∞—è.
interpolation=cv2.INTER_LINEAR ‚Äî —ç—Ç–æ –∫–∞–∫ —Å–ø–æ—Å–æ–± —Å–∂–∞—Ç–∏—è,
—á—Ç–æ–± –±—ã–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–Ω—å–∫–æ, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –º–∞–ª–µ–Ω—å–∫–æ–µ.
        """
        temp = cv2.resize(frame, (w//scale, h//scale), interpolation=cv2.INTER_LINEAR)
        """
        ‚Äî –ü–æ—Ç–æ–º –±–µ—Ä—ë–º —ç—Ç—É —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –º—É—Ç—å –∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω.
–ò –≤–æ—Ç –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏—è –ø–æ–ª—É—á–∞—é—Ç—Å—è –∑–¥–æ—Ä–æ–≤–µ–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏,
–ø—Ä—è–º —Ç–∞–∫–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–∏—Ä–ø–∏—á–∏, –∫–∞–∫ –ø–ª–∏—Ç–∫–∞ –≤ –ø–æ–¥–≤–∞–ª–µ.
interpolation=cv2.INTER_NEAREST ‚Äî —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–± —Ç—É–ø–æ –∫–æ–ø–∏—Ä—É–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç—ã –±–µ–∑ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è.
–í –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç –ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç–∞, –∫–∞–∫ –±—É–¥—Ç–æ —É —Ç–µ–±—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ —Ä–∞–π–æ–Ω–µ 90-—Ö.
        """
        return cv2.resize(temp,(w,h), interpolation=cv2.INTER_NEAREST)

    # 13. Heat haze
    """
–≠—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥ —ç—Ñ—Ñ–µ–∫—Ç: —Ä–∞–∑–º–µ—Ä –ø–ª–∏—Ç–∫–∏ (tile_size),
–±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Å–º–µ–Ω—ã (base_change_rate),
—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ (early_speed_mul).
–ü–æ—Ç–æ–º –∏–¥—É—Ç –ø—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã–µ –ø—Ä–∏–∫–æ–ª—ã: –∏–Ω–≤–µ—Ä—Å–∏—è —Ü–≤–µ—Ç–æ–≤ (prob_inv),
–¥–∏–∫–∞—è –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å (prob_sat), –≥–∏–ø–µ—Ä-—Ü–≤–µ—Ç–∞ (prob_hyper), —à—É–º (prob_noise).

seed ‚Äî —Ä–∞–Ω–¥–æ–º —Ñ–∏–∫—Å–∏—Ä—É–µ–º, —á—Ç–æ–± –∫–∞—à–∞ –Ω–µ –º–µ–Ω—è–ª–∞—Å—å –∫–∞–∂–¥—ã–π —Ä–∞–∑.
max_sat_mult ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –∑–∞–¥—Ä–∞—Ç—å –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å.
hyper_hue_shift ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–¥–≤–∏–≥–∞–µ–º —Ü–≤–µ—Ç –ø–æ –∫—Ä—É–≥—É.
lock_blend_window ‚Äî –ø–ª–∞–≤–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø—Ä–∏ "—Ñ–∏–∫—Å–∞—Ü–∏–∏".
soften_edges –∏ edge_blur_ksize ‚Äî —á—Ç–æ–±—ã —Å–≥–ª–∞–¥–∏—Ç—å –∫—Ä–∞—è –ø–ª–∏—Ç–æ–∫, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ.
    """
    def heat_haze(self, frame, t, duration=None,
                                    tile_size: int = 24,
                                    base_change_rate: float = 80.0,
                                    early_speed_mul: float = 1.8,
                                    prob_inv: float = 0.25,
                                    prob_sat: float = 0.25,
                                    prob_hyper: float = 0.2,
                                    prob_noise: float = 0.15,
                                    seed: int = 1337,
                                    max_sat_mult: float = 3.5,
                                    hyper_hue_shift: int = 40,
                                    lock_blend_window: float = 0.07,
                                    soften_edges: bool = False,
                                    edge_blur_ksize: int = 5) -> np.ndarray:
        """
        –ë—ã—Å—Ç—Ä–∞—è ¬´—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞¬ª –ø–ª–∏—Ç–∫–∞–º–∏, –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–æ–≥—Ä–µ—Å—Å—É (t/duration).
        –ö–æ–≥–¥–∞ duration –∑–∞–¥–∞–Ω ‚Äî p = clamp(t/duration, 0, 1).
        –ü—Ä–∏ p->1 –ø–ª–∏—Ç–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª.
        """
        '''
–ï—Å–ª–∏ –∫–∞–¥—Ä–∞ –Ω–µ—Ç ‚Äî –Ω—É –∏ –ø–æ—à—ë–ª –æ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—è–∫.
        '''
        if frame is None:
            return frame
        '''
–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É—Ä–∞–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –º–∞—Å—Å–∏–≤ (–Ω–µ—Ç .shape) ‚Äî —à–ª—ë–º –æ—à–∏–±–∫—É.
        '''
        if not hasattr(frame, "shape"):
            raise TypeError("rapid_decode_tiles_progress: –æ–∂–∏–¥–∞–ª—Å—è –∫–∞–¥—Ä (np.ndarray).")

        h, w = frame.shape[:2]
        """
–ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ uint8 (0..255 –Ω–∞ –∫–∞–Ω–∞–ª),
—Ç–æ –æ–±—Ä–µ–∑–∞–µ–º –ª–∏—à–Ω–µ–µ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º, —á—Ç–æ–± OpenCV –Ω–µ —Å–¥–æ—Ö.
        """
        if frame.dtype != np.uint8:
            frame = np.clip(frame, 0, 255).astype(np.uint8)

        # –ø—Ä–æ–≥—Ä–µ—Å—Å 0..1: –µ—Å–ª–∏ duration –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º t/duration,
        #–∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
        '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç 0 –¥–æ 1.
–ï—Å–ª–∏ –µ—Å—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –≤—Å—ë —á–∏–Ω–Ω–æ-–±–ª–∞–≥–æ—Ä–æ–¥–Ω–æ: –¥–µ–ª–∏–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—â—É—é –¥–ª–∏–Ω—É.
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–µ–ª–∞–µ–º —Å–∏–Ω—É—Å–æ–∏–¥—É, —Ç–∏–ø–∞ –∫–æ–ª–±–∞—Å–∏—Ç—Å—è —Ç—É–¥–∞-—Å—é–¥–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.

        '''
        if duration is not None and duration > 0:
            raw_p = float(t) / float(duration)
            p = max(0.0, min(1.0, raw_p))
        else:
            # —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π fallback ‚Äî –Ω–æ —Å–±–æ—Ä–∫–∏ –≤ –µ–¥–∏–Ω—ã–π –∫–∞–¥—Ä –Ω–µ –±—É–¥–µ—Ç, –µ—Å–ª–∏ duration –Ω–µ —É–∫–∞–∑–∞–Ω
            p = abs(math.sin(t * 1.3))

        # easing –¥–ª—è —Ñ–∏–Ω–∞–ª–∞ (smoothstep)
        '''
–§—É–Ω–∫—Ü–∏—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è,
—á—Ç–æ–± –ø–µ—Ä–µ—Ö–æ–¥—ã –±—ã–ª–∏ –Ω–µ –∫–∞–∫ –ø–æ –±–æ—Ä–¥—é—Ä—É, –∞ –º—è–≥–µ–Ω—å–∫–æ, –ø–ª–∞–≤–Ω–æ.
        '''
        def smoothstep(x):
            x = np.clip(x, 0.0, 1.0)
            return x * x * (3.0 - 2.0 * x)
        '''
–°–∫–æ–ª—å–∫–æ –ø–ª–∏—Ç–æ–∫ —É–∂–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–æ—Å—å ‚Äî –æ—Ç 0 –¥–æ 1.
        '''
        reveal_frac = float(smoothstep(p))  # 0..1 ‚Äî –¥–æ–ª—è —É–∂–µ ¬´—Ä–∞—Å–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö¬ª –ø–ª–∏—Ç–æ–∫

        # –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Å–º–µ–Ω—ã: –≤ –Ω–∞—á–∞–ª–µ –±—ã—Å—Ç—Ä–µ–µ, –ø–æ–¥ –∫–æ–Ω–µ—Ü –º–µ–¥–ª–µ–Ω–Ω–µ–µ
        change_rate = base_change_rate * (1.0 + (1.0 - reveal_frac) * (early_speed_mul - 1.0))

        # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
        '''
–°–æ–±–∏—Ä–∞–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ –º–∞—Å—Å–∏–≤.
        '''
        probs = np.array([max(0.0, prob_inv), max(0.0, prob_sat), max(0.0, prob_hyper), max(0.0, prob_noise)], dtype=np.float32)
        '''
–ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–∞—Ö–∞–ø–∞–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (—Å—É–º–º–∞ –±–æ–ª—å—à–µ –µ–¥–∏–Ω–∏—Ü—ã) ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º,
—á—Ç–æ–± —Å—É–º–º–∞—Ä–Ω–æ –º–µ–Ω—å—à–µ –µ–¥–∏–Ω–∏—Ü—ã –±—ã–ª–æ.
        '''
        total = probs.sum()
        if total >= 1.0:
            probs = probs / total * 0.95
            '''
–†–∞–∑–¥–∞—ë–º —à–∞–Ω—Å—ã: –∏–Ω–≤–µ—Ä—Å–∏—è, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å, –≥–∏–ø–µ—Ä, —à—É–º –∏ –æ—Å—Ç–∞—Ç–æ–∫ ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª.
            '''
        p_inv, p_sat, p_hyper, p_noise = probs
        p_orig = 1.0 - (p_inv + p_sat + p_hyper + p_noise)

        # –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–∞–¥—Ä–∞ ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –∑–∞—Ä–∞–Ω–µ–µ
        '''
–î–µ–ª–∞–µ–º –≤–µ—Ä—Å–∏—é "–Ω–∞–∏–∑–Ω–∞–Ω–∫—É" ‚Äî —Ü–≤–µ—Ç–∞ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç—ã–µ.
        '''
        inverted = cv2.bitwise_not(frame)

        # –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        '''
–ì–æ–Ω–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ HSV, —á—Ç–æ–± —Ä—É–ª–∏—Ç—å –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å—é (ss) –∏ —è—Ä–∫–æ—Å—Ç—å—é (vv).
        '''
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV).astype(np.float32)
        hh, ss, vv = cv2.split(hsv)
        '''
–ß–µ–º –º–µ–Ω—å—à–µ –ø–ª–∏—Ç–æ–∫ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –≤—ã–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å.
        '''
        sat_factor = 1.0 + (max_sat_mult - 1.0) * (1.0 - reveal_frac)  # –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Å–∏–ª—å–Ω–µ–µ –≤ –Ω–∞—á–∞–ª–µ, —Å–ª–∞–±–µ–µ –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É
        '''
–ü–æ–¥–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –∏ —è—Ä–∫–æ—Å—Ç—å, –Ω–æ —Å–ª–µ–¥–∏–º, —á—Ç–æ–± –Ω–µ –≤—ã–≤–∞–ª–∏–ª–∏—Å—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã 0‚Äì255.
        '''
        ss2 = ss * sat_factor
        vv2 = vv * (1.0 + 0.15 * (1.0 - reveal_frac))
        np.clip(ss2, 0, 255, out=ss2)
        np.clip(vv2, 0, 255, out=vv2)
        '''
–°–æ–±—Ä–∞–ª–∏ –æ–±—Ä–∞—Ç–Ω–æ —Ü–≤–µ—Ç–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –¥–∏–∫–∏–º —Ü–≤–µ—Ç–æ–º.
        '''
        sat_frame = cv2.cvtColor(cv2.merge((hh, ss2, vv2)).astype(np.uint8), cv2.COLOR_HSV2BGR)

        # –≥–∏–ø–µ—Ä-—Ü–≤–µ—Ç (hue shift –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã) ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        '''
–ì–∏–ø–µ—Ä-—Ä–µ–∂–∏–º: –¥–µ–ª–∞–µ–º –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞,
–æ–¥–∏–Ω —Å–æ —Å–¥–≤–∏–≥–æ–º —Ç–æ–Ω–∞ –≤–ø—Ä–∞–≤–æ, –¥—Ä—É–≥–æ–π –≤–ª–µ–≤–æ. –ß–µ–º —Ä–∞–Ω—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –¥–≤–∏–≥–∞–µ–º.
        '''
        hsv_h1 = hsv.copy()
        hsv_h2 = hsv.copy()
        # –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ H (OpenCV: H in [0..179])
        shift = int(hyper_hue_shift * (1.0 - reveal_frac))  # —Å–∏–ª—å–Ω–µ–µ –≤ –Ω–∞—á–∞–ª–µ
        '''
–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –≤ –≥–∏–ø–µ—Ä–µ —Ç—É–ø–æ –≤ –ø–æ–ª –∏ –µ—â—ë –≥–∞–∑—É —Å–≤–µ—Ä—Ö—É.
        '''
        hsv_h1[..., 0] = (hsv_h1[..., 0] + shift) % 180.0
        hsv_h2[..., 0] = (hsv_h2[..., 0] - shift) % 180.0
        # —É—Å–∏–ª–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –≥–∏–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–¥–∞
        hsv_h1[..., 1] = np.clip(hsv_h1[..., 1] * (1.6 + 1.4 * (1.0 - reveal_frac)), 0, 255)
        hsv_h2[..., 1] = np.clip(hsv_h2[..., 1] * (1.6 + 1.4 * (1.0 - reveal_frac)), 0, 255)
        '''
–°–æ–±—Ä–∞–ª–∏ –æ–±—Ä–∞—Ç–Ω–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –ø–æ–ª—É—á–∏–ª–∏—Å—å –¥–≤–∞ –±–µ—à–µ–Ω—ã—Ö –≥–∏–ø–µ—Ä-–≤–∞—Ä–∏–∞–Ω—Ç–∞.
        '''
        hyper1 = cv2.cvtColor(hsv_h1.astype(np.uint8), cv2.COLOR_HSV2BGR)
        hyper2 = cv2.cvtColor(hsv_h2.astype(np.uint8), cv2.COLOR_HSV2BGR)

        # —à—É–º–æ–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–±–µ–ª—ã–π/—Ü–≤–µ—Ç–Ω–æ–π —à—É–º, –º–∞–ª—ã–π –≤–∫–ª–∞–¥)
        # —Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω —à—É–º–æ–≤–æ–π –∫–∞–¥—Ä –Ω–∞ –≤–µ—Å—å —Ä–∞–∑–º–µ—Ä
        '''
–¢—É—Ç –≥–µ–Ω–µ—Ä–∏–º —à—É–º ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ —Ç–µ–ª–µ–∫ –±–µ–∑ –∞–Ω—Ç–µ–Ω–Ω—ã —à–∏–ø–∏—Ç.
        '''
        rng = np.random.RandomState((seed ^ int(t * 1000)) & 0xFFFFFFFF)
        noise = (rng.randint(0, 256, (h, w, 1), dtype=np.uint8))
        # –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ —à—É–º–∞
        """
–î–µ–ª–∞–µ–º —Ü–≤–µ—Ç–Ω–æ–π —à—É–º, —Å–¥–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã.
–ü–æ—Ç–æ–º –º–µ—à–∞–µ–º –µ–≥–æ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –≥—Ä—è–∑–Ω—ã–π —Ç—Ä—ç—à.
        """
        noise_color = np.concatenate([noise, np.roll(noise, 7, axis=1), np.roll(noise, 13, axis=0)], axis=2)
        noise_mix = cv2.addWeighted(frame, 0.25, noise_color, 0.75, 0)

        # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∏—Ç–æ—á–Ω–æ–π —Å–µ—Ç–∫–∏
        '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –ø–ª–∏—Ç–æ–∫ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
        '''
        Ty = (h + tile_size - 1) // tile_size
        Tx = (w + tile_size - 1) // tile_size

        # –Ω–æ–º–µ—Ä–∞ –ø–ª–∏—Ç–æ–∫
        '''
–î–µ–ª–∞–µ–º —Å–µ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø–ª–∏—Ç–æ–∫.
        '''
        ty = np.arange(Ty, dtype=np.int64)
        tx = np.arange(Tx, dtype=np.int64)
        tile_y, tile_x = np.meshgrid(ty, tx, indexing='ij')  # shape Ty x Tx

        # –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø–ª–∏—Ç–æ–∫: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–Ω–∂/–ø–æ—Ä—è–¥–æ–∫ —Ñ–∏–∫—Å–∞—Ü–∏–∏
        '''
–°—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ö—ç—à –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∏—Ç–∫–∏,
—á—Ç–æ–± –ø–æ—Ä—è–¥–æ–∫ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –±—ã–ª –Ω–µ —Ä–∞–Ω–¥–æ–º–Ω—ã–π, –∞ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π.
        '''
        lock_hash = (tile_x * 73856093) ^ (tile_y * 19349663) ^ np.int64(seed * 16777619)
        lock_hash = (lock_hash & 0xFFFFFFFF).astype(np.uint32)
        # –Ω–æ—Ä–º–∏—Ä—É–µ–º –≤ 0..1 ‚Äî –ø–æ—Ä—è–¥–æ–∫ —Ñ–∏–∫—Å–∞—Ü–∏–∏
        lock_order = (lock_hash.astype(np.float32) / 4294967295.0)  # Ty x Tx, 0..1

        # –≤—ã—á–∏—Å–ª—è–µ–º –≤–µ—Å —Ñ–∏–∫—Å–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∏—Ç–∫–∏: 0..1
        # –ø–ª–∏—Ç–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ reveal_frac >= lock_order
        # –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ –æ–∫–Ω–æ –ø–ª–∞–≤–Ω–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏ lock_blend_window
        lbw = max(1e-4, lock_blend_window)
        w_lock_tile = np.clip((reveal_frac - lock_order) / lbw, 0.0, 1.0)  # Ty x Tx

        # discrete time step (–¥–ª—è —Å–º–µ–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è —É –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–ª–∏—Ç–æ–∫)
        time_step = int(math.floor(t * change_rate))

        # –•—ç—à –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–ª–∏—Ç–∫–∏ –≤ —Ç–µ–∫—É—â–∏–π time_step
        '''
–î–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∏—Ç–∫–∏ –≥–µ–Ω–µ—Ä–∏–º "–∂—Ä–µ–±–∏–π" 0‚Äì100,
–ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –≤—ã–±–∏—Ä–∞–µ–º, –∫–∞–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –Ω–µ–π.
        '''
        state_hash = ((tile_x * 2166136261) ^ (tile_y * 16777619) ^ (np.int64(time_step) * 2246822519) ^ np.int64(seed)) & 0xFFFFFFFF
        r100 = (state_hash % 100).astype(np.int32)

        thr_inv = int(np.clip(p_inv * 100.0, 0, 100))
        thr_sat = int(np.clip((p_inv + p_sat) * 100.0, 0, 100))
        thr_hyper = int(np.clip((p_inv + p_sat + p_hyper) * 100.0, 0, 100))
        # –æ—Å—Ç–∞–ª—å–Ω—ã–µ -> noise / orig

        # –º–∞—Å–∫–∏ –ø–ª–∏—Ç–æ–∫ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π (Ty x Tx)
        mask_inv_tile = (r100 < thr_inv)
        mask_sat_tile = (r100 >= thr_inv) & (r100 < thr_sat)
        mask_hyper_tile = (r100 >= thr_sat) & (r100 < thr_hyper)
        mask_noise_tile = (r100 >= thr_hyper) & (r100 < int((p_inv + p_sat + p_hyper + p_noise) * 100.0))
        mask_orig_tile = ~(mask_inv_tile | mask_sat_tile | mask_hyper_tile | mask_noise_tile)

        # —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–ª–∏—Ç–æ—á–Ω—É—é –º–∞—Å–∫—É –Ω–∞ –ø–∏–∫—Å–µ–ª–∏
        tiles_y = (np.arange(h) // tile_size).astype(np.int32)  # (h,)
        tiles_x = (np.arange(w) // tile_size).astype(np.int32)  # (w,)
        ty_idx = tiles_y[:, None]
        tx_idx = tiles_x[None, :]

        mask_inv = mask_inv_tile[ty_idx, tx_idx]
        mask_sat = mask_sat_tile[ty_idx, tx_idx]
        mask_hyper = mask_hyper_tile[ty_idx, tx_idx]
        mask_noise = mask_noise_tile[ty_idx, tx_idx]
        mask_orig_dynamic = mask_orig_tile[ty_idx, tx_idx]  # orig by state (before locking)

        '''
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏–∫—Å–µ–ª—è –±–µ—Ä—ë–º –≤–µ—Å —Ñ–∏–∫—Å–∞—Ü–∏–∏ –µ–≥–æ –ø–ª–∏—Ç–∫–∏.
        '''
        w_lock = w_lock_tile[ty_idx, tx_idx]
        w_lock_3 = w_lock[:, :, None]

        '''
–ù–∞—á–∏–Ω–∞–µ–º —Å –æ–±—ã—á–Ω–æ–≥–æ –∫–∞–¥—Ä–∞.
        '''
        effect_mix = frame.astype(np.float32)

        # step 1: invert
        '''
–ï—Å–ª–∏ –ø–ª–∏—Ç–∫–∞ –≤ –∏–Ω–≤–µ—Ä—Å–∏–∏ ‚Äî –ø–æ–¥–º–µ–Ω—è–µ–º –Ω–∞ –∏–Ω–≤–µ—Ä—Ç.
        '''
        effect_mix = np.where(mask_inv[:, :, None], inverted.astype(np.float32), effect_mix)
        # step 2: sat
        effect_mix = np.where(mask_sat[:, :, None], sat_frame.astype(np.float32), effect_mix)
        # step 3: hyper choose between hyper1 and hyper2 using another bit from state_hash
        '''
–ï—Å–ª–∏ –ø–ª–∏—Ç–∫–∞ –≤ –≥–∏–ø–µ—Ä-—Ä–µ–∂–∏–º–µ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –æ–¥–∏–Ω –∏–∑ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (—Å–¥–≤–∏–≥ –≤–ø—Ä–∞–≤–æ –∏–ª–∏ –≤–ª–µ–≤–æ).
        '''
        hyper_choice = ((state_hash >> 16) & 1).astype(np.bool_)
        hyper_tile = np.where(hyper_choice[ty_idx, tx_idx][:, :, None], hyper1.astype(np.float32), hyper2.astype(np.float32))
        effect_mix = np.where(mask_hyper[:, :, None], hyper_tile, effect_mix)
        # step 4: noise
        '''
–®—É–º–Ω—ã–µ –ø–ª–∏—Ç–∫–∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ —à—É–º.
        '''
        effect_mix = np.where(mask_noise[:, :, None], noise_mix.astype(np.float32), effect_mix)
        # step 5: dynamic orig
        '''
–ê –ø–ª–∏—Ç–∫–∏, –æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑ –ø—Ä–∏–∫–æ–ª–æ–≤
        '''
        effect_mix = np.where(mask_orig_dynamic[:, :, None], frame.astype(np.float32), effect_mix)

        '''
–°–º–µ—à–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ —ç—Ñ—Ñ–µ–∫—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–µ–ø–µ–Ω–∏ —Ñ–∏–∫—Å–∞—Ü–∏–∏:
–∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ = –æ—Ä–∏–≥–∏–Ω–∞–ª, –æ—Å—Ç–∞–ª—å–Ω–æ–µ = —ç—Ñ—Ñ–µ–∫—Ç—ã.
        '''
        out_f = frame.astype(np.float32) * w_lock_3 + effect_mix * (1.0 - w_lock_3)

        # optional: if soften_edges True, –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–∑–º—ã–≤–∞–µ–º –º–∞—Å–∫–∏ –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –º–∏–∫—Å–æ–º
        '''
–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è ‚Äî —Ä–∞–∑–º—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É —Ñ–∏–∫—Å–∞—Ü–∏–∏,
–∏ –ø–ª–∏—Ç–∫–∏ –ø–ª–∞–≤–Ω–æ –ø–µ—Ä–µ—Ç–µ–∫–∞—é—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª, –±–µ–∑ —Ä—É–±–ª–µ–Ω—ã—Ö –∫—Ä–∞—ë–≤.
        '''
        if soften_edges:
            k = edge_blur_ksize if (edge_blur_ksize % 2 == 1) else (edge_blur_ksize + 1)
            # —Ä–∞–∑–º—ã–≤–∞–µ–º w_lock —á—Ç–æ–±—ã —Å–≥–ª–∞–¥–∏—Ç—å –∫—Ä–∞—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø–ª–∏—Ç–æ–∫
            w_lock_blur = cv2.GaussianBlur(w_lock.astype(np.float32), (k, k), 0)
            w_lock_blur_3 = w_lock_blur[:, :, None]
            out_f = frame.astype(np.float32) * w_lock_blur_3 + effect_mix * (1.0 - w_lock_blur_3)

            '''
–í –∫–æ–Ω—Ü–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–∏–∫—Å–µ–ª–∏ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ 0‚Äì255 –∏ –æ—Ç–¥–∞—ë–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º.
            '''
        out = np.clip(out_f, 0, 255).astype(np.uint8)
        return out

    # 14. Edge sketch
    '''
–≠—Ç–æ, –±—Ä–∞—Ç—É—Ö–∞, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏. –¢–∏–ø–∞ –∫–∞–∫ —Ä—É—á–∫–∏ –Ω–∞ –º–∞–≥–Ω–∏—Ç–æ—Ñ–æ–Ω–µ.

downscale=2 ‚Üí —É–º–µ–Ω—å—à–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–± –±—ã—Å—Ç—Ä–µ–µ —Å—á–∏—Ç–∞—Ç—å.

bilateral_iters=1 ‚Üí —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã.

color_levels=20 ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–≤–µ—Ç–æ–≤, –º–µ–Ω—å—à–µ = –±–æ–ª–µ–µ –º—É–ª—å—Ç—è—à–Ω–æ.

edge_th1=50, edge_th2=140 ‚Üí –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥—Ä–∞–Ω–∏—Ü (—Ç–∏–ø–∞ –∫–æ–Ω—Ç—É—Ä—ã).

edge_dilate=2 ‚Üí –¥–µ–ª–∞–µ–º –∫—Ä–∞—è –∂–∏—Ä–Ω–µ–µ.

edge_glow_strength=0.9 ‚Üí –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ —Å–∏—è—é—Ç –Ω–µ–æ–Ω–æ–≤—ã–µ –ª–∏–Ω–∏–∏.

edge_color=(0, 255, 255) ‚Üí —Ü–≤–µ—Ç –∫–æ–Ω—Ç—É—Ä–∞, —Ç—É—Ç –∂—ë–ª—Ç–æ-–∑–µ–ª—ë–Ω—ã–π –Ω–µ–æ–Ω.

pink_tint_strength=0.35 ‚Üí —Ä–æ–∑–æ–≤—ã–π –Ω–∞–ª—ë—Ç –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ, —á—Ç–æ–± –ø–æ-–∫–∏–±–µ—Ä–ø–∞–Ω–∫–æ–≤—Å–∫–∏.

chroma_shift_px=6 ‚Üí —Å–º–µ—â–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –ø–æ –∫–∞–Ω–∞–ª–∞–º, —Ç–∏–ø–∞ –≥–ª—é–∫.

glitch_slices=6 ‚Üí —Å–∫–æ–ª—å–∫–æ –ø–æ–ª–æ—Å–æ–∫-–≥–ª—é–∫–æ–≤ –±—É–¥–µ—Ç –ø—Ä—ã–≥–∞—Ç—å.

glitch_max_shift=40 ‚Üí –Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–ª–µ–∫–æ –ø–æ–ª–æ—Å—ã –±—É–¥—É—Ç –ø—Ä—ã–≥–∞—Ç—å.

scanline_strength=0.08 ‚Üí –ø–æ–ª–æ—Å—ã, –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä–æ–º —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–µ.

noise_strength=0.03 ‚Üí —à—É–º, —Ç–∏–ø–∞ –ø–ª—ë–Ω–∫–∞ –≥—Ä—è–∑–Ω–∞—è.

sharpen_amount=0.15 ‚Üí —Ä–µ–∑–∫–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å, —á—Ç–æ–± –≤—Å—ë –∫–æ–ª–æ–ª–æ—Å—å –≥–ª–∞–∑–∞–º–∏.
    '''
    def edge_sketch(self, frame, t, duration,
                           downscale=2,
                           bilateral_iters=1,
                           color_levels=20,
                           edge_th1=50, edge_th2=140,
                           edge_dilate=2,
                           edge_glow_strength=0.9,
                           edge_color=(0, 255, 255),   # neon yellow in BGR
                           pink_tint_strength=0.35,
                           chroma_shift_px=6,         # max pixels for chromatic aberration
                           glitch_slices=6,
                           glitch_max_shift=40,
                           scanline_strength=0.08,
                           noise_strength=0.03,
                           sharpen_amount=0.15):
        
        img = frame.copy()
        h, w = img.shape[:2]

        # ---- downscale for heavy ops ----
        '''
–¢—É—Ç —Ç–µ–º–∞ —Ç–∞–∫–∞—è: –º—ã –±–µ—Ä—ë–º –∫–∞—Ä—Ç–∏–Ω–∫—É img –∏ –Ω–∞–∑—ã–≤–∞–µ–º –µ—ë small.
–ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä downscale –±–æ–ª—å—à–µ –µ–¥–∏–Ω–∏—Ü—ã, —Ç–æ –º—ã —Ö–æ—Ç–∏–º —É–º–µ–Ω—å—à–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É,
—á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ–π ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç—ã –∂—Ä—É—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∫–∞–∫ —Å–µ–º–∫–∏ –≤ –ø–æ–¥—ä–µ–∑–¥–µ.

steps = ... ‚Üí —Ç—É—Ç —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –º–æ–∂–Ω–æ —Å–∂–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ–ø–æ–ª–∞–º (–∫–∞–∂–¥—ã–π —Ä–∞–∑ —É–º–µ–Ω—å—à–∞–µ–º –≤ 2 —Ä–∞–∑–∞).

for _ in range(steps): ‚Üí –∫—Ä—É—Ç–∏–º —Ü–∏–∫–ª —Å—Ç–æ–ª—å–∫–æ —Ä–∞–∑.

if small.shape[0] // 2 < 1 ... ‚Üí –µ—Å–ª–∏ –ø—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏ –≤—ã—Å–æ—Ç–∞ –∏–ª–∏ —à–∏—Ä–∏–Ω–∞ —É–π–¥—É—Ç –≤ –Ω–æ–ª—å, —Ç–æ—Ä–º–æ–∑–∏–º.

small = cv2.pyrDown(small) ‚Üí OpenCV-—à–Ω–∞—è –º–∞–≥–∏—è: —É–º–µ–Ω—å—à–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ 2 —Ä–∞–∑–∞, –Ω–æ –∫—Ä–∞—Å–∏–≤–æ, –Ω–µ –∫–∞–∫ paint.

–ò—Ç–æ–≥: –ø–æ–ª—É—á–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–æ–ø–∏—é –∫–∞—Ä—Ç–∏–Ω–∫–∏, —á—Ç–æ–±—ã –≤—Å–µ —Ç—è–∂—ë–ª—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ.
        '''
        small = img
        if downscale > 1:
            steps = max(1, int(np.round(np.log2(max(1, downscale)))))
            for _ in range(steps):
                if small.shape[0] // 2 < 1 or small.shape[1] // 2 < 1:
                    break
                small = cv2.pyrDown(small)

        # ---- fast smoothing (cheap substitute for many bilateral passes) ----
        """
–ö–æ—Ä–æ—á–µ, —Ç—É—Ç –º—ã –¥–µ–ª–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≥–ª–∞–¥–∫–æ–π, –∫–∞–∫ –ª–æ–± –ø–æ—Å–ª–µ –∑–æ–Ω—ã üòÜ

for _ in range(max(1, bilateral_iters)):
–∫—Ä—É—Ç–∏–º —Ñ–∏–ª—å—Ç—Ä –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–æ –≤ bilateral_iters
(–µ—Å–ª–∏ –≤–¥—Ä—É–≥ 0 –ø–æ—Å—Ç–∞–≤–∏–ª–∏, –≤—Å—ë —Ä–∞–≤–Ω–æ —Ö–æ—Ç—å —Ä–∞–∑ –ø—Ä–æ–≥–æ–Ω–∏—Ç).

cv2.bilateralFilter(small, 7, 50, 50)
—ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏–∑ OpenCV. –û–Ω —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç —à—É–º, –Ω–æ –∫—Ä–∞—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç —á—ë—Ç–∫–∏–º–∏.
–¢–∏–ø–∞ –¥–µ–ª–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –±–æ–ª–µ–µ –º—É–ª—å—Ç—è—à–Ω–æ–π, —á—Ç–æ–± –ª–∏–Ω–∏–∏ –Ω–µ –ø–æ–ø–ª—ã–ª–∏, –∞ —Ñ–æ–Ω —Å—Ç–∞–ª –º—è–≥–∫–∏–º.

–ü–æ —Ñ–∞–∫—Ç—É ‚Äî —ç—Ç–æ –∫–∞–∫ –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –ø—Ä–æ–≥–Ω–∞–ª–∏ —á–µ—Ä–µ–∑ –±—å—é—Ç–∏-—Ñ–∏–ª—å—Ç—Ä –∏–∑ –∏–Ω—Å—Ç—ã, —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–¥–µ–æ.
        """
        for _ in range(max(1, bilateral_iters)):
            small = cv2.bilateralFilter(small, 7, 50, 50)

        # ---- color quantization (cartoon-ish base) ----
        '''
–¢—É—Ç –º—ã —Ä—É–±–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–≤–µ—Ç–æ–≤, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –∫–∞–∫ –∫–æ–º–∏–∫—Å.
–ë–µ—Ä—ë–º –¥–∏–∞–ø–∞–∑–æ–Ω –æ—Ç 0 –¥–æ 255 –∏ —Ä–µ–∂–µ–º –Ω–∞ color_levels —á–∞—Å—Ç–µ–π.
–ò—Ç–æ–≥: —Ü–≤–µ—Ç–∞ –∫—Ä—É–ø–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏, –∫–∞–∫ –±—É–¥—Ç–æ —Ñ–æ—Ç–∫—É –Ω–∞—Ä–∏—Å–æ–≤–∞–ª —à–∫–æ–ª—å–Ω–∏–∫ —Ñ–ª–æ–º–∞—Å—Ç–µ—Ä–æ–º.
        '''
        quant = max(1, 256 // max(1, color_levels))
        q = (small // quant) * quant + quant // 2
        q = np.clip(q, 0, 255).astype(np.uint8)

        # ---- upscale back ----
        """
–ú—ã —É–º–µ–Ω—å—à–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É, —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞—Ç–Ω–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –¥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
–¢–∏–ø–∞ –≤–∑—è–ª–∏ –ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç –∏ –Ω–∞–∫–∏–Ω—É–ª –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω.
        """
        out = q
        while out.shape[0] < h or out.shape[1] < w:
            out = cv2.pyrUp(out)
        out = out[:h, :w]

        # ---- keep some detail from original ----
        """
–ë–µ—Ä—ë–º –º—É–ª—å—Ç—è—à–∫—É –∏ –ø—Ä–∏–º–µ—à–∏–≤–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –Ω–∞—Å—Ç–æ—è—â–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ (18%).
–ü–æ–ª—É—á–∞–µ–º ‚Äî –º—É–ª—å—Ç—è—à–∫–∞, –Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –Ω–µ —Å–æ–≤—Å–µ–º –∫–∞–∫ —É —Ä–µ–±—ë–Ω–∫–∞ –≤ —Ç–µ—Ç—Ä–∞–¥–∏.
        """
        base = cv2.addWeighted(out, 0.82, img, 0.18, 0)

        # ---- edges (for neon outlines) ----
        """
–ü–µ—Ä–µ–≤–µ–ª–∏ –≤ –ß/–ë, —á—É—Ç—å —Ä–∞–∑–º—ã–ª–∏, –ø–æ—Ç–æ–º —á–µ—Ä–µ–∑ Canny –∏—â–µ–º –≥—Ä–∞–Ω–∏—Ü—ã.
–ö–æ—Ä–æ—á–µ ‚Äî —Ä–∏—Å—É–µ–º –∫–æ–Ω—Ç—É—Ä –≤—Å–µ–≥–æ, —á—Ç–æ –≤–∏–¥–Ω–æ.
        """
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        gray_blur = cv2.medianBlur(gray, 5)
        edges = cv2.Canny(gray_blur, edge_th1, edge_th2)
        """
–ï—Å–ª–∏ –Ω–∞–¥–æ ‚Äî –¥–µ–ª–∞–µ–º –∫—Ä–∞—è —Ç–æ–ª—â–µ, —Ç–∏–ø–∞ –∂–∏—Ä–Ω—ã–π –º–∞—Ä–∫–µ—Ä.
mask2 ‚Äî —ç—Ç–æ –∫–∞—Ä—Ç–∞, –≥–¥–µ –µ—Å—Ç—å –ª–∏–Ω–∏–∏.
        """
        if edge_dilate and edge_dilate > 0:
            ker = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
            edges = cv2.dilate(edges, ker, iterations=edge_dilate)
        mask2 = edges > 0

        # ---- colored neon edges + glow (halo) ----
        """
–°–æ–∑–¥–∞–ª–∏ –ø—É—Å—Ç—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –Ω–∞—Ä–∏—Å–æ–≤–∞–ª–∏ –Ω–∞ –Ω–µ–π –Ω–µ–æ–Ω–æ–≤—ã–µ –ª–∏–Ω–∏–∏ —Ü–≤–µ—Ç–æ–º edge_color.
        """
        neon = np.zeros_like(img)
        neon[mask2] = edge_color  # BGR

        # glow: blur a dilated version of edges and tint with neon color
        """
–°–¥–µ–ª–∞–ª–∏ —Å–≤–µ—á–µ–Ω–∏–µ (—Ä–∞–∑–º–∞–∑–∞–ª–∏ –ª–∏–Ω–∏–∏, –∫–∞–∫ —Å–≤–µ—Ç—è—â–∏–π—Å—è —Å–ª–µ–¥).
–ü–æ—Ç–æ–º —Å–ª–æ–∂–∏–ª–∏ –ª–∏–Ω–∏–∏ –∏ —Å–≤–µ—á–µ–Ω–∏–µ ‚Üí —Ç–µ–ø–µ—Ä—å —É –Ω–∞—Å —á—ë—Ç–∫–∏–µ –Ω–µ–æ–Ω–æ–≤—ã–µ –æ–±–≤–æ–¥–∫–∏ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π.
        """
        glow = np.zeros_like(img, dtype=np.float32)
        large = cv2.dilate(edges, cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (7, 7)), iterations=1)
        large = (large > 0).astype(np.uint8) * 255
        # color the large mask with edge_color
        for c in range(3):
            glow[..., c] = large.astype(np.float32) * (edge_color[c] / 255.0)
        glow = glow.astype(np.uint8)
        # big gaussian to get soft halo
        glow = cv2.GaussianBlur(glow, (0, 0), sigmaX=9, sigmaY=9)
        # combine neon and halo
        neon_total = cv2.addWeighted(neon, 1.0, glow, edge_glow_strength, 0)

        # ---- apply pink tint / cyberpunk grade ----
        # simple and fast approach: push R and B up, reduce G; then overlay a subtle pink
        '''
–ë—É—Å—Ç–∏–º –∫—Ä–∞—Å–Ω—ã–π –∏ —Å–∏–Ω–∏–π, —Ä–µ–∂–µ–º –∑–µ–ª—ë–Ω—ã–π ‚Üí –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–∏–±–µ—Ä–ø–∞–Ω–∫-—Ä–æ–∑–æ–≤–æ–π.
        '''
        fbase = base.astype(np.float32) / 255.0
        # per-channel scaling to push to pinkish/cyan-magenta palette
        # B, G, R order
        fbase[..., 0] *= 1.05   # blue slightly up
        fbase[..., 1] *= 0.7    # green down
        fbase[..., 2] *= 1.25   # red up
        fbase = np.clip(fbase, 0, 1.0)

        # pink overlay (BGR) ‚Äî values chosen for neon/pink
        """
–î–æ–±–∞–≤–ª—è–µ–º —Ä–æ–∑–æ–≤—ã–π –Ω–∞–ª—ë—Ç –ø–æ–≤–µ—Ä—Ö. –ü–æ–ª—É—á–∞–µ—Ç—Å—è —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –Ω–µ–æ–Ω–æ–≤—ã–π —Å—Ç–∏–ª—å ¬´–Ω–æ—á—å –≤ –¢–æ–∫–∏–æ¬ª.
        """
        pink_bgr = np.array([190, 30, 200], dtype=np.float32) / 255.0
        # overlay only partially to preserve details
        fbase = fbase * (1.0 - pink_tint_strength) + pink_bgr * pink_tint_strength
        result = (fbase * 255.0).astype(np.uint8)

        # ---- chromatic aberration (fast using np.roll) ----
        # offsets vary with time for animation
        """
–î–≤–∏–≥–∞–µ–º –∫–∞–Ω–∞–ª—ã RGB –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Üí –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞–∫ —Å –∫—Ä–∏–≤–æ–≥–æ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞ –∏–ª–∏ VR –æ—á–∫–æ–≤.
        """
        phase = np.sin(2.0 * np.pi * (t / max(0.0001, duration))) if duration > 0 else np.sin(t * 2.0)
        max_shift = max(1, int(round(chroma_shift_px)))
        dx_r = int(round(phase * max_shift))
        dx_b = -int(round(phase * max_shift / 2.0))
        dy_g = int(round(phase * (max_shift // 3)))

        b, g, r = cv2.split(result)
        if dx_b != 0:
            b = np.roll(b, dx_b, axis=1)
        if dx_r != 0:
            r = np.roll(r, dx_r, axis=1)
        if dy_g != 0:
            g = np.roll(g, dy_g, axis=0)
        result = cv2.merge([b, g, r])

        # ---- glitch slices (horizontal bands shifted) ----
        rng = np.random.RandomState(int(t * 1000) & 0xffffffff)
        res_copy = result.copy()
        n = max(1, int(glitch_slices))
        """
–ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã –∏ –¥–≤–∏–≥–∞–µ–º –∏—Ö –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ.
–ü–ª—é—Å –∏–Ω–æ–≥–¥–∞ –∫–∏–¥–∞–µ–º –Ω–∞ –Ω–∏—Ö —Ü–≤–µ—Ç–Ω–æ–π –æ—Ç—Ç–µ–Ω–æ–∫.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π ¬´–≥–ª—é–∫-—ç—Ñ—Ñ–µ–∫—Ç¬ª.
        """
        for i in range(n):
            h0 = rng.randint(0, max(1, h - 2))
            hh = rng.randint(2, max(3, h // 8))
            y1 = h0
            y2 = min(h, h0 + hh)
            shift = int(rng.randint(-glitch_max_shift, glitch_max_shift + 1) * abs(np.sin(t * (i + 1) * 1.17)))
            if shift == 0:
                continue
            # slice and roll horizontally
            band = res_copy[y1:y2, :, :].copy()
            band = np.roll(band, shift, axis=1)
            # small color distortion inside band: tint band slightly cyan/magenta randomly
            tint = rng.uniform(0.85, 1.25, size=(3,))
            band = np.clip(band.astype(np.float32) * tint.reshape((1, 1, 3)), 0, 255).astype(np.uint8)
            result[y1:y2, :, :] = band

        # ---- scanlines (subtle) ----
        # create alternating dark/light lines
        """
–†–∏—Å—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏, –∫–∞–∫ —É —Å—Ç–∞—Ä–æ–≥–æ —Ç–µ–ª–∏–∫–∞.
–û—á–µ–Ω—å —Å–ª–∞–±—ã–µ, —á–∏—Å—Ç–æ –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã.
        """
        yy = np.arange(h, dtype=np.float32)
        scan = (0.5 + 0.5 * np.sin((yy / 2.0) * np.pi)).reshape(h, 1)  # 0..1 pattern
        scan = 1.0 - scan * scanline_strength
        # broadcast and apply per-channel
        result = (result.astype(np.float32) * scan[:, :, None]).astype(np.uint8)

        # ---- add subtle colored noise/grain ----
        """
–ü–æ–¥–∫–∏–¥—ã–≤–∞–µ–º —à—É–º –∏ —Ü–≤–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏, –∫–∞–∫ –±—É–¥—Ç–æ VHS –∫–∞—Å—Å–µ—Ç–∞.
        """
        noise = (rng.randn(h, w, 1) * 255.0 * noise_strength).astype(np.float32)
        chroma_noise = (rng.randn(h, w, 3) * 255.0 * (noise_strength * 0.6)).astype(np.float32)
        noisy = result.astype(np.float32) + noise + chroma_noise
        result = np.clip(noisy, 0, 255).astype(np.uint8)

        # ---- overlay neon edges (only on edge pixels + glow) ----
        # put neon_total only where edges exist, and add glow additively
        # add glow globally but masked by blurred edges to avoid full-frame bloom
        glow_mask_f = cv2.GaussianBlur((edges > 0).astype(np.float32) * 1.0, (0, 0), sigmaX=12)
        glow_mask = np.expand_dims(glow_mask_f, axis=2)
        # normalize glow_mask to 0..1
        glow_mask = np.clip(glow_mask, 0.0, 1.0)
        # add neon_total (uint8) as floating blend
        """
–î–æ–±–∞–≤–ª—è–µ–º —Å–∏—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –µ—Å—Ç—å –∫–æ–Ω—Ç—É—Ä—ã.
–ò –æ—Å—Ç–∞–≤–ª—è–µ–º —á—ë—Ç–∫–∏–µ –Ω–µ–æ–Ω–æ–≤—ã–µ –ª–∏–Ω–∏–∏.
        """
        result_f = result.astype(np.float32)
        neon_f = neon_total.astype(np.float32)
        result_f = result_f * (1.0 - glow_mask * 0.8) + neon_f * (glow_mask * 0.95)
        result = np.clip(result_f, 0, 255).astype(np.uint8)

        # also paint sharp solid neon lines exactly on edges to keep contour readability
        result[mask2] = neon[mask2]

        # ---- optional sharpen to make it more "sharp cyberpunk" ----
        """
–ü–æ—Å–ª–µ–¥–Ω–∏–π —à—Ç—Ä–∏—Ö: –¥–µ–ª–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –±–æ–ª–µ–µ —Ä–µ–∑–∫–æ–π, —á—Ç–æ–±—ã ¬´–∫–∏–±–µ—Ä–ø–∞–Ω–∫ –∫–æ–ª–æ–ª –≥–ª–∞–∑–∞¬ª.
        """
        if sharpen_amount and sharpen_amount > 0:
            blur = cv2.GaussianBlur(result, (0, 0), sigmaX=1.0)
            result = cv2.addWeighted(result, 1.0 + sharpen_amount, blur, -sharpen_amount, 0)
            result = np.clip(result, 0, 255).astype(np.uint8)

            '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî –ø–æ —Ñ–∞–∫—Ç—É —ç—Ç–æ –Ω–µ–æ–Ω–æ–≤—ã–π –≥–ª—é—á–Ω—ã–π –∫–∏–±–µ—Ä–ø–∞–Ω–∫–æ–≤—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä.
            '''
        return result

    # 16. Color invert pulse
    '''
–≠—Ç–æ –≤—Å—ë —Ç–∏–ø–∞ "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥ –∫–ª—é—á". –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ –¥–µ—Ñ–æ–ª—Ç—É, —á—Ç–æ–±—ã –≤–∏–¥–æ—Å –Ω–µ –ª–∞–≥–∞–ª –∏ –∫—Ä–∞—Å–∏–≤–æ –≤—ã–≥–ª—è–¥–µ–ª.

downscale_chroma ‚Äî —É–º–µ–Ω—å—à–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é —Ü–≤–µ—Ç–∞, —á—Ç–æ–± –±—ã—Å—Ç—Ä–µ–µ –æ–±—Å—á–∏—Ç–∞—Ç—å.

chroma_blur_sigma ‚Äî —á—É—Ç–∫–∞ –∑–∞–º—ã–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç, —Ç–∏–ø–∞ –º—É–ª—å—Ç—è—à–Ω–æ—Å—Ç–∏.

pink_strength ‚Äî —Å–∫–æ–ª—å–∫–æ —Ä–æ–∑–æ–≤–æ–≥–æ –Ω–∞–≤–∞–ª–∏–≤–∞–µ–º.

neon_color ‚Äî –∫–∞–∫–æ–π —Ü–≤–µ—Ç –Ω–µ–æ–Ω–∞ —é–∑–∞–µ–º (BGR, –∞ –Ω–µ RGB).

edge_th1, edge_th2 ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Canny, –∏—â–µ–º –≥—Ä–∞–Ω–∏—Ü—ã.

edge_glow_sigma ‚Äî —Ä–∞–¥–∏—É—Å —Ä–∞–∑–º—ã—Ç–∏—è –¥–ª—è —Å–≤–µ—á–µ–Ω–∏—è.

chroma_shift_px ‚Äî —Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤, —Ç–∏–ø–∞ –∞–±–µ—Ä—Ä–∞—Ü–∏—è –∫–∞–∫ –Ω–∞ —Å—Ç–∞—Ä–æ–º —Ç–µ–ª–∏–∫–µ.

glitch_slices –∏ glitch_max_shift ‚Äî —Å–∫–æ–ª—å–∫–æ "—Å–ª–∞–π—Å–æ–≤" –≥–ª—é–∫–Ω–µ—Ç—Å—è –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ.

glitch_prob ‚Äî —à–∞–Ω—Å, —á—Ç–æ –≤–æ–æ–±—â–µ –≥–ª—é–∫ –±–∞—Ö–Ω–µ—Ç.

scan_strength ‚Äî —Å–∏–ª–∞ –ø–æ–ª–æ—Å–æ—á–µ–∫ —Å–∫–∞–Ω–ª–∞–π–Ω–æ–≤.

noise_strength ‚Äî —Å–∏–ª–∞ —à—É–º–∫–∞, —á—Ç–æ–± "–≥—Ä—è–∑—å –∫–∏–±–µ—Ä–ø–∞–Ω–∫–∞".
    '''
    def color_invert_pulse44(self, frame, t, duration,
                        downscale_chroma=2,    # —É—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö—Ä–æ–º—ã
                        chroma_blur_sigma=1.2, # –ª–µ–≥–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ö—Ä–æ–º—ã
                        pink_strength=0.35,    # 0..1
                        neon_color=(0, 230, 255), # BGR neon yellow
                        edge_th1=40, edge_th2=120,
                        edge_glow_sigma=8,
                        chroma_shift_px=3,     # –Ω–µ–±–æ–ª—å—à–∞—è —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è
                        glitch_slices=4,
                        glitch_max_shift=18,
                        glitch_prob=0.6,
                        scan_strength=0.06,
                        noise_strength=0.02):
        
        img = frame.copy()
        h, w = img.shape[:2]

        # 1) luma/chroma separation ‚Äî YCrCb: —Å–æ—Ö—Ä–∞–Ω–∏–º —è—Ä–∫–æ—Å—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
        """
–¢—É—Ç –ø–µ—Ä–µ–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ BGR –≤ YCrCb ‚Äî —ç—Ç–æ —Ç–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç, –≥–¥–µ –æ—Ç–¥–µ–ª—å–Ω–æ —è—Ä–∫–æ—Å—Ç—å (Y) –∏ —Ü–≤–µ—Ç–∞ (Cr, Cb).
–Ø—Ä–∫–æ—Å—Ç—å (Y_orig) –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –∞ —Ü–≤–µ—Ç–∞ –±—É–¥–µ–º –º—É—Ç–∏—Ç—å.
        """
        ycrcb = cv2.cvtColor(img, cv2.COLOR_BGR2YCrCb).astype(np.float32)
        Y_orig, Cr, Cb = cv2.split(ycrcb)

        # 2) quick smoothing only on chroma (downscale -> blur -> upscale) ‚Äî –ª–µ–≥–∫–∞—è –º—É–ª—å—Ç—è—à–Ω–æ—Å—Ç—å
        '''
–î–µ–ª–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤, —á—Ç–æ–± –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–º—ã—Ç—å.
        '''
        small_h = max(1, h // downscale_chroma)
        small_w = max(1, w // downscale_chroma)
        '''
–°–∂–∏–º–∞–µ–º —Ü–≤–µ—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã –¥–æ –º–µ–ª–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
        '''
        Cr_s = cv2.resize(Cr, (small_w, small_h), interpolation=cv2.INTER_LINEAR)
        Cb_s = cv2.resize(Cb, (small_w, small_h), interpolation=cv2.INTER_LINEAR)

        # gaussian on small chroma is fast
        """
–†–∞–∑–º–∞–∑—ã–≤–∞–µ–º —ç—Ç–∏ —Å–∂–∞—Ç—ã–µ –∫–∞–Ω–∞–ª—ã –ì–∞—É—Å—Å–æ–º, —á—Ç–æ–± —Ü–≤–µ—Ç–∞ –±—ã–ª–∏ –ø–ª–∞–≤–Ω—ã–µ.
ksize ‚Äî —Ä–∞–∑–º–µ—Ä —è–¥—Ä–∞ —Ä–∞–∑–º—ã—Ç–∏—è, –¥–µ–ª–∞–µ–º –Ω–µ—á—ë—Ç–Ω—ã–π.
        """
        ksize = max(1, int(round(chroma_blur_sigma * 4)) | 1)
        Cr_s = cv2.GaussianBlur(Cr_s, (ksize, ksize), sigmaX=chroma_blur_sigma)
        Cb_s = cv2.GaussianBlur(Cb_s, (ksize, ksize), sigmaX=chroma_blur_sigma)

        '''
–û–±—Ä–∞—Ç–Ω–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –¥–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
        '''
        Cr_proc = cv2.resize(Cr_s, (w, h), interpolation=cv2.INTER_LINEAR)
        Cb_proc = cv2.resize(Cb_s, (w, h), interpolation=cv2.INTER_LINEAR)

        # optional: quantize chroma a bit to get flatish cartoon regions (fast)
        # small number of levels prevents banding; comment out to keep full precision
        """
–¢—É—Ç –º—ã —Ü–≤–µ—Ç–∞ "—Å—Ç—É–ø–µ–Ω—å–∫–∞–º–∏" —Ä–µ–∂–µ–º (–∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ).
–ö–æ—Ä–æ—á–µ, –¥–µ–ª–∞–µ–º –º–µ–Ω—å—à–µ –æ—Ç—Ç–µ–Ω–∫–æ–≤, —á—Ç–æ–± –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤—ã–≥–ª—è–¥–µ–ª–∞ –º—É–ª—å—Ç—è—à–Ω–æ–π.
        """
        levels = 24
        step = max(1.0, 256.0 / levels)
        Cr_proc = (np.floor(Cr_proc / step) * step + step * 0.5)
        Cb_proc = (np.floor(Cb_proc / step) * step + step * 0.5)

        # 3) recompose color image from processed chroma and original luma -> preserves detail
        '''
–°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Ü–≤–µ—Ç–æ–∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ —è—Ä–∫–æ—Å—Ç–∏ –∏ –Ω–æ–≤—ã—Ö —Ü–≤–µ—Ç–æ–≤. –≠—Ç–æ –±–∞–∑–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞.
        '''
        ycrcb_proc = cv2.merge([Y_orig, Cr_proc, Cb_proc]).astype(np.uint8)
        base = cv2.cvtColor(ycrcb_proc, cv2.COLOR_YCrCb2BGR).astype(np.float32) / 255.0

        # 4) apply pink/cyber grade quickly (color scale in BGR space, subtle)
        """
–ù–∞–≤–∞–ª–∏–≤–∞–µ–º —Ä–æ–∑–æ–≤—ã–π/—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä.
–ë–µ—Ä—ë–º —Å–º–µ—Å—å –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ —Ä–æ–∑–æ–≤–æ–≥–æ –æ—Ç—Ç–µ–Ω–∫–∞.
        """
        pink_bgr = np.array([190, 30, 200], dtype=np.float32) / 255.0
        base = base * (1.0 - pink_strength) + pink_bgr * pink_strength
        base = np.clip(base, 0.0, 1.0)

        # 5) compute crisp edges on luminance (small blur then Canny); thin edges -> no heavy masks
        '''
–ù–∞—Ö–æ–¥–∏–º –∫—Ä–∞—è —á–µ—Ä–µ–∑ Canny, —á—Ç–æ–± –ø–æ—Ç–æ–º –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –Ω–µ–æ–Ω–æ–º.
        '''
        gray = (Y_orig / 255.0).astype(np.float32)
        gray_blur = cv2.GaussianBlur((gray * 255).astype(np.uint8), (3, 3), 0)
        edges = cv2.Canny(gray_blur, edge_th1, edge_th2)  # uint8 0/255
        edges_f = edges.astype(np.float32) / 255.0

        # 6) neon lines image (only on edges)
        """
–†–∏—Å—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –Ω–µ–æ–Ω–æ–≤—ã–º–∏ –ª–∏–Ω–∏—è–º–∏ —Ç–∞–º, –≥–¥–µ –µ—Å—Ç—å –∫—Ä–∞—è.
–¶–≤–µ—Ç –±–µ—Ä—ë–º –∏–∑ neon_color.
        """
        neon_img = np.zeros_like(img, dtype=np.float32) / 255.0
        neon_bgr_f = np.array(neon_color, dtype=np.float32) / 255.0
        # draw solid thin lines where edges exist
        mask_edges = edges > 0
        neon_img[mask_edges] = neon_bgr_f

        # 7) glow: blur edges to create soft halo but clamp intensity so background remains clean
        '''
–°–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ —ç—Ç–∏—Ö –ª–∏–Ω–∏–π. –ß—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ –Ω–µ–æ–Ω —Å –æ—Ä–µ–æ–ª–æ–º.
        '''
        glow = cv2.GaussianBlur(edges.astype(np.float32), (0, 0), sigmaX=edge_glow_sigma, sigmaY=edge_glow_sigma)
        glow = np.clip(glow / 255.0, 0.0, 1.0)  # 0..1
        # make color glow and attenuate strongly away from edges to avoid full-frame bloom
        glow_colored = (glow[:, :, None] * neon_bgr_f[None, None, :]) * 0.9

        # 8) additive combine base + glow (only near edges)
        # Use soft mask to ensure glow doesn't produce an ugly full-frame mask
        """
–°–∫–ª–µ–∏–≤–∞–µ–º —Å–≤–µ—á–µ–Ω–∏–µ —Å –±–∞–∑–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.
–ê —Ç–∞–º, –≥–¥–µ –ø—Ä—è–º –∫—Ä–∞–π, —Å—Ç–∞–≤–∏–º —á–∏—Å—Ç—ã–π –Ω–µ–æ–Ω, —á—Ç–æ–±—ã –∂—ë—Å—Ç–∫–æ –≤—ã–¥–µ–ª—è–ª–æ—Å—å.
        """
        result_f = base.copy()
        result_f = np.clip(result_f + glow_colored, 0.0, 1.0)

        # apply sharp neon lines exactly on edges (preserve contrast)
        result_f[mask_edges] = neon_bgr_f  # ensure readability

        # 9) lightweight chromatic aberration: tiny roll per channel depending on time
        '''
–ó–¥–µ—Å—å –∑–∞–º—É—Ç —Å —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–±–µ—Ä—Ä–∞—Ü–∏–µ–π, –±—Ä–∞—Ç: –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª (R, G, B) —á—É—Ç—å –¥–≤–∏–≥–∞–µ–º –ø–æ-—Ä–∞–∑–Ω–æ–º—É.
–¢–∏–ø–∞ –∫–∞–∫ –±—É–¥—Ç–æ —Å—Ç–∞—Ä—ã–π –∫–∏–Ω–µ—Å–∫–æ–ø –º–æ—Ä–≥–∞–µ—Ç –∏–ª–∏ VHS —Ç—É–ø–∏—Ç.
phase –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ t, —á—Ç–æ–± –¥–≤–∏–∂–µ–Ω–∏–µ –±—ã–ª–æ –ø–ª–∞–≤–Ω–æ–µ, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–¥–≤–∏–≥.
        '''
        phase = (t or 0.0) * 2.0 * np.pi / max(0.0001, max(0.1, duration or 1.0))
        dx_r = int(round(np.sin(phase * 1.1) * chroma_shift_px))
        dx_b = -int(round(np.sin(phase * 0.7) * (chroma_shift_px * 0.6)))
        dy_g = int(round(np.cos(phase * 0.9) * (chroma_shift_px * 0.3)))

        # convert to uint8 for rolling and channel math
        '''
–ì–æ—Ç–æ–≤–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∫ —Å–¥–≤–∏–≥—É: –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ uint8 –∏ –¥–µ–ª–∏–º –Ω–∞ –∫–∞–Ω–∞–ª—ã (—Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∫—Ä–∞—Å–Ω—ã–π).
        '''
        result_u = (result_f * 255.0).astype(np.uint8)
        b, g, r = cv2.split(result_u)
        """
–¢—É—Ç –∏ –µ—Å—Ç—å —Å–∞–º –ø—Ä–∏–∫–æ–ª ‚Äî –±–µ—Ä—ë–º –∫–∞–Ω–∞–ª—ã –∏ –¥–≤–∏–≥–∞–µ–º:

b (—Å–∏–Ω–∏–π) –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ,

r (–∫—Ä–∞—Å–Ω—ã–π) —Ç–æ–∂–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏,

g (–∑–µ–ª—ë–Ω—ã–π) –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏.

–ü–æ–ª—É—á–∞–µ—Ç—Å—è —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–π —Ä–∞–∑—ä–µ–∑–¥ –ø–æ –∫—Ä–∞—è–º.
        """
        if dx_b != 0:
            b = np.roll(b, dx_b, axis=1)
        if dx_r != 0:
            r = np.roll(r, dx_r, axis=1)
        if dy_g != 0:
            g = np.roll(g, dy_g, axis=0)
            '''
–°–æ–±–∏—Ä–∞–µ–º –≤—Å—ë –Ω–∞–∑–∞–¥ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0..1].
            '''
        result_u = cv2.merge([b, g, r]).astype(np.float32) / 255.0

        # 10) glitch slices ‚Äî few, small shifts; preserve most of frame, only local bands modified
        """
–î–∞–ª—å—à–µ –ø–æ–π–¥—É—Ç –≥–ª–∏—á–∏ ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ª–∞–≥–Ω—É–ª–∞ –Ω–∞ —Ç–µ–ª–∏–∫–µ.
rng ‚Äî —Å–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞–Ω–¥–æ–º–∞, —á—Ç–æ–± –≤—Å—ë –≤—ã–≥–ª—è–¥–µ–ª–æ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ.
        """
        rng = np.random.RandomState(int((t or 0.0) * 1000) & 0xffffffff)
        res_glitch = result_u.copy()
        n_slices = max(1, int(glitch_slices))
        '''
–ö–∞–∂–¥—ã–π —Å–ª–∞–π—Å –º–æ–∂–µ—Ç –ª–∏–±–æ –≥–ª—é–∫–Ω—É—Ç—å, –ª–∏–±–æ –Ω–µ—Ç ‚Äî –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ glitch_prob.
        '''
        for i in range(n_slices):
            if rng.rand() > glitch_prob:
                continue
            # pick band
            """
–í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π "–æ—Ç—Ä–µ–∑–æ–∫" –ø–æ –≤—ã—Å–æ—Ç–µ (y0..y1) –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ –µ–≥–æ —Å–¥–≤–∏–Ω—É—Ç—å –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (shift).
            """
            y0 = int(rng.randint(0, max(1, h - 2)))
            hh = int(rng.randint(2, max(3, h // (2 * n_slices))))
            y1 = min(h, y0 + hh)
            shift = int(rng.randint(-glitch_max_shift, glitch_max_shift + 1))
            # clamp shift to small magnitude so details not destroyed
            '''
–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–¥–≤–∏–≥, —á—Ç–æ–± –Ω–µ –±—ã–ª–æ –ø—Ä—è–º —Ä–∞–∑—Ä—ã–≤–∞ –≤ –ø–æ–ª-—ç–∫—Ä–∞–Ω–∞.
            '''
            shift = int(np.clip(shift * (0.25 + 0.75 * rng.rand()), -glitch_max_shift, glitch_max_shift))
            if shift == 0:
                continue
            '''
–ë–µ—Ä—ë–º —ç—Ç–æ—Ç –∫—É—Å–æ–∫ –∏ –¥–≤–∏–≥–∞–µ–º –≤–±–æ–∫.
            '''
            band = res_glitch[y0:y1, :, :].copy()
            band = np.roll(band, shift, axis=1)
            # slight color tint inside band (cheap)
            """
–ï—â—ë –∏ —Ü–≤–µ—Ç–æ–∫ –ø–æ–¥–∫—Ä–∞—Å–∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Å–¥–≤–∏–Ω—É—Ç–æ–≥–æ –∫—É—Å–∫–∞,
—á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –ø–æ-–∫–∏–±–µ—Ä–ø–∞–Ω–∫–æ–≤—Å–∫–∏, –∫–∞–∫ –Ω–∞ –±–∏—Ç–æ–º —ç–∫—Ä–∞–Ω–µ.
            """
            tint = 0.9 + 0.4 * rng.rand()  # 0.9..1.3
            band = np.clip(band * (1.0 + (tint - 1.0) * np.array([1.0, 0.9, 1.1])[None, None, :]), 0.0, 1.0)
            res_glitch[y0:y1, :, :] = band

        result_u = (res_glitch * 255.0).astype(np.uint8)

        # 11) subtle scanlines and noise to add cyberpunk texture (very light)
        """
–ù–∞–≤–∞–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–ª–∞–π–Ω—ã ‚Äî —Ç—ë–º–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ CRT —Ç–µ–ª–µ–∫.
scan –ø–æ –≤—ã—Å–æ—Ç–µ —Å–æ–∑–¥–∞—ë—Ç —Å–∏–Ω—É—Å–æ–∏–¥–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏.
        """
        result_f = result_u.astype(np.float32) / 255.0
        yy = np.arange(h, dtype=np.float32)
        scan = 1.0 - (0.5 * np.sin((yy * 1.0) * np.pi / 2.0) ** 2) * scan_strength
        result_f = result_f * scan[:, None, None]

        # color noise
        '''
–î–æ–±–∞–≤–ª—è–µ–º –ª—ë–≥–∫–∏–π —à—É–º–æ–∫, –∫–∞–∫ –±—É–¥—Ç–æ –ø–æ–º–µ—Ö–∏ –Ω–∞ –ø—Ä–æ–≤–æ–¥–µ.
        '''
        noise = (rng.randn(h, w, 3) * noise_strength).astype(np.float32)
        result_f = np.clip(result_f + noise, 0.0, 1.0)

        # 12) final: restore original luminance strongly to keep details (blend a bit of processed luminance)
        '''
–ü–µ—Ä–µ–≤–æ–¥–∏–º —Å–Ω–æ–≤–∞ –≤ YCrCb, —á—Ç–æ–±—ã –∑–∞–º—É—Ç–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é —è—Ä–∫–æ—Å—Ç–∏.
        '''
        result_u8 = (result_f * 255.0).astype(np.uint8)
        # convert to YCrCb, replace Y with mix of original and processed Y
        ycrcb_fin = cv2.cvtColor(result_u8, cv2.COLOR_BGR2YCrCb).astype(np.float32)
        Y_proc, Cr_fin, Cb_fin = cv2.split(ycrcb_fin)
        # blend Y: mostly original (preserve details), some processed (adds slight glow contrast)
        """
–§–∏–Ω—Ç —É—à–∞–º–∏: —è—Ä–∫–æ—Å—Ç—å –±–µ—Ä—ë–º –ø–æ—á—Ç–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é (85%), –Ω–æ –ø–æ–¥–º–µ—à–∏–≤–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –Ω–æ–≤—É—é (15%).
–¢–∞–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏, –Ω–æ –¥–∞—ë–º –º—è–≥–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç –∏ glow.
        """
        blend_y = 0.85 * Y_orig + 0.15 * Y_proc
        ycrcb_fin = cv2.merge([blend_y, Cr_fin, Cb_fin]).astype(np.uint8)
        final = cv2.cvtColor(ycrcb_fin, cv2.COLOR_YCrCb2BGR)

        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º ‚Äî —á–∏—Å—Ç—ã–π –Ω–µ–æ–Ω-–≥–æ–ø–æ-–∫–∏–±–µ—Ä–ø–∞–Ω–∫ üî•
        '''
        return final

    # 17. Zoom shake
    def zoom_shake(self, frame, t, duration,
                               ion_strength=0.9,       # –æ–±—â–∞—è —Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ (0..1)
                               warp_amp=16.0,          # –∞–º–ø–ª–∏—Ç—É–¥–∞ –≤–æ–ª–Ω–æ–≤–æ–π –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏(px)
                               warp_freq=1.8,          # —á–∞—Å—Ç–æ—Ç–∞ –≤–æ–ª–Ω–æ–≤–æ–π –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏
                               radial_pulse_amp=0.12,  # —Å–∏–ª–∞ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–≥–æ –ø—É–ª—å—Å–∞ (–º–∞—Å—à—Ç–∞–±)
                               pulse_speed=6.0,        # —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å—Å–∞
                               trail_decay=0.82,       # –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–±—ã–≤–∞–Ω–∏—è —Å–ª–µ–¥–æ–≤ (0..1)
                               trail_mix=0.28,         # —Å–∫–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Ç—Ä–µ–π–ª
                               rgb_split=2.4,          # –º–∞–∫—Å. —Å–º–µ—â–µ–Ω–∏–µ RGB –∫–∞–Ω–∞–ª–æ–≤(px)
                               bloom_thresh=200,       # –ø–æ—Ä–æ–≥ –¥–ª—è bloom
                               bloom_strength=0.8,     # —Å–∏–ª–∞ bloom –¥–æ–±–∞–≤–∫–∏
                               scanline_strength=0.08, # —Å–∏–ª–∞ —Å–∫–∞–Ω–ª–∞–π–Ω–æ–≤ (0..0.2)
                               grain_amp=4.5):         # —Å–∏–ª–∞ –∑–µ—Ä–Ω–∞
        """
        frame: BGR uint8
        t: –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–∏–ª–∏ –∫–∞–¥—Ä_id / fps ‚Äî –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω—è–ª–æ—Å—å)
        duration: –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –º–æ–∂–Ω–æ –¥–ª—è —Ñ–∞–∑–∏—Ä–æ–≤–∞–Ω–∏—è
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç BGR uint8.
        """
        h, w = frame.shape[:2]

        # --- ensure color ---
        gray_in = (frame.ndim == 2 or frame.shape[2] == 1)
        if gray_in:
            frame = cv2.cvtColor(frame, cv2.COLOR_GRAY2BGR)

        # --- init caches ---
        if not hasattr(self, "_hpi_cache") or self._hpi_cache.get("shape") != (h, w):
            self._hpi_cache = {
                "shape": (h, w),
                "xs": None,
                "ys": None,
                "map_x": None,
                "map_y": None,
                "trail": np.zeros((h, w, 3), dtype=np.float32)
            }
        cache = self._hpi_cache

        # –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–µ —Å–µ—Ç–∫–∏ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ [-1..1]
        if cache["xs"] is None:
            ys = np.linspace(-1.0, 1.0, h, dtype=np.float32)
            xs = np.linspace(-1.0, 1.0, w, dtype=np.float32)
            X, Y = np.meshgrid(xs, ys)
            cache["xs"], cache["ys"] = X, Y

        X, Y = cache["xs"], cache["ys"]

        # --- wave warp: –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∏–Ω—É—Å–æ–∏–¥ –Ω–∞ X/Y (–±—ã—Å—Ç—Ä–∞ –∏ –º–µ–¥–ª–µ–Ω–Ω–∞—è) ---
        # —Å–æ–∑–¥–∞—ë–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        px = float(w)
        py = float(h)
        # –±–∞–∑–æ–≤—ã–µ —Ñ–∞–∑—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –¥–∞—ë—Ç —Ç–µ–∫—É—á–µ—Å—Ç—å
        phase1 = t * 1.6
        phase2 = t * 3.9 + 1.7

        # –¥–≤—É–º–µ—Ä–Ω—ã–µ –≤–æ–ª–Ω—ã
        wave_x = (np.sin((X * warp_freq * 3.0 + phase1) * 2.0 * math.pi) +
                  0.5 * np.sin((Y * warp_freq * 6.0 + phase2) * 2.0 * math.pi))
        wave_y = (np.cos((Y * warp_freq * 3.3 + phase2) * 2.0 * math.pi) +
                  0.5 * np.cos((X * warp_freq * 5.2 + phase1) * 2.0 * math.pi))

        disp_x = (wave_x * warp_amp * ion_strength).astype(np.float32)
        disp_y = (wave_y * (warp_amp * 0.6) * ion_strength).astype(np.float32)

        # --- radial pulsing / proton core: –º–∞—Å—à—Ç–∞–± + slight pinch ---
        cx = 0.0  # center in normalized coords (X,Y already -1..1 centered)
        cy = 0.0
        R = np.sqrt((X - cx) ** 2 + (Y - cy) ** 2)  # 0..~1.4
        # –ø—É–ª—å—Å, –±–µ–≥—É—â–∏–π –Ω–∞—Ä—É–∂—É
        pulse = 0.5 * (1.0 + np.sin(pulse_speed * t - R * 10.0))
        pulse = np.clip(pulse, 0.0, 1.0)
        # —Ä–∞–¥–∏–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (—É–º–µ–Ω—å—à–∏–º –≤ —Ü–µ–Ω—Ç—Ä–µ, –¥–æ–±–∞–≤–∏–º –∫–æ–ª—å—Ü–∞)
        radial = (pulse * radial_pulse_amp * ion_strength) / (R + 0.35)
        # –ø–µ—Ä–µ–≤–æ–¥ –≤ –ø–∏–∫—Å–µ–ª–∏: –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–∏—Å–ø–ª–µ–π
        radial_x = (X * radial * px).astype(np.float32)
        radial_y = (Y * radial * py).astype(np.float32)

        # --- combine displacements –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è remap ---
        # –±–∞–∑–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        base_x = (X * (w * 0.5) + (w * 0.5)).astype(np.float32)
        base_y = (Y * (h * 0.5) + (h * 0.5)).astype(np.float32)

        map_x = base_x + disp_x + radial_x
        map_y = base_y + disp_y + radial_y

        # –Ω–µ–±–æ–ª—å—à–∞—è –ø—Å–µ–≤–¥–æ-—Å–ª—É—á–∞–π–Ω–∞—è —Ñ–∞–∑–∞: –ø–µ—Ä-–∫–∞–¥—Ä —Å–º–µ—â–µ–Ω–∏–µ
        jitter = 0.5 * ion_strength * np.array([math.sin(t * 9.1), math.cos(t * 7.3)], dtype=np.float32)
        map_x += jitter[0]
        map_y += jitter[1]

        # --- resample –æ–¥–∏–Ω —Ä–∞–∑ —Å remap ---
        warped = cv2.remap(frame, map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        # --- RGB split: –∫–∞–∂–¥–æ–º—É –∫–∞–Ω–∞–ª—É —Å–≤–æ–π –Ω–µ–±–æ–ª—å—à–æ–π remap (cheap: just shift) ---
        # —Å–¥–≤–∏–≥–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ñ–∞–∑
        sR = rgb_split * (0.5 + 0.5 * math.sin(t * 3.1 + 0.2)) * ion_strength
        sB = rgb_split * (0.5 + 0.5 * math.cos(t * 2.3 + 1.4)) * ion_strength
        # —Å–æ–∑–¥–∞—ë–º —Ç–∞–∫–∏–µ –∂–µ –∫–∞—Ä—Ç—ã, —Å–¥–≤–∏–Ω—É—Ç—ã–µ –ø–æ X
        map_x_r = (map_x + sR).astype(np.float32)
        map_y_r = map_y
        map_x_b = (map_x - sB).astype(np.float32)
        map_y_b = map_y

        r = cv2.remap(frame[:, :, 2], map_x_r, map_y_r, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        g = cv2.remap(warped[:, :, 1], map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        b = cv2.remap(frame[:, :, 0], map_x_b, map_y_b, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)
        merged = cv2.merge([b, g, r])

        # --- bloom / proton flare: —è—Ä–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏ —Ä–∞–∑–º–∞–∑—ã–≤–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ ---
        # bright pass
        gray = cv2.cvtColor(merged, cv2.COLOR_BGR2GRAY).astype(np.float32)
        bright_mask = np.clip((gray - bloom_thresh) / (255.0 - bloom_thresh), 0.0, 1.0)
        bright_mask = cv2.GaussianBlur(bright_mask, (0, 0), sigmaX=6.0)  # —Ä–∞–∑–º—ã—Ç–∏–µ –º–∞—Å–∫–∏
        # apply blur on bright parts
        bright = (merged.astype(np.float32) * bright_mask[:, :, None])
        blurred_bright = cv2.GaussianBlur(bright, (0, 0), sigmaX=12.0)
        # color dodge-like add
        merged = np.clip(merged.astype(np.float32) + blurred_bright * bloom_strength, 0, 255).astype(np.uint8)

        # --- temporal trail (cheap feedback) ---
        trail = cache["trail"]
        # —Å–º–µ—à–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π trail —Å —Ç–µ–∫—É—â–∏–º –∫–∞–¥—Ä–æ–º (–∫–∞–∫ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–µ–¥)
        frame_f = merged.astype(np.float32)
        # decay –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ
        trail *= trail_decay
        trail += frame_f * trail_mix * ion_strength
        # combine trail and current (weighted)
        combined = np.clip(frame_f + trail * 0.6, 0, 255).astype(np.uint8)

        # --- scanlines –∏ CRT-ish contrast ---
        # –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ/–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–Ω–∫–∏–µ –ø–æ–ª–æ—Å—ã: use sin over rows
        lines = (0.5 + 0.5 * np.sin((np.arange(h, dtype=np.float32)[:, None] / 1.0) * 3.1415 * 2.0 + t * 18.0))
        lines = 1.0 - scanline_strength * (1.0 - lines)  # invert small darkening
        combined = (combined.astype(np.float32) * lines[:, :, None]).astype(np.uint8)

        # --- grain (cheap) ---
        if grain_amp > 0.01:
            gn = np.random.randn(h // 2, w // 2, 1).astype(np.float32)
            gn = cv2.resize(gn, (w, h), interpolation=cv2.INTER_LINEAR)
            # sometimes cv2.resize squeezes the last dim -> force 3D
            if gn.ndim == 2:
                gn = gn[:, :, None]
            # normalize
            gn = (gn - gn.mean()) / (gn.std() + 1e-9)
            noise = (gn * grain_amp).astype(np.float32)
            # expand single channel noise to 3 channels to match image
            if noise.shape[2] == 1:
                noise = np.repeat(noise, 3, axis=2)
            combined = np.clip(combined.astype(np.float32) + noise, 0, 255).astype(np.uint8)
            
        # --- final tint / clamp ---
        # –ª—ë–≥–∫–∞—è —Å–∏–Ω—è—è/—Ü–∏–∞–Ω–æ–≤–∞—è —Ç–æ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è "–∏–æ–Ω–Ω–æ–≥–æ" –Ω–∞—Å—Ç—Ä–æ—è
        tint = np.array([0.92, 0.96, 1.04], dtype=np.float32)  # BGR multipliers
        out = np.clip(combined.astype(np.float32) * tint[None, None, :], 0, 255).astype(np.uint8)

        # save trail back
        cache["trail"] = trail

        if gray_in:
            out = cv2.cvtColor(out, cv2.COLOR_BGR2GRAY)

        return out

    # 18. VHS noise
    def vhs_noise44(self, frame, t, duration):
        
        h, w = frame.shape[:2]
        if not hasattr(self, 'prev_frames'):
            self.prev_frames = []

        # —Ä–∞–±–æ—Ç–∞ –≤ float [0..1]
        f = frame.astype(np.float32) / 255.0

        # –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π RNG –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–¥—Ä–∞
        rng = np.random.RandomState(int((t * 1000)) & 0xFFFFFFFF)

        # 1) –ú–µ—Ä—Ü–∞–Ω–∏–µ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
        flicker_base = 0.04 * np.sin(2.0 * np.pi * t * 3.2) + rng.randn() * 0.01
        rows = np.arange(h)
        flicker_rows = 0.02 * np.sin(rows * 0.55 + t * 25.0)
        flicker = (1.0 + flicker_base + flicker_rows).astype(np.float32)  # shape (h,)
        f *= flicker[:, None, None]

        # 2) –°–∫–∞–Ω–ª–∞–π–Ω—ã
        scan_strength = 0.06
        scan = 1.0 - scan_strength * ((rows % 2) == 0).astype(np.float32)
        scan = cv2.GaussianBlur(scan[:, None], (1, 5), 0)  # shape (h,1)
        f *= scan[:, :, None]

        # 3) –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π –¥—Ä–æ–∂–∞—â–∏–π —Å–¥–≤–∏–≥ –∏ —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è
        b_ch = f[:, :, 0].copy()
        g_ch = f[:, :, 1].copy()
        r_ch = f[:, :, 2].copy()

        base_shift = int(1 + 2 * (0.5 + 0.5 * np.sin(t * 5.0)))
        row_jitter = (np.sin(rows * 0.12 + t * 30.0) * 2.0 + rng.randn(h) * 0.6).astype(np.float32)
        shift_b = (row_jitter + base_shift).astype(np.int32)
        shift_r = (row_jitter - base_shift).astype(np.int32)
        shift_g = (row_jitter * 0.45).astype(np.int32)

        cols_idx = np.arange(w)[None, :]

        def shift_channel(ch, shifts):
            idx = (cols_idx - shifts[:, None]) % w
            return ch[np.arange(h)[:, None], idx]

        b_ch = shift_channel(b_ch, shift_b)
        g_ch = shift_channel(g_ch, shift_g)
        r_ch = shift_channel(r_ch, shift_r)
        f = np.stack([b_ch, g_ch, r_ch], axis=2)

        # 4) –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã/—Ü–∞—Ä–∞–ø–∏–Ω—ã
        stripe_mask = np.zeros((h, w), dtype=np.float32)
        n_stripes = max(1, w // 70)
        xs = rng.randint(0, w, size=n_stripes)
        for x in xs:
            width = rng.randint(1, 4)
            intensity = rng.uniform(-0.27, 0.27)
            ygrad = (np.linspace(-1.0, 1.0, h) ** 2).astype(np.float32)
            x0 = max(0, x - width)
            x1 = min(w, x + width)
            stripe_mask[:, x0:x1] += intensity * (0.6 + 0.4 * ygrad)[:, None]
        stripe_mask = cv2.GaussianBlur(stripe_mask, (3, 7), 0)
        f += stripe_mask[:, :, None] * 0.6

        # 5) –ò–æ–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏ / –≤—Å–ø—ã—à–∫–∏ (—è—Ä–∫–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏ —Å bloom)
        ion_mask = np.zeros((h, w), dtype=np.float32)
        n_ions = rng.randint(6, 16)
        for _ in range(n_ions):
            cy = rng.randint(0, h)
            cx = rng.randint(0, w)
            strength = rng.uniform(0.4, 1.2) * (0.6 + 0.4 * abs(np.sin(t * 2.0)))
            size = rng.randint(1, 5)
            y0 = max(0, cy - size * 3)
            y1 = min(h, cy + size * 3 + 1)
            x0 = max(0, cx - size * 3)
            x1 = min(w, cx + size * 3 + 1)
            yy, xx = np.mgrid[y0:y1, x0:x1]
            dy = yy - cy
            dx = xx - cx
            blob = np.exp(-(dx * dx + dy * dy) / (2.0 * (size**2 + 1.0)))
            ion_mask[y0:y1, x0:x1] += blob * strength
        ion_bloom = cv2.GaussianBlur(ion_mask, (0, 0), 6)
        ion_color = np.empty((h, w, 3), dtype=np.float32)
        ion_color[:, :, 0] = 0.6 + 0.4 * np.sin(t * 1.3)
        ion_color[:, :, 1] = 0.2 + 0.3 * np.cos(t * 0.9)
        ion_color[:, :, 2] = 0.7 - 0.4 * np.sin(t * 0.7)
        f += (ion_bloom[:, :, None] * ion_color) * 0.85
        # 6) VHS-–∑–µ—Ä–Ω–æ / —Ö—Ä–æ–º–∞-—à—É–º (FIXED: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º 3D-—Ñ–æ—Ä–º—É grain)
        grain = rng.randn(h, w, 1).astype(np.float32) * 0.055
        # —Ä–∞–∑–º—ã–≤–∞–µ–º –ø–æ 2D; —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω–æ–≥–¥–∞ —Ç–µ—Ä—è–µ—Ç —Ç—Ä–µ—Ç—å—é –æ—Å—å -> –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
        grain_blur = cv2.GaussianBlur(grain[:, :, 0], (3, 3), 0)
        # FIXED: –ø—Ä–∏–≤–µ–¥—ë–º –∫ (h,w,1)
        grain = grain_blur[:, :, None]
        # —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–æ–º–∞-—à—É–º–∞
        chroma_noise = np.concatenate([
            grain * (1.0 + 0.6 * rng.randn()), 
            grain * 0.6, 
            grain * (1.1 + 0.4 * rng.randn())
        ], axis=2)
        f += chroma_noise * 1.0

        # 7) –ì–ª–∏—Ç—á-–±–ª–æ–∫–∏
        n_glitches = rng.randint(1, 4)
        for _ in range(n_glitches):
            gh = rng.randint(max(4, h // 20), max(8, h // 6))
            gw = rng.randint(max(8, w // 20), max(16, w // 6))
            gy = rng.randint(0, max(1, h - gh))
            gx = rng.randint(0, max(1, w - gw))
            shift = rng.randint(-gw // 3, gw // 3)
            block = f[gy:gy+gh, gx:gx+gw, :].copy()
            for ci, s in enumerate([shift, -shift//2, shift//3]):
                block[:, :, ci] = np.roll(block[:, :, ci], s, axis=1)
            block = np.clip((block - 0.2) * 1.15 + 0.2, 0.0, 1.0)
            f[gy:gy+gh, gx:gx+gw, :] = block

        # 8) –ú–µ—Å—Ç–Ω–∞—è –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è (–º–æ–∑–∞–∏–∫–∞) –≤ –ø–æ–ª–æ—Å–∞—Ö
        if rng.rand() < 0.8:
            band_h = max(8, h // 10)
            by = rng.randint(0, max(1, h - band_h))
            small_h = max(1, band_h // 4)
            small_w = max(1, w // 20)
            small = cv2.resize(f[by:by+band_h], (small_w, small_h), interpolation=cv2.INTER_LINEAR)
            small_up = cv2.resize(small, (w, band_h), interpolation=cv2.INTER_NEAREST)
            mix = rng.uniform(0.08, 0.28)
            f[by:by+band_h] = f[by:by+band_h] * (1.0 - mix) + small_up * mix

        # 9) Ghost / —Ñ–∞–Ω—Ç–æ–º—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–∞–¥—Ä–æ–≤
        if len(self.prev_frames) > 0:
            if len(self.prev_frames) >= 2:
                prev = np.mean(np.stack(self.prev_frames[-2:], axis=0), axis=0).astype(np.float32) / 255.0
            else:
                prev = self.prev_frames[-1].astype(np.float32) / 255.0
            prev = cv2.GaussianBlur(prev, (9, 9), 6)
            ghost_shift = int(4 * np.sin(t * 3.0))
            if ghost_shift != 0:
                prev = np.roll(prev, ghost_shift, axis=1)
            f = cv2.addWeighted(f, 1.0, prev * 0.6, 0.12, 0.0)

        # 10) –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è ¬´roll¬ª –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
        if rng.rand() < 0.25:
            roll_off = int(rng.randn() * 6)
            f = np.roll(f, roll_off, axis=1)

        # 11) –ö—Ä–∏–≤—ã–µ / posterize
        f = np.clip(f, 0.0, 1.0)
        f = np.power(f, 1.0 / (1.0 + 0.02 * np.sin(t * 0.9)))

        # 12) CRT-–∏—Å–∫–∞–∂–µ–Ω–∏–µ (remap)
        k = 0.06 * (0.7 + 0.6 * np.sin(t * 0.6))
        cx = w / 2.0
        cy = h / 2.0
        xv, yv = np.meshgrid(np.arange(w), np.arange(h))
        nx = (xv - cx) / cx
        ny = (yv - cy) / cy
        rr = np.sqrt(nx * nx + ny * ny)
        factor = 1.0 + k * (rr ** 2)
        map_x = (cx + nx * factor * cx).astype(np.float32)
        map_y = (cy + ny * factor * cy).astype(np.float32)
        f = cv2.remap(f.astype(np.float32), map_x, map_y, interpolation=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        # 13) –§–∏–Ω–∞–ª
        f = cv2.GaussianBlur(f, (3, 3), 0.6)
        f = np.clip(f, 0.0, 1.0)

        # 14) –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∞
        self.prev_frames.append(frame.copy())
        if len(self.prev_frames) > 4:
            self.prev_frames.pop(0)

        out = (f * 255.0).clip(0, 255).astype(np.uint8)
        return out

    # 19. Glow aura
    def glow_aura(self, frame, t, duration):
        h, w = frame.shape[:2]
        dur = max(1e-6, duration)
        phase = (t % dur) / dur
        pi2 = 2.0 * math.pi

        # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å
        global_shift_rel = 0.06    # –¥–æ–ª—è —à–∏—Ä–∏–Ω—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–¥–≤–∏–≥–∞ (—è–≤–Ω—ã–π, –Ω–æ –ø–ª–∞–≤–Ω—ã–π)
        chroma_rel = 0.035         # –¥–æ–ª—è —à–∏—Ä–∏–Ω—ã –¥–ª—è RGB —Ä–∞–∑—Ä—ã–≤–∞
        flicker_amp = 0.9          # —Å–∏–ª–∞ —Ü–≤–µ—Ç–æ–≤—ã—Ö –º–µ—Ä—Ü–∞–Ω–∏–π (0..1)
        yellow_amp = 1.0
        pink_amp = 0.95
        noise_grid = max(6, min(48, w // 30))  # low-res mask —Ä–∞–∑–º–µ—Ä
        noise_blur = 3.0
        edge_glow_amt = 0.85
        sat_boost = 1.18           # –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Ñ–∏–Ω–∞–ª–∞
        final_mix = 0.92           # —Å–∫–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ vs –æ—Ä–∏–≥–∏–Ω–∞–ª (—á–∏—Ç–∞–µ–º–æ—Å—Ç—å)

        # –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π RNG –ø–æ –∫–∞–¥—Ä—É (–ø–ª–∞–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
        seed = int(t * 1000.0) & 0xffffffff
        rng = np.random.RandomState(seed)

        # float32 —Ä–∞–±–æ—á–∞—è –∫–æ–ø–∏—è
        src = frame.astype(np.float32) / 255.0

        # 1) –ø–ª–∞–≤–Ω—ã–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π X-—Å–¥–≤–∏–≥ (subpixel, –±–µ–∑ —Ä–µ–∑–∫–∏—Ö –ø—Ä—ã–∂–∫–æ–≤)
        g_shift = (math.sin(pi2 * (phase * 0.95)) * 0.5 + 0.5 * math.sin(pi2 * (phase * 2.7)) * 0.25)
        g_shift_px = float(w) * global_shift_rel * g_shift
        # –Ω–µ–±–æ–ª—å—à–æ–π –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–º–ø—É–ª—å—Å
        g_shift_px += (rng.rand() - 0.5) * (w * 0.01)
        Mg = np.array([[1.0, 0.0, g_shift_px], [0.0, 1.0, 0.0]], dtype=np.float32)
        shifted = cv2.warpAffine(src, Mg, (w, h), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        # 2) chroma split ‚Äî subpixel R/B —Å–º–µ—â–µ–Ω–∏—è (–ø–ª–∞–≤–Ω–æ —Å–≤—è–∑–∞–Ω—ã —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å–¥–≤–∏–≥–æ–º)
        max_chroma = float(w) * chroma_rel
        ch_phase = math.sin(pi2 * (phase * 1.7 + 0.12))
        shift_r = g_shift_px * 0.9 + max_chroma * (0.6 + 0.4 * ch_phase) + (rng.rand() - 0.5) * 2.0
        shift_b = g_shift_px * -0.7 - max_chroma * (0.4 + 0.4 * ch_phase) + (rng.rand() - 0.5) * 2.0

        def warp_chan_f(ch, dx):
            if abs(dx) < 1e-3:
                return ch
            M = np.array([[1.0, 0.0, float(dx)], [0.0, 1.0, 0.0]], dtype=np.float32)
            return cv2.warpAffine(ch, M, (w, h), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        b = warp_chan_f(shifted[:, :, 0], shift_b)
        g = warp_chan_f(shifted[:, :, 1], 0.0)
        r = warp_chan_f(shifted[:, :, 2], shift_r)
        chroma = np.stack([b, g, r], axis=2)

        # 3) —Ü–≤–µ—Ç–æ–≤—ã–µ –º–µ—Ä—Ü–∞–Ω–∏—è ‚Äî –¥–µ–ª–∞–µ–º –¥–≤–∞ —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã—Ö low-res –ø–æ–ª—è (–∂—ë–ª—Ç–æ–µ –∏ —Ä–æ–∑–æ–≤–æ–µ)
        nx = max(3, noise_grid)
        ny = max(3, noise_grid)
        ny_field = rng.randn(ny, nx).astype(np.float32)
        pm_field = rng.randn(ny, nx).astype(np.float32)

        ny_up = cv2.resize(ny_field, (w, h), interpolation=cv2.INTER_LINEAR)
        pm_up = cv2.resize(pm_field, (w, h), interpolation=cv2.INTER_LINEAR)
        ny_up = cv2.GaussianBlur(ny_up, (0, 0), noise_blur)
        pm_up = cv2.GaussianBlur(pm_up, (0, 0), noise_blur)

        def norm01(x):
            mn = x.min()
            mx = x.max()
            if mx - mn < 1e-6:
                return np.zeros_like(x)
            y = (x - mn) / (mx - mn)
            return np.clip(y, 0.0, 1.0)

        mask_y = norm01(ny_up * (0.7 + 0.6 * math.sin(pi2 * phase * 2.3)))
        mask_p = norm01(pm_up * (0.8 + 0.5 * math.cos(pi2 * phase * 1.6 + 0.9)))

        # —è—Ä–∫–∏–µ BGR-—Ü–≤–µ—Ç–∞ (–Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –Ω–∞—Å—ã—â–µ–Ω–Ω–æ–≥–æ –∂–µ–ª—Ç–æ–≥–æ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ–≥–æ —Ä–æ–∑–æ–≤–æ–≥–æ)
        yellow_bgr = np.array([0.12, 0.95, 1.0], dtype=np.float32)  # —Å–ª–µ–≥–∫–∞ —Ö–æ–ª–æ–¥–Ω–æ–≤–∞—Ç—ã–π –∂–µ–ª—Ç—ã–π -> —Å–æ—á–Ω–æ—Å—Ç—å
        pink_bgr   = np.array([1.0, 0.30, 0.78], dtype=np.float32)  # —è—Ä–∫–∏–π —Ä–æ–∑–æ–≤—ã–π

        # —Å–æ–∑–¥–∞—ë–º —Ü–≤–µ—Ç–æ–≤—ã–µ –ø–æ–ª—è (additive ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å)
        # –ø–ª–∞–≤–Ω—ã–π —Å–∏–Ω—É—Å-–∏–º–ø—É–ª—å—Å –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
        amp_y = yellow_amp * (0.6 + 0.4 * math.sin(pi2 * (phase * 3.1 + 0.2)))
        amp_p = pink_amp   * (0.5 + 0.5 * math.cos(pi2 * (phase * 2.0 + 0.7)))
        color_overlay = (mask_y[:, :, None] * yellow_bgr[None, None, :] * amp_y +
                         mask_p[:, :, None] * pink_bgr[None, None, :] * amp_p) * flicker_amp

        # 4) –∫–æ–Ω—Ç—É—Ä–Ω—ã–π –Ω–µ–æ–Ω–æ–≤—ã–π glow (Sobel –Ω–∞ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ, –∑–∞—Ç–µ–º —Ä–∞—Å–∫—Ä–∞—à–∏–≤–∞–µ–º)
        gray = cv2.cvtColor((src * 255.0).astype(np.uint8), cv2.COLOR_BGR2GRAY).astype(np.float32) / 255.0
        sx = cv2.Sobel(gray, cv2.CV_32F, 1, 0, ksize=3)
        sy = cv2.Sobel(gray, cv2.CV_32F, 0, 1, ksize=3)
        mag = np.sqrt(sx * sx + sy * sy)
        mag = cv2.GaussianBlur(mag, (0, 0), 4.0)
        if mag.max() > 1e-6:
            mag = mag / (mag.max() + 1e-9)
        neon_col = np.array([1.0, 0.9, 0.28], dtype=np.float32)  # warm neon tint
        edge_glow = (mag[:, :, None] * neon_col[None, None, :]) * edge_glow_amt

        # 5) —Å–ª–æ–∂–µ–Ω–∏–µ: chroma + additive overlays + edge glow, –∑–∞—Ç–µ–º –º—è–≥–∫–∏–π crossfade —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        additive = chroma + color_overlay * 0.9 + edge_glow * 0.8
        # –Ω–µ–±–æ–ª—å—à–æ–π local contrast boost to keep colors pop
        boosted = np.clip(additive * 1.0 + (additive - cv2.GaussianBlur(additive, (0, 0), 3.0)) * 0.18, 0.0, 1.0)

        # 6) –ª—ë–≥–∫–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏ (HSV S channel tweak) ‚Äî –≤ float
        hsv = cv2.cvtColor((boosted * 255.0).astype(np.uint8), cv2.COLOR_BGR2HSV).astype(np.float32)
        h_ch, s_ch, v_ch = cv2.split(hsv)
        s_ch = np.clip(s_ch * sat_boost, 0, 255)
        hsv = cv2.merge([h_ch, s_ch, v_ch]).astype(np.uint8)
        saturated = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR).astype(np.float32) / 255.0

        # 7) —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –º—è–≥–∫–∏–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥—Ä–µ–π—Ñ X (–æ—á–µ–Ω—å –ø–ª–∞–≤–Ω–æ) ‚Äî –µ—â—ë –æ–¥–Ω–æ –Ω–µ–±–æ–ª—å—à–æ–µ warp, –≤ float
        final_shift = float(w) * (global_shift_rel * 0.45) * math.cos(pi2 * (phase * 0.9 + 0.37))
        final_shift += (rng.rand() - 0.5) * (w * 0.006)
        Mf = np.array([[1.0, 0.0, final_shift], [0.0, 1.0, 0.0]], dtype=np.float32)
        final_warp = cv2.warpAffine(saturated, Mf, (w, h), flags=cv2.INTER_LINEAR, borderMode=cv2.BORDER_REFLECT)

        # 8) —Å–º–µ—à–∏–≤–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –ª–æ–≥–æ—Ç–∏–ø–æ–≤/–¥–µ—Ç–∞–ª–µ–π
        out = np.clip(src * (1.0 - final_mix) + final_warp * final_mix, 0.0, 1.0)

        # 9) —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω–∫–∏–π —à—É–º (low-res) –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã –±–µ–∑ —è—Ä–∫–∏—Ö –ø–∏–∫—Å–µ–ª–µ–π
        ns_h = max(2, h // 36)
        ns_w = max(2, w // 36)
        small_noise = rng.normal(0.0, 1.0, (ns_h, ns_w)).astype(np.float32)
        noise_up = cv2.resize(small_noise, (w, h), interpolation=cv2.INTER_LINEAR)
        noise_up = cv2.GaussianBlur(noise_up, (0, 0), 1.2)
        out = np.clip(out + (noise_up[:, :, None] * (4.0 / 255.0)), 0.0, 1.0)

        return (out * 255.0).astype(np.uint8)

    # 20. Circle ripple
    def circle_ripple44(self, frame, t, duration,
                      pull=0.85,        # 0..1 ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ —Å–∂–∏–º–∞–µ–º –Ω–∞—Ä—É–∂–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤ —Ü–µ–Ω—Ç—Ä
                      turns=3.0,        # —Å–∫–æ–ª—å–∫–æ –≤–∏—Ç–∫–æ–≤ (–º–∞–∫—Å) –≤–æ—Ä–æ–Ω–∫–∏
                      spin_rate=1.5,    # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏
                      falloff=1.0,      # –∫–∞–∫ –±—ã—Å—Ç—Ä–æ —Å–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ —É–±—ã–≤–∞–µ—Ç –∫ –∫—Ä–∞—é (>0)
                      interp=cv2.INTER_LINEAR):
        """
        –ó–∞–∫—Ä—É—á–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ –≤ –≤–æ—Ä–æ–Ω–∫—É (–±–µ–∑ "–≤–æ–ª–Ω–æ–≤–æ–≥–æ" —Ä–∞–∑–º–∞–∑—ã–≤–∞–Ω–∏—è).
        frame: BGR numpy array
        t: —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (s)
        duration: –æ–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–∂–Ω–æ –ø–æ–¥–±–∏—Ä–∞—Ç—å.
        """
        h, w = frame.shape[:2]
        cx, cy = w / 2.0, h / 2.0

        key = (w, h)
        cache = getattr(self, '_vortex_cache', None)
        if cache is None or cache.get('key') != key:
            # —Å–µ—Ç–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑
            xs, ys = np.meshgrid(np.arange(w, dtype=np.float32),
                                 np.arange(h, dtype=np.float32))
            dx = xs - cx
            dy = ys - cy
            r = np.sqrt(dx * dx + dy * dy)
            r_safe = np.where(r == 0.0, 1.0, r).astype(np.float32)
            theta = np.arctan2(dy, dx).astype(np.float32)
            maxr = np.sqrt(cx * cx + cy * cy).astype(np.float32)
            cache = {
                'key': key, 'xs': xs, 'ys': ys, 'dx': dx, 'dy': dy,
                'r': r.astype(np.float32), 'r_safe': r_safe, 'theta': theta,
                'maxr': np.float32(maxr)
            }
            self._vortex_cache = cache

        xs = cache['xs']; ys = cache['ys']
        dx = cache['dx']; dy = cache['dy']
        r = cache['r']; r_safe = cache['r_safe']
        theta = cache['theta']; maxr = cache['maxr']

        prog = np.clip(t / max(duration, 1e-6), 0.0, 1.0)

        # –¥–µ–ª–∞–µ–º exponent < 1 –¥–ª—è —Å–∂–∞—Ç–∏—è: —á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–∂–∞—Ç–∏–µ
        # exponent = 1.0 - pull * prog, –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω—É–ª—è
        exponent = np.clip(1.0 - pull * prog, 0.08, 1.0)

        # –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–¥–∏–∞–ª—å–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ 0..1
        r_norm = (r / maxr).astype(np.float32)

        # –Ω–æ–≤–æ–µ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ (–±–µ—Ä—ë–º —Å—Ç–µ–ø–µ–Ω—å <1 —á—Ç–æ–±—ã –≤–∑—è—Ç—å source –¥–∞–ª—å—à–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞)
        r_src = maxr * (r_norm ** exponent)

        # —É–≥–æ–ª: –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏—Ç–∫–∏, —Å–∏–ª—å–Ω–µ–µ —É —Ü–µ–Ω—Ç—Ä–∞ (1 - r_norm^falloff)
        twist = turns * 2.0 * np.pi * (1.0 - (r_norm ** np.maximum(0.001, falloff))) * prog
        # –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏–Ω –≤–æ –≤—Ä–µ–º–µ–Ω–∏
        time_spin = t * spin_rate
        theta_src = theta + twist + time_spin

        # –æ–±—Ä–∞—Ç–Ω–æ –≤ –¥–µ–∫–∞—Ä—Ç–æ–≤—ã–µ ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        map_x = (cx + r_src * np.cos(theta_src)).astype(np.float32)
        map_y = (cy + r_src * np.sin(theta_src)).astype(np.float32)

        # remap (–æ–±—Ä–∞—Ç–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ dst –±–µ—Ä–µ–º src)
        out = cv2.remap(frame, map_x, map_y, interpolation=interp, borderMode=cv2.BORDER_REFLECT)

        return out

    def neon_glitch2(self, frame, t, duration,
                max_band_height=8,       # –º–∞–∫—Å –≤—ã—Å–æ—Ç–∞ –ø–æ–ª–æ—Å—ã –≥–ª–∏—Ç—á–∞
                base_bands=6,            # –±–∞–∑–æ–≤–æ–µ —á–∏—Å–ª–æ –ø–æ–ª–æ—Å
                downscale=4):            # —Ñ–∞–∫—Ç–æ—Ä —É–º–µ–Ω—å—à–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (—á–µ–º –±–æ–ª—å—à–µ ‚Äî –ª–µ–≥—á–µ)
        """
        frame: BGR uint8
        t: —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (—Å–µ–∫)
        duration: –æ–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞ (—Å–µ–∫)
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç BGR uint8 —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º.
        """
        if duration <= 0:
            progress = 1.0
        else:
            progress = float(t) / float(duration)
            progress = max(0.0, min(1.0, progress))

        h, w = frame.shape[:2]

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏–ª—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        band_count = int(base_bands + progress * 18)          # –æ—Ç base_bands –¥–æ ~24
        max_shift = int(1 + progress * 20)                   # –ø–∏–∫—Å–µ–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –¥–ª—è –ø–æ–ª–æ—Å
        glow_strength = 0.3 + 0.7 * progress                  # –æ—Ç 0.3 –¥–æ 1.0 (–≤–ª–∏—è–Ω–∏–µ glow –ø—Ä–∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–∏)
        chroma_shift = int(1 + progress * 3)                 # —Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–±–µ—Ä—Ä–∞—Ü–∏–∏

        # –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ–¥–∏–Ω —Ä–∞–∑ (–±—É–¥–µ–º –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å)
        out = frame.copy()

        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö "—Å–ª—É—á–∞–π–Ω—ã—Ö" –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏,
        # —á—Ç–æ–±—ã –∫–∞–¥—Ä—ã –±—ã–ª–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (–º–µ–Ω—å—à–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —à—É–º–∞)
        rng = np.random.RandomState(int(t * 1000) & 0xffffffff)

        # –ù–∞–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–æ—Å-–≥–ª–∏—Ç—á–µ–π: –±–µ—Ä–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ª–æ—Å—ã –∏ np.roll –∏—Ö –ø–æ X.
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–æ—Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–±–æ–ª—å—à–æ–µ => —Ü–∏–∫–ª OK –∏ –±—ã—Å—Ç—Ä—ã–π –≤ C.
        for _ in range(band_count):
            y0 = rng.randint(0, max(1, h - 1))
            bh = rng.randint(1, max(1, min(max_band_height, h - y0)))
            shift = rng.randint(-max_shift, max_shift + 1)
            # –Ω–µ–±–æ–ª—å—à–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –∏–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º —É–∑–∫–∏–µ –ø–æ–ª–æ—Å—ã –∏–ª–∏ —á—É—Ç—å –±–æ–ª—å—à–µ ‚Äî –≤—ã–≥–ª—è–¥–∏—Ç –∂–∏–≤–µ–µ
            out[y0:y0 + bh, :] = np.roll(out[y0:y0 + bh, :], shift, axis=1)

        # –ë—ã—Å—Ç—Ä—ã–π –Ω–µ–æ–Ω–æ–≤—ã–π —Å–≤–µ—Ç: —Ä–∞–±–æ—Ç–∞–µ–º —Å —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∫–æ–ø–∏–µ–π –≥—Ä–∞–¥–∞—Ü–∏–π —Å–µ—Ä–æ–≥–æ,
        # –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–ª–æ—Ä–º—ç–ø –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∑–∞–¥ —Å —Ä–∞–∑–º—ã—Ç–∏–µ–º.
        gray = cv2.cvtColor(out, cv2.COLOR_BGR2GRAY)
        small_w, small_h = max(1, w // downscale), max(1, h // downscale)
        gray_small = cv2.resize(gray, (small_w, small_h), interpolation=cv2.INTER_LINEAR)

        # –ö–æ–ª–æ—Ä–º–∞–ø –Ω–∞ 1-–∫–∞–Ω–∞–ª–µ ‚Äî —ç—Ç–æ –¥–µ—à–µ–≤–ª–µ, —á–µ–º –Ω–∞ –ø–æ–ª–Ω–æ–º BGR
        glow_small = cv2.applyColorMap(gray_small, cv2.COLORMAP_HOT)

        # –†–∞–∑–º—ã—Ç–∏–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–∞–¥ (—Ä–∞–∑–º—ã—Ç–∏–µ –¥–µ–ª–∞–µ–º –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∏ –∑–∞—Ç–µ–º –∞–ø—Å–∫–µ–π–ª–∏–º)
        sigma = 1.0 + progress * 3.0
        glow_small = cv2.GaussianBlur(glow_small, (0, 0), sigmaX=sigma, sigmaY=sigma)
        glow = cv2.resize(glow_small, (w, h), interpolation=cv2.INTER_LINEAR)

        # –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è (—Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤), –Ω–æ –æ—á–µ–Ω—å –ª—ë–≥–∫–∞—è ‚Äî –¥–µ—à—ë–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
        if chroma_shift > 0:
            b, g, r = cv2.split(out)
            # –ù–µ–±–æ–ª—å—à–∏–µ np.roll –ø–æ X/Y: –¥–µ–ª–∞–µ–º –∫–æ–ø–∏–∏ –∫–∞–Ω–∞–ª–æ–≤, –Ω–æ —ç—Ç–æ –¥–µ—à–µ–≤–æ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–æ–ª–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º
            r_shifted = np.roll(r, chroma_shift, axis=1)
            b_shifted = np.roll(b, -chroma_shift, axis=1)
            chroma = cv2.merge([b_shifted, g, r_shifted])
        else:
            chroma = out

        # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ:
        #  - —Å–Ω–∞—á–∞–ª–∞ —Å–º–µ—à–∏–≤–∞–µ–º –≥–ª–∏—Ç—á-–∫–∞—Ä—Ç–∏–Ω–∫—É —Å –Ω–µ–æ–Ω–æ–≤—ã–º glow (glow_strength —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –µ–≥–æ –≤–∫–ª–∞–¥)
        #  - –∑–∞—Ç–µ–º —Å–ª–µ–≥–∫–∞ –º–∏–∫—Å—É–µ–º —Å —Ö—Ä–æ–º–∞-–≤–µ—Ä—Å–∏–µ–π, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç–æ–≤—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è
        neon_mix = cv2.addWeighted(out, 1.0 - glow_strength, glow, glow_strength, 0)
        result = cv2.addWeighted(neon_mix, 0.85, chroma, 0.15, 0)

        # –ù–µ–±–æ–ª—å—à–æ–π –ø—É–ª—å—Å/–º–µ—Ä—Ü–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∂–∏–≤–æ—Å—Ç–∏ (–ª–µ–≥–∫–∏–π, –Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç)
        flicker = 0.95 + 0.05 * np.sin(t * 12.0)  # —Å–∫–æ—Ä–æ—Å—Ç—å –º–µ—Ä—Ü–∞–Ω–∏—è –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å
        result = cv2.convertScaleAbs(result * flicker)

        return result

    def raid_flashbang2(self, frame, t, duration):
        '''
–ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –∑–∞–º–µ—Ä—ã –∏ –≤—Å—è–∫–∞—è —Ö—É–∏—Ç–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π —Ä–∞–±–æ—Ç–∞–ª–∞.
        '''
        import time
        
        h, w = frame.shape[:2]

        '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ñ—Ñ–µ–∫—Ç–∞.
–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å –∏–ª–∏ —Ñ–∏–≥–Ω—è, –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º –Ω–æ–ª—å.
np.clip –Ω–µ –¥–∞—Å—Ç –≤—ã–π—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã 0‚Äì1, —á—Ç–æ–± –Ω–µ –≤—ã—ë–±—ã–≤–∞—Ç—å—Å—è.
        '''
        try:
            prog_passed = float(t) / max(1e-9, float(duration))
            prog_passed = np.clip(prog_passed, 0.0, 1.0)
        except Exception:
            prog_passed = 0.0

            '''
–ß–µ–∫–∞–µ–º, –µ—Å—Ç—å –ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞
            '''
        state = getattr(self, '_hack_state', None)
        '''
–ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ—Ç –∏–ª–∏ —Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞ –ø–æ–º–µ–Ω—è–ª—Å—è ‚Äî –±—É–¥–µ–º –∑–∞–Ω–æ–≤–æ —Å—Ç—Ä–æ–∏—Ç—å –±–ª–æ–∫–∏ –∏ –º–∞—Å–∫–∏.
        '''
        if (state is None) or (state.get('size') != (w, h)):
            '''
–†–µ—à–∞–µ–º, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–æ–∫ –∏ —Ä—è–¥–æ–≤ –¥–µ–ª–∏–º –∫–∞–¥—Ä.
–ë–ª–æ–∫–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ 64 –ø–∏–∫—Å–µ–ª—è, –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ 4 –∏ –Ω–µ –±–æ–ª—å—à–µ 36, —á—Ç–æ–±—ã –≤—Å—ë –∫—Ä–∞—Å–∏–≤–æ –±—ã–ª–æ.
            '''
            target_block_pixels = 64
            cols = max(4, min(36, w // target_block_pixels))
            rows = max(4, min(36, h // target_block_pixels))

            '''
–î–µ–ª–∞–µ–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–µ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ –∏ –≤—ã—Å–æ—Ç—ã —Ä—è–¥–æ–≤.
–ï—Å–ª–∏ –¥–µ–ª–µ–Ω–∏–µ –Ω–µ—Ü–µ–ª–æ–µ, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ –ø–∏–∫—Å–µ–ª—é –∫ –ø–µ—Ä–≤—ã–º, —á—Ç–æ–± —Å—Ö–æ–¥–∏–ª–æ—Å—å.
            '''
            col_widths = [w // cols] * cols
            for i in range(w % cols):
                col_widths[i] += 1
            row_heights = [h // rows] * rows
            for i in range(h % rows):
                row_heights[i] += 1

                '''
–ë—Ä–∞—Ç–∞–Ω, —ç—Ç–æ —Å–æ–∑–¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (x, y, width, height), –∫—É–¥–∞ –±—É–¥–µ–º –∫–∏–¥–∞—Ç—å –ø–∏–∫—Å–µ–ª–∏.
                '''
            target_positions = []
            y = 0
            for r in range(rows):
                x = 0
                for c in range(cols):
                    target_positions.append((x, y, col_widths[c], row_heights[r]))
                    x += col_widths[c]
                y += row_heights[r]

                '''
–¢—É—Ç —Ö—É—è—Ä–∏–º —Ö–∞–æ—Å:

perm ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–ª–æ–∫–æ–≤.

delays ‚Äî –∫–∞–∂–¥—ã–π –±–ª–æ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å —Ä–∞–∑–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.

masks ‚Äî —Å–ª—É—á–∞–π–Ω—ã–µ –º–∞—Å–∫–∏, —á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª –ª–æ–º–∞–Ω–Ω—ã–π –∏ –ø–∏–∫—Å–µ–ª—å–Ω—ã–π.
                '''
            N = len(target_positions)
            perm = np.random.permutation(N)
            delays = np.random.uniform(0.0, 0.45, size=N)
            masks = []
            for (tx, ty, tw, th) in target_positions:
                masks.append(np.random.randint(0, 256, (th, tw), dtype=np.uint8))

                '''
–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë —ç—Ç–æ –±–µ–∑–æ–±—Ä–∞–∑–∏–µ –≤ –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∫–∞–¥—Ä–µ –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –±–ª–æ–∫–∏
                '''
            state = {
                'size': (w, h),
                'rows': rows,
                'cols': cols,
                'target_positions': target_positions,
                'perm': perm,
                'delays': delays,
                'masks': masks,
                'init_time': time.time(),
                'last_passed': prog_passed
            }
            self._hack_state = state

            '''
–î–æ—Å—Ç–∞—ë–º –æ–±—Ä–∞—Ç–Ω–æ –≤—Å—ë, —á—Ç–æ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞.
            '''
        target_positions = state['target_positions']
        perm = state['perm']
        delays = state['delays']
        masks = state['masks']
        N = len(target_positions)

        '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ñ—Ñ–µ–∫—Ç–∞.
–ï—Å–ª–∏ –≤—Ä–µ–º—è —Ä–µ–∞–ª—å–Ω–æ —Å–¥–≤–∏–Ω—É–ª–æ—Å—å, –±–µ—Ä—ë–º –ø—Ä—è–º t/duration, –∏–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º –ø–æ —Ç–∞–π–º–µ—Ä—É.
        '''
        last_passed = state.get('last_passed', -1.0)
        if abs(prog_passed - last_passed) > 1e-7:
            progress = prog_passed
        else:
            elapsed = time.time() - state.get('init_time', time.time())
            dur = max(0.001, float(duration)) if float(duration) > 0.0 else 1.5
            progress = np.clip(elapsed / dur, 0.0, 1.0)
        state['last_passed'] = prog_passed

        '''
–ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –∫–æ–Ω—á–∏–ª—Å—è, —á–∏—Å—Ç–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–∞–¥—Ä, –±–µ–∑ –∏–∑–≤—Ä–∞—â–µ–Ω–∏–π.
        '''
        if progress >= 1.0:
            if hasattr(self, '_hack_state'):
                delattr(self, '_hack_state')
            return frame

        '''
–°–æ–∑–¥–∞—ë–º –∫–∞–¥—Ä-–∑–∞–≥–ª—É—à–∫—É, –ø–æ—á—Ç–∏ —á—ë—Ä–Ω—ã–π —Å –º–µ–ª–∫–∏–º —Å–≤–µ—Ç–æ–º (6 ‚Äî —Ç–µ–º–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫).
        '''
        out = np.full_like(frame, 6)

        '''
–ù–∞ —Å—Ç–∞—Ä—Ç–µ –¥–æ–±–∞–≤–ª—è–µ–º —à—É–º, —á—Ç–æ–±—ã —Ñ–ª–µ—à–±—ç–Ω–≥ –±—ã–ª —Å–ª–µ–ø—è—â–∏–π. –ß–µ–º –±–ª–∏–∂–µ –∫ 0.6 –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —à—É–º.
        '''
        if progress < 0.6:
            noise_alpha = (0.6 - progress) / 0.6 * 0.18
            noise = np.random.randint(0, 256, (h, w, 1), dtype=np.uint8)
            noise = np.repeat(noise, 3, axis=2)
            out = cv2.addWeighted(out, 1.0 - noise_alpha, noise, noise_alpha, 0)

        # scrambled –∂–∏–≤–æ–π —Ñ–æ–Ω
        '''
–ü–∞—Ü–∞–Ω—Å–∫–∏–π ‚Äúscramble‚Äù: –∫–∞–∂–¥—ã–π –±–ª–æ–∫ –∫–∞–¥—Ä–∞ –∫–∏–¥–∞–µ–º –Ω–∞ —Å–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ.
        '''
        for i in range(N):
            tx, ty, tw, th = target_positions[i]
            block = frame[ty:ty+th, tx:tx+tw]
            dst_index = int(perm[i])
            dx, dy, dw, dh = target_positions[dst_index]
            out[dy:dy+dh, dx:dx+dw] = block

            '''
–§—É–Ω–∫—Ü–∏—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ë–µ–∑ –∂—ë—Å—Ç–∫–∏—Ö —Ä—ã–≤–∫–æ–≤, –≤—Å—ë –º—è–≥–∫–æ –≤—ã–≥–æ—Ä–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è.
            '''
        def smootherstep(x):
            x = np.clip(x, 0.0, 1.0)
            return x * x * x * (x * (x * 6 - 15) + 10)

        '''
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω ‚Äú–≤–∫–ª—é—á–∏–ª—Å—è‚Äù.
–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–µ—Ä–∂–∫–∞, –ø–æ—Ç–æ–º –ø–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç —á–µ—Ä–µ–∑ smootherstep.
        '''
        for i in range(N):
            tx, ty, tw, th = target_positions[i]
            block = frame[ty:ty+th, tx:tx+tw]
            d = float(delays[i])
            if progress <= d:
                bp = 0.0
            else:
                denom = 1.0 - d
                bp = (progress - d) / denom if denom > 1e-6 else 1.0
                bp = np.clip(bp, 0.0, 1.0)
            e = smootherstep(bp)
            if e <= 1e-6:
                continue
            '''
–ú–∞—Å–∫–∞: –∫–∞–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏ –±–ª–æ–∫–∞ —É–∂–µ –≤–∏–¥–Ω—ã, –∞ –∫–∞–∫–∏–µ –µ—â—ë –Ω–µ—Ç.
            '''
            thr = int(np.clip(e * 255.0, 0, 255))
            mask8 = (masks[i] <= thr)  # shape (th, tw), bool

            '''
–ë–µ—Ä—ë–º –∫—É—Å–æ–∫ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –∫–∞–¥—Ä–∞, —á—Ç–æ–±—ã –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å.
            '''
            out_block_area = out[ty:ty+th, tx:tx+tw]
            orig_out_area = out_block_area.copy()

            # glitch: –¥–µ–ª–∞–µ–º XOR —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Ö –ø–∏–∫—Å–µ–ª—è—Ö, –≥–¥–µ mask —Å–ª—É—á–∞–π–Ω–æ –∏—Å—Ç–∏–Ω–µ–Ω,
            # –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω–æ-–∫–∞–Ω–∞–ª—å–Ω—É—é –º–∞—Å–∫—É –¥–ª—è cv2.bitwise_xor (–±–µ–∑ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤)
            '''
‚Äú–ì–ª–∏—Ç—á–∏–º‚Äù –±–ª–æ–∫, –¥–µ–ª–∞–µ–º XOR –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–∏–∫—Å–µ–ª—è—Ö, —á—Ç–æ–± —ç—Ñ—Ñ–µ–∫—Ç –ª–æ–º–∫–∏ –≤—ã–≥–ª—è–¥–µ–ª –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É.
            '''
            if 0.15 < e < 0.85:
                glitch_mask = (np.random.rand(th, tw) < 0.02).astype(np.uint8) * 255  # shape (th,tw), uint8
                xor_val = np.full_like(out_block_area, 0x33, dtype=np.uint8)
                # bitwise_xor –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ glitch_mask != 0
                out_block_area = cv2.bitwise_xor(out_block_area, xor_val, mask=glitch_mask)

            # —Ä–∞—Å—à–∏—Ä—è–µ–º –º–∞—Å–∫—É –Ω–∞ 3 –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—Ä—è–º–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
            '''
–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –∫ —Ç—Ä—ë–º –∫–∞–Ω–∞–ª–∞–º, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∏–∫—Å–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª.
            '''
            mask3 = np.repeat(mask8[:, :, None], 3, axis=2)

            # –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∏–∫—Å–µ–ª–∏ –ø–æ –º–∞—Å–∫–µ
            out_block_area[mask3] = block[mask3]

            # –º—è–≥–∫–∏–π blend –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π
            '''
–î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π –¥–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω—ã–π blend, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–µ–∑–∫–æ–π —Å–º–µ–Ω—ã.
            '''
            alpha_soft = 0.15 + 0.75 * e
            if alpha_soft > 1e-6:
                blended = cv2.addWeighted(block, float(alpha_soft), orig_out_area, float(1.0 - alpha_soft), 0)
                inv_mask3 = ~mask3
                if inv_mask3.any():
                    out_block_area[inv_mask3] = blended[inv_mask3]

                    '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –±–ª–æ–∫ –≤ –∏—Ç–æ–≥–æ–≤—ã–π –∫–∞–¥—Ä.
                    '''
            out[ty:ty+th, tx:tx+tw] = out_block_area

            '''
–î–æ–±–∞–≤–ª—è–µ–º –±–µ–ª—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏, —Ç–∏–ø–∞ ‚Äú—è—Ä–∫–∏–π —Ñ–ª–µ—à‚Äù, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∏—Å—á–µ–∑–∞—é—Ç.
            '''
        if progress < 0.95:
            lines_alpha = (1.0 - progress) * 0.22
            step = max(3, h // 140)
            for yy in range(0, h, step * 5):
                y2 = min(h, yy + step)
                out[yy:y2, :] = cv2.addWeighted(out[yy:y2, :], 1.0 - lines_alpha,
                                                np.full_like(out[yy:y2, :], 255), lines_alpha, 0)

                '''
–û—Ç–¥–∞—ë–º –≥–æ—Ç–æ–≤—ã–π –∫–∞–¥—Ä —Å —Ñ–ª–µ—à–±—ç–Ω–≥–æ–º –∏ –≥–ª–∏—Ç—á-—ç—Ñ—Ñ–µ–∫—Ç–æ–º.
                '''
        return out


# --- –ü–æ—Ç–æ–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è GIF'–æ–≤ –∏–∑ –≤–∏–¥–µ–æ ---
class GifCreatorThread(QThread):
    '''
–≠—Ç–∞ —Å—Ç—Ä–æ—á–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç: ¬´–≠–π, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —è –±—É–¥—É —Å–∏–≥–Ω–∞–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ç–∏–ø–∞ 0-100 –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤¬ª.
    '''
    progress = pyqtSignal(int)
    '''
–ö–æ–≥–¥–∞ –≤–µ—Å—å –¥–≤–∏–∂–æ–∫ —Å GIF–∞–º–∏ –∑–∞–∫–æ–Ω—á–∏—Ç —Ä–∞–±–æ—Ç—É ‚Äî –±–∞—Ö, —Å–∏–≥–Ω–∞–ª –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —á—Ç–æ –≤—Å—ë –≥–æ—Ç–æ–≤–æ.
    '''
    finished = pyqtSignal(str)
    '''
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, —à–µ—Ñ, —ç—Ç–æ—Ç —Å–∏–≥–Ω–∞–ª —Å–æ–æ–±—â–∏—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ.
    '''
    error = pyqtSignal(str)

    '''
–≠—Ç–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, —Ç–∏–ø–∞ ¬´—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∞–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GIF–∞–º–∏¬ª
–∏ –¥–∞—ë–º –µ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: –≥–¥–µ –ø–∞–ø–∫–∞ —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏,
—Ä–∞–∑–º–µ—Ä –ø–æ–ª–æ—Ç–Ω–∞, –∫–∞–¥—Ä—ã –≤ —Å–µ–∫—É–Ω–¥—É –∏ –¥–ª–∏–Ω—É –∞–Ω–∏–º–∞—Ü–∏–∏.
    '''
    def __init__(self, effects_dir, canvas_size, fps, animation_length, parent=None):
        '''
–ö–ª–∞—Å—Å-—Ä–æ–¥–∏—Ç–µ–ª—å QThread —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –∑–∞—é–∑–∞—Ç—å, —á—Ç–æ–± –ø–æ—Ç–æ–∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–ª.
        '''
        super().__init__(parent)
        '''
–ü–∞–ø–∫—É —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –∑–∞–ø–∏—Ö–∏–≤–∞–µ–º –≤ –æ–±—ä–µ–∫—Ç Path, —á—Ç–æ–± —Å —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–æ—â–µ —Ä–∞–±–æ—Ç–∞—Ç—å.
        '''
        self.effects_dir = Path(effects_dir)
        '''
–≠—Ç–∏ —Ç—Ä–∏ —Å—Ç—Ä–æ—á–∫–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —á—Ç–æ–± –ø–æ—Ç–æ–º –∑–Ω–∞—Ç—å,
–∫–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä GIF–∞,
—Å–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
–∏ —Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è.
        '''
        self.canvas_size = canvas_size
        self.fps = fps
        self.animation_length = animation_length
        '''
–§–ª–∞–≥, —á—Ç–æ–± –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ—Ç–æ–º —Å–∫–∞–∑–∞—Ç—å: ¬´–≠–π, —Å—Ç–æ–ø, –±–æ–ª—å—à–µ –Ω–µ –¥–µ–ª–∞–µ–º GIF—ã¬ª.
        '''
        self._is_running = True
        '''
–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è ‚Äî —Å–µ—Ä–¥—Ü–µ –ø–æ—Ç–æ–∫–∞. –¢—É—Ç –≤—Å—ë —Ä–µ–∞–ª—å–Ω–æ –¥–µ–ª–∞–µ—Ç—Å—è.
        '''
    def run(self):
        '''
–ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ ¬´–ª–æ–≤–∏–º –æ—à–∏–±–∫–∏¬ª, —á—Ç–æ–±—ã –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Ö—Ä–µ–Ω–æ–≤–æ –ø–æ–π–¥–µ—Ç, –º—ã –Ω–µ —É–ø–∞–ª–∏ —Å –æ—à–∏–±–∫–æ–π.
        '''
        try:
            '''
–°–æ–∑–¥–∞—ë–º –ø—É—Ç—å –∫ –Ω–æ–≤–æ–π –ø–∞–ø–∫–µ, –≥–¥–µ –±—É–¥—É—Ç GIF—ã.
            '''
            gifs_dir = self.effects_dir / "GIFs"
            '''
–ï—Å–ª–∏ –ø–∞–ø–∫–∏ –Ω–µ—Ç ‚Äî –¥–µ–ª–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å ‚Äî —á—ë-—Ç–æ –Ω–µ –ø–∞—Ä–∏–º—Å—è, –ø—Ä–æ—Å—Ç–æ –∏–¥—ë–º –¥–∞–ª—å—à–µ.
            '''
            gifs_dir.mkdir(parents=True, exist_ok=True)

            '''
–°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∏–¥–æ—Å—ã –≤ –ø–∞–ø–∫–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤. –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º ‚Äî –Ω–∞–º –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ.
            '''
            video_files = [p for p in self.effects_dir.iterdir()
                           if p.is_file() and p.suffix.lower() in {'.mp4', '.avi', '.mov', '.mkv'}]
            '''
–°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ —É –Ω–∞—Å –≤—Å–µ–≥–æ.
            '''
            total = len(video_files)
            '''
–ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ—Ç, —Å—Ä–∞–∑—É –≥–æ–≤–æ—Ä–∏–º ¬´–ø–æ—à–ª–∏ –Ω–∞—Ö–µ—Ä¬ª –∏ —Å–∏–≥–Ω–∞–ª–∏–º, —á—Ç–æ –≤—Å—ë –∫–æ–Ω—á–∏–ª–æ—Å—å
            '''
            if total == 0:
                self.finished.emit("–ù–µ—Ç –≤–∏–¥–µ–æ –≤ –ø–∞–ø–∫–µ '—ç—Ñ—Ñ–µ–∫—Ç—ã' –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ GIF.")
                return

            '''
–¶–∏–∫–ª –ø–æ –≤—Å–µ–º –≤–∏–¥–µ–æ, —Å –Ω–æ–º–µ—Ä–∞–º–∏ –æ—Ç 1 –∏ –≤—ã—à–µ.
            '''
            for i, vf in enumerate(video_files, start=1):
                '''
–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Å–∫–∞–∑–∞–ª ¬´—Å—Ç–æ–ø¬ª, –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª –∏ —Å–∏–≥–Ω–∞–ª–∏–º, —á—Ç–æ —Ä–∞–±–æ—Ç—É –∑–∞–≤–µ—Ä—à–∏–ª–∏
                '''
                if not self._is_running:
                    self.finished.emit("–û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞.")
                    return
                '''
–ì–æ—Ç–æ–≤–∏–º –ø—É—Ç—å –¥–ª—è –Ω–æ–≤–æ–≥–æ GIF–∞ —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º, –Ω–æ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .gif.
                '''
                out_path = gifs_dir / vf.with_suffix('.gif').name
                '''
–¢—É—Ç –º—ã —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è ffmpeg ‚Äî —Ç–∏–ø–∞ —à–µ—Ñ –Ω–∞ –∫—É—Ö–Ω–µ:
–±–µ—Ä—ë–º –≤–∏–¥–µ–æ, —Ä–µ—Å–∞–π–∑–∏–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ø–æ–ª–æ—Ç–Ω–∞,
–∑–∞–¥–∞–µ–º FPS, –æ–±—Ä–µ–∑–∞–µ–º –¥–æ –¥–ª–∏–Ω—ã –∞–Ω–∏–º–∞—Ü–∏–∏, —É–±–∏—Ä–∞–µ–º –∑–≤—É–∫, –∫–ª–∞–¥–µ–º –≤ –≤—ã—Ö–æ–¥–Ω–æ–π GIF.
                '''
                cmd = [
                    "ffmpeg", "-y",
                    "-i", str(vf),
                    "-vf", f"scale={self.canvas_size[0]}:{self.canvas_size[1]},fps={self.fps}",
                    "-t", str(self.animation_length),
                    "-an",
                    str(out_path)
                ]
                '''
–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É. check=True ‚Äî –µ—Å–ª–∏ ffmpeg –æ—Ç–≤–∞–ª–∏—Ç—Å—è,
–ª–æ–≤–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ. stdout –∏ stderr –≤ –Ω–æ–ª—å ‚Äî –Ω–µ –∑–∞—Å–æ—Ä—è–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª –ª–∏—à–Ω–µ–π —Ö–µ—Ä–Ω–µ–π.
                '''
                try:
                    subprocess.run(cmd, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                    '''
–ï—Å–ª–∏ ffmpeg —Å–¥–æ—Ö, —Å–∏–≥–Ω–∞–ª–∏–º –æ–± –æ—à–∏–±–∫–µ –∏ –ø–∏—à–µ–º, –∫–∞–∫–æ–π –≤–∏–¥–æ—Å –Ω–µ –ø—Ä–æ–∫–∞—Ç–∏–ª
                    '''
                except subprocess.CalledProcessError as e:
                    self.error.emit(f"ffmpeg –Ω–µ —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å GIF –∏–∑ {vf.name}: {e}")
                    '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –∏ —à–ª—ë–º —Å–∏–≥–Ω–∞–ª –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
                    '''
                self.progress.emit(int(i / total * 100))
                '''
–ö–æ–≥–¥–∞ —Ü–∏–∫–ª –∫–æ–Ω—á–∏–ª—Å—è, —Å–∏–≥–Ω–∞–ª–∏–º: ¬´–í—Å–µ GIF—ã –≥–æ—Ç–æ–≤—ã, —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –ø–∞–ø–∫—É¬ª.
                '''
            self.finished.emit(f"GIF'—ã —Å–æ–∑–¥–∞–Ω—ã –≤: {gifs_dir}")
            '''
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –≤–∑–æ—Ä–≤–∞–ª–æ –∫–æ–¥, –ø–æ–π–º–∞–ª–∏ –∏ —à–ª—ë–º —Å–∏–≥–Ω–∞–ª —Å –æ—à–∏–±–∫–æ–π.
            '''
        except Exception as e:
            self.error.emit(str(e))

            '''
–ü—Ä–æ—Å—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, —á—Ç–æ–± —Å–∫–∞–∑–∞—Ç—å –ø–æ—Ç–æ–∫—É: ¬´–ü–∞—Ä–µ–Ω—å, —Ö–≤–∞—Ç–∏—Ç, –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–π¬ª.
            '''
    def stop(self):
        self._is_running = False

# --- –ü–æ—Ç–æ–∫ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ GIF -> WEBM –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ---
'''
–ö–æ—Ä–æ—á–µ, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫,
–∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ç—å –≥–∏—Ñ–∫–∏ –≤ WebM,
—á—Ç–æ–± –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–æ–Ω—è–ª?
QThread ‚Äî —ç—Ç–æ —Ç–∏–ø–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–¥ –¥–ª—è —Ç—è–∂—ë–ª–æ–π —Ä–∞–±–æ—Ç—ã.
'''
class WebmConverterThread(QThread):
    progress = pyqtSignal(int)
    finished = pyqtSignal(str)
    error = pyqtSignal(str)
    
    def __init__(self, gifs_dir, canvas_size, fps, animation_length, max_size_kb, parent=None):
        super().__init__(parent)
        self.gifs_dir = Path(gifs_dir)
        self.canvas_size = canvas_size
        self.fps = fps
        self.animation_length = animation_length
        self.max_size_kb = max_size_kb
        self._is_running = True

    def convert_gif_to_webm(self, gif_path, output_path):
        '''
–¢—É—Ç –º—ã –¥–µ–ª–∞–µ–º —Å–∞–º—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –≥–∏—Ñ–∫–∏ –≤ WebM.
        '''
        command = [
            "ffmpeg", "-y",
            "-i", str(gif_path),
            "-vf", f"scale={self.canvas_size[0]}:{self.canvas_size[1]},fps={self.fps}",
            "-t", str(self.animation_length),
            "-an",
            "-c:v", "libvpx-vp9",
            "-b:v", "150k",
            str(output_path)
        ]
        '''
‚Äî –°–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è ffmpeg:

"-y" ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ñ–∞–π–ª—ã –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤;

"-i" ‚Äî –≤—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª (–≥–¥–µ –Ω–∞—à–∞ –≥–∏—Ñ–∫–∞);

"-vf" ‚Äî —Ñ–∏–ª—å—Ç—Ä –≤–∏–¥–µ–æ: –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ –Ω–∞—à —Ö–æ–ª—Å—Ç –∏ —Å—Ç–∞–≤–∏–º FPS;

"-t" ‚Äî —Ä–µ–∂–µ–º –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏;

"-an" ‚Äî –±–µ–∑ –∑–≤—É–∫–∞;

"-c:v" ‚Äî –∫–æ–¥–µ–∫ VP9 –¥–ª—è WebM;

"-b:v" ‚Äî –±–∏—Ç—Ä–µ–π—Ç 150 –∫–±–∏—Ç/—Å;

–∏ –ø—É—Ç—å –∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        '''
        '''
–ó–∞–ø—É—Å–∫–∞–µ–º ffmpeg, –º–æ–ª—á–∞ (—á—Ç–æ–± –∫–æ–Ω—Å–æ–ª—å –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å), –µ—Å–ª–∏ ffmpeg —Ñ–µ–π–ª–∏—Ç—Å—è ‚Äî –∫–∏–¥–∞—Ç—å –æ—à–∏–±–∫—É.
        '''
        subprocess.run(command, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

        '''
–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞.
        '''
    def optimize_file_size(self, output_path):
        '''
–ë–µ—Ä—ë–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö.
        '''
        try:
            size_bytes = os.path.getsize(output_path)
            '''
–ï—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–µ, —á–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–æ, —Ç–æ–≥–¥–∞ –±—É–¥–µ–º —Å–∂–∏–º–∞—Ç—å.
            '''
            if size_bytes > self.max_size_kb * 1024:
                '''
–°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫.
                '''
                temp_path = str(output_path) + ".tmp.webm"
                '''
–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–∂–∞—Ç–∏—è: –±–∏—Ç—Ä–µ–π—Ç –Ω–∏–∂–µ (100 –∫–±–∏—Ç/—Å), –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Ç–æ –∂–µ —Å–∞–º–æ–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª.
                '''
                command = [
                    "ffmpeg", "-y",
                    "-i", str(output_path),
                    "-c:v", "libvpx-vp9",
                    "-b:v", "100k",
                    "-an",
                    temp_path
                ]
                '''
–ó–∞–ø—É—Å–∫–∞–µ–º —Å–∂–∞—Ç–∏–µ, –æ–ø—è—Ç—å –º–æ–ª—á–∞.
                '''
                subprocess.run(command, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                '''
–ï—Å–ª–∏ –≤—Å—ë –Ω–æ—Ä–º, –∑–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π.
                '''
                os.replace(temp_path, str(output_path))
        except Exception as e:
            # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            self.error.emit(f"–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ {output_path.name}: {e}")
    '''
–ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ—Ç–æ–∫–∞, —Ç—É—Ç –≤—Å—ë —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.
    '''
    def run(self):
        '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞–ø–∫–∞ —Å –≥–∏—Ñ–∫–∞–º–∏. –ù–µ—Ç ‚Äî —Å–∏–≥–Ω–∞–ª–∏–º –∏ –≤—ã—Ö–æ–¥–∏–º.
        '''
        try:
            if not self.gifs_dir.exists():
                self.finished.emit(f"–ü–∞–ø–∫–∞ {self.gifs_dir} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                return

            '''
–ë–µ—Ä—ë–º –≤—Å–µ –≥–∏—Ñ–∫–∏ –∏–∑ –ø–∞–ø–∫–∏.
            '''
            gifs = [p for p in self.gifs_dir.iterdir() if p.is_file() and p.suffix.lower() == '.gif']
            '''
–ï—Å–ª–∏ –≥–∏—Ñ–æ–∫ –Ω–µ—Ç, —Å–∏–≥–Ω–∞–ª–∏–º –∏ –≤—ã—Ö–æ–¥–∏–º.
            '''
            total = len(gifs)
            if total == 0:
                self.finished.emit("–ù–µ—Ç GIF —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.")
                return

            '''
–ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–π –≥–∏—Ñ–∫–µ. –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ ‚Äî —Å–∏–≥–Ω–∞–ª–∏–º –∏ –≤—ã—Ö–æ–¥–∏–º.
            '''
            for i, gif in enumerate(gifs, start=1):
                if not self._is_running:
                    self.finished.emit("–û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞.")
                    return
                '''
–ó–∞–¥–∞—ë–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .webm.
                '''
                out_webm = gif.with_suffix('.webm')
                '''
–ö–æ–Ω–≤–µ—Ä—Ç–∏–º –≥–∏—Ñ–∫—É –∏ —Å—Ä–∞–∑—É –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä.
                '''
                try:
                    self.convert_gif_to_webm(gif, out_webm)
                    self.optimize_file_size(out_webm)
                    '''
–õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ ffmpeg –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏ —Å–∏–≥–Ω–∞–ª–∏–º –æ –Ω–∏—Ö.
                    '''
                except subprocess.CalledProcessError as exc:
                    self.error.emit(f"ffmpeg –Ω–µ —Å–º–æ–≥ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å {gif.name}: {exc}")
                except Exception as e:
                    self.error.emit(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {gif.name}: {e}")
                    '''
–°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å–∏–≥–Ω–∞–ª–∏–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
                    '''
                self.progress.emit(int(i / total * 100))

            self.finished.emit(f"WEBM —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –≤: {self.gifs_dir}")
        except Exception as e:
            self.error.emit(str(e))

    def stop(self):
        self._is_running = False



'''
–ê —ç—Ç–æ –º—ã –¥–µ–ª–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–æ—à–∫–æ, –±—Ä–∞—Ç–∞–Ω.
–û–Ω–æ –Ω–∞—Å–ª–µ–¥—É–µ—Ç –æ—Ç QDialog,
–∑–Ω–∞—á–∏—Ç, —Ç–∏–ø–∞ –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ,
–∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ.
'''
class PreviewWindow(QDialog):
    '''
–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, –∫–æ—Ä–æ—á–µ.
–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—ë–º –Ω–∞—à–µ –æ–∫–æ—à–∫–æ,
—Å—é–¥–∞ –º–æ–∂–Ω–æ —Å—É–Ω—É—Ç—å parent ‚Äî —ç—Ç–æ —Ç–∏–ø–∞ –∫—Ç–æ –µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—å, –∫–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç.
–ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–¥—É—Ç, –±—É–¥–µ—Ç None.
    '''
    def __init__(self, parent=None):
        '''
–≠—Ç–æ —á—Ç–æ–±—ã –±–∞–∑–æ–≤—ã–π QDialog —Ç–æ–∂–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–æ–∫–∞—á–∞–ª—Å—è –∏ –Ω–µ —Ä—É–≥–∞–ª—Å—è.
–¢–∏–ø–∞ –≤—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.
        '''
        super().__init__(parent)
        '''
–¢—É—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–∫–Ω–∞ —Å—Ç–∞–≤–∏–º ‚Äî —Å–≤–µ—Ä—Ö—É –±—É–¥–µ—Ç "–ü—Ä–µ–≤—å—é —ç—Ñ—Ñ–µ–∫—Ç–∞".
        '''
        self.setWindowTitle("–ü—Ä–µ–≤—å—é —ç—Ñ—Ñ–µ–∫—Ç–∞")
        '''
–§–ª–∞–≥–∏ –æ–∫–Ω–∞, –ø–æ–Ω—è–ª?
–¢—É—Ç –º—ã –≥–æ–≤–æ—Ä–∏–º: ‚Äú–¥–µ–ª–∞–π —ç—Ç–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –æ–∫–Ω–æ, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –º–æ–¥–∞–ª–∫—É‚Äù.
–ë–µ—Ä—ë–º —Å—Ç–∞—Ä—ã–µ —Ñ–ª–∞–≥–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º Qt.Window.
        '''
        self.setWindowFlags(self.windowFlags() | Qt.Window)
        '''
–õ–µ–π–±–ª –∑–∞–≤–æ–¥–∏–º, –±—Ä–∞—Ç–∞–Ω, —ç—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –±—É–¥–µ—Ç GIF –∏–ª–∏ —Ç–µ–∫—Å—Ç. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –µ–≥–æ –∫ –Ω–∞—à–µ–º—É –æ–∫–Ω—É.
        '''
        self.label = QLabel(self)
        '''
–ê —ç—Ç–æ —á—Ç–æ–±—ã —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–µ–π–±–ª–∞ –±—ã–ª–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É. –ù–∏ –≤–ª–µ–≤–æ, –Ω–∏ –≤–ø—Ä–∞–≤–æ ‚Äî –ø—Ä—è–º —Ä–æ–≤–Ω–æ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ.
        '''
        self.label.setAlignment(Qt.AlignCenter)
        '''
–ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –ª–µ–π–±–ª–∞: —Ñ–æ–Ω —á—ë—Ä–Ω—ã–π, —Ç–∏–ø–∞ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä –≤ –ø–æ–¥–≤–∞–ª–µ, —á—Ç–æ–±—ã –≥–ª–∞–∑–∞ –Ω–µ —Ä–µ–∑–∞–ª–æ.
        '''
        self.label.setStyleSheet("background: black;")
        '''
–°–æ–∑–¥–∞—ë–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ª—ç–π–∞—É—Ç ‚Äî —Ç–∏–ø–∞ —Å—Ç–æ–ø–∫—É –≤–∏–¥–∂–µ—Ç–æ–≤ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑.
        '''
        lay = QVBoxLayout(self)
        '''
–î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à –ª–µ–π–±–ª –≤ —ç—Ç–æ—Ç –ª—ç–π–∞—É—Ç, —á—Ç–æ–±—ã –æ–Ω –∑–∞–Ω–∏–º–∞–ª –º–µ—Å—Ç–æ –≤ –æ–∫–Ω–µ.
        '''
        lay.addWidget(self.label)
        '''
–ó–¥–µ—Å—å –º—ã –∑–∞–≤–æ–¥–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è GIF. –ü–æ–∫–∞ None,
–Ω–æ –ø–æ—Ç–æ–º —Ç—É–¥–∞ –∫–∏–Ω–µ–º QMovie. –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–π –Ω–µ –º–µ—à–∞–ª –Ω–æ–≤–æ–º—É.
        '''
        self.movie = None               # <- –≤–∞–∂–Ω–æ!
        '''
–†–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –∑–∞–¥–∞—ë–º, —á—Ç–æ–±—ã –±—ã–ª–æ
–Ω–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ
‚Äî –ø—Ä–∏–º–µ—Ä–Ω–æ 480x360 –ø–∏–∫—Å–µ–ª–µ–π.
        '''
        self.resize(480, 360)

        '''
–ú–µ—Ç–æ–¥, –±—Ä–∞—Ç–∞–Ω, –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ GIF. –¢—É–¥–∞ —Ç—ã –ø–µ—Ä–µ–¥–∞—ë—à—å –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        '''
    def set_gif(self, path):
        # –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        '''
–ï—Å–ª–∏ —É–∂–µ –±—ã–ª –∫–∞–∫–æ–π-—Ç–æ GIF,
–º—ã –µ–≥–æ –≥–∞—Å–∏–º,
—É–¥–∞–ª—è–µ–º, —á—Ç–æ–±—ã –ø–∞–º—è—Ç—å –Ω–µ –∂—Ä–∞–ª–∞.
–ß–∏—Å—Ç–æ –ø–æ –ø–æ–Ω—è—Ç–∏—è–º: —Å—Ç–∞—Ä—ã–π –≤ —Ä–∞—Å—Ö–æ–¥, –Ω–æ–≤—ã–π –∑–∞—Ö–æ–¥–∏—Ç.
        '''
        if self.movie is not None:
            self.movie.stop()
            self.movie.deleteLater()
            self.movie = None

            '''
–ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª.
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–∏—à–µ–º "–ü—Ä–µ–≤—å—é –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" –Ω–∞ –ª–µ–π–±–ª–µ –∏ –≤—ã—Ö–æ–¥–∏–º. –í—Å—ë –ø—Ä–æ—Å—Ç–æ.
            '''
        if not os.path.exists(path):
            self.label.setText("–ü—Ä–µ–≤—å—é –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:\n" + path)
            return

        '''
–°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç GIF –∏–∑ —Ñ–∞–π–ª–∞. –≠—Ç–æ —Ç–∏–ø–∞ –Ω–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏.
        '''
        self.movie = QMovie(path)
        '''
–†–∞–∑–º–µ—Ä GIF –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ª–µ–π–±–ª–∞. –ß—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª—Å—è –∫—Ä–∏–≤–æ.
        '''
        self.movie.setScaledSize(self.label.size())
        '''
–ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –Ω–∞—à GIF –∫ –ª–µ–π–±–ª—É, —á—Ç–æ–±—ã –æ–Ω –Ω–∞—á–∞–ª –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è.
        '''
        self.label.setMovie(self.movie)
        '''
–ó–∞–ø—É—Å–∫–∞–µ–º GIF. –í–∂—É—Ö, –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—à–ª–∞.
        '''
        self.movie.start()

        '''
–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –æ–∫–Ω–æ –º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä.
        '''
    def resizeEvent(self, event):
        '''
–ß—Ç–æ–±—ã –±–∞–∑–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ–∫–Ω–∞ —Ç–æ–∂–µ –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å
‚Äî —á—ë, –æ–Ω–æ —Å–≤–æ—ë –¥–µ–ª–∞–µ—Ç, –º—ã –Ω–µ –º–µ—à–∞–µ–º.
        '''
        super().resizeEvent(event)
        '''
–ò –µ—Å–ª–∏ GIF –µ—Å—Ç—å,
–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –µ–≥–æ —Ä–∞–∑–º–µ—Ä –ø–æ–¥ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ.
–¢–∏–ø–∞ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∞ –Ω–µ –≤ –∫—Ä–∏–≤–æ–º –≤–∏–¥–µ.
        '''
        if self.movie is not None:
            self.movie.setScaledSize(self.label.size())
            


# --- –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ ---
class VideoEffectsApp(QWidget):
    def __init__(self):
        super().__init__()
        '''
–ù–∞–∑–≤–∞–Ω–∏–µ –æ–∫–Ω–∞ —Å–≤–µ—Ä—Ö—É ‚Äî —á—Ç–æ–± –∫—Ä–∞—Å–∏–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å ¬´PyEffection ‚Äî –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ¬ª.
        '''
        self.setWindowTitle("PyEffection ‚Äî –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ")
        '''
–†–∞–∑–º–µ—Ä –æ–∫–Ω–∞, 700 –Ω–∞ 380 –ø–∏–∫—Å–µ–ª–µ–π. –ß—Ç–æ–± –Ω–µ –±—ã–ª–æ –º–µ–ª–∫–∏–º, –Ω–æ –∏ –Ω–µ –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω.
        '''
        self.resize(700, 380)

        # –ö—Ä–∞—Å–∏–≤—ã–π —à—Ä–∏—Ñ—Ç –∏ —Å—Ç–∏–ª—å
        '''
–¢—É—Ç –º—ã —à—Ä–∏—Ñ—Ç –¥–µ–ª–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π: Segoe UI, —Ä–∞–∑–º–µ—Ä 10.
        '''
        font = QFont("Segoe UI", 10)
        '''
–ü—Ä–∏—Å–æ–±–∞—á–∏–ª–∏ —ç—Ç–æ—Ç —à—Ä–∏—Ñ—Ç –∫–æ –≤—Å–µ–º—É –æ–∫–Ω—É.
        '''
        self.setFont(font)
        """
–¢—É—Ç, –±—Ä–∞—Ç, CSS –¥–ª—è PyQt.
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞, –∫–Ω–æ–ø–∫–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã,
–≤—Å—ë —á—Ç–æ–± –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ –±—É–¥—Ç–æ –ø–∞—Ü–∞–Ω—ã –∏–∑ –ö—Ä–µ–º–Ω–∏–µ–≤–æ–π –¥–æ–ª–∏–Ω—ã —Ä–∏—Å–æ–≤–∞–ª–∏.

QWidget ‚Äî —Ñ–æ–Ω –æ–∫–Ω–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π, —Ç–µ–∫—Å—Ç –±–µ–ª—ã–π.

QGroupBox ‚Äî —Ä–∞–º–æ—á–∫–∏ —Ç–∞–∫–∏–µ —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º.

QPushButton ‚Äî –∑–µ–ª—ë–Ω—ã–µ –∫–Ω–æ–ø–∫–∏, —É –∫–Ω–æ–ø–∫–∏ danger –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç.

QProgressBar ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π –±–∞—Ä —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º.
        """
        self.setStyleSheet("""
            QWidget {
                background: qlineargradient(x1:0 y1:0, x2:1 y2:1,
                              stop:0 #0f2027, stop:1 #2c5364);
                color: #e6f0f0;
            }
            QGroupBox { 
                border: 1px solid rgba(255,255,255,0.15); 
                border-radius: 8px; 
                margin-top: 6px;
                background: rgba(255,255,255,0.03);
            }
            QGroupBox::title { subcontrol-origin: margin; left: 10px; padding: 0 3px 0 3px; }
            QPushButton {
                background-color: #4caf50;
                color: white;
                border-radius: 6px;
                padding: 8px;
            }
            QPushButton#danger {
            background-color: #e53935;
            }
            QPushButton:disabled {
                background-color: rgba(255,255,255,0.12);
                color: rgba(255,255,255,0.4);
            }
            QComboBox, QLabel {
                color: #e6f0f0;
            }
            QProgressBar {
                border: 1px solid rgba(255,255,255,0.12);
                border-radius: 6px;
                text-align: center;
                background: rgba(0,0,0,0.2);
                color: #ffffff;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                                            stop:0 #6dd5ed, stop:1 #2193b0);
                border-radius: 6px;
            }
        """)

        # Layout
        '''
–ì–ª–∞–≤–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫—É–¥–∞ –±—É–¥–µ–º –ø–∏—Ö–∞—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã.
        '''
        main_layout = QVBoxLayout(self)
        '''
–ú–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∑–∞–∑–æ—Ä 12 –ø–∏–∫—Å–µ–ª–µ–π, —á—Ç–æ–± –Ω–µ —Å–ª–∏–ø–ª–æ—Å—å.
        '''
        main_layout.setSpacing(12)

        # Header
        '''
–®–∞–ø–∫–∞, —Ç–∏–ø–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≤–µ—Ä—Ö—É –æ–∫–Ω–∞.
        '''
        header = QLabel("PyEffection ‚Äî –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∏ —ç–∫—Å–ø–æ—Ä—Ç")
        '''
–î–µ–ª–∞–µ–º –∂–∏—Ä–Ω—ã–π –∏ –ø–æ–±–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –±—Ä–æ—Å–∞–ª—Å—è –≤ –≥–ª–∞–∑–∞.
        '''
        header.setFont(QFont("Segoe UI", 14, QFont.Bold))
        '''
–¶–µ–Ω—Ç—Ä—É–µ–º —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
        '''
        header.setAlignment(Qt.AlignCenter)
        '''
–ö–∏–¥–∞–µ–º —à–∞–ø–∫—É –≤ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
        '''
        main_layout.addWidget(header)

        # File selection group
        '''
–ì—Ä—É–ø–ø–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–∞, –ø–æ–¥–ø–∏—Å–∞–Ω–∞ ¬´–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ¬ª.
        '''
        file_group = QGroupBox("–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ")
        '''
–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã.
        '''
        fg_layout = QHBoxLayout()
        '''
–ú–µ—Ç–∫–∞, –≥–¥–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –∏–º—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞. –°–Ω–∞—á–∞–ª–∞ –ø–∏—à–µ—Ç ¬´–ù–µ –≤—ã–±—Ä–∞–Ω–æ¬ª.
        '''
        self.label = QLabel("–ù–µ –≤—ã–±—Ä–∞–Ω–æ")
        '''
–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ‚Äî ¬´–í—ã–±—Ä–∞–Ω–Ω–æ–µ –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ¬ª.
        '''
        self.label.setToolTip("–í—ã–±—Ä–∞–Ω–Ω–æ–µ –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ")
        '''
–ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–æ—Å–∞.
        '''
        self.select_button = QPushButton("–í—ã–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ")
        '''
–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏.
        '''
        self.select_button.setToolTip("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —ç—Ñ—Ñ–µ–∫—Ç—ã")
        '''
–ö–æ–≥–¥–∞ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É ‚Äî –≤—ã–∑–æ–≤–∏ –º–µ—Ç–æ–¥ select_video.
        '''
        self.select_button.clicked.connect(self.select_video)
        '''
–î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤ —Å—Ç—Ä–æ–∫—É.
        '''
        fg_layout.addWidget(self.label)
        '''
–°—Ç–∞–≤–∏–º ¬´–ø—É—Å—Ç—ã—à–∫—É¬ª, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ —É—à–ª–∞ –≤–ø—Ä–∞–≤–æ.
        '''
        fg_layout.addItem(QSpacerItem(20, 0, QSizePolicy.Expanding, QSizePolicy.Minimum))
        '''
–ö–∏–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å—Ç—Ä–æ–∫—É.
        '''
        fg_layout.addWidget(self.select_button)
        '''
–ü—Ä–∏–∫—Ä—É—á–∏–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫—É –≤ –≥—Ä—É–ø–ø—É.
        '''
        file_group.setLayout(fg_layout)
        '''
–ò —ç—Ç—É –≥—Ä—É–ø–ø—É —Å—É—ë–º –≤ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
        '''
        main_layout.addWidget(file_group)



        # –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞
        '''
–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–¥ –≤—ã–±–æ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞.
        '''
        effects_layout = QHBoxLayout()
        '''
–î—Ä–æ–ø–¥–∞—É–Ω (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫), —á—Ç–æ–± –≤—ã–±–∏—Ä–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç.
        '''
        self.effect_combo = QComboBox()
        '''
–¶–∏–∫–ª: —Å–æ–∑–¥–∞—ë–º –ø—É–Ω–∫—Ç—ã ¬´–≠—Ñ—Ñ–µ–∫—Ç 1¬ª, ¬´–≠—Ñ—Ñ–µ–∫—Ç 2¬ª ... –¥–æ 62.
        '''
        for i in range(1, 63):
            self.effect_combo.addItem(f"–≠—Ñ—Ñ–µ–∫—Ç {i}", i)
            '''
–ö–æ–≥–¥–∞ –º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç, –≤—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ on_effect_changed.
            '''
        self.effect_combo.currentIndexChanged.connect(self.on_effect_changed)
        '''
–ö–∏–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫—É.
        '''
        effects_layout.addWidget(self.effect_combo)
        '''
–ø—è—Ç—å –≤—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã—à–∫—É –¥–ª—è —Ä–∞–∑–¥–≤–∏–∂–∫–∏.
        '''
        effects_layout.addItem(QSpacerItem(20, 0, QSizePolicy.Expanding, QSizePolicy.Minimum))
        '''
–ó–∞—Å–æ–≤—ã–≤–∞–µ–º –≤—Å—ë —ç—Ç–æ –≤ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
        '''
        main_layout.addLayout(effects_layout)

        # —Å–æ–∑–¥–∞—ë–º –æ–∫–Ω–æ –ø—Ä–µ–≤—å—é –∑–∞—Ä–∞–Ω–µ–µ
        '''
–°–æ–∑–¥–∞—ë–º –æ–∫–Ω–æ –ø—Ä–µ–≤—å—é (–ø—Ä–æ—Å–º–æ—Ç—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞), –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∫–∞.
        '''
        self.preview_window = PreviewWindow(self)



        
        # Effects group
        '''
–û—Ç–¥–µ–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.
        '''
        effects_group = QGroupBox("–≠—Ñ—Ñ–µ–∫—Ç")
        '''
–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã.
        '''
        eg_layout = QHBoxLayout()
        '''
–ï—â—ë –æ–¥–∏–Ω –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (—Ç—É—Ç –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω—ã–µ).
        '''
        self.effect_combo = QComboBox()
        self.effect_combo.addItems([
            "1. –í—ã–ª–µ—Ç —á–∞—Å—Ç–∏—Ü", "2. –†–∞–∑—Ä–µ–∑–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª–æ—Å—ã", "3. –í–∏—Ö—Ä—å —Ä–æ—Ç–∞—Ü–∏–∏",
            "4. –í–∑—Ä—ã–≤ —Å –æ—Å–∫–æ–ª–∫–∞–º–∏ –≤–ø–µ—Ä—ë–¥", "5. –ú–æ—Ä—Ñ–∏–Ω–≥ –≤–æ–ª–Ω", "6. –ú—É–ª—å—Ç—è—à–Ω—ã–π —Å—Ç–∏–ª—å",
            "7. –ö–æ–ø–∏–∏ –º–∞—Ç—Ä–∏—Ü—ã", "8. –ó–µ—Ä–∫–∞–ª—å–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç", "9. –ì–ª–∏—Ç—á-–∞—Ä—Ç",
            "10. TV-—à—É–º", "11. –í–æ–¥–Ω–∞—è —Ä—è–±—å", "12. –ü–∏–∫—Å–µ–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
            "13. –ö–∞–ª–µ–π–¥–æ—Å–∫–æ–ø", "14. –¢—É–Ω–Ω–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏", "15. –ù–µ–æ–Ω–æ–≤—ã–π glow",
            "16. –ì–ª–∏—Ç—á-—Å–¥–≤–∏–≥", "17. –ó–≤—ë–∑–¥–Ω—ã–π –≤–∑—Ä—ã–≤", "18. –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ",
            "19. –¶–≤–µ—Ç–æ–≤–∞—è –≤–æ–ª–Ω–∞ —Å –≥–ª–∏—Ç—á–µ–º", "20. –ü–∏–∫—Å–µ–ª—å–Ω—ã–π –≤—ã–ª–µ—Ç", "21. –ì–æ–ª–æ–≥—Ä–∞–º–º–Ω–æ–µ –º–µ—Ä—Ü–∞–Ω–∏–µ",
            "22. –§–µ–π–µ—Ä–≤–µ—Ä–∫ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ", "23. –ñ–∏–¥–∫–æ–µ —Ç–∞—è–Ω–∏–µ", "24. –ù–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ 2",
            "25. –í—Ä–µ–º–µ–Ω–Ω–æ–π warp", "26. –°–µ—Ç–∫–∞ —Å —É–º–µ–Ω—å—à–µ–Ω–∏–µ–º", "27. –°–º–µ—â–µ–Ω–∏–µ –ø–æ–ª–æ–≤–∏–Ω",
            "28. –ú—É–ª—å—Ç—è—â–Ω—ã–π —Å—Ç–∏–ª—å 2 [Hard]", "29. C–ø–∏—Ä–∞–ª—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏", "30. –ó–µ—Ä–∫–∞–ª—å–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç 2",
            "31. –ì–ª–∏—Ç—á-–∞—Ä—Ç 2", "32. –ì–ª–∏—Ç—á-–∞—Ä—Ç 3", "33. VHS-–∞—Ä—Ç", "34. –ö–∞–ª–µ–π–¥–æ—Å–∫–æ–ø 2",
            "35. –¢—É–Ω–Ω–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ 2", "36. –ù–µ–æ–Ω–æ–≤—ã–π glow 3 (Hard)", "37. –ì–ª–∏—Ç—á-—Å–¥–≤–∏–≥ 2",
            "38. –ó–≤—ë–∑–¥–Ω—ã–π –≤–∑—Ä—ã–≤ 2", "39. –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ 2", "40. –¶–≤–µ—Ç–æ–≤–∞—è –≤–æ–ª–Ω–∞ —Å –≥–ª–∏—Ç—á–µ–º 2",
            "41. –¢–∞—è–Ω–∏–µ –∫–∞–ø–µ–ª—å", "42. –ù–µ–æ–Ω–æ–≤—ã–π –≥–ª–∏—Ç—á", "43. –ù–µ–æ–Ω–æ–≤—ã–µ –ø–æ–ª–æ—Å—ã [Hard]", "44. –ú–∞—Ç—Ä–∏—Ü–∞",
            "45. –í–æ–ª–Ω–æ–≤–æ–π –ì–ª–∏—Ç—á", "46. –ú—Ä–∞—á–Ω—ã–π –º—É–ª—å—Ç–∏–∫", "47. –ú—É–ª—å—Ç—è—à–Ω—ã–π –ù–µ–æ–Ω",
            "48. –§—Ä–∞–≥–º–µ–Ω—Ç—ã", "49. –•–æ—Ä—Ä–æ—Ä [Hard]", "50. –†–∞–∑—ä–µ–∑–¥ –ø–æ–ª–æ–≤–∏–Ω",
            "51. –Ø–¥–æ–≤–∏—Ç—ã–π-—Ç—É—Å–∫–ª—ã–π —Ü–≤–µ—Ç", "52. –ü—É–ª—å—Å–∞—Ü–∏—è —Ü–≤–µ—Ç–∞", "53. 8-bit",
            "54. –®–∏—Ñ—Ä —Ü–≤–µ—Ç–∞", "55. –ì–ª–∏—Ç—á-–ö–∏–±–µ—Ä –ú—É–ª—å—Ç [Hard]", "56. –†–æ–∑–æ–≤–æ-–∑–æ–ª–æ—Ç–æ–π –≥–ª–∏—Ç—á [Hard]",
            "57. –¢—Ä–∏–ø –≤ –õ–∞—Å-–í–µ–≥–∞—Å–µ [Hard]", "58. VHS [Hard]", "59. –ó–æ–ª–æ—Ç—ã–µ –±–ª–∏–∫–∏ [Hard]", "60. –í–æ—Ä–æ–Ω–∫–∞",
            "61. –ù–µ–æ–Ω–æ–≤—ã–π –≥–ª–∏—Ç—á 2", "62. –§—Ä–∞–≥–º–µ–Ω—Ç—ã 2",
        ])

        '''
–ö–Ω–æ–ø–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.
        '''
        self.apply_button = QPushButton("–ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç")
        '''
–°–≤—è–∑–∞–ª–∏ –∫–Ω–æ–ø–∫—É —Å –º–µ—Ç–æ–¥–æ–º apply_effect.
        '''
        self.apply_button.clicked.connect(self.apply_effect)
        '''
–ö–∏–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ –∫–Ω–æ–ø–∫—É –≤ —Å—Ç—Ä–æ–∫—É.
        '''
        eg_layout.addWidget(self.effect_combo)
        eg_layout.addWidget(self.apply_button)
        '''
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É –≤ –≥—Ä—É–ø–ø—É.
        '''
        effects_group.setLayout(eg_layout)
        '''
–î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
        '''
        main_layout.addWidget(effects_group)

        # Batch actions
        '''
–ì—Ä—É–ø–ø–∞ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π, —Ç–∏–ø–∞ ¬´—Å–¥–µ–ª–∞—Ç—å –≤—Å—ë —Ä–∞–∑–æ–º¬ª.
        '''
        batch_group = QGroupBox("–ü–∞–∫–µ—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏")
        '''
–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫–∞ –≤–Ω—É—Ç—Ä–∏.
        '''
        bg_layout = QHBoxLayout()
        '''
–ö–Ω–æ–ø–∫–∞, —á—Ç–æ–± —Å—Ä–∞–∑—É —Å–¥–µ–ª–∞—Ç—å –≥–∏—Ñ–∫–∏ —Å–æ –≤—Å–µ–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏.
        '''
        self.create_gifs_button = QPushButton("–°–æ–∑–¥–∞—Ç—å GIF –∏–∑ –≤—Å–µ—Ö –≤–∏–¥–µ–æ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤")
        '''
–ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –º–µ—Ç–æ–¥—É create_gifs_from_effects.
        '''
        self.create_gifs_button.clicked.connect(self.create_gifs_from_effects)
        '''
–ö–Ω–æ–ø–∫–∞, —á—Ç–æ–± –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –≥–∏—Ñ–∫–∏ –≤ webm.
        '''
        self.convert_webm_button = QPushButton("–°–æ–∑–¥–∞—Ç—å WEBM –∏–∑ –≤—Å–µ—Ö GIF")
        '''
–ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ –∫ –º–µ—Ç–æ–¥—É convert_all_gifs_to_webm.
        '''
        self.convert_webm_button.clicked.connect(self.convert_all_gifs_to_webm)
        '''
–°—Ç–∞–≤–∏–º id ¬´danger¬ª, —á—Ç–æ–±—ã –ø–æ —Å—Ç–∏–ª—è–º –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –∫—Ä–∞—Å–Ω–∞—è.
        '''
        self.convert_webm_button.setObjectName("danger")
        '''
–î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å—Ç—Ä–æ–∫—É.
        '''
        bg_layout.addWidget(self.create_gifs_button)
        bg_layout.addWidget(self.convert_webm_button)
        '''
–ü—Ä–∏—Å–æ–±–∞—á–∏–≤–∞–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É –≤ –≥—Ä—É–ø–ø—É.
        '''
        batch_group.setLayout(bg_layout)
        '''
–ì—Ä—É–ø–ø–∞ –∏–¥—ë—Ç –≤ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
        '''
        main_layout.addWidget(batch_group)

        # Progress and status
        '''
–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–±–æ—Ç—ã.
        '''
        self.progress_bar = QProgressBar()
        '''
–°—Ä–∞–∑—É –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ 0.
        '''
        self.progress_bar.setValue(0)
        '''
–õ–µ–π–±–ª —Å–ø—Ä–∞–≤–∞ –æ—Ç –±–∞—Ä–∞, –ø–∏—à–µ—Ç ¬´–ì–æ—Ç–æ–≤–æ¬ª
        '''
        self.status_label = QLabel("–ì–æ—Ç–æ–≤–æ")
        '''
–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∫–∞ –¥–ª—è –±–∞—Ä–∞ –∏ —Ç–µ–∫—Å—Ç–∞.
        '''
        status_layout = QHBoxLayout()
        '''
–ó–∞–∫–∏–Ω—É–ª–∏ –±–∞—Ä –∏ —Ç–µ–∫—Å—Ç –≤ —Å—Ç—Ä–æ–∫—É.
        '''
        status_layout.addWidget(self.progress_bar)
        status_layout.addWidget(self.status_label)
        '''
–î–æ–±–∞–≤–∏–ª–∏ —Å—Ç—Ä–æ–∫—É –≤ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
        '''
        main_layout.addLayout(status_layout)

        # Internal state
        '''
–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ. –ü–æ–∫–∞ –ø—É—Å—Ç–æ.
        '''
        self.input_video = None
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è GIF -> WEBM
        '''
–†–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞ (—Ç–∏–ø–∞ —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞).
        '''
        self.canvas_size = (512, 512)
        '''
–ö–∞–¥—Ä—ã –≤ —Å–µ–∫—É–Ω–¥—É.
        '''
        self.fps = 25
        '''
–î–ª–∏–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ 5 —Å–µ–∫—É–Ω–¥.
        '''
        self.animation_length = 5
        '''
–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ ‚Äî 256 –∫–∏–ª–æ–±–∞–π—Ç.
        '''
        self.max_size_kb = 256

        # –ü–æ—Ç–æ–∫–∏
        '''
–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤ (—á—Ç–æ–± –ø—Ä–æ–≥–∞ –Ω–µ –≤–∏—Å–ª–∞, –∫–æ–≥–¥–∞ –≥–∏—Ñ–∫–∏ –∏ webm –¥–µ–ª–∞–µ—Ç).
        '''
        self._gif_thread = None
        self._webm_thread = None



        '''
–ú–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—à—å —ç—Ñ—Ñ–µ–∫—Ç –≤ –∫–æ–º–±–æ–±–æ–∫—Å–µ.
        '''
    def on_effect_changed(self, index):
        '''
–ë–µ—Ä—ë–º –Ω–æ–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Ç–æ –ø—Ä–∏–±–∞–≤–ª—è–µ–º 1 –∫ –∏–Ω–¥–µ–∫—Å—É (—á—Ç–æ–± —Å 1 –Ω–∞—á–∏–Ω–∞–ª–æ—Å—å).
        '''
        effect_number = self.effect_combo.itemData(index) or (index + 1)
        '''
–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.
        '''
        self.show_preview_for(effect_number)


        '''
–§—É–Ω–∫—Ü–∏—è, —á—Ç–æ–± –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–æ –µ–≥–æ –Ω–æ–º–µ—Ä—É.
        '''
    def show_preview_for(self, number):
        '''
–ï—Å–ª–∏ –æ–∫–Ω–æ –ø—Ä–µ–≤—å—é –Ω–µ –≤–∏–¥–Ω–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ.
        '''
        if not self.preview_window.isVisible():
            self.preview_window.show()

        # –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ preview
        '''
–í—ã—á–∏—Å–ª—è–µ–º, –≥–¥–µ –ª–µ–∂–∏—Ç —Å–∞–º —Ñ–∞–π–ª. –ï—Å–ª–∏ __file__ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ –±–µ—Ä—ë–º —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—á—É—é –ø–∞–ø–∫—É.
        '''
        try:
            base = os.path.dirname(os.path.abspath(__file__))
        except NameError:
            base = os.getcwd()
            '''
–ï—Å–ª–∏ –ø—Ä–æ–≥–∞ —Å–æ–±—Ä–∞–Ω–∞ –≤ exe-—à–Ω–∏–∫ —á–µ—Ä–µ–∑ PyInstaller, —Ç–æ –±–∞–∑–∞ –±—É–¥–µ—Ç –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏ _MEIPASS.
            '''
        if getattr(sys, 'frozen', False) and hasattr(sys, '_MEIPASS'):
            base = sys._MEIPASS

            '''
–°–∫–ª–∞–¥—ã–≤–∞–µ–º –ø—É—Ç—å –¥–æ –≥–∏—Ñ–∫–∏ –ø—Ä–µ–≤—å—é—à–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, preview/3.gif).
            '''
        gif_path = os.path.join(base, "preview", f"{number}.gif")
        '''
–ó–∞–≥—Ä—É–∂–∞–µ–º —ç—Ç—É –≥–∏—Ñ–∫—É –≤ –æ–∫–Ω–æ –ø—Ä–µ–≤—å—é.
        '''
        self.preview_window.set_gif(gif_path)




        '''
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
        '''
    def _get_effects_dir(self):
        '''
–ï—Å–ª–∏ –≤–∏–¥–æ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî —Å–º—ã—Å–ª–∞ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None.
        '''
        if not self.input_video:
            return None
        '''
–ë–µ—Ä—ë–º –ø–∞–ø–∫—É, –≥–¥–µ –ª–µ–∂–∏—Ç –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ.
        '''
        parent = self.input_video.parent
        '''
–°–æ–∑–¥–∞—ë–º –ø—É—Ç—å –≤ –ø–∞–ø–∫—É ¬´—ç—Ñ—Ñ–µ–∫—Ç—ã¬ª.
        '''
        effects_dir = parent / "—ç—Ñ—Ñ–µ–∫—Ç—ã"
        '''
–ï—Å–ª–∏ —Ç–∞–∫–æ–π –ø–∞–ø–∫–∏ –Ω–µ—Ç, —Ç–æ —Å–æ–∑–¥–∞—ë–º.
        '''
        effects_dir.mkdir(parents=True, exist_ok=True)
        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Ç—å –∫ —ç—Ç–æ–π –ø–∞–ø–∫–µ.
        '''
        return effects_dir


    '''
–ß–∏—Å—Ç–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞, —á—Ç–æ–±—ã –∏–∑ –Ω–µ–≥–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞.
    '''
    def _sanitize_effect_name(self, text):
        '''
–£–±–∏—Ä–∞–µ–º –≤ –Ω–∞—á–∞–ª–µ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫—É, —Ç–∏–ø–∞ ¬´1. ¬ª –∏–ª–∏ ¬´23. ¬ª.
        '''
        __name__ = re.sub(r'^\d+\.\s*', '', text)
        '''
–í—ã–∫–∏–¥—ã–≤–∞–µ–º –≤—Å—è–∫–∏–π –º—É—Å–æ—Ä, –∫—Ä–æ–º–µ –±—É–∫–≤, —Ü–∏—Ñ—Ä, –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –¥–µ—Ñ–∏—Å–æ–≤.
        '''
        __name__ = re.sub(r'[^\w\s-]', '', __name__, flags=re.UNICODE)
        '''
–£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
        '''
        __name__ = re.sub(r'\s+', '', __name__.strip())
        '''
–ï—Å–ª–∏ –≤ –∏—Ç–æ–≥–µ –ø—É—Å—Ç–æ, —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ¬´effect¬ª.
        '''
        return __name__ or "effect"

    '''
–ú–µ—Ç–æ–¥ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –≤–∏–¥–µ–æ.
    '''
    def select_video(self):
        '''
–û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞. –ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ.
        '''
        video_path, _ = QFileDialog.getOpenFileName(self, "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ", "", "Video Files (*.mp4 *.avi *.mov *.mkv)")
        '''
E—Å–ª–∏ —á—Ç–æ-—Ç–æ –≤—ã–±—Ä–∞–ª–∏: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
        '''
        if video_path:
            self.input_video = Path(video_path)
            self.label.setText(self.input_video.name)
            self.status_label.setText("–ò—Å—Ç–æ—á–Ω–∏–∫ –≤—ã–±—Ä–∞–Ω")

            '''
–¢—É—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –º—è—Å–æ: –ø—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∫ –≤–∏–¥–µ–æ.
            '''
    def apply_effect(self):
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        '''
–ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã—Ö–æ–¥–∏–º.
        '''
        if not self.input_video:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ.")
            return

        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—É—Ç–∏ –∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        '''
–ë–µ—Ä—ë–º –ø–∞–ø–∫—É ¬´—ç—Ñ—Ñ–µ–∫—Ç—ã¬ª, –∏–Ω–¥–µ–∫—Å —ç—Ñ—Ñ–µ–∫—Ç–∞, –µ–≥–æ —Ç–µ–∫—Å—Ç –∏ –ø—Ä–∏–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –ø–æ—Ä—è–¥–æ–∫.
        '''
        effects_dir = self._get_effects_dir()
        effect_index = self.effect_combo.currentIndex() + 1
        effect_text = self.effect_combo.currentText()
        effect_name = self._sanitize_effect_name(effect_text)

        '''
–§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: –∏–º—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ + –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ + —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ.
        '''
        orig_stem = Path(self.input_video).stem
        ext = Path(self.input_video).suffix
        output_name = f"{orig_stem}_{effect_name}{ext}"
        output_path = effects_dir / output_name

        # –û—Ç–∫–ª—é—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        '''
–ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç¬ª, —á—Ç–æ–± –¥–≤–∞ —Ä–∞–∑–∞ –Ω–µ –∂–∞–ª–∏.
        '''
        try:
            self.apply_button.setDisabled(True)
        except Exception:
            pass
        '''
–ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏.
        '''
        try:
            self.create_gifs_button.setDisabled(True)
            self.convert_webm_button.setDisabled(True)
        except Exception:
            pass

        '''
–û–±–Ω—É–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ø–∏—à–µ–º ¬´–û–±—Ä–∞–±–æ—Ç–∫–∞...¬ª.
        '''
        self.progress_bar.setValue(0)
        if hasattr(self, "status_label"):
            self.status_label.setText("–û–±—Ä–∞–±–æ—Ç–∫–∞...")

        # –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä EffectProcessor.
        # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π init –∏–ª–∏ –æ—à–∏–±–æ—á–Ω—ã–π init.
        '''
–°–æ–∑–¥–∞—ë–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
–ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª,
–ø—Ä–æ–±—É–µ–º ¬´–∫–æ—Å—Ç—ã–ª—å–Ω—ã–π¬ª init. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ ‚Äî –æ—à–∏–±–∫–∞.
        '''
        try:
            # –ü–æ–ø—ã—Ç–∫–∞ –æ–±—ã—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            self.processor = EffectProcessor(str(self.input_video), str(output_path), effect_index)
        except TypeError:
            # –ï—Å–ª–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ init –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ init
            self.processor = EffectProcessor()
            if hasattr(self.processor, "init"):
                # –í—ã–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ init (–∫–∞–∫ –≤ –≤–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ)
                self.processor.init(str(self.input_video), str(output_path), effect_index)
            else:
                # –ù–µ—á–µ–≥–æ –¥–µ–ª–∞—Ç—å ‚Äî –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É
                QMessageBox.critical(self, "–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å EffectProcessor: –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.")
                self._enable_ui_after_processing()
                return

        # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
        '''
–ï—Å–ª–∏ —É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –µ—Å—Ç—å —Å–∏–≥–Ω–∞–ª –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –ø–æ–¥–∫–ª—é—á–∞–µ–º –µ–≥–æ –∫ –Ω–∞—à–µ–º—É –±–∞—Ä—É.
        '''
        if hasattr(self.processor, "progress"):
            try:
                self.processor.progress.connect(self.progress_bar.setValue)
            except Exception:
                pass

        # finished –æ–∂–∏–¥–∞–µ—Ç—Å—è —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        '''
–ö–æ–≥–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è ‚Äî –≤—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ _on_effect_finished.
        '''
        self.processor.finished.connect(self._on_effect_finished)

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
        '''
–ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
        '''
        self.processor.start()

    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è UI
    '''
–ú–µ—Ç–æ–¥, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ.
    '''
    def _enable_ui_after_processing(self):
        '''
–°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å –∫–Ω–æ–ø–æ–∫ –∏ –ø–∏—à–µ–º ¬´–ì–æ—Ç–æ–≤–æ¬ª.
        '''
        try:
            self.apply_button.setDisabled(False)
        except Exception:
            pass
        try:
            self.create_gifs_button.setDisabled(False)
            self.convert_webm_button.setDisabled(False)
        except Exception:
            pass
        if hasattr(self, "status_label"):
            self.status_label.setText("–ì–æ—Ç–æ–≤–æ")

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    '''
–ö–æ–≥–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∑–∞–∫–æ–Ω—á–µ–Ω–∞.
    '''
    def _on_effect_finished(self, msg):
        # –í–∫–ª—é—á–∞–µ–º UI
        '''
–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏, —Å—Ç–∞–≤–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ 100% –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        '''
        self._enable_ui_after_processing()
        self.progress_bar.setValue(100)
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç EffectProcessor (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        QMessageBox.information(self, "–†–µ–∑—É–ª—å—Ç–∞—Ç", msg if msg else "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

        '''
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è GIF –¥–ª—è –≤—Å–µ—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
        '''
    def create_gifs_from_effects(self):
        '''
–ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ—Ç ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.
        '''
        if not self.input_video:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–µ –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ.")
            return

        '''
–û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ø–∏—à–µ–º ¬´–°–æ–∑–¥–∞–Ω–∏–µ GIF...¬ª.
        '''
        effects_dir = self._get_effects_dir()
        # –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏, –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
        self.create_gifs_button.setDisabled(True)
        self.convert_webm_button.setDisabled(True)
        self.apply_button.setDisabled(True)
        self.progress_bar.setValue(0)
        self.status_label.setText("–°–æ–∑–¥–∞–Ω–∏–µ GIF...")


        '''
–°–æ–∑–¥–∞—ë–º –ø–æ—Ç–æ–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ GIF.
        '''
        self._gif_thread = GifCreatorThread(
            effects_dir, self.canvas_size, self.fps, self.animation_length
        )
        '''
–ü–æ–¥–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, –æ—à–∏–±–∫–∏, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ. –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫.
        '''
        self._gif_thread.progress.connect(self.progress_bar.setValue)
        self._gif_thread.error.connect(lambda msg: QMessageBox.warning(self, "–û—à–∏–±–∫–∞", msg))
        self._gif_thread.finished.connect(self._on_gif_finished)
        self._gif_thread.start()


        '''
–ö–æ–≥–¥–∞ –≤—Å–µ –≥–∏—Ñ–∫–∏ –≥–æ—Ç–æ–≤—ã.
        '''
    def _on_gif_finished(self, msg):
        '''
–í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ,
–ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ 100,
–ø–∏—à–µ–º ¬´–ì–æ—Ç–æ–≤–æ¬ª –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ.
        '''
        self.create_gifs_button.setDisabled(False)
        self.convert_webm_button.setDisabled(False)
        self.apply_button.setDisabled(False)
        self.progress_bar.setValue(100)
        self.status_label.setText("–ì–æ—Ç–æ–≤–æ")
        QMessageBox.information(self, "–†–µ–∑—É–ª—å—Ç–∞—Ç", msg)

        '''
–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Å–µ—Ö GIF –≤ WEBM.
        '''
    def convert_all_gifs_to_webm(self):
        if not self.input_video:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–µ –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ.")
            return

        '''
–°–º–æ—Ç—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –ø–∞–ø–∫–∞ —Å –≥–∏—Ñ–∫–∞–º–∏. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–Ω—Ñ–∞ –∏ –≤—ã—Ö–æ–¥–∏–º.
        '''
        effects_dir = self._get_effects_dir()
        gifs_dir = effects_dir / "GIFs"
        if not gifs_dir.exists():
            QMessageBox.information(self, "–ò–Ω—Ñ–æ", f"–ü–∞–ø–∫–∞ {gifs_dir} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        # –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
        self.create_gifs_button.setDisabled(True)
        self.convert_webm_button.setDisabled(True)
        self.apply_button.setDisabled(True)
        self.progress_bar.setValue(0)
        self.status_label.setText("–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è GIF -> WEBM...")

        '''
–ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.
        '''
        self._webm_thread = WebmConverterThread(
            gifs_dir, self.canvas_size, self.fps, self.animation_length, self.max_size_kb
        )
        '''
–ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã, –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫.
        '''
        self._webm_thread.progress.connect(self.progress_bar.setValue)
        self._webm_thread.error.connect(lambda msg: QMessageBox.warning(self, "–û—à–∏–±–∫–∞", msg))
        self._webm_thread.finished.connect(self._on_webm_finished)
        self._webm_thread.start()

    def _on_webm_finished(self, msg):
        self.create_gifs_button.setDisabled(False)
        self.convert_webm_button.setDisabled(False)
        self.apply_button.setDisabled(False)
        self.progress_bar.setValue(100)
        self.status_label.setText("–ì–æ—Ç–æ–≤–æ")
        QMessageBox.information(self, "–†–µ–∑—É–ª—å—Ç–∞—Ç", msg)
            

if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = VideoEffectsApp()
    window.show()
    sys.exit(app.exec_())

